<!DOCTYPE html>
<html lang="ko" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>업무 일지 목록</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 50;
        flex-direction: column;
        gap: 1rem;
      }
      .table-row-hover:hover {
        background-color: #f9fafb;
        cursor: pointer;
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
      <i class="fas fa-spinner fa-spin fa-3x text-green-600"></i>
      <span class="text-green-800 font-semibold">데이터를 불러오는 중...</span>
    </div>

    <div class="min-h-screen pb-20">
      <!-- Header -->
      <div class="bg-gradient-to-r from-green-600 to-green-700 text-white p-4 shadow-lg sticky top-0 z-10">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
          <div>
            <h1 class="text-2xl font-bold flex items-center gap-2">
              <i class="fas fa-list-alt"></i>
              업무 일지 목록
            </h1>
            <p class="text-green-100 text-sm mt-1">작성된 업무 일지 현황</p>
          </div>
          <a
            href="work-log-create.html"
            class="bg-white text-green-700 px-4 py-2 rounded-lg font-bold hover:bg-green-50 transition shadow-sm flex items-center gap-2 text-sm md:text-base"
          >
            <i class="fas fa-plus"></i>
            <span class="hidden md:inline">새 일지 작성</span>
            <span class="md:hidden">작성</span>
          </a>
        </div>
      </div>

      <div class="max-w-6xl mx-auto p-4">
        <!-- Filters -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">시작 날짜</label>
              <input
                type="date"
                id="startDate"
                class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm"
              />
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">종료 날짜</label>
              <input
                type="date"
                id="endDate"
                class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm"
              />
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">상태</label>
              <select
                id="statusFilter"
                class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm"
              >
                <option value="">전체</option>
                <option value="draft">작성중</option>
                <option value="pending_team_leader">팀장 검수 대기</option>
                <option value="pending_manager">소장 검수 대기</option>
                <option value="approved">승인 완료</option>
                <option value="rejected">반려</option>
              </select>
            </div>
            <div class="flex gap-2">
              <button
                onclick="loadWorkLogs()"
                class="flex-1 bg-green-600 text-white px-4 py-2 rounded font-bold hover:bg-green-700 transition text-sm"
              >
                <i class="fas fa-search mr-1"></i> 검색
              </button>
              <button
                onclick="resetFilters()"
                class="bg-gray-200 text-gray-600 px-4 py-2 rounded font-bold hover:bg-gray-300 transition text-sm"
              >
                <i class="fas fa-undo"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-12 bg-white rounded-lg border border-dashed border-gray-300">
          <i class="fas fa-folder-open text-gray-300 text-5xl mb-4"></i>
          <p class="text-gray-500 text-lg mb-2">조건에 맞는 업무 일지가 없습니다.</p>
          <button onclick="location.href = 'work-log-create.html'" class="text-green-600 hover:underline font-semibold">
            새 일지 작성하기
          </button>
        </div>

        <!-- Desktop Table -->
        <div id="desktopTableContainer" class="hidden md:block bg-white rounded-lg shadow-md overflow-hidden">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  scope="col"
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32"
                >
                  날짜
                </th>
                <th
                  scope="col"
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24"
                >
                  날씨
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  작성자
                </th>
                <th
                  scope="col"
                  class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-32"
                >
                  상태
                </th>
                <th
                  scope="col"
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-40"
                >
                  작성일시
                </th>
                <th
                  scope="col"
                  class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-24"
                >
                  작업
                </th>
              </tr>
            </thead>
            <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
              <!-- Rows will be populated by JS -->
            </tbody>
          </table>
        </div>

        <!-- Mobile Cards -->
        <div id="mobileCards" class="md:hidden space-y-4">
          <!-- Cards will be populated by JS -->
        </div>
      </div>
    </div>

    <script>
      // ==================== CONFIGURATION ====================
      const SUPABASE_URL = 'https://qgpqhtuynxhmgawakjxe.supabase.co';
      const SUPABASE_ANON_KEY = 'sb_publishable_ujXj0mLf1casiQdVkc0fCA_G6exymqG';

      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Status Configuration
      const STATUS_CONFIG = {
        draft: { label: '작성중', color: 'bg-gray-100 text-gray-700 border-gray-200' },
        pending_team_leader: { label: '팀장 검수 대기', color: 'bg-yellow-50 text-yellow-700 border-yellow-200' },
        pending_manager: { label: '소장 검수 대기', color: 'bg-blue-50 text-blue-700 border-blue-200' },
        approved: { label: '승인 완료', color: 'bg-green-50 text-green-700 border-green-200' },
        rejected: { label: '반려', color: 'bg-red-50 text-red-700 border-red-200' },
      };

      // ==================== INITIALIZATION ====================
      window.onload = function () {
        // Set default date range (Last 30 days)
        const today = new Date();
        const lastMonth = new Date(today);
        lastMonth.setDate(today.getDate() - 30);

        document.getElementById('endDate').value = today.toISOString().split('T')[0];
        document.getElementById('startDate').value = lastMonth.toISOString().split('T')[0];

        loadWorkLogs();
      };

      // ==================== FUNCTIONS ====================
      async function loadWorkLogs() {
        const loadingOverlay = document.getElementById('loadingOverlay');
        loadingOverlay.classList.remove('hidden');

        try {
          const startDate = document.getElementById('startDate').value;
          const endDate = document.getElementById('endDate').value;
          const status = document.getElementById('statusFilter').value;

          let query = supabase.from('work_logs').select('*').order('date', { ascending: false });

          if (startDate) query = query.gte('date', startDate);
          if (endDate) query = query.lte('date', endDate);
          if (status) query = query.eq('status', status);

          const { data: workLogs, error } = await query;

          if (error) throw error;

          renderData(workLogs);
        } catch (error) {
          console.error('Error loading logs:', error);
          alert('데이터를 불러오는데 실패했습니다.');
        } finally {
          loadingOverlay.classList.add('hidden');
        }
      }

      function renderData(logs) {
        const tableBody = document.getElementById('tableBody');
        const mobileCards = document.getElementById('mobileCards');
        const emptyState = document.getElementById('emptyState');
        const desktopTable = document.getElementById('desktopTableContainer');

        tableBody.innerHTML = '';
        mobileCards.innerHTML = '';

        if (!logs || logs.length === 0) {
          emptyState.classList.remove('hidden');
          desktopTable.classList.add('hidden');
          return;
        }

        emptyState.classList.add('hidden');
        desktopTable.classList.remove('hidden');

        logs.forEach((log) => {
          // 1. Render Table Row
          const row = document.createElement('tr');
          row.className = 'table-row-hover transition duration-150';
          row.onclick = () => navigateToDetail(log.id);

          const statusStyle = STATUS_CONFIG[log.status] || STATUS_CONFIG.draft;

          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
              ${log.date}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              ${log.weather || '-'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <div class="flex items-center">
                <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 mr-2">
                   <i class="fas fa-user"></i>
                </div>
                <!-- TODO: Join with auth user to get email/name -->
                <span title="${log.author_id}">센터장</span>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-center">
              <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full border ${statusStyle.color}">
                ${statusStyle.label}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              ${new Date(log.created_at).toLocaleString('ko-KR', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <button onclick="event.stopPropagation(); navigateToDetail('${log.id}')" class="text-green-600 hover:text-green-900">
                <i class="fas fa-chevron-right"></i>
              </button>
            </td>
          `;
          tableBody.appendChild(row);

          // 2. Render Mobile Card
          const card = document.createElement('div');
          card.className = 'bg-white rounded-lg shadow-sm border border-gray-100 p-4 active:bg-gray-50';
          card.onclick = () => navigateToDetail(log.id);

          card.innerHTML = `
            <div class="flex justify-between items-start mb-2">
              <div>
                <span class="text-lg font-bold text-gray-800">${log.date}</span>
                <span class="text-sm text-gray-500 ml-2">${log.weather}</span>
              </div>
              <span class="px-2 py-1 text-xs font-semibold rounded-full border ${statusStyle.color}">
                ${statusStyle.label}
              </span>
            </div>
            <div class="flex justify-between items-center text-sm text-gray-600 mb-2">
               <div class="flex items-center gap-1">
                 <i class="fas fa-user-circle"></i>
                 <span>센터장</span>
               </div>
               <span>${new Date(log.created_at).toLocaleDateString()}</span>
            </div>
            <div class="mt-2 pt-2 border-t border-gray-100 flex justify-end">
               <span class="text-green-600 font-medium text-sm flex items-center gap-1">
                 상세보기 <i class="fas fa-arrow-right"></i>
               </span>
            </div>
          `;
          mobileCards.appendChild(card);
        });
      }

      function navigateToDetail(id) {
        window.location.href = `work-log-view.html?id=${id}`;
      }

      function resetFilters() {
        document.getElementById('statusFilter').value = '';
        const today = new Date();
        const lastMonth = new Date(today);
        lastMonth.setDate(today.getDate() - 30);

        document.getElementById('endDate').value = today.toISOString().split('T')[0];
        document.getElementById('startDate').value = lastMonth.toISOString().split('T')[0];

        loadWorkLogs();
      }
    </script>
  </body>
</html>
