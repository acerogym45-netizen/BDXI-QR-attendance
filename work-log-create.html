<!DOCTYPE html>
<html lang="ko" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>업무 일지 작성</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      .step-indicator.active {
        background-color: #16a34a; /* green-600 */
        color: white;
        border-color: #16a34a;
      }
      .step-indicator.completed {
        background-color: #16a34a;
        color: white;
        border-color: #16a34a;
      }
      .step-line.active {
        background-color: #16a34a;
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
        flex-direction: column;
        gap: 1rem;
      }
      .hidden-step {
        display: none;
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800 pb-24">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
      <i class="fas fa-spinner fa-spin fa-3x text-green-600"></i>
      <span id="loadingText" class="text-green-800 font-bold text-lg">처리중...</span>
    </div>

    <!-- Header -->
    <div class="bg-green-700 text-white p-4 shadow-lg sticky top-0 z-50">
      <div class="max-w-3xl mx-auto flex justify-between items-center">
        <h1 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-edit"></i> 업무 일지 작성</h1>
        <a href="work-log-list.html" class="text-green-100 hover:text-white text-sm">
          <i class="fas fa-times"></i> 닫기
        </a>
      </div>
    </div>

    <div class="max-w-3xl mx-auto p-4">
      <!-- Step Indicators -->
      <div class="flex items-center justify-between mb-8 px-2 relative">
        <div class="absolute top-1/2 left-0 w-full h-1 bg-gray-200 -z-10 transform -translate-y-1/2 rounded"></div>
        <div
          class="absolute top-1/2 left-0 h-1 bg-green-600 -z-10 transform -translate-y-1/2 rounded transition-all duration-300"
          id="progressBar"
          style="width: 0%"
        ></div>

        <!-- Steps -->
        <div class="step-item flex flex-col items-center gap-1 bg-gray-50 px-2">
          <div
            class="step-indicator w-8 h-8 rounded-full border-2 border-gray-300 flex items-center justify-center font-bold bg-white text-gray-400 transition-all active"
          >
            1
          </div>
          <span class="text-xs font-medium text-green-700">기본</span>
        </div>
        <div class="step-item flex flex-col items-center gap-1 bg-gray-50 px-2">
          <div
            class="step-indicator w-8 h-8 rounded-full border-2 border-gray-300 flex items-center justify-center font-bold bg-white text-gray-400 transition-all"
          >
            2
          </div>
          <span class="text-xs font-medium text-gray-500">일정</span>
        </div>
        <div class="step-item flex flex-col items-center gap-1 bg-gray-50 px-2">
          <div
            class="step-indicator w-8 h-8 rounded-full border-2 border-gray-300 flex items-center justify-center font-bold bg-white text-gray-400 transition-all"
          >
            3
          </div>
          <span class="text-xs font-medium text-gray-500">구역</span>
        </div>
        <div class="step-item flex flex-col items-center gap-1 bg-gray-50 px-2">
          <div
            class="step-indicator w-8 h-8 rounded-full border-2 border-gray-300 flex items-center justify-center font-bold bg-white text-gray-400 transition-all"
          >
            4
          </div>
          <span class="text-xs font-medium text-gray-500">사진</span>
        </div>
        <div class="step-item flex flex-col items-center gap-1 bg-gray-50 px-2">
          <div
            class="step-indicator w-8 h-8 rounded-full border-2 border-gray-300 flex items-center justify-center font-bold bg-white text-gray-400 transition-all"
          >
            5
          </div>
          <span class="text-xs font-medium text-gray-500">완료</span>
        </div>
      </div>

      <!-- Main Form Container -->
      <form id="workLogForm" onsubmit="return false;">
        <!-- STEP 1: Basic Information -->
        <div id="step1" class="step-content">
          <div class="bg-white rounded-lg shadow p-6 space-y-6 animate-fade-in">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-2">기본 정보 입력</h2>

            <div>
              <label class="block text-gray-700 font-bold mb-2">날짜 <span class="text-red-500">*</span></label>
              <div class="flex gap-2">
                <input
                  type="date"
                  id="logDate"
                  class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                  required
                />
                <button
                  type="button"
                  onclick="autoFetchData()"
                  class="bg-blue-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow-md whitespace-nowrap"
                >
                  <i class="fas fa-download mr-1"></i> 자동 가져오기
                </button>
              </div>
              <p class="text-xs text-gray-500 mt-1 ml-1">
                * 날짜 선택 후 자동 가져오기를 클릭하면 청소/근태 기록을 불러옵니다.
              </p>
            </div>

            <div>
              <label class="block text-gray-700 font-bold mb-2">작성자 <span class="text-red-500">*</span></label>
              <select
                id="logAuthor"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
              >
                <option value="센터장">센터장</option>
                <option value="부센터장">부센터장</option>
                <option value="관리팀장">관리팀장</option>
                <option value="관리소장">관리소장</option>
              </select>
            </div>
          </div>
        </div>

        <!-- STEP 2: Time Table -->
        <div id="step2" class="step-content hidden-step">
          <div class="bg-white rounded-lg shadow p-6 space-y-4">
            <div class="flex justify-between items-center border-b pb-2">
              <h2 class="text-xl font-bold text-gray-800">타임테이블 업무</h2>
              <button
                type="button"
                onclick="addTask()"
                class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-bold hover:bg-green-200"
              >
                <i class="fas fa-plus"></i> 추가
              </button>
            </div>

            <div id="taskList" class="space-y-3">
              <!-- Tasks will be added here dynamically -->
            </div>

            <div class="text-center pt-4">
              <button type="button" onclick="addTask()" class="text-green-600 font-bold hover:underline">
                <i class="fas fa-plus-circle"></i> 업무 항목 추가하기
              </button>
            </div>
          </div>
        </div>

        <!-- STEP 3: Cleaning Areas -->
        <div id="step3" class="step-content hidden-step">
          <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">청소 및 점검 구역 선택</h2>
            <p class="text-sm text-gray-500 mb-4">오늘 점검하거나 청소한 구역을 모두 선택해주세요.</p>

            <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="areaGrid">
              <!-- Areas generated by JS -->
            </div>
          </div>
        </div>

        <!-- STEP 4: Photos -->
        <div id="step4" class="step-content hidden-step">
          <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">사진 업로드</h2>
            <p class="text-sm text-gray-500 mb-6">선택한 구역의 전/후 사진을 등록해주세요.</p>

            <div id="photoUploadList" class="space-y-8">
              <!-- Photo uploaders generated by JS -->
            </div>
          </div>
        </div>

        <!-- STEP 5: Special Notes & Review -->
        <div id="step5" class="step-content hidden-step">
          <div class="bg-white rounded-lg shadow p-6 space-y-6">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-2">최종 확인 및 특이사항</h2>

            <div>
              <label class="block text-gray-700 font-bold mb-2">특이사항 / 비고</label>
              <textarea
                id="specialNotes"
                rows="5"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                placeholder="오늘 업무 중 특이사항이나 전달사항을 입력하세요."
              ></textarea>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
              <h3 class="font-bold text-gray-700 mb-2">작성 내용 요약</h3>
              <ul class="text-sm text-gray-600 space-y-1">
                <li>• 날짜: <span id="summaryDate" class="font-bold"></span></li>
                <li>• 작성자: <span id="summaryAuthor" class="font-bold"></span></li>
                <li>• 업무 항목: <span id="summaryTaskCount" class="font-bold">0</span>개</li>
                <li>• 청소 구역: <span id="summaryAreaCount" class="font-bold">0</span>곳</li>
              </ul>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Navigation Buttons -->
    <div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-4 shadow-lg z-40">
      <div class="max-w-3xl mx-auto flex justify-between gap-3">
        <button
          type="button"
          id="prevBtn"
          onclick="prevStep()"
          class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-bold hidden"
        >
          이전
        </button>

        <div class="flex-1 flex justify-end gap-2">
          <button
            type="button"
            id="saveDraftBtn"
            onclick="submitLog('draft')"
            class="px-4 py-3 bg-yellow-100 text-yellow-800 rounded-lg font-bold hidden"
          >
            임시저장
          </button>

          <button
            type="button"
            id="nextBtn"
            onclick="nextStep()"
            class="px-8 py-3 bg-green-600 text-white rounded-lg font-bold shadow-md hover:bg-green-700 flex-1 md:flex-none text-center"
          >
            다음 단계 <i class="fas fa-arrow-right ml-2"></i>
          </button>

          <button
            type="button"
            id="submitBtn"
            onclick="submitLog('submit')"
            class="px-8 py-3 bg-green-600 text-white rounded-lg font-bold shadow-md hover:bg-green-700 hidden flex-1 md:flex-none"
          >
            제출하기 <i class="fas fa-check ml-2"></i>
          </button>
        </div>
      </div>
    </div>

    <script>
      (function () {
        'use strict';

        // ==================== CONFIGURATION ====================
        const SUPABASE_URL = 'https://qgpqhtuynxhmgawakjxe.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_ujXj0mLf1casiQdVkc0fCA_G6exymqG';
        const STORAGE_BUCKET = 'work-log-photos';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ==================== STATE ====================
        let currentStep = 1;
        const totalSteps = 5;

        const CLEANING_AREAS = [
          '골프장',
          '수영장',
          '남자 사우나',
          '여자 사우나',
          '카페테리아',
          '헬스장',
          '다목적 체육관',
          '게스트하우스',
          '화장실',
          '기타 구역',
        ];

        // Form Data State
        let selectedAreas = new Set();
        let areaPhotos = {}; // { '골프장': { before: url, after: url, beforeFile: file, afterFile: file } }

        // ==================== INITIALIZATION ====================
        window.onload = function () {
          // Set default date to today
          document.getElementById('logDate').value = new Date().toISOString().split('T')[0];

          // Initialize Task List with one empty task
          addTask();

          // Initialize Cleaning Areas Grid
          renderAreaGrid();

          updateUI();
        };

        // ==================== AUTO FETCH DATA ====================
        window.autoFetchData = async function () {
          const selectedDate = document.getElementById('logDate').value;
          if (!selectedDate) {
            alert('먼저 날짜를 선택해주세요.');
            return;
          }

          showLoading(true, '데이터를 불러오는 중...');

          try {
            // 1. 청소 기록 조회 (cleaning_tasks 테이블)
            const { data: cleaningData, error: cleaningError } = await supabase
              .from('cleaning_tasks')
              .select('*')
              .eq('date', selectedDate);

            if (cleaningError) {
              console.warn('청소 기록 조회 실패:', cleaningError);
            }

            // 2. 근태 기록 조회 (attendance_records 테이블) - 직원명으로 조회
            const startTime = `${selectedDate}T00:00:00`;
            const endTime = `${selectedDate}T23:59:59`;
            
            const { data: attendanceData, error: attendanceError } = await supabase
              .from('attendance_records')
              .select('*')
              .gte('scan_time', startTime)
              .lte('scan_time', endTime)
              .order('scan_time', { ascending: true });

            if (attendanceError) {
              console.warn('근태 기록 조회 실패:', attendanceError);
            }

            console.log('조회된 근태 기록:', attendanceData);

            let fetchedInfo = [];

            // 3. 청소 기록 자동 삽입
            if (cleaningData && cleaningData.length > 0) {
              cleaningData.forEach((record) => {
                if (record.area_name) {
                  selectedAreas.add(record.area_name);
                  if (!areaPhotos[record.area_name]) {
                    areaPhotos[record.area_name] = {};
                  }
                  if (record.before_photo_url) areaPhotos[record.area_name].before = record.before_photo_url;
                  if (record.after_photo_url) areaPhotos[record.area_name].after = record.after_photo_url;
                }
              });
              renderAreaGrid();
              fetchedInfo.push(`청소 기록: ${cleaningData.length}건`);
            } else {
              fetchedInfo.push('청소 기록: 0건');
            }

            // 4. 근태 기록으로 타임테이블 생성 (직원명 기준, 모든 기록 표시)
            if (attendanceData && attendanceData.length > 0) {
              // 기존 타임테이블 초기화
              document.getElementById('taskList').innerHTML = '';

              attendanceData.forEach((record) => {
                const scanTime = record.scan_time ? record.scan_time.substring(11, 16) : ''; // HH:MM
                const workerName = record.location_name || '직원';
                const attendanceType = record.attendance_type || '';

                // 표시 형식: "직원명 출근" 또는 "직원명 퇴근"
                let taskDesc = '';
                if (attendanceType === '출근') {
                  taskDesc = `${workerName} 출근`;
                } else if (attendanceType === '퇴근') {
                  taskDesc = `${workerName} 퇴근`;
                } else {
                  taskDesc = `${workerName} ${attendanceType}`;
                }

                addTaskWithData(scanTime, taskDesc, true);
              });

              fetchedInfo.push(`근태 기록: ${attendanceData.length}건`);
            } else {
              fetchedInfo.push('근태 기록: 0건');
            }

            showLoading(false);
            alert(`자동 가져오기 완료!\n\n${fetchedInfo.join('\n')}`);

            // 데이터가 있으면 2단계로 이동
            if ((cleaningData && cleaningData.length > 0) || (attendanceData && attendanceData.length > 0)) {
              currentStep = 2;
              updateUI();
            }
          } catch (error) {
            console.error('자동 가져오기 오류:', error);
            showLoading(false);
            alert('데이터를 불러오는데 실패했습니다.\n\n' + error.message);
          }
        };

        window.addTaskWithData = function (time, description, completed) {
          const taskList = document.getElementById('taskList');
          const id = Date.now() + Math.random();

          const html = `
          <div class="task-item flex gap-2 items-center bg-gray-50 p-3 rounded border border-gray-200" id="task-${id}">
            <div class="flex-1 grid grid-cols-12 gap-2">
              <div class="col-span-3">
                <input type="time" class="task-time w-full p-2 border rounded text-sm" value="${time || ''}" placeholder="시간">
              </div>
              <div class="col-span-8">
                <input type="text" class="task-desc w-full p-2 border rounded text-sm" value="${description || ''}" placeholder="업무 내용 입력">
              </div>
              <div class="col-span-1 flex items-center justify-center">
                <input type="checkbox" class="task-check w-5 h-5 text-green-600 rounded" ${completed ? 'checked' : ''}>
              </div>
            </div>
            <button onclick="removeTask(${id})" class="text-red-400 hover:text-red-600 p-2">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
          taskList.insertAdjacentHTML('beforeend', html);
        };

        // ==================== NAVIGATION ====================
        window.nextStep = function () {
          if (!validateStep(currentStep)) return;

          if (currentStep < totalSteps) {
            currentStep++;
            updateUI();
            window.scrollTo(0, 0);

            // Generate photo uploaders if entering step 4
            if (currentStep === 4) {
              renderPhotoUploaders();
            }
            // Update summary if entering step 5
            if (currentStep === 5) {
              updateSummary();
            }
          }
        };

        window.prevStep = function () {
          if (currentStep > 1) {
            currentStep--;
            updateUI();
            window.scrollTo(0, 0);
          }
        };

        function updateUI() {
          // 1. Show/Hide Steps
          document.querySelectorAll('.step-content').forEach((el, index) => {
            if (index + 1 === currentStep) {
              el.classList.remove('hidden-step');
            } else {
              el.classList.add('hidden-step');
            }
          });

          // 2. Update Progress Indicator
          const progressPercentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
          document.getElementById('progressBar').style.width = `${progressPercentage}%`;

          document.querySelectorAll('.step-indicator').forEach((el, index) => {
            const stepNum = index + 1;
            el.classList.remove('active', 'completed', 'bg-green-600', 'text-white', 'border-green-600');
            el.classList.add('bg-white', 'text-gray-400', 'border-gray-300');

            if (stepNum < currentStep) {
              el.classList.add('completed', 'bg-green-600', 'text-white', 'border-green-600');
              el.innerHTML = '<i class="fas fa-check"></i>';
            } else if (stepNum === currentStep) {
              el.classList.add('active', 'bg-green-600', 'text-white', 'border-green-600');
              el.innerHTML = stepNum;
            } else {
              el.innerHTML = stepNum;
            }
          });

          // 3. Update Buttons
          const prevBtn = document.getElementById('prevBtn');
          const nextBtn = document.getElementById('nextBtn');
          const saveDraftBtn = document.getElementById('saveDraftBtn');
          const submitBtn = document.getElementById('submitBtn');

          // Prev Button
          if (currentStep === 1) prevBtn.classList.add('hidden');
          else prevBtn.classList.remove('hidden');

          // Next/Submit Buttons
          if (currentStep === totalSteps) {
            nextBtn.classList.add('hidden');
            saveDraftBtn.classList.remove('hidden');
            submitBtn.classList.remove('hidden');
          } else {
            nextBtn.classList.remove('hidden');
            saveDraftBtn.classList.add('hidden');
            submitBtn.classList.add('hidden');
          }
        }

        function validateStep(step) {
          if (step === 1) {
            const date = document.getElementById('logDate').value;
            const author = document.getElementById('logAuthor').value;
            if (!date || !author) {
              alert('날짜와 작성자를 입력해주세요.');
              return false;
            }
          }
          if (step === 3) {
            if (selectedAreas.size === 0) {
              if (!confirm('선택된 청소 구역이 없습니다. 계속 진행하시겠습니까?')) return false;
            }
          }
          return true;
        }

        // ==================== STEP 2: TASKS ====================
        window.addTask = function () {
          const taskList = document.getElementById('taskList');
          const id = Date.now();

          const html = `
          <div class="task-item flex gap-2 items-center bg-gray-50 p-3 rounded border border-gray-200" id="task-${id}">
            <div class="flex-1 grid grid-cols-12 gap-2">
              <div class="col-span-3">
                <input type="time" class="task-time w-full p-2 border rounded text-sm" placeholder="시간">
              </div>
              <div class="col-span-8">
                <input type="text" class="task-desc w-full p-2 border rounded text-sm" placeholder="업무 내용 입력">
              </div>
              <div class="col-span-1 flex items-center justify-center">
                <input type="checkbox" class="task-check w-5 h-5 text-green-600 rounded">
              </div>
            </div>
            <button onclick="removeTask(${id})" class="text-red-400 hover:text-red-600 p-2">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
          taskList.insertAdjacentHTML('beforeend', html);
        };

        window.removeTask = function (id) {
          const el = document.getElementById(`task-${id}`);
          if (el) el.remove();
        };

        // ==================== STEP 3: AREAS ====================
        window.renderAreaGrid = function () {
          const grid = document.getElementById('areaGrid');
          grid.innerHTML = CLEANING_AREAS.map(
            (area) => `
          <button type="button" 
            class="area-btn p-4 rounded-lg border-2 text-center transition-all duration-200 hover:shadow-md ${selectedAreas.has(area) ? 'border-green-600 bg-green-50 text-green-700 font-bold' : 'border-gray-200 bg-white text-gray-600'}"
            onclick="toggleArea('${area}', this)"
          >
            ${area}
            ${selectedAreas.has(area) ? '<i class="fas fa-check-circle ml-2 text-green-600"></i>' : ''}
          </button>
        `,
          ).join('');
        };

        window.toggleArea = function (area, btn) {
          if (selectedAreas.has(area)) {
            selectedAreas.delete(area);
            btn.className =
              'area-btn p-4 rounded-lg border-2 text-center transition-all duration-200 hover:shadow-md border-gray-200 bg-white text-gray-600';
            btn.innerHTML = area;
          } else {
            selectedAreas.add(area);
            btn.className =
              'area-btn p-4 rounded-lg border-2 text-center transition-all duration-200 hover:shadow-md border-green-600 bg-green-50 text-green-700 font-bold';
            btn.innerHTML = `${area} <i class="fas fa-check-circle ml-2 text-green-600"></i>`;
          }
        };

        // ==================== STEP 4: PHOTOS ====================
        window.renderPhotoUploaders = function () {
          const list = document.getElementById('photoUploadList');
          list.innerHTML = '';

          if (selectedAreas.size === 0) {
            list.innerHTML = '<p class="text-center text-gray-500 py-10">선택된 청소 구역이 없습니다.</p>';
            return;
          }

          selectedAreas.forEach((area) => {
            if (!areaPhotos[area]) areaPhotos[area] = { before: null, after: null };

            const html = `
            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
              <h3 class="font-bold text-gray-800 mb-3 text-lg flex items-center">
                <i class="fas fa-map-marker-alt text-green-600 mr-2"></i> ${area}
              </h3>
              <div class="grid grid-cols-2 gap-4">
                <!-- Before Photo -->
                <div class="space-y-2">
                  <div class="text-xs font-bold text-gray-500 uppercase">Before (작업 전)</div>
                  <div class="relative w-full aspect-video bg-gray-200 rounded-lg overflow-hidden border border-dashed border-gray-400 flex items-center justify-center group cursor-pointer"
                       onclick="triggerFile('before', '${area}')">
                    ${
                      areaPhotos[area].before
                        ? `<img src="${areaPhotos[area].before}" class="w-full h-full object-cover">`
                        : `<div class="text-center text-gray-400 group-hover:text-gray-600">
                           <i class="fas fa-camera text-2xl mb-1"></i><br>
                           <span class="text-xs">사진 촬영/선택</span>
                         </div>`
                    }
                  </div>
                  <input type="file" id="file-before-${area}" class="hidden" accept="image/*" capture="environment" onchange="handleFileSelect(event, 'before', '${area}')">
                </div>

                <!-- After Photo -->
                <div class="space-y-2">
                  <div class="text-xs font-bold text-gray-500 uppercase">After (작업 후)</div>
                  <div class="relative w-full aspect-video bg-gray-200 rounded-lg overflow-hidden border border-dashed border-gray-400 flex items-center justify-center group cursor-pointer"
                       onclick="triggerFile('after', '${area}')">
                    ${
                      areaPhotos[area].after
                        ? `<img src="${areaPhotos[area].after}" class="w-full h-full object-cover">`
                        : `<div class="text-center text-gray-400 group-hover:text-gray-600">
                           <i class="fas fa-camera text-2xl mb-1"></i><br>
                           <span class="text-xs">사진 촬영/선택</span>
                         </div>`
                    }
                  </div>
                  <input type="file" id="file-after-${area}" class="hidden" accept="image/*" capture="environment" onchange="handleFileSelect(event, 'after', '${area}')">
                </div>
              </div>
            </div>
          `;
            list.insertAdjacentHTML('beforeend', html);
          });
        };

        window.triggerFile = function (type, area) {
          document.getElementById(`file-${type}-${area}`).click();
        };

        window.handleFileSelect = function (event, type, area) {
          const file = event.target.files[0];
          if (file) {
            // Preview immediately
            const reader = new FileReader();
            reader.onload = (e) => {
              // Update state with base64 for preview (will be replaced by URL on upload)
              // But we store file object to upload later
              if (!areaPhotos[area]) areaPhotos[area] = {};
              areaPhotos[area][`${type}File`] = file;
              areaPhotos[area][type] = e.target.result; // Preview URL
              renderPhotoUploaders(); // Re-render to show image
            };
            reader.readAsDataURL(file);
          }
        };

        // ==================== STEP 5: SUMMARY ====================
        function updateSummary() {
          document.getElementById('summaryDate').innerText = document.getElementById('logDate').value;
          document.getElementById('summaryAuthor').innerText = document.getElementById('logAuthor').value;
          document.getElementById('summaryTaskCount').innerText = document.querySelectorAll('.task-item').length;
          document.getElementById('summaryAreaCount').innerText = selectedAreas.size;
        }

        // ==================== SUBMISSION ====================
        window.submitLog = async function (actionType) {
          showLoading(true, '저장 중입니다...');
          try {
            console.log('[제출] 시작:', actionType);

            // 1. Upload Photos First
            const photoUploads = [];
            for (const area of selectedAreas) {
              const data = areaPhotos[area];
              if (data.beforeFile) {
                console.log('[사진 업로드 준비] Before:', area, data.beforeFile.name);
                photoUploads.push(uploadPhoto(data.beforeFile, area, 'before'));
              }
              if (data.afterFile) {
                console.log('[사진 업로드 준비] After:', area, data.afterFile.name);
                photoUploads.push(uploadPhoto(data.afterFile, area, 'after'));
              }
            }

            // Wait for all uploads
            console.log('[사진 업로드] 시작:', photoUploads.length, '개');
            await Promise.all(photoUploads);
            console.log('[사진 업로드] 완료');

            // 2. Prepare Data
            // Note: author_id is set to null temporarily. In production, use actual logged-in user ID

            const workLog = {
              date: document.getElementById('logDate').value,
              author_id: null, // Set to null to avoid foreign key constraint
              weather: null,
              temperature: null,
              special_notes: document.getElementById('specialNotes').value,
              status: actionType === 'submit' ? 'pending_team_leader' : 'draft',
              created_at: new Date().toISOString(),
            };
            console.log('[로그 데이터]:', workLog);

            // 3. Insert Work Log
            console.log('[DB 저장] work_logs 시작');
            const { data: logData, error: logError } = await supabase
              .from('work_logs')
              .insert(workLog)
              .select()
              .single();

            if (logError) {
              console.error('[DB 에러] work_logs:', logError);
              throw logError;
            }
            const logId = logData.id;
            console.log('[DB 저장] work_logs 완료, ID:', logId);

            // 4. Insert Tasks
            const tasks = [];
            document.querySelectorAll('.task-item').forEach((el, index) => {
              const time = el.querySelector('.task-time').value;
              const desc = el.querySelector('.task-desc').value;
              const checked = el.querySelector('.task-check').checked;
              if (time || desc) {
                tasks.push({
                  work_log_id: logId,
                  time_slot: time,
                  task_description: desc,
                  is_completed: checked,
                  order_index: index,
                });
              }
            });

            if (tasks.length > 0) {
              console.log('[DB 저장] work_log_tasks 시작:', tasks.length, '개');
              const { error: taskError } = await supabase.from('work_log_tasks').insert(tasks);
              if (taskError) {
                console.error('[DB 에러] work_log_tasks:', taskError);
                throw taskError;
              }
              console.log('[DB 저장] work_log_tasks 완료');
            }

            // 5. Insert Cleanings (using uploaded URLs)
            const cleanings = [];
            for (const area of selectedAreas) {
              cleanings.push({
                work_log_id: logId,
                area_name: area,
                before_photo_url: isRemoteUrl(areaPhotos[area].before) ? areaPhotos[area].before : null,
                after_photo_url: isRemoteUrl(areaPhotos[area].after) ? areaPhotos[area].after : null,
                notes: '',
              });
            }

            if (cleanings.length > 0) {
              console.log('[DB 저장] work_log_cleanings 시작:', cleanings.length, '개');
              const { error: cleaningError } = await supabase.from('work_log_cleanings').insert(cleanings);
              if (cleaningError) {
                console.error('[DB 에러] work_log_cleanings:', cleaningError);
                throw cleaningError;
              }
              console.log('[DB 저장] work_log_cleanings 완료');
            }

            console.log('[제출] 완료!');
            if (confirm('성공적으로 저장되었습니다!\n\n새로운 일지를 작성하시겠습니까?')) {
              window.location.reload(); // 페이지 새로고침으로 다시 작성
            } else {
              // 목록 페이지로 이동하지 않고 현재 페이지 유지
              alert('작성이 완료되었습니다.');
            }
          } catch (error) {
            console.error('❌ [제출 에러]:', error);
            alert(
              '저장 중 오류가 발생했습니다:\n\n' +
                error.message +
                '\n\n자세한 내용은 개발자 도구(F12)의 Console을 확인해주세요.',
            );
          } finally {
            showLoading(false);
          }
        };

        async function uploadPhoto(file, area, type) {
          if (!file) return;
          const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}_${type}.jpg`;
          const filePath = `temp/${fileName}`;

          console.log('[사진 업로드]:', area, type, fileName);

          const { data, error } = await supabase.storage.from(STORAGE_BUCKET).upload(filePath, file);

          if (error) {
            console.error(`❌ [사진 업로드 실패] ${area} ${type}:`, error);
            throw error;
          }

          const { data: publicUrlData } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(filePath);
          console.log('[사진 업로드 성공]:', publicUrlData.publicUrl);

          // Update state with real URL
          areaPhotos[area][type] = publicUrlData.publicUrl;
          return publicUrlData.publicUrl;
        }

        function isRemoteUrl(string) {
          return string && string.startsWith('http');
        }

        function showLoading(show, text = '처리중...') {
          const overlay = document.getElementById('loadingOverlay');
          const loadingText = document.getElementById('loadingText');
          if (loadingText) loadingText.innerText = text;
          if (show) overlay.classList.remove('hidden');
          else overlay.classList.add('hidden');
        }
      })();
    </script>
  </body>
</html>
