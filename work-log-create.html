<!DOCTYPE html>
<html lang="ko" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì—…ë¬´ ì¼ì§€ ì‘ì„±</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      .step-indicator.active {
        background-color: #16a34a; /* green-600 */
        color: white;
        border-color: #16a34a;
      }
      .step-indicator.completed {
        background-color: #16a34a;
        color: white;
        border-color: #16a34a;
      }
      .step-line.active {
        background-color: #16a34a;
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
        flex-direction: column;
        gap: 1rem;
      }
      .hidden-step {
        display: none;
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800 pb-24">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
      <i class="fas fa-spinner fa-spin fa-3x text-green-600"></i>
      <span id="loadingText" class="text-green-800 font-bold text-lg">ì²˜ë¦¬ì¤‘...</span>
    </div>

    <!-- Header -->
    <div class="bg-green-700 text-white p-4 shadow-lg sticky top-0 z-50">
      <div class="max-w-3xl mx-auto flex justify-between items-center">
        <h1 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-edit"></i> ì—…ë¬´ ì¼ì§€ ì‘ì„±</h1>
        <a href="work-log-list.html" class="text-green-100 hover:text-white text-sm">
          <i class="fas fa-times"></i> ë‹«ê¸°
        </a>
      </div>
    </div>

    <div class="max-w-3xl mx-auto p-4">
      <!-- Step Indicators -->
      <div class="flex items-center justify-between mb-8 px-2 relative">
        <div class="absolute top-1/2 left-0 w-full h-1 bg-gray-200 -z-10 transform -translate-y-1/2 rounded"></div>
        <div
          class="absolute top-1/2 left-0 h-1 bg-green-600 -z-10 transform -translate-y-1/2 rounded transition-all duration-300"
          id="progressBar"
          style="width: 0%"
        ></div>

        <!-- Steps -->
        <div class="step-item flex flex-col items-center gap-1 bg-gray-50 px-2">
          <div
            class="step-indicator w-8 h-8 rounded-full border-2 border-gray-300 flex items-center justify-center font-bold bg-white text-gray-400 transition-all active"
          >
            1
          </div>
          <span class="text-xs font-medium text-green-700">ê¸°ë³¸</span>
        </div>
        <div class="step-item flex flex-col items-center gap-1 bg-gray-50 px-2">
          <div
            class="step-indicator w-8 h-8 rounded-full border-2 border-gray-300 flex items-center justify-center font-bold bg-white text-gray-400 transition-all"
          >
            2
          </div>
          <span class="text-xs font-medium text-gray-500">ì¼ì •</span>
        </div>
        <div class="step-item flex flex-col items-center gap-1 bg-gray-50 px-2">
          <div
            class="step-indicator w-8 h-8 rounded-full border-2 border-gray-300 flex items-center justify-center font-bold bg-white text-gray-400 transition-all"
          >
            3
          </div>
          <span class="text-xs font-medium text-gray-500">êµ¬ì—­</span>
        </div>
        <div class="step-item flex flex-col items-center gap-1 bg-gray-50 px-2">
          <div
            class="step-indicator w-8 h-8 rounded-full border-2 border-gray-300 flex items-center justify-center font-bold bg-white text-gray-400 transition-all"
          >
            4
          </div>
          <span class="text-xs font-medium text-gray-500">ì‚¬ì§„</span>
        </div>
        <div class="step-item flex flex-col items-center gap-1 bg-gray-50 px-2">
          <div
            class="step-indicator w-8 h-8 rounded-full border-2 border-gray-300 flex items-center justify-center font-bold bg-white text-gray-400 transition-all"
          >
            5
          </div>
          <span class="text-xs font-medium text-gray-500">ì™„ë£Œ</span>
        </div>
      </div>

      <!-- Main Form Container -->
      <form id="workLogForm" onsubmit="return false;">
        <!-- STEP 1: Basic Information -->
        <div id="step1" class="step-content">
          <div class="bg-white rounded-lg shadow p-6 space-y-6 animate-fade-in">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-2">ê¸°ë³¸ ì •ë³´ ì…ë ¥</h2>

            <div>
              <label class="block text-gray-700 font-bold mb-2">ë‚ ì§œ <span class="text-red-500">*</span></label>
              <input
                type="date"
                id="logDate"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                required
              />
            </div>

            <div>
              <label class="block text-gray-700 font-bold mb-2">ì‘ì„±ì <span class="text-red-500">*</span></label>
              <select
                id="logAuthor"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
              >
                <option value="ì„¼í„°ì¥">ì„¼í„°ì¥</option>
                <option value="ë¶€ì„¼í„°ì¥">ë¶€ì„¼í„°ì¥</option>
                <option value="ê´€ë¦¬íŒ€ì¥">ê´€ë¦¬íŒ€ì¥</option>
                <option value="ê´€ë¦¬ì†Œì¥">ê´€ë¦¬ì†Œì¥</option>
              </select>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-gray-700 font-bold mb-2">ë‚ ì”¨</label>
                <select
                  id="logWeather"
                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                >
                  <option value="ë§‘ìŒ">â˜€ï¸ ë§‘ìŒ</option>
                  <option value="êµ¬ë¦„ì¡°ê¸ˆ">â›… êµ¬ë¦„ì¡°ê¸ˆ</option>
                  <option value="íë¦¼">â˜ï¸ íë¦¼</option>
                  <option value="ë¹„">ğŸŒ§ï¸ ë¹„</option>
                  <option value="ëˆˆ">â„ï¸ ëˆˆ</option>
                </select>
              </div>
              <div>
                <label class="block text-gray-700 font-bold mb-2">ì˜¨ë„ (Â°C)</label>
                <input
                  type="text"
                  id="logTemp"
                  placeholder="ì˜ˆ: 24"
                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                />
              </div>
            </div>
          </div>
        </div>

        <!-- STEP 2: Time Table -->
        <div id="step2" class="step-content hidden-step">
          <div class="bg-white rounded-lg shadow p-6 space-y-4">
            <div class="flex justify-between items-center border-b pb-2">
              <h2 class="text-xl font-bold text-gray-800">íƒ€ì„í…Œì´ë¸” ì—…ë¬´</h2>
              <button
                type="button"
                onclick="addTask()"
                class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-bold hover:bg-green-200"
              >
                <i class="fas fa-plus"></i> ì¶”ê°€
              </button>
            </div>

            <div id="taskList" class="space-y-3">
              <!-- Tasks will be added here dynamically -->
            </div>

            <div class="text-center pt-4">
              <button type="button" onclick="addTask()" class="text-green-600 font-bold hover:underline">
                <i class="fas fa-plus-circle"></i> ì—…ë¬´ í•­ëª© ì¶”ê°€í•˜ê¸°
              </button>
            </div>
          </div>
        </div>

        <!-- STEP 3: Cleaning Areas -->
        <div id="step3" class="step-content hidden-step">
          <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">ì²­ì†Œ ë° ì ê²€ êµ¬ì—­ ì„ íƒ</h2>
            <p class="text-sm text-gray-500 mb-4">ì˜¤ëŠ˜ ì ê²€í•˜ê±°ë‚˜ ì²­ì†Œí•œ êµ¬ì—­ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.</p>

            <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="areaGrid">
              <!-- Areas generated by JS -->
            </div>
          </div>
        </div>

        <!-- STEP 4: Photos -->
        <div id="step4" class="step-content hidden-step">
          <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">ì‚¬ì§„ ì—…ë¡œë“œ</h2>
            <p class="text-sm text-gray-500 mb-6">ì„ íƒí•œ êµ¬ì—­ì˜ ì „/í›„ ì‚¬ì§„ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.</p>

            <div id="photoUploadList" class="space-y-8">
              <!-- Photo uploaders generated by JS -->
            </div>
          </div>
        </div>

        <!-- STEP 5: Special Notes & Review -->
        <div id="step5" class="step-content hidden-step">
          <div class="bg-white rounded-lg shadow p-6 space-y-6">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-2">ìµœì¢… í™•ì¸ ë° íŠ¹ì´ì‚¬í•­</h2>

            <div>
              <label class="block text-gray-700 font-bold mb-2">íŠ¹ì´ì‚¬í•­ / ë¹„ê³ </label>
              <textarea
                id="specialNotes"
                rows="5"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                placeholder="ì˜¤ëŠ˜ ì—…ë¬´ ì¤‘ íŠ¹ì´ì‚¬í•­ì´ë‚˜ ì „ë‹¬ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”."
              ></textarea>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
              <h3 class="font-bold text-gray-700 mb-2">ì‘ì„± ë‚´ìš© ìš”ì•½</h3>
              <ul class="text-sm text-gray-600 space-y-1">
                <li>â€¢ ë‚ ì§œ: <span id="summaryDate" class="font-bold"></span></li>
                <li>â€¢ ì‘ì„±ì: <span id="summaryAuthor" class="font-bold"></span></li>
                <li>â€¢ ì—…ë¬´ í•­ëª©: <span id="summaryTaskCount" class="font-bold">0</span>ê°œ</li>
                <li>â€¢ ì²­ì†Œ êµ¬ì—­: <span id="summaryAreaCount" class="font-bold">0</span>ê³³</li>
              </ul>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Navigation Buttons -->
    <div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-4 shadow-lg z-40">
      <div class="max-w-3xl mx-auto flex justify-between gap-3">
        <button
          type="button"
          id="prevBtn"
          onclick="prevStep()"
          class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-bold hidden"
        >
          ì´ì „
        </button>

        <div class="flex-1 flex justify-end gap-2">
          <button
            type="button"
            id="saveDraftBtn"
            onclick="submitLog('draft')"
            class="px-4 py-3 bg-yellow-100 text-yellow-800 rounded-lg font-bold hidden"
          >
            ì„ì‹œì €ì¥
          </button>

          <button
            type="button"
            id="nextBtn"
            onclick="nextStep()"
            class="px-8 py-3 bg-green-600 text-white rounded-lg font-bold shadow-md hover:bg-green-700 flex-1 md:flex-none text-center"
          >
            ë‹¤ìŒ ë‹¨ê³„ <i class="fas fa-arrow-right ml-2"></i>
          </button>

          <button
            type="button"
            id="submitBtn"
            onclick="submitLog('submit')"
            class="px-8 py-3 bg-green-600 text-white rounded-lg font-bold shadow-md hover:bg-green-700 hidden flex-1 md:flex-none"
          >
            ì œì¶œí•˜ê¸° <i class="fas fa-check ml-2"></i>
          </button>
        </div>
      </div>
    </div>

    <script>
      // ==================== CONFIGURATION ====================
      const SUPABASE_URL = 'https://qgpqhtuynxhmgawakjxe.supabase.co';
      const SUPABASE_ANON_KEY = 'sb_publishable_ujXj0mLf1casiQdVkc0fCA_G6exymqG';
      const STORAGE_BUCKET = 'work-log-photos';
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // ==================== STATE ====================
      let currentStep = 1;
      const totalSteps = 5;

      const CLEANING_AREAS = [
        'ê³¨í”„ì¥',
        'ìˆ˜ì˜ì¥',
        'ë‚¨ì ì‚¬ìš°ë‚˜',
        'ì—¬ì ì‚¬ìš°ë‚˜',
        'ì¹´í˜í…Œë¦¬ì•„',
        'í—¬ìŠ¤ì¥',
        'ë‹¤ëª©ì  ì²´ìœ¡ê´€',
        'ê²ŒìŠ¤íŠ¸í•˜ìš°ìŠ¤',
        'í™”ì¥ì‹¤',
        'ê¸°íƒ€ êµ¬ì—­',
      ];

      // Form Data State
      let selectedAreas = new Set();
      let areaPhotos = {}; // { 'ê³¨í”„ì¥': { before: url, after: url, beforeFile: file, afterFile: file } }

      // ==================== INITIALIZATION ====================
      window.onload = function () {
        // Set default date to today
        document.getElementById('logDate').value = new Date().toISOString().split('T')[0];

        // Initialize Task List with one empty task
        addTask();

        // Initialize Cleaning Areas Grid
        renderAreaGrid();

        updateUI();
      };

      // ==================== NAVIGATION ====================
      function nextStep() {
        if (!validateStep(currentStep)) return;

        if (currentStep < totalSteps) {
          currentStep++;
          updateUI();
          window.scrollTo(0, 0);

          // Generate photo uploaders if entering step 4
          if (currentStep === 4) {
            renderPhotoUploaders();
          }
          // Update summary if entering step 5
          if (currentStep === 5) {
            updateSummary();
          }
        }
      }

      function prevStep() {
        if (currentStep > 1) {
          currentStep--;
          updateUI();
          window.scrollTo(0, 0);
        }
      }

      function updateUI() {
        // 1. Show/Hide Steps
        document.querySelectorAll('.step-content').forEach((el, index) => {
          if (index + 1 === currentStep) {
            el.classList.remove('hidden-step');
          } else {
            el.classList.add('hidden-step');
          }
        });

        // 2. Update Progress Indicator
        const progressPercentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
        document.getElementById('progressBar').style.width = `${progressPercentage}%`;

        document.querySelectorAll('.step-indicator').forEach((el, index) => {
          const stepNum = index + 1;
          el.classList.remove('active', 'completed', 'bg-green-600', 'text-white', 'border-green-600');
          el.classList.add('bg-white', 'text-gray-400', 'border-gray-300');

          if (stepNum < currentStep) {
            el.classList.add('completed', 'bg-green-600', 'text-white', 'border-green-600');
            el.innerHTML = '<i class="fas fa-check"></i>';
          } else if (stepNum === currentStep) {
            el.classList.add('active', 'bg-green-600', 'text-white', 'border-green-600');
            el.innerHTML = stepNum;
          } else {
            el.innerHTML = stepNum;
          }
        });

        // 3. Update Buttons
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const saveDraftBtn = document.getElementById('saveDraftBtn');
        const submitBtn = document.getElementById('submitBtn');

        // Prev Button
        if (currentStep === 1) prevBtn.classList.add('hidden');
        else prevBtn.classList.remove('hidden');

        // Next/Submit Buttons
        if (currentStep === totalSteps) {
          nextBtn.classList.add('hidden');
          saveDraftBtn.classList.remove('hidden');
          submitBtn.classList.remove('hidden');
        } else {
          nextBtn.classList.remove('hidden');
          saveDraftBtn.classList.add('hidden');
          submitBtn.classList.add('hidden');
        }
      }

      function validateStep(step) {
        if (step === 1) {
          const date = document.getElementById('logDate').value;
          const author = document.getElementById('logAuthor').value;
          if (!date || !author) {
            alert('ë‚ ì§œì™€ ì‘ì„±ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return false;
          }
        }
        if (step === 3) {
          if (selectedAreas.size === 0) {
            if (!confirm('ì„ íƒëœ ì²­ì†Œ êµ¬ì—­ì´ ì—†ìŠµë‹ˆë‹¤. ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return false;
          }
        }
        return true;
      }

      // ==================== STEP 2: TASKS ====================
      function addTask() {
        const taskList = document.getElementById('taskList');
        const id = Date.now();

        const html = `
          <div class="task-item flex gap-2 items-center bg-gray-50 p-3 rounded border border-gray-200" id="task-${id}">
            <div class="flex-1 grid grid-cols-12 gap-2">
              <div class="col-span-3">
                <input type="time" class="task-time w-full p-2 border rounded text-sm" placeholder="ì‹œê°„">
              </div>
              <div class="col-span-8">
                <input type="text" class="task-desc w-full p-2 border rounded text-sm" placeholder="ì—…ë¬´ ë‚´ìš© ì…ë ¥">
              </div>
              <div class="col-span-1 flex items-center justify-center">
                <input type="checkbox" class="task-check w-5 h-5 text-green-600 rounded">
              </div>
            </div>
            <button onclick="removeTask(${id})" class="text-red-400 hover:text-red-600 p-2">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        taskList.insertAdjacentHTML('beforeend', html);
      }

      function removeTask(id) {
        const el = document.getElementById(`task-${id}`);
        if (el) el.remove();
      }

      // ==================== STEP 3: AREAS ====================
      function renderAreaGrid() {
        const grid = document.getElementById('areaGrid');
        grid.innerHTML = CLEANING_AREAS.map(
          (area) => `
          <button type="button" 
            class="area-btn p-4 rounded-lg border-2 text-center transition-all duration-200 hover:shadow-md ${selectedAreas.has(area) ? 'border-green-600 bg-green-50 text-green-700 font-bold' : 'border-gray-200 bg-white text-gray-600'}"
            onclick="toggleArea('${area}', this)"
          >
            ${area}
            ${selectedAreas.has(area) ? '<i class="fas fa-check-circle ml-2 text-green-600"></i>' : ''}
          </button>
        `,
        ).join('');
      }

      function toggleArea(area, btn) {
        if (selectedAreas.has(area)) {
          selectedAreas.delete(area);
          btn.className =
            'area-btn p-4 rounded-lg border-2 text-center transition-all duration-200 hover:shadow-md border-gray-200 bg-white text-gray-600';
          btn.innerHTML = area;
        } else {
          selectedAreas.add(area);
          btn.className =
            'area-btn p-4 rounded-lg border-2 text-center transition-all duration-200 hover:shadow-md border-green-600 bg-green-50 text-green-700 font-bold';
          btn.innerHTML = `${area} <i class="fas fa-check-circle ml-2 text-green-600"></i>`;
        }
      }

      // ==================== STEP 4: PHOTOS ====================
      function renderPhotoUploaders() {
        const list = document.getElementById('photoUploadList');
        list.innerHTML = '';

        if (selectedAreas.size === 0) {
          list.innerHTML = '<p class="text-center text-gray-500 py-10">ì„ íƒëœ ì²­ì†Œ êµ¬ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        selectedAreas.forEach((area) => {
          if (!areaPhotos[area]) areaPhotos[area] = { before: null, after: null };

          const html = `
            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
              <h3 class="font-bold text-gray-800 mb-3 text-lg flex items-center">
                <i class="fas fa-map-marker-alt text-green-600 mr-2"></i> ${area}
              </h3>
              <div class="grid grid-cols-2 gap-4">
                <!-- Before Photo -->
                <div class="space-y-2">
                  <div class="text-xs font-bold text-gray-500 uppercase">Before (ì‘ì—… ì „)</div>
                  <div class="relative w-full aspect-video bg-gray-200 rounded-lg overflow-hidden border border-dashed border-gray-400 flex items-center justify-center group cursor-pointer"
                       onclick="triggerFile('before', '${area}')">
                    ${
                      areaPhotos[area].before
                        ? `<img src="${areaPhotos[area].before}" class="w-full h-full object-cover">`
                        : `<div class="text-center text-gray-400 group-hover:text-gray-600">
                           <i class="fas fa-camera text-2xl mb-1"></i><br>
                           <span class="text-xs">ì‚¬ì§„ ì´¬ì˜/ì„ íƒ</span>
                         </div>`
                    }
                  </div>
                  <input type="file" id="file-before-${area}" class="hidden" accept="image/*" capture="environment" onchange="handleFileSelect(event, 'before', '${area}')">
                </div>

                <!-- After Photo -->
                <div class="space-y-2">
                  <div class="text-xs font-bold text-gray-500 uppercase">After (ì‘ì—… í›„)</div>
                  <div class="relative w-full aspect-video bg-gray-200 rounded-lg overflow-hidden border border-dashed border-gray-400 flex items-center justify-center group cursor-pointer"
                       onclick="triggerFile('after', '${area}')">
                    ${
                      areaPhotos[area].after
                        ? `<img src="${areaPhotos[area].after}" class="w-full h-full object-cover">`
                        : `<div class="text-center text-gray-400 group-hover:text-gray-600">
                           <i class="fas fa-camera text-2xl mb-1"></i><br>
                           <span class="text-xs">ì‚¬ì§„ ì´¬ì˜/ì„ íƒ</span>
                         </div>`
                    }
                  </div>
                  <input type="file" id="file-after-${area}" class="hidden" accept="image/*" capture="environment" onchange="handleFileSelect(event, 'after', '${area}')">
                </div>
              </div>
            </div>
          `;
          list.insertAdjacentHTML('beforeend', html);
        });
      }

      function triggerFile(type, area) {
        document.getElementById(`file-${type}-${area}`).click();
      }

      function handleFileSelect(event, type, area) {
        const file = event.target.files[0];
        if (file) {
          // Preview immediately
          const reader = new FileReader();
          reader.onload = (e) => {
            // Update state with base64 for preview (will be replaced by URL on upload)
            // But we store file object to upload later
            if (!areaPhotos[area]) areaPhotos[area] = {};
            areaPhotos[area][`${type}File`] = file;
            areaPhotos[area][type] = e.target.result; // Preview URL
            renderPhotoUploaders(); // Re-render to show image
          };
          reader.readAsDataURL(file);
        }
      }

      // ==================== STEP 5: SUMMARY ====================
      function updateSummary() {
        document.getElementById('summaryDate').innerText = document.getElementById('logDate').value;
        document.getElementById('summaryAuthor').innerText = document.getElementById('logAuthor').value;
        document.getElementById('summaryTaskCount').innerText = document.querySelectorAll('.task-item').length;
        document.getElementById('summaryAreaCount').innerText = selectedAreas.size;
      }

      // ==================== SUBMISSION ====================
      async function submitLog(actionType) {
        showLoading(true);
        try {
          // 1. Upload Photos First
          const photoUploads = [];
          for (const area of selectedAreas) {
            const data = areaPhotos[area];
            if (data.beforeFile) photoUploads.push(uploadPhoto(data.beforeFile, area, 'before'));
            if (data.afterFile) photoUploads.push(uploadPhoto(data.afterFile, area, 'after'));
          }

          // Wait for all uploads
          await Promise.all(photoUploads);

          // 2. Prepare Data
          const workLog = {
            date: document.getElementById('logDate').value,
            author_id: 'temp-user-id', // Assuming auth is handled elsewhere or mock
            weather: document.getElementById('logWeather').value,
            temperature: document.getElementById('logTemp').value,
            special_notes: document.getElementById('specialNotes').value,
            status: actionType === 'submit' ? 'pending_team_leader' : 'draft',
            created_at: new Date().toISOString(),
          };

          // 3. Insert Work Log
          const { data: logData, error: logError } = await supabase.from('work_logs').insert(workLog).select().single();

          if (logError) throw logError;
          const logId = logData.id;

          // 4. Insert Tasks
          const tasks = [];
          document.querySelectorAll('.task-item').forEach((el, index) => {
            const time = el.querySelector('.task-time').value;
            const desc = el.querySelector('.task-desc').value;
            const checked = el.querySelector('.task-check').checked;
            if (time || desc) {
              tasks.push({
                work_log_id: logId,
                time_slot: time,
                task_description: desc,
                is_completed: checked,
                order_index: index,
              });
            }
          });

          if (tasks.length > 0) {
            const { error: taskError } = await supabase.from('work_log_tasks').insert(tasks);
            if (taskError) throw taskError;
          }

          // 5. Insert Cleanings (using uploaded URLs)
          const cleanings = [];
          for (const area of selectedAreas) {
            // Get URLs from state (updated by uploadPhoto function)
            // Note: In a real app, uploadPhoto should return the URL and we map it here.
            // But for simplicity, we rely on the state being updated or we need to track it better.
            // Since uploadPhoto updates areaPhotos[area][type] with the public URL, we use that.
            // Wait, handleFileSelect set it to base64 preview. We need to ensure it's the URL.
            // Let's modify logic slightly: uploadPhoto should update the state to the remote URL.

            cleanings.push({
              work_log_id: logId,
              area_name: area,
              before_photo_url: isRemoteUrl(areaPhotos[area].before) ? areaPhotos[area].before : null,
              after_photo_url: isRemoteUrl(areaPhotos[area].after) ? areaPhotos[area].after : null,
              notes: '',
            });
          }

          if (cleanings.length > 0) {
            const { error: cleaningError } = await supabase.from('work_log_cleanings').insert(cleanings);
            if (cleaningError) throw cleaningError;
          }

          alert('ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
          window.location.href = 'work-log-list.html';
        } catch (error) {
          console.error('Submission Error:', error);
          alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        } finally {
          showLoading(false);
        }
      }

      async function uploadPhoto(file, area, type) {
        if (!file) return;
        const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}_${type}.jpg`;
        const filePath = `temp/${fileName}`;

        const { data, error } = await supabase.storage.from(STORAGE_BUCKET).upload(filePath, file);

        if (error) {
          console.error(`Upload failed for ${area} ${type}`, error);
          throw error;
        }

        const { data: publicUrlData } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(filePath);

        // Update state with real URL
        areaPhotos[area][type] = publicUrlData.publicUrl;
        return publicUrlData.publicUrl;
      }

      function isRemoteUrl(string) {
        return string && string.startsWith('http');
      }

      function showLoading(show) {
        const overlay = document.getElementById('loadingOverlay');
        if (show) overlay.classList.remove('hidden');
        else overlay.classList.add('hidden');
      }
    </script>
  </body>
</html>
