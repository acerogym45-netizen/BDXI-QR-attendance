<!DOCTYPE html>
<html lang="ko" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KINDWON Admin Dashboard</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap"
      rel="stylesheet"
    />

    <!-- CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      body {
        font-family: 'Noto Sans KR', sans-serif;
      }
      .bg-gradient-brand {
        background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
      }
      .text-brand {
        color: #1b5e3e;
      }
      .bg-brand {
        background-color: #1b5e3e;
      }
      .tab-active {
        border-bottom: 3px solid #1b5e3e;
        color: #1b5e3e;
        font-weight: 700;
      }
      .tab-inactive {
        border-bottom: 3px solid transparent;
        color: #6b7280;
      }
      .loader {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #1b5e3e;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      /* Smooth transitions */
      * {
        transition:
          color 0.2s ease,
          background-color 0.2s ease;
      }

      /* Modal */
      .modal-backdrop {
        backdrop-filter: blur(8px);
        animation: fadeIn 0.2s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* Dropdown */
      .dropdown-item:hover {
        background-color: #f3f4f6;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- LOGIN VIEW -->
    <div id="view-login" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-brand hidden">
      <div
        class="bg-white p-10 rounded-2xl shadow-2xl w-full max-w-md text-center transform transition-all hover:scale-[1.01]"
      >
        <div class="mb-10">
          <img src="https://www.genspark.ai/api/files/s/UmgxPvd3" alt="KINDWON Logo" class="h-16 mx-auto" />
        </div>

        <h1 class="text-3xl font-extrabold text-gray-800 mb-2">ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
        <p class="text-gray-500 mb-2 text-sm">KINDWON ì§ì› ì—…ë¬´ ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
        <p class="text-gray-400 mb-8 text-xs">ğŸ”’ ë³´ì•ˆ ì ‘ì†ì„ ìœ„í•´ PIN ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>

        <div class="space-y-4">
          <input
            type="password"
            id="inp-pin"
            placeholder="PIN ë²ˆí˜¸ ì…ë ¥"
            class="w-full text-center text-2xl font-bold tracking-[0.3em] py-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-green-600 transition-colors"
            maxlength="10"
            onkeypress="if (event.key === 'Enter') app.login();"
          />

          <button
            onclick="app.login()"
            class="w-full bg-brand hover:bg-green-800 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95"
          >
            ì…ì¥í•˜ê¸°
          </button>
        </div>
        <p id="msg-error" class="text-red-500 mt-4 text-sm font-bold hidden">
          <i class="fas fa-exclamation-circle"></i> PIN ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </p>
      </div>
    </div>

    <!-- DASHBOARD VIEW -->
    <div id="view-dashboard" class="min-h-screen flex flex-col hidden">
      <!-- Header -->
      <header class="bg-white border-b sticky top-0 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
          <div class="flex items-center gap-4">
            <img src="https://www.genspark.ai/api/files/s/UmgxPvd3" alt="Logo" class="h-10" />
            <span class="text-gray-300">|</span>
            <div>
              <div class="font-bold text-gray-800 text-lg">KINDWON</div>
              <div class="text-xs text-gray-400 -mt-1">ê´€ë¦¬ì ì‹œìŠ¤í…œ</div>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div
              class="hidden md:flex items-center gap-2 text-sm text-gray-500 bg-gray-50 px-3 py-1.5 rounded-lg border"
            >
              <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
              <span id="live-time" class="font-mono">00:00:00</span>
            </div>
            <button
              onclick="app.logout()"
              class="text-gray-500 hover:text-red-600 px-3 py-2 rounded-lg hover:bg-red-50 transition"
            >
              <i class="fas fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ
            </button>
          </div>
        </div>
      </header>

      <!-- Navigation -->
      <nav class="bg-white border-b shadow-sm sticky top-16 z-30">
        <div class="max-w-7xl mx-auto px-4">
          <div class="flex space-x-8">
            <button
              onclick="app.switchTab('gallery')"
              class="nav-tab tab-active py-4 px-2 text-sm font-medium transition-colors flex items-center gap-2"
            >
              <i class="fas fa-images text-lg"></i> ì²­ì†Œ ê°¤ëŸ¬ë¦¬
            </button>
            <button
              onclick="app.switchTab('history')"
              class="nav-tab tab-inactive py-4 px-2 text-sm font-medium transition-colors flex items-center gap-2"
            >
              <i class="fas fa-list-alt text-lg"></i> ìƒì„¸ ì¡°íšŒ
            </button>
            <button
              onclick="app.switchTab('stats')"
              class="nav-tab tab-inactive py-4 px-2 text-sm font-medium transition-colors flex items-center gap-2"
            >
              <i class="fas fa-chart-pie text-lg"></i> í†µê³„ ìš”ì•½
            </button>
            <button
              onclick="app.switchTab('data')"
              class="nav-tab tab-inactive py-4 px-2 text-sm font-medium transition-colors flex items-center gap-2"
            >
              <i class="fas fa-database text-lg"></i> ë°ì´í„° ê´€ë¦¬
            </button>
          </div>
        </div>
      </nav>

      <!-- Content Area -->
      <main class="flex-1 bg-gray-50 p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
          <!-- TAB 1: Gallery -->
          <div id="tab-gallery" class="tab-content space-y-6">
            <!-- Filters -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-wrap gap-4 items-center">
              <div class="flex items-center gap-2">
                <i class="fas fa-calendar text-gray-400"></i>
                <input
                  type="date"
                  id="filter-date"
                  class="border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none"
                />
              </div>

              <div class="flex items-center gap-2 relative dropdown-container">
                <i class="fas fa-user text-gray-400"></i>
                <input
                  type="text"
                  id="filter-employee-input"
                  placeholder="ì§ì› ì´ë¦„ ê²€ìƒ‰"
                  class="border rounded-lg px-3 py-2 text-sm w-40 focus:ring-2 focus:ring-green-500 outline-none"
                />
                <div
                  id="filter-employee-dropdown"
                  class="dropdown-list absolute top-full left-8 w-40 bg-white border rounded-lg shadow-lg mt-1 max-h-48 overflow-y-auto hidden z-20"
                ></div>
              </div>

              <div class="flex items-center gap-2">
                <i class="fas fa-map-marker-alt text-gray-400"></i>
                <select
                  id="filter-location"
                  class="border rounded-lg px-3 py-2 text-sm w-32 focus:ring-2 focus:ring-green-500 outline-none"
                >
                  <option value="ì „ì²´">ì „ì²´ ìœ„ì¹˜</option>
                </select>
              </div>

              <button
                onclick="app.applyGalleryFilters()"
                class="bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-lg text-sm transition shadow-md ml-auto"
              >
                <i class="fas fa-search mr-2"></i>ê²€ìƒ‰
              </button>
              <button
                onclick="app.resetGalleryFilters()"
                class="text-gray-500 hover:text-gray-700 px-3 py-2 text-sm border rounded-lg hover:bg-gray-50 transition"
              >
                ì´ˆê¸°í™”
              </button>
            </div>

            <!-- Gallery Grid -->
            <div class="flex justify-between items-center">
              <h2 class="text-xl font-bold text-gray-800">
                ğŸ“¸ ì²­ì†Œ ì‘ì—… ê°¤ëŸ¬ë¦¬
                <span id="gallery-count" class="text-sm text-gray-500 font-normal"></span>
              </h2>
              <button
                onclick="app.loadGallery()"
                class="text-sm bg-white border px-3 py-1 rounded shadow-sm hover:bg-gray-50"
              >
                <i class="fas fa-sync-alt mr-1"></i>ìƒˆë¡œê³ ì¹¨
              </button>
            </div>

            <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
              <!-- Items injected by JS -->
            </div>
          </div>

          <!-- TAB 2: History -->
          <div id="tab-history" class="tab-content hidden space-y-6">
            <!-- Filters -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 grid grid-cols-1 md:grid-cols-4 gap-4">
              <div class="space-y-1">
                <label class="text-xs text-gray-500 font-bold">ì‹œì‘ì¼</label>
                <input type="date" id="hist-start" class="w-full border rounded-lg px-3 py-2 text-sm" />
              </div>
              <div class="space-y-1">
                <label class="text-xs text-gray-500 font-bold">ì¢…ë£Œì¼</label>
                <input type="date" id="hist-end" class="w-full border rounded-lg px-3 py-2 text-sm" />
              </div>
              <div class="space-y-1 relative dropdown-container">
                <label class="text-xs text-gray-500 font-bold">ì§ì›</label>
                <input
                  type="text"
                  id="hist-employee-input"
                  placeholder="ì´ë¦„ ê²€ìƒ‰"
                  class="w-full border rounded-lg px-3 py-2 text-sm"
                />
                <div
                  id="hist-employee-dropdown"
                  class="dropdown-list absolute top-full left-0 w-full bg-white border rounded-lg shadow-lg mt-1 max-h-48 overflow-y-auto hidden z-20"
                ></div>
              </div>
              <div class="space-y-1">
                <label class="text-xs text-gray-500 font-bold">ê·¼íƒœ ìœ í˜•</label>
                <div class="flex gap-2">
                  <select id="hist-type" class="flex-1 border rounded-lg px-3 py-2 text-sm">
                    <option value="">ì „ì²´</option>
                    <option value="ì¶œê·¼">ì¶œê·¼</option>
                    <option value="í‡´ê·¼">í‡´ê·¼</option>
                    <option value="íœ´ê²Œ ì‹œì‘">íœ´ê²Œ ì‹œì‘</option>
                    <option value="íœ´ê²Œ ì¢…ë£Œ">íœ´ê²Œ ì¢…ë£Œ</option>
                  </select>
                  <button
                    onclick="app.applyHistoryFilters()"
                    class="bg-brand text-white px-4 rounded-lg text-sm hover:bg-green-800"
                  >
                    ì¡°íšŒ
                  </button>
                </div>
              </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                  <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                    <tr>
                      <th class="px-6 py-3">ì‹œê°„</th>
                      <th class="px-6 py-3">ì§ì›</th>
                      <th class="px-6 py-3">ìœ„ì¹˜</th>
                      <th class="px-6 py-3">ìœ í˜•</th>
                    </tr>
                  </thead>
                  <tbody id="history-list" class="divide-y divide-gray-100">
                    <!-- JS Injected -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- TAB 3: Stats -->
          <div id="tab-stats" class="tab-content hidden space-y-8">
            <!-- Period Selector -->
            <div class="flex items-center justify-between">
              <h2 class="text-xl font-bold text-gray-800">ğŸ“Š í†µê³„ ëŒ€ì‹œë³´ë“œ</h2>
              <div class="flex items-center gap-2">
                <select
                  id="stats-period"
                  onchange="app.changePeriod()"
                  class="border rounded-lg px-3 py-2 text-sm shadow-sm"
                >
                  <option value="today">ì˜¤ëŠ˜</option>
                  <option value="week" selected>ìµœê·¼ 7ì¼</option>
                  <option value="month">ì´ë²ˆ ë‹¬</option>
                  <option value="custom">ì§ì ‘ ì„ íƒ</option>
                </select>

                <div id="custom-range" class="hidden flex items-center gap-2 bg-white p-1 rounded-lg border shadow-sm">
                  <input type="date" id="custom-start" class="text-sm border-none focus:ring-0" />
                  <span class="text-gray-400">~</span>
                  <input type="date" id="custom-end" class="text-sm border-none focus:ring-0" />
                  <button onclick="app.loadStats()" class="bg-gray-800 text-white text-xs px-2 py-1 rounded">
                    ì ìš©
                  </button>
                </div>
              </div>
            </div>

            <!-- KPI Cards -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
              <!-- Total Employees -->
              <div
                class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-gray-500 relative overflow-hidden group hover:shadow-md transition"
              >
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-xs text-gray-500 font-bold uppercase mb-1">ì´ì›</p>
                    <h3 class="text-2xl font-bold text-gray-800" id="stat-total">-</h3>
                    <p class="text-xs text-gray-400 mt-1">ëª… (ì „ì²´ ì§ì›)</p>
                  </div>
                  <div class="bg-gray-100 p-2 rounded-lg text-gray-600">
                    <i class="fas fa-users"></i>
                  </div>
                </div>
              </div>

              <!-- Absent -->
              <div
                class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-red-500 relative overflow-hidden group hover:shadow-md transition"
              >
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-xs text-gray-500 font-bold uppercase mb-1">íœ´ê°€/ê²°ê·¼</p>
                    <h3 class="text-2xl font-bold text-gray-800" id="stat-absent">-</h3>
                    <p class="text-xs text-gray-400 mt-1">ëª… (ë¯¸ì¶œê·¼)</p>
                  </div>
                  <div class="bg-red-50 p-2 rounded-lg text-red-600">
                    <i class="fas fa-umbrella-beach"></i>
                  </div>
                </div>
              </div>

              <!-- Present -->
              <div
                class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-blue-500 relative overflow-hidden group hover:shadow-md transition"
              >
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-xs text-gray-500 font-bold uppercase mb-1">í˜„ì¬ì›</p>
                    <h3 class="text-2xl font-bold text-gray-800" id="stat-present">-</h3>
                    <p class="text-xs text-gray-400 mt-1">ëª… (ì¶œê·¼ ì™„ë£Œ)</p>
                  </div>
                  <div class="bg-blue-50 p-2 rounded-lg text-blue-600">
                    <i class="fas fa-check-circle"></i>
                  </div>
                </div>
              </div>

              <!-- Cleaning Tasks -->
              <div
                class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-green-500 relative overflow-hidden group hover:shadow-md transition"
              >
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-xs text-gray-500 font-bold uppercase mb-1">ì²­ì†Œ ì‘ì—…</p>
                    <h3 class="text-2xl font-bold text-gray-800" id="stat-cleaning">-</h3>
                    <p class="text-xs text-gray-400 mt-1">ê±´ (ê°¤ëŸ¬ë¦¬ ì—…ë¡œë“œ)</p>
                  </div>
                  <div class="bg-green-50 p-2 rounded-lg text-green-600">
                    <i class="fas fa-broom"></i>
                  </div>
                </div>
              </div>

              <!-- Avg Hours -->
              <div
                class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-purple-500 relative overflow-hidden group hover:shadow-md transition"
              >
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-xs text-gray-500 font-bold uppercase mb-1">í‰ê·  ê·¼ë¬´</p>
                    <h3 class="text-2xl font-bold text-gray-800" id="stat-hours">-</h3>
                    <p class="text-xs text-gray-400 mt-1">ì‹œê°„ (íœ´ê²Œ ì œì™¸)</p>
                  </div>
                  <div class="bg-purple-50 p-2 rounded-lg text-purple-600">
                    <i class="fas fa-clock"></i>
                  </div>
                </div>
              </div>
            </div>

            <!-- Charts Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Daily Chart -->
              <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-bold text-gray-700">
                    <i class="fas fa-chart-line mr-2 text-blue-500"></i>ì¼ë³„ ì¶œê·¼ í˜„í™©
                  </h3>
                </div>
                <div class="h-64">
                  <canvas id="daily-chart"></canvas>
                </div>
              </div>

              <!-- Location Chart -->
              <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-bold text-gray-700">
                    <i class="fas fa-map-marker-alt mr-2 text-red-500"></i>êµ¬ì—­ë³„ ì²­ì†Œ ì‘ì—…
                  </h3>
                </div>
                <div class="h-64">
                  <canvas id="location-chart"></canvas>
                </div>
              </div>

              <!-- Employee Chart -->
              <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-bold text-gray-700">
                    <i class="fas fa-users mr-2 text-purple-500"></i>ì§ì›ë³„ ì‘ì—…ëŸ‰ (Top 10)
                  </h3>
                </div>
                <div class="h-64">
                  <canvas id="employee-chart"></canvas>
                </div>
              </div>

              <!-- Type Chart -->
              <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-bold text-gray-700">
                    <i class="fas fa-pie-chart mr-2 text-yellow-500"></i>ê·¼íƒœ ìœ í˜• ë¶„í¬
                  </h3>
                </div>
                <div class="h-64">
                  <canvas id="type-chart"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- TAB 4: Data -->
          <div id="tab-data" class="tab-content hidden space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <!-- Excel Export -->
              <div
                class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 text-center hover:shadow-md transition"
              >
                <div
                  class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"
                >
                  <i class="fas fa-file-excel"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">ë°ì´í„° ë°±ì—…</h3>
                <p class="text-gray-500 text-sm mb-6">ì „ì²´ ë°ì´í„°ë¥¼ ì—‘ì…€ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.</p>
                <button
                  onclick="app.downloadData()"
                  class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg transition"
                >
                  <i class="fas fa-download mr-2"></i>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Image Modal -->
    <div
      id="image-modal"
      class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop bg-black/80"
      onclick="app.closeModal()"
    >
      <div
        class="bg-white p-1 rounded-xl shadow-2xl max-w-4xl w-full mx-4 overflow-hidden relative"
        onclick="event.stopPropagation()"
      >
        <button
          onclick="app.closeModal()"
          class="absolute top-4 right-4 text-white bg-black/50 hover:bg-black/70 rounded-full w-8 h-8 flex items-center justify-center transition z-10"
        >
          <i class="fas fa-times"></i>
        </button>
        <div class="flex flex-col md:flex-row h-[80vh]">
          <div class="flex-1 bg-black flex items-center justify-center">
            <img id="modal-image" src="" alt="ìƒì„¸ ì´ë¯¸ì§€" class="max-w-full max-h-full object-contain" />
          </div>
          <div class="w-full md:w-80 bg-white p-6 flex flex-col justify-center border-l">
            <h3 class="text-lg font-bold text-gray-800 mb-1" id="modal-employee-name">-</h3>
            <p class="text-sm text-gray-500 mb-6" id="modal-time">-</p>
            <div class="space-y-4">
              <div class="p-3 bg-gray-50 rounded-lg">
                <p class="text-xs text-gray-400 mb-1">ì´¬ì˜ ìœ„ì¹˜</p>
                <p class="font-medium text-gray-700">ì •ë³´ ì—†ìŒ</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // KINDWON Admin Dashboard - Option A + B (Stable Version)

      // Config
      const SUPABASE_URL = 'https://qgpqhtuynxhmgawakjxe.supabase.co';
      const SUPABASE_KEY =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFncHFodHV5bnhobWdhd2FranhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyOTQyNTEsImV4cCI6MjA4Mjg3MDI1MX0.WNljQIKDbeZCDlXe8fpBdZs58XRFfujGt7lBGfq_pVg';
      const LOGIN_PIN = 'bdxi2026';

      const app = {
        sb: null,
        charts: {},
        employeeList: [],
        locationList: [],

        init: function () {
          try {
            if (window.supabase) {
              this.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
              console.log('âœ… Supabase Ready');
            }
          } catch (e) {
            console.error(e);
          }

          this.updateClock();
          setInterval(() => this.updateClock(), 1000);

          // Dropdown close
          document.addEventListener('click', (e) => {
            if (!e.target.closest('.dropdown-container')) {
              document.querySelectorAll('.dropdown-list').forEach((el) => el.classList.add('hidden'));
            }
          });

          // Input Search Setup
          this.setupSearch('filter-employee-input', 'filter-employee-dropdown');
          this.setupSearch('hist-employee-input', 'hist-employee-dropdown');
        },

        setupSearch: function (inputId, listId) {
          const input = document.getElementById(inputId);
          const list = document.getElementById(listId);
          if (!input || !list) return;

          const handler = () => {
            const term = input.value.toLowerCase();
            const filtered = this.employeeList.filter((e) => e.name.toLowerCase().includes(term));

            list.innerHTML = '';
            filtered.forEach((emp) => {
              const div = document.createElement('div');
              div.className = 'dropdown-item px-3 py-2 cursor-pointer text-sm';
              div.textContent = emp.name;
              div.onclick = () => {
                input.value = emp.name;
                list.classList.add('hidden');
              };
              list.appendChild(div);
            });

            if (filtered.length > 0) list.classList.remove('hidden');
            else list.classList.add('hidden');
          };

          input.addEventListener('input', handler);
          input.addEventListener('focus', handler);
        },

        updateClock: function () {
          const now = new Date();
          const time = now.toLocaleTimeString('ko-KR', { hour12: false });
          const el = document.getElementById('live-time');
          if (el) el.textContent = time;
        },

        login: function () {
          const pin = document.getElementById('inp-pin').value;
          if (pin === LOGIN_PIN) {
            sessionStorage.setItem('kindwon_login', 'true');
            this.showDashboard();
          } else {
            document.getElementById('msg-error').classList.remove('hidden');
          }
        },

        logout: function () {
          if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            sessionStorage.removeItem('kindwon_login');
            location.reload();
          }
        },

        checkLogin: function () {
          if (sessionStorage.getItem('kindwon_login') === 'true') {
            this.showDashboard();
          } else {
            document.getElementById('view-login').classList.remove('hidden');
          }
        },

        showDashboard: function () {
          document.getElementById('view-login').classList.add('hidden');
          document.getElementById('view-dashboard').classList.remove('hidden');
          this.switchTab('gallery');
        },

        switchTab: function (tab) {
          document.querySelectorAll('.tab-content').forEach((el) => el.classList.add('hidden'));
          document.getElementById(`tab-${tab}`).classList.remove('hidden');

          document.querySelectorAll('.nav-tab').forEach((el) => {
            el.classList.remove('tab-active');
            el.classList.add('tab-inactive');
          });

          const btn = document.querySelector(`button[onclick="app.switchTab('${tab}')"]`);
          if (btn) {
            btn.classList.remove('tab-inactive');
            btn.classList.add('tab-active');
          }

          if (tab === 'gallery') {
            this.loadGallery();
            this.loadMeta();
          } else if (tab === 'history') {
            this.loadHistory();
            this.loadMeta();
          } else if (tab === 'stats') {
            this.loadStats();
          }
        },

        loadMeta: async function () {
          if (this.employeeList.length > 0) return;
          try {
            const { data } = await this.sb.from('employees').select('name').eq('status', 'active');
            if (data) this.employeeList = data;

            const locRes = await this.sb.from('locations').select('name').eq('status', 'active');
            if (locRes.data) {
              const select = document.getElementById('filter-location');
              select.innerHTML = '<option value="ì „ì²´">ì „ì²´ ìœ„ì¹˜</option>';
              locRes.data.forEach((l) => {
                const opt = document.createElement('option');
                opt.value = l.name;
                opt.textContent = l.name;
                select.appendChild(opt);
              });
            }
          } catch (e) {}
        },

        // Gallery
        loadGallery: async function () {
          const grid = document.getElementById('gallery-grid');
          grid.innerHTML = '<div class="col-span-full text-center py-10"><div class="loader"></div></div>';

          try {
            let q = this.sb.from('cleaning_tasks').select('*').order('created_at', { ascending: false });

            const date = document.getElementById('filter-date').value;
            const emp = document.getElementById('filter-employee-input').value;
            const loc = document.getElementById('filter-location').value;

            if (date) {
              q = q.gte('created_at', `${date}T00:00:00+09:00`).lte('created_at', `${date}T23:59:59+09:00`);
            }
            if (emp) q = q.ilike('employee_name', `%${emp}%`);
            if (loc !== 'ì „ì²´') q = q.eq('location', loc);

            const { data } = await q.limit(50);

            grid.innerHTML = '';
            if (data && data.length > 0) {
              document.getElementById('gallery-count').textContent = `(${data.length}ê±´)`;
              data.forEach((item) => {
                if (item.photo_url) {
                  const div = document.createElement('div');
                  div.className = 'gallery-item bg-white rounded-lg shadow hover:shadow-lg transition-shadow';
                  div.innerHTML = `
                    <img src="${item.photo_url}" class="w-full h-48 object-cover rounded-t-lg"
                        onclick="app.openModal('${item.photo_url}', '${item.employee_name}', '${item.created_at}')">
                    <div class="p-3">
                        <div class="font-medium text-gray-800">${item.employee_name}</div>
                        <div class="text-sm text-gray-500">
                            ${new Date(item.created_at).toLocaleString('ko-KR', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
                        </div>
                    </div>
                `;
                  grid.appendChild(div);
                }
              });
            } else {
              grid.innerHTML = '<div class="col-span-full text-center py-20 text-gray-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
              document.getElementById('gallery-count').textContent = '(0ê±´)';
            }
          } catch (e) {
            console.error(e);
            grid.innerHTML = '<div class="col-span-full text-center text-red-500">ì˜¤ë¥˜ ë°œìƒ</div>';
          }
        },

        applyGalleryFilters: function () {
          this.loadGallery();
        },
        resetGalleryFilters: function () {
          document.getElementById('filter-date').value = '';
          document.getElementById('filter-employee-input').value = '';
          document.getElementById('filter-location').value = 'ì „ì²´';
          this.loadGallery();
        },

        openModal: function (url, name, time) {
          document.getElementById('modal-image').src = url;
          document.getElementById('modal-employee-name').textContent = name;
          document.getElementById('modal-time').textContent = new Date(time).toLocaleString('ko-KR');
          document.getElementById('image-modal').classList.remove('hidden');
        },
        closeModal: function () {
          document.getElementById('image-modal').classList.add('hidden');
        },

        // History
        loadHistory: async function () {
          const list = document.getElementById('history-list');
          list.innerHTML = '<tr><td colspan="4" class="text-center py-4"><div class="loader"></div></td></tr>';

          try {
            let q = this.sb.from('attendance_records').select('*').order('scan_time', { ascending: false });

            const start = document.getElementById('hist-start').value;
            const end = document.getElementById('hist-end').value;
            const emp = document.getElementById('hist-employee-input').value;
            const type = document.getElementById('hist-type').value;

            if (start) q = q.gte('scan_time', `${start}T00:00:00+09:00`);
            if (end) q = q.lte('scan_time', `${end}T23:59:59+09:00`);
            if (emp) q = q.ilike('employee_name', `%${emp}%`);
            if (type) q = q.eq('attendance_type', type);

            const { data } = await q.limit(100);

            list.innerHTML = '';
            if (data && data.length > 0) {
              data.forEach((row) => {
                const tr = document.createElement('tr');
                let color = 'bg-gray-100 text-gray-800';
                if (row.attendance_type === 'ì¶œê·¼') color = 'bg-blue-100 text-blue-800';
                if (row.attendance_type === 'í‡´ê·¼') color = 'bg-green-100 text-green-800';

                tr.innerHTML = `
                <td class="px-6 py-4 text-sm text-gray-900">${new Date(row.scan_time).toLocaleString('ko-KR')}</td>
                <td class="px-6 py-4 text-sm text-gray-500">${row.employee_name}</td>
                <td class="px-6 py-4 text-sm text-gray-500">${row.location || '-'}</td>
                <td class="px-6 py-4"><span class="px-2 py-1 text-xs rounded-full ${color}">${row.attendance_type}</span></td>
            `;
                list.appendChild(tr);
              });
            } else {
              list.innerHTML =
                '<tr><td colspan="4" class="text-center py-10 text-gray-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            }
          } catch (e) {
            console.error(e);
          }
        },

        applyHistoryFilters: function () {
          this.loadHistory();
        },

        // Stats
        loadStats: async function () {
          const period = document.getElementById('stats-period').value;
          const now = new Date();
          let start, end;

          if (period === 'today') {
            start = end = now.toISOString().split('T')[0];
          } else if (period === 'week') {
            const d = new Date();
            d.setDate(d.getDate() - 7);
            start = d.toISOString().split('T')[0];
            end = now.toISOString().split('T')[0];
          } else if (period === 'month') {
            start = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            end = now.toISOString().split('T')[0];
          } else {
            start = document.getElementById('custom-start').value;
            end = document.getElementById('custom-end').value;
          }

          if (!start) return;

          try {
            const [empRes, attRes, cleanRes] = await Promise.all([
              this.sb.from('employees').select('id, name').eq('status', 'active'),
              this.sb
                .from('attendance_records')
                .select('*')
                .gte('scan_time', `${start}T00:00:00`)
                .lte('scan_time', `${end}T23:59:59`),
              this.sb
                .from('cleaning_tasks')
                .select('*')
                .gte('created_at', `${start}T00:00:00`)
                .lte('created_at', `${end}T23:59:59`),
            ]);

            const emps = empRes.data || [];
            const atts = attRes.data || [];
            const cleans = cleanRes.data || [];

            // KPIs
            const total = emps.length;
            const presentSet = new Set(atts.filter((a) => a.attendance_type === 'ì¶œê·¼').map((a) => a.employee_name));
            const present = presentSet.size;

            // Calc Hours
            let totalHours = 0,
              days = 0;
            const workMap = {};
            atts.forEach((a) => {
              const k = `${a.employee_name}-${a.scan_time.split('T')[0]}`;
              if (!workMap[k]) workMap[k] = {};
              workMap[k][a.attendance_type] = new Date(a.scan_time);
            });

            Object.values(workMap).forEach((d) => {
              if (d['ì¶œê·¼'] && d['í‡´ê·¼']) {
                let h = (d['í‡´ê·¼'] - d['ì¶œê·¼']) / 3600000;
                if (d['íœ´ê²Œ ì‹œì‘'] && d['íœ´ê²Œ ì¢…ë£Œ']) h -= (d['íœ´ê²Œ ì¢…ë£Œ'] - d['íœ´ê²Œ ì‹œì‘']) / 3600000;
                if (h > 0) {
                  totalHours += h;
                  days++;
                }
              }
            });

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-absent').textContent = total - present;
            document.getElementById('stat-present').textContent = present;
            document.getElementById('stat-cleaning').textContent = cleans.length;
            document.getElementById('stat-hours').textContent = days > 0 ? (totalHours / days).toFixed(1) : '0.0';

            // Charts
            this.renderCharts(atts, cleans);
          } catch (e) {
            console.error(e);
          }
        },

        changePeriod: function () {
          const val = document.getElementById('stats-period').value;
          const cust = document.getElementById('custom-range');
          if (val === 'custom') cust.classList.remove('hidden');
          else {
            cust.classList.add('hidden');
            this.loadStats();
          }
        },

        renderCharts: function (atts, cleans) {
          // Destroy old
          Object.values(this.charts).forEach((c) => c && c.destroy());

          // Daily
          const dailyData = {};
          atts
            .filter((a) => a.attendance_type === 'ì¶œê·¼')
            .forEach((a) => {
              const d = a.scan_time.split('T')[0];
              dailyData[d] = (dailyData[d] || 0) + 1;
            });
          this.charts.daily = new Chart(document.getElementById('daily-chart'), {
            type: 'line',
            data: {
              labels: Object.keys(dailyData),
              datasets: [{ label: 'ì¶œê·¼', data: Object.values(dailyData), borderColor: '#3b82f6', tension: 0.4 }],
            },
            options: { maintainAspectRatio: false },
          });

          // Location
          const locData = {};
          cleans.forEach((c) => (locData[c.location || 'ë¯¸ì •'] = (locData[c.location] || 0) + 1));
          this.charts.loc = new Chart(document.getElementById('location-chart'), {
            type: 'doughnut',
            data: {
              labels: Object.keys(locData),
              datasets: [
                { data: Object.values(locData), backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e'] },
              ],
            },
            options: { maintainAspectRatio: false },
          });

          // Employee
          const empData = {};
          cleans.forEach((c) => (empData[c.employee_name] = (empData[c.employee_name] || 0) + 1));
          const sortedEmp = Object.entries(empData)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);
          this.charts.emp = new Chart(document.getElementById('employee-chart'), {
            type: 'bar',
            data: {
              labels: sortedEmp.map((i) => i[0]),
              datasets: [{ label: 'ì‘ì—…ìˆ˜', data: sortedEmp.map((i) => i[1]), backgroundColor: '#8b5cf6' }],
            },
            options: { maintainAspectRatio: false, indexAxis: 'y' },
          });

          // Type
          const typeData = {};
          atts.forEach((a) => (typeData[a.attendance_type] = (typeData[a.attendance_type] || 0) + 1));
          this.charts.type = new Chart(document.getElementById('type-chart'), {
            type: 'pie',
            data: {
              labels: Object.keys(typeData),
              datasets: [
                { data: Object.values(typeData), backgroundColor: ['#22c55e', '#ef4444', '#f59e0b', '#8b5cf6'] },
              ],
            },
            options: { maintainAspectRatio: false },
          });
        },

        downloadData: async function () {
          try {
            const { data: emps } = await this.sb.from('employees').select('*');
            const { data: atts } = await this.sb.from('attendance_records').select('*');

            const wb = XLSX.utils.book_new();
            if (emps) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(emps), 'ì§ì›');
            if (atts) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(atts), 'ê·¼íƒœ');
            XLSX.writeFile(wb, 'KINDWON_Data.xlsx');
          } catch (e) {
            alert('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
          }
        },
      };

      document.addEventListener('DOMContentLoaded', () => {
        app.init();
        app.checkLogin();
      });
    </script>
  </body>
</html>
