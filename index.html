
<!DOCTYPE html>
<html lang="ko" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KINDWON Admin Dashboard</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap"
      rel="stylesheet"
    />
    <!-- CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.js"></script>
    <style>
      body {
        font-family: 'Noto Sans KR', sans-serif;
      }
      .bg-gradient-brand {
        background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
      }
      .text-brand {
        color: #1b5e3e;
      }
      .bg-brand {
        background-color: #1b5e3e;
      }
      .tab-active {
        border-bottom: 3px solid #1b5e3e;
        color: #1b5e3e;
        font-weight: 700;
      }
      .tab-inactive {
        border-bottom: 3px solid transparent;
        color: #6b7280;
      }
      .loader {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #1b5e3e;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      * {
        transition:
          color 0.2s ease,
          background-color 0.2s ease;
      }
      .modal-backdrop {
        backdrop-filter: blur(8px);
        animation: fadeIn 0.2s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .dropdown-item:hover {
        background-color: #f3f4f6;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- LOGIN VIEW -->
    <div id="view-login" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-brand hidden">
      <div
        class="bg-white p-10 rounded-2xl shadow-2xl w-full max-w-md text-center transform transition-all hover:scale-[1.01]"
      >
        <div class="mb-10">
          <img src="https://www.genspark.ai/api/files/s/UmgxPvd3" alt="KINDWON Logo" class="h-16 mx-auto" />
        </div>
        <h1 class="text-3xl font-extrabold text-gray-800 mb-2">ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
        <p class="text-gray-500 mb-6 text-sm">KINDWON ì§ì› ì—…ë¬´ ê´€ë¦¬ ì‹œìŠ¤í…œ</p>

        <!-- Apartment Selector -->
        <div class="mb-6 text-left">
          <label class="block text-sm font-bold text-gray-700 mb-2">ì•„íŒŒíŠ¸ ë‹¨ì§€ ì„ íƒ</label>
          <div class="relative">
            <select
              id="login-apt-select"
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-green-600 appearance-none bg-white text-gray-700 font-medium"
            >
              <option value="BJD001">ë´‰ë‹´ìì´í”„ë¼ì´ë“œì‹œí‹°</option>
              <option value="YDB002">ìš©ì¸ë™ë°±ì„¼íŠ¸ëŸ´</option>
              <option value="SYT003">ìˆ˜ì›ì˜í†µìì´</option>
              <option value="PGD004">í‰íƒê³ ë•êµ­ì œì‹ ë„ì‹œ</option>
              <option value="ETC999">ê¸°íƒ€ ë‹¨ì§€</option>
            </select>
            <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-gray-500">
              <i class="fas fa-chevron-down"></i>
            </div>
          </div>
        </div>

        <p class="text-gray-400 mb-4 text-xs">ğŸ”’ ë³´ì•ˆ ì ‘ì†ì„ ìœ„í•´ PIN ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
        <div class="space-y-4">
          <input
            type="password"
            id="inp-pin"
            placeholder="PIN ë²ˆí˜¸ ì…ë ¥"
            class="w-full text-center text-2xl font-bold tracking-[0.3em] py-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-green-600 transition-colors"
            maxlength="10"
            onkeypress="if (event.key === 'Enter') app.login();"
          />
          <button
            onclick="app.login()"
            class="w-full bg-brand hover:bg-green-800 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95"
          >
            <i class="fas fa-sign-in-alt mr-2"></i>ì…ì¥í•˜ê¸°
          </button>
        </div>
        <p id="msg-error" class="hidden mt-4 text-red-600 text-sm font-bold">
          <i class="fas fa-exclamation-triangle mr-1"></i>PIN ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </p>
      </div>
    </div>

    <!-- DASHBOARD VIEW -->
    <div id="view-dashboard" class="min-h-screen flex flex-col hidden">
      <!-- Header -->
      <header class="bg-white border-b sticky top-0 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
          <div class="flex items-center gap-4">
            <img src="https://www.genspark.ai/api/files/s/UmgxPvd3" alt="Logo" class="h-10" />
            <span class="text-gray-300">|</span>
            <div>
              <div class="font-bold text-gray-800 text-lg">KINDWON</div>
              <div class="text-xs text-gray-400 -mt-1">ê´€ë¦¬ì ì‹œìŠ¤í…œ</div>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div
              id="current-apt-badge"
              class="hidden md:flex items-center gap-2 text-sm font-bold text-brand bg-green-50 px-3 py-1.5 rounded-lg border border-green-200"
            >
              <i class="fas fa-building"></i> <span id="apt-name-display">ì•„íŒŒíŠ¸ëª…</span>
            </div>
            <button
              onclick="app.logout()"
              class="px-4 py-2 text-sm bg-gray-800 text-white rounded-lg hover:bg-gray-900 transition-colors"
            >
              <i class="fas fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ
            </button>
          </div>
        </div>
      </header>

      <!-- Nav -->
      <nav class="bg-white border-b sticky top-16 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4">
          <div class="flex space-x-8 overflow-x-auto">
            <button
              onclick="app.switchTab('gallery')"
              class="nav-tab py-4 px-2 text-sm font-medium transition-all tab-active whitespace-nowrap"
            >
              <i class="fas fa-images mr-2"></i>ì²­ì†Œ ê°¤ëŸ¬ë¦¬
            </button>
            <button
              onclick="app.switchTab('history')"
              class="nav-tab py-4 px-2 text-sm font-medium transition-all tab-inactive whitespace-nowrap"
            >
              <i class="fas fa-history mr-2"></i>ìƒì„¸ ì¡°íšŒ
            </button>
            <button
              onclick="app.switchTab('stats')"
              class="nav-tab py-4 px-2 text-sm font-medium transition-all tab-inactive whitespace-nowrap"
            >
              <i class="fas fa-chart-bar mr-2"></i>í†µê³„ ìš”ì•½
            </button>
            <button
              onclick="app.switchTab('data')"
              class="nav-tab py-4 px-2 text-sm font-medium transition-all tab-inactive whitespace-nowrap"
            >
              <i class="fas fa-database mr-2"></i>ë°ì´í„° ê´€ë¦¬
            </button>
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="flex-1 max-w-7xl w-full mx-auto px-4 py-6">
        <!-- TAB 1: Gallery -->
        <div id="tab-gallery" class="tab-content space-y-6">
          <div class="bg-white p-6 rounded-xl shadow-sm border space-y-4">
            <h3 class="font-bold text-gray-800 mb-4"><i class="fas fa-filter mr-2 text-brand"></i>í•„í„°</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                <input
                  type="date"
                  id="filter-date"
                  class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì§ì›</label>
                <input
                  type="text"
                  id="filter-employee-input"
                  placeholder="ì´ë¦„ ê²€ìƒ‰..."
                  class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ìœ„ì¹˜</label>
                <select
                  id="filter-location"
                  class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500"
                >
                  <option value="ì „ì²´">ì „ì²´ ìœ„ì¹˜</option>
                </select>
              </div>
            </div>
            <div class="flex gap-2">
              <button
                onclick="app.loadGallery()"
                class="px-4 py-2 bg-brand text-white rounded-lg hover:bg-green-700 transition-colors"
              >
                <i class="fas fa-search mr-2"></i>ì ìš©
              </button>
              <button
                onclick="app.resetGalleryFilters()"
                class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"
              >
                <i class="fas fa-redo mr-2"></i>ì´ˆê¸°í™”
              </button>
            </div>
          </div>
          <div class="flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-800">
              ğŸ“¸ ì²­ì†Œ ì‘ì—… ê°¤ëŸ¬ë¦¬ <span id="gallery-count" class="text-sm text-gray-500 font-normal"></span>
            </h2>
            <button
              onclick="app.loadGallery()"
              class="text-sm bg-white border px-3 py-1 rounded shadow-sm hover:bg-gray-50"
            >
              <i class="fas fa-sync-alt mr-1"></i>ìƒˆë¡œê³ ì¹¨
            </button>
          </div>
          <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
        </div>

        <!-- TAB 2: History -->
        <div id="tab-history" class="tab-content space-y-6 hidden">
          <div class="bg-white p-6 rounded-xl shadow-sm border space-y-4">
            <h3 class="font-bold text-gray-800 mb-4"><i class="fas fa-filter mr-2 text-brand"></i>í•„í„°</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì‹œì‘ì¼</label
                ><input
                  type="date"
                  id="hist-start"
                  class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì¢…ë£Œì¼</label
                ><input
                  type="date"
                  id="hist-end"
                  class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì§ì›</label
                ><input
                  type="text"
                  id="hist-employee-input"
                  placeholder="ì´ë¦„ ê²€ìƒ‰"
                  class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ìœ í˜•</label>
                <select id="hist-type" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
                  <option value="">ì „ì²´</option>
                  <option value="ì¶œê·¼">ì¶œê·¼</option>
                  <option value="í‡´ê·¼">í‡´ê·¼</option>
                  <option value="íœ´ê²Œ ì‹œì‘">íœ´ê²Œ ì‹œì‘</option>
                  <option value="íœ´ê²Œ ì¢…ë£Œ">íœ´ê²Œ ì¢…ë£Œ</option>
                </select>
              </div>
            </div>
            <button onclick="app.loadHistory()" class="px-4 py-2 bg-brand text-white rounded-lg hover:bg-green-700">
              <i class="fas fa-search mr-2"></i>ê²€ìƒ‰
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-left">ë‚ ì§œ/ì‹œê°„</th>
                    <th class="px-4 py-3 text-left">ì§ì›</th>
                    <th class="px-4 py-3 text-left">ìœ í˜•</th>
                    <th class="px-4 py-3 text-left">ìœ„ì¹˜</th>
                  </tr>
                </thead>
                <tbody id="history-list" class="divide-y divide-gray-100"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- TAB 3: Stats -->
        <div id="tab-stats" class="tab-content space-y-6 hidden">
          <!-- Filter -->
          <div class="bg-white p-6 rounded-xl shadow-sm border">
            <div class="flex items-center gap-4 mb-4">
              <h3 class="font-bold text-gray-800"><i class="fas fa-calendar-alt mr-2 text-brand"></i>ê¸°ê°„ ì¡°íšŒ</h3>
              <select id="stats-period" onchange="app.changePeriod()" class="px-4 py-2 border rounded-lg text-sm">
                <option value="today">ì˜¤ëŠ˜</option>
                <option value="week">ìµœê·¼ 7ì¼</option>
                <option value="month">ì´ë²ˆ ë‹¬</option>
                <option value="custom">ì§ì ‘ ì„ íƒ</option>
              </select>
            </div>
            <div id="custom-range" class="hidden flex gap-4 items-end">
              <div>
                <label class="block text-xs mb-1">ì‹œì‘ì¼</label
                ><input type="date" id="custom-start" class="px-3 py-2 border rounded-lg text-sm" />
              </div>
              <div>
                <label class="block text-xs mb-1">ì¢…ë£Œì¼</label
                ><input type="date" id="custom-end" class="px-3 py-2 border rounded-lg text-sm" />
              </div>
              <button
                onclick="app.loadStats()"
                class="px-4 py-2 bg-brand text-white rounded-lg hover:bg-green-700 text-sm"
              >
                ì¡°íšŒ
              </button>
            </div>
          </div>

          <!-- KPI Cards -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-l-4 border-l-blue-500">
              <p class="text-sm text-gray-500 mb-1">ì´ì›</p>
              <p class="text-3xl font-bold text-gray-800" id="stat-total">0</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-l-4 border-l-red-500">
              <p class="text-sm text-gray-500 mb-1">íœ´ê°€/ê²°ê·¼</p>
              <p class="text-3xl font-bold text-gray-800" id="stat-absent">0</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-l-4 border-l-green-500">
              <p class="text-sm text-gray-500 mb-1">í˜„ì¬ì›</p>
              <p class="text-3xl font-bold text-gray-800" id="stat-present">0</p>
            </div>
          </div>

          <!-- Work Hours Table -->
          <div class="bg-white p-6 rounded-xl shadow-sm border">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-gray-800">
                <i class="fas fa-clock mr-2 text-blue-600"></i>ê°œì¸ë³„ ê·¼ë¡œì‹œê°„ ìƒì„¸
              </h3>
              <button
                onclick="app.downloadWorkHours()"
                class="px-3 py-1.5 bg-green-600 text-white rounded-lg text-xs hover:bg-green-700"
              >
                <i class="fas fa-file-excel mr-1"></i>Excel ì €ì¥
              </button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-center">
                <thead class="bg-gray-100 text-gray-600">
                  <tr>
                    <th class="py-2 px-2">ì§ì›ëª…</th>
                    <th class="py-2 px-2">ì¼ í‰ê· </th>
                    <th class="py-2 px-2">ì£¼ë‹¹ ê·¼ë¬´ì¼</th>
                    <th class="py-2 px-2">ì´ ì‹œê°„</th>
                    <th class="py-2 px-2">ê·¼ë¬´ì¼ìˆ˜</th>
                    <th class="py-2 px-2">ìƒíƒœ</th>
                  </tr>
                </thead>
                <tbody id="work-hours-table" class="divide-y divide-gray-100"></tbody>
              </table>
            </div>
          </div>

          <!-- Cleaning Stats -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="cleaning-stats-container">
            <!-- Location Stats -->
            <div class="bg-white p-6 rounded-xl shadow-sm border">
              <h3 class="font-bold text-gray-800 mb-4">ğŸ“ êµ¬ì—­ë³„ ì²­ì†Œ í˜„í™©</h3>
              <div class="flex gap-4 mb-4 text-sm">
                <div class="flex-1 bg-green-50 p-3 rounded text-center">
                  <div class="font-bold text-green-700">BEST</div>
                  <div id="location-best-name">-</div>
                  <div id="location-best-count" class="text-xs text-gray-500">-</div>
                </div>
                <div class="flex-1 bg-red-50 p-3 rounded text-center">
                  <div class="font-bold text-red-700">WORST</div>
                  <div id="location-worst-name">-</div>
                  <div id="location-worst-count" class="text-xs text-gray-500">-</div>
                </div>
              </div>
              <div class="space-y-2" id="location-top3"></div>
            </div>
            <!-- Employee Stats -->
            <div class="bg-white p-6 rounded-xl shadow-sm border">
              <h3 class="font-bold text-gray-800 mb-4">ğŸ† ì§ì›ë³„ ì²­ì†Œ í˜„í™©</h3>
              <div class="flex gap-4 mb-4 text-sm">
                <div class="flex-1 bg-blue-50 p-3 rounded text-center">
                  <div class="font-bold text-blue-700">BEST</div>
                  <div id="employee-best-name">-</div>
                  <div id="employee-best-count" class="text-xs text-gray-500">-</div>
                </div>
                <div class="flex-1 bg-gray-50 p-3 rounded text-center">
                  <div class="font-bold text-gray-700">WORST</div>
                  <div id="employee-worst-name">-</div>
                  <div id="employee-worst-count" class="text-xs text-gray-500">-</div>
                </div>
              </div>
              <div class="space-y-2" id="employee-top3"></div>
            </div>
          </div>

          <!-- Charts -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border">
              <h3 class="font-bold mb-4 text-sm">ì¼ë³„ ì¶œê·¼</h3>
              <div class="h-64"><canvas id="daily-chart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border">
              <h3 class="font-bold mb-4 text-sm">êµ¬ì—­ë³„ ì‘ì—…</h3>
              <div class="h-64"><canvas id="location-chart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border">
              <h3 class="font-bold mb-4 text-sm">ì§ì›ë³„ ì‘ì—…</h3>
              <div class="h-64"><canvas id="employee-chart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border">
              <h3 class="font-bold mb-4 text-sm">ê·¼íƒœ ìœ í˜•</h3>
              <div class="h-64"><canvas id="type-chart"></canvas></div>
            </div>
          </div>
        </div>

        <!-- TAB 4: Data -->
        <div id="tab-data" class="tab-content space-y-6 hidden">
          <!-- Employee Management -->
          <div class="bg-white p-6 rounded-xl shadow-sm border">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-gray-800 text-xl"><i class="fas fa-users mr-2 text-green-600"></i>ì§ì› ê´€ë¦¬</h3>
              <button
                onclick="app.toggleEmployeeForm()"
                class="px-3 py-1.5 bg-green-600 text-white rounded hover:bg-green-700 text-sm"
              >
                <i class="fas fa-plus mr-1"></i>ì¶”ê°€
              </button>
            </div>
            <div id="employee-form" class="hidden bg-green-50 p-4 rounded mb-4 border border-green-200">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                <input type="text" id="emp-name" placeholder="ì´ë¦„ *" class="border p-2 rounded text-sm" />
                <input type="text" id="emp-phone" placeholder="ì „í™”ë²ˆí˜¸" class="border p-2 rounded text-sm" />
                <input type="text" id="emp-position" placeholder="ì§ê¸‰" class="border p-2 rounded text-sm" />
              </div>
              <button onclick="app.saveEmployee()" class="bg-green-600 text-white px-4 py-1.5 rounded text-sm">
                ì €ì¥
              </button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="p-2 text-left">ì´ë¦„</th>
                    <th class="p-2 text-left">ì „í™”</th>
                    <th class="p-2 text-left">ì§ê¸‰</th>
                    <th class="p-2 text-center">ê´€ë¦¬</th>
                  </tr>
                </thead>
                <tbody id="employee-list" class="divide-y"></tbody>
              </table>
            </div>
          </div>

          <!-- Location Management -->
          <div class="bg-white p-6 rounded-xl shadow-sm border">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-gray-800 text-xl">
                <i class="fas fa-map-marker-alt mr-2 text-purple-600"></i>êµ¬ì—­ ê´€ë¦¬
              </h3>
              <button
                onclick="app.toggleLocationForm()"
                class="px-3 py-1.5 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm"
              >
                <i class="fas fa-plus mr-1"></i>ì¶”ê°€
              </button>
            </div>
            <div id="location-form" class="hidden bg-purple-50 p-4 rounded mb-4 border border-purple-200">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                <input type="text" id="loc-name" placeholder="êµ¬ì—­ëª… *" class="border p-2 rounded text-sm" />
                <input type="text" id="loc-floor" placeholder="ì¸µìˆ˜" class="border p-2 rounded text-sm" />
                <input type="text" id="loc-desc" placeholder="ì„¤ëª…" class="border p-2 rounded text-sm" />
              </div>
              <button onclick="app.saveLocation()" class="bg-purple-600 text-white px-4 py-1.5 rounded text-sm">
                ì €ì¥
              </button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="p-2 text-left">êµ¬ì—­ëª…</th>
                    <th class="p-2 text-left">ì¸µìˆ˜</th>
                    <th class="p-2 text-left">ì„¤ëª…</th>
                    <th class="p-2 text-center">ê´€ë¦¬</th>
                  </tr>
                </thead>
                <tbody id="location-list" class="divide-y"></tbody>
              </table>
            </div>
          </div>

          <!-- CSV Upload -->
          <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl shadow-sm border border-blue-200">
            <h3 class="font-bold text-gray-800 mb-4 text-xl">ğŸ“¤ CSV ë°ì´í„° ì¼ê´„ ë“±ë¡</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Employee CSV -->
              <div class="bg-white p-4 rounded shadow border-l-4 border-green-500">
                <div class="font-bold mb-2">ğŸ‘¤ ì§ì› (employees)</div>
                <button
                  onclick="app.downloadTemplate('employees')"
                  class="text-xs bg-gray-100 px-2 py-1 rounded mb-2 block w-full"
                >
                  í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
                </button>
                <input
                  type="file"
                  accept=".csv"
                  onchange="app.handleCSVUpload(event, 'employees')"
                  class="text-xs w-full"
                />
              </div>
              <!-- Location CSV -->
              <div class="bg-white p-4 rounded shadow border-l-4 border-purple-500">
                <div class="font-bold mb-2">ğŸ“ ìœ„ì¹˜ (locations)</div>
                <button
                  onclick="app.downloadTemplate('locations')"
                  class="text-xs bg-gray-100 px-2 py-1 rounded mb-2 block w-full"
                >
                  í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
                </button>
                <input
                  type="file"
                  accept=".csv"
                  onchange="app.handleCSVUpload(event, 'locations')"
                  class="text-xs w-full"
                />
              </div>
              <!-- Cleaning CSV -->
              <div class="bg-white p-4 rounded shadow border-l-4 border-orange-500">
                <div class="font-bold mb-2">ğŸ§¹ ì²­ì†Œ (cleaning_tasks)</div>
                <button
                  onclick="app.downloadTemplate('cleaning_tasks')"
                  class="text-xs bg-gray-100 px-2 py-1 rounded mb-2 block w-full"
                >
                  í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
                </button>
                <input
                  type="file"
                  accept=".csv"
                  onchange="app.handleCSVUpload(event, 'cleaning_tasks')"
                  class="text-xs w-full"
                />
              </div>
              <!-- Attendance CSV -->
              <div class="bg-white p-4 rounded shadow border-l-4 border-blue-500">
                <div class="font-bold mb-2">â° ê·¼íƒœ (attendance_records)</div>
                <button
                  onclick="app.downloadTemplate('attendance_records')"
                  class="text-xs bg-gray-100 px-2 py-1 rounded mb-2 block w-full"
                >
                  í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
                </button>
                <input
                  type="file"
                  accept=".csv"
                  onchange="app.handleCSVUpload(event, 'attendance_records')"
                  class="text-xs w-full"
                />
              </div>
            </div>
          </div>

          <!-- Excel Export -->
          <div class="bg-white p-6 rounded-xl shadow-sm border">
            <h3 class="font-bold text-gray-800 mb-2">ğŸ“¥ ì „ì²´ ë°ì´í„° ë°±ì—…</h3>
            <button
              onclick="app.downloadData()"
              class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow-md w-full md:w-auto"
            >
              <i class="fas fa-download mr-2"></i>ì „ì²´ Excel ë‹¤ìš´ë¡œë“œ
            </button>
          </div>
        </div>
      </main>
    </div>

    <!-- Image Modal -->
    <div
      id="image-modal"
      class="fixed inset-0 z-50 hidden modal-backdrop bg-black/80 flex items-center justify-center p-4"
      onclick="if (event.target === this) app.closeModal();"
    >
      <div class="bg-white rounded-2xl max-w-4xl w-full max-h-full overflow-hidden shadow-2xl relative">
        <div class="flex justify-between items-center p-4 border-b">
          <div>
            <p class="font-bold text-gray-800" id="modal-emp"></p>
            <p class="text-sm text-gray-500" id="modal-time"></p>
          </div>
          <button onclick="app.closeModal()" class="text-2xl text-gray-400 hover:text-gray-600">Ã—</button>
        </div>
        <div class="p-4 bg-black flex justify-center">
          <img id="modal-img" src="" class="max-h-[80vh] object-contain" />
        </div>
      </div>
    </div>

    <script>
      const SUPABASE_URL = 'https://qgpqhtuynxhmgawakjxe.supabase.co';
      const SUPABASE_ANON_KEY =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFncHFodHV5bnhobWdhd2FranhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyOTQyNTEsImV4cCI6MjA4Mjg3MDI1MX0.WNljQIKDbeZCDlXe8fpBdZs58XRFfujGt7lBGfq_pVg';
      const LOGIN_PIN = 'bdxi2026';

      const APARTMENTS = {
        BJD001: 'ë´‰ë‹´ìì´í”„ë¼ì´ë“œì‹œí‹°',
        YDB002: 'ìš©ì¸ë™ë°±ì„¼íŠ¸ëŸ´',
        SYT003: 'ìˆ˜ì›ì˜í†µìì´',
        PGD004: 'í‰íƒê³ ë•êµ­ì œì‹ ë„ì‹œ',
        ETC999: 'ê¸°íƒ€ ë‹¨ì§€',
      };

      const app = {
        sb: null,
        currentAptId: null,
        charts: {},

        init: function () {
          this.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          this.checkLogin();
        },

        // --- AUTH ---
        login: function () {
          const pin = document.getElementById('inp-pin').value;
          const aptId = document.getElementById('login-apt-select').value;

          if (pin === LOGIN_PIN) {
            this.currentAptId = aptId;
            sessionStorage.setItem('kindwon_auth', 'true');
            sessionStorage.setItem('kindwon_apt_id', aptId);
            this.showDashboard();
          } else {
            document.getElementById('msg-error').classList.remove('hidden');
          }
        },

        checkLogin: function () {
          const auth = sessionStorage.getItem('kindwon_auth');
          const aptId = sessionStorage.getItem('kindwon_apt_id');

          if (auth === 'true' && aptId) {
            this.currentAptId = aptId;
            this.showDashboard();
          } else {
            document.getElementById('view-login').classList.remove('hidden');
          }
        },

        showDashboard: function () {
          document.getElementById('view-login').classList.add('hidden');
          document.getElementById('view-dashboard').classList.remove('hidden');
          document.getElementById('apt-name-display').textContent = APARTMENTS[this.currentAptId];
          document.getElementById('current-apt-badge').classList.remove('hidden');
          this.switchTab('gallery');
        },

        logout: function () {
          if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            sessionStorage.clear();
            location.reload();
          }
        },

        // --- TABS ---
        switchTab: function (tab) {
          document.querySelectorAll('.tab-content').forEach((e) => e.classList.add('hidden'));
          document.getElementById('tab-' + tab).classList.remove('hidden');

          document.querySelectorAll('.nav-tab').forEach((e) => {
            e.classList.remove('tab-active');
            e.classList.add('tab-inactive');
          });
          event.currentTarget.classList.remove('tab-inactive');
          event.currentTarget.classList.add('tab-active');

          if (tab === 'gallery') this.loadGallery();
          if (tab === 'history') this.loadHistory();
          if (tab === 'stats') this.loadStats();
          if (tab === 'data') {
            this.loadEmployees();
            this.loadLocations();
          }
        },

        // --- UTILS ---
        toKST: function (isoStr) {
          const d = new Date(isoStr);
          return new Date(d.getTime() + 9 * 60 * 60 * 1000);
        },

        // --- GALLERY ---
        loadGallery: async function () {
          const grid = document.getElementById('gallery-grid');
          grid.innerHTML = '<div class="col-span-full text-center py-10"><div class="loader"></div></div>';

          let q = this.sb
            .from('cleaning_tasks')
            .select('*')
            .eq('apartment_id', this.currentAptId)
            .order('created_at', { ascending: false });

          const date = document.getElementById('filter-date').value;
          const emp = document.getElementById('filter-employee-input').value;

          // Filter by Date (UTC comparison)
          if (date) {
            const start = new Date(date);
            const end = new Date(date);
            end.setDate(end.getDate() + 1);
            q = q.gte('created_at', start.toISOString()).lt('created_at', end.toISOString());
          }
          if (emp) q = q.ilike('employee_name', `%${emp}%`);

          const { data, error } = await q.limit(50);

          grid.innerHTML = '';
          if (error || !data) {
            grid.innerHTML = '<div class="col-span-full text-center text-red-500">ë¡œë“œ ì‹¤íŒ¨</div>';
            return;
          }

          document.getElementById('gallery-count').textContent = `(${data.length}ê±´)`;
          data.forEach((item) => {
            if (item.photo_url) {
              const kstDate = this.toKST(item.created_at);
              const div = document.createElement('div');
              div.className = 'bg-white rounded-lg shadow overflow-hidden';
              div.innerHTML = `
                   <img src="${item.photo_url}" class="w-full h-48 object-cover cursor-pointer hover:opacity-90" onclick="app.openModal('${item.photo_url}', '${item.employee_name}', '${kstDate.toLocaleString()}')">
                   <div class="p-3">
                      <div class="font-bold text-gray-800 text-sm">${item.employee_name}</div>
                      <div class="text-xs text-gray-500">${kstDate.toLocaleString('ko-KR')}</div>
                      <div class="text-xs text-gray-400 truncate">${item.location || ''}</div>
                   </div>
                `;
              grid.appendChild(div);
            }
          });
        },
        openModal: function (url, name, time) {
          document.getElementById('modal-img').src = url;
          document.getElementById('modal-emp').textContent = name;
          document.getElementById('modal-time').textContent = time;
          document.getElementById('image-modal').classList.remove('hidden');
        },
        closeModal: function () {
          document.getElementById('image-modal').classList.add('hidden');
        },
        resetGalleryFilters: function () {
          document.getElementById('filter-date').value = '';
          document.getElementById('filter-employee-input').value = '';
          this.loadGallery();
        },

        // --- HISTORY ---
        loadHistory: async function () {
          const tbody = document.getElementById('history-list');
          tbody.innerHTML = '<tr><td colspan="4" class="text-center py-10"><div class="loader"></div></td></tr>';

          let q = this.sb
            .from('attendance_records')
            .select('*')
            .eq('apartment_id', this.currentAptId)
            .order('scan_time', { ascending: false });

          const start = document.getElementById('hist-start').value;
          const end = document.getElementById('hist-end').value;
          const emp = document.getElementById('hist-employee-input').value;
          const type = document.getElementById('hist-type').value;

          if (start) q = q.gte('scan_time', new Date(start).toISOString());
          if (end) {
            const e = new Date(end);
            e.setDate(e.getDate() + 1);
            q = q.lt('scan_time', e.toISOString());
          }
          if (emp) q = q.ilike('employee_name', `%${emp}%`);
          if (type) q = q.eq('attendance_type', type);

          const { data, error } = await q.limit(100);
          tbody.innerHTML = '';

          if (data) {
            data.forEach((item) => {
              const kst = this.toKST(item.scan_time);
              const tr = document.createElement('tr');
              tr.innerHTML = `
                    <td class="px-4 py-3">${kst.toLocaleString('ko-KR')}</td>
                    <td class="px-4 py-3 font-medium">${item.employee_name}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs ${item.attendance_type === 'ì¶œê·¼' ? 'bg-blue-100 text-blue-700' : item.attendance_type === 'í‡´ê·¼' ? 'bg-green-100 text-green-700' : 'bg-gray-100'}">${item.attendance_type}</span></td>
                    <td class="px-4 py-3 text-gray-500">${item.location || '-'}</td>
                 `;
              tbody.appendChild(tr);
            });
          } else {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
          }
        },

        // --- STATS ---
        changePeriod: function () {
          const p = document.getElementById('stats-period').value;
          document.getElementById('custom-range').classList.toggle('hidden', p !== 'custom');
          if (p !== 'custom') this.loadStats();
        },

        loadStats: async function () {
          const p = document.getElementById('stats-period').value;
          let start, end;
          const now = new Date();

          if (p === 'today') {
            start = new Date(now.setHours(0, 0, 0, 0));
            end = new Date(now.setHours(23, 59, 59, 999));
          } else if (p === 'week') {
            end = new Date();
            start = new Date();
            start.setDate(end.getDate() - 7);
          } else if (p === 'month') {
            start = new Date(now.getFullYear(), now.getMonth(), 1);
            end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          } else {
            if (!document.getElementById('custom-start').value) return;
            start = new Date(document.getElementById('custom-start').value);
            end = new Date(document.getElementById('custom-end').value);
            end.setHours(23, 59, 59);
          }

          // Fetch Data
          const { data: emps } = await this.sb
            .from('employees')
            .select('name')
            .eq('apartment_id', this.currentAptId)
            .eq('status', 'active');
          const { data: atts } = await this.sb
            .from('attendance_records')
            .select('*')
            .eq('apartment_id', this.currentAptId)
            .gte('scan_time', start.toISOString())
            .lte('scan_time', end.toISOString());
          const { data: cleans } = await this.sb
            .from('cleaning_tasks')
            .select('*')
            .eq('apartment_id', this.currentAptId)
            .gte('created_at', start.toISOString())
            .lte('created_at', end.toISOString());

          // KPI
          const total = emps ? emps.length : 0;
          const presentSet = new Set(
            atts ? atts.filter((a) => a.attendance_type === 'ì¶œê·¼').map((a) => a.employee_name) : [],
          );
          const present = presentSet.size;
          document.getElementById('stat-total').textContent = total;
          document.getElementById('stat-present').textContent = present;
          document.getElementById('stat-absent').textContent = total - present;

          // Calculate Work Hours
          const workMap = {}; // { empName: { date: { start, end, break } } }
          if (atts)
            atts.forEach((a) => {
              const kst = this.toKST(a.scan_time);
              const dateKey = kst.toISOString().split('T')[0];
              if (!workMap[a.employee_name]) workMap[a.employee_name] = {};
              if (!workMap[a.employee_name][dateKey]) workMap[a.employee_name][dateKey] = { events: [] };
              workMap[a.employee_name][dateKey].events.push({ type: a.attendance_type, time: kst });
            });

          const tableBody = document.getElementById('work-hours-table');
          tableBody.innerHTML = '';
          this.workHoursData = [];

          for (const emp of emps || []) {
            let totalHours = 0;
            let workDays = 0;
            const records = workMap[emp.name] || {};

            Object.values(records).forEach((day) => {
              day.events.sort((a, b) => a.time - b.time);
              const start = day.events.find((e) => e.type === 'ì¶œê·¼');
              const end = day.events.find((e) => e.type === 'í‡´ê·¼');
              if (start && end) {
                let duration = (end.time - start.time) / (1000 * 60 * 60);
                // Simple break logic: subtract 1h if > 4h
                if (duration > 4) duration -= 1;
                if (duration > 0) {
                  totalHours += duration;
                  workDays++;
                }
              }
            });

            const dailyAvg = workDays > 0 ? totalHours / workDays : 0;
            const periodDays = (end - start) / (1000 * 60 * 60 * 24);
            const weeks = Math.max(1, periodDays / 7);
            const weeklyAvg = workDays / weeks;

            this.workHoursData.push({
              name: emp.name,
              daily: dailyAvg,
              weekly: weeklyAvg,
              total: totalHours,
              days: workDays,
            });

            const tr = document.createElement('tr');
            tr.innerHTML = `
                 <td class="py-2 font-medium">${emp.name}</td>
                 <td class="py-2">${dailyAvg.toFixed(1)}h</td>
                 <td class="py-2">${weeklyAvg.toFixed(1)}ì¼</td>
                 <td class="py-2 text-blue-600 font-bold">${totalHours.toFixed(1)}h</td>
                 <td class="py-2">${workDays}ì¼</td>
                 <td class="py-2"><span class="px-2 py-0.5 rounded text-xs ${workDays > 0 ? 'bg-green-100 text-green-700' : 'bg-gray-100'}">${workDays > 0 ? 'ì •ìƒ' : 'ë¯¸ì¶œê·¼'}</span></td>
              `;
            tableBody.appendChild(tr);
          }

          // Cleaning Stats
          const locCounts = {};
          const empCounts = {};
          if (cleans)
            cleans.forEach((c) => {
              locCounts[c.location] = (locCounts[c.location] || 0) + 1;
              empCounts[c.employee_name] = (empCounts[c.employee_name] || 0) + 1;
            });

          this.renderStatsList(locCounts, 'location');
          this.renderStatsList(empCounts, 'employee');
          this.renderCharts(atts || [], cleans || []);
        },

        renderStatsList: function (counts, prefix) {
          const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
          const top3 = sorted.slice(0, 3);
          const div = document.getElementById(prefix + '-top3');
          div.innerHTML = '';
          top3.forEach((item, i) => {
            div.innerHTML += `<div class="flex justify-between items-center bg-gray-50 p-2 rounded text-sm"><span>${i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰'} ${item[0]}</span><span class="font-bold text-brand">${item[1]}ê±´</span></div>`;
          });
          if (sorted.length > 0) {
            document.getElementById(prefix + '-best-name').textContent = sorted[0][0];
            document.getElementById(prefix + '-best-count').textContent = sorted[0][1] + 'ê±´';
            document.getElementById(prefix + '-worst-name').textContent = sorted[sorted.length - 1][0];
            document.getElementById(prefix + '-worst-count').textContent = sorted[sorted.length - 1][1] + 'ê±´';
          }
        },

        renderCharts: function (atts, cleans) {
          // Basic chart rendering
          const daily = {};
          atts
            .filter((a) => a.attendance_type === 'ì¶œê·¼')
            .forEach((a) => {
              const d = a.scan_time.split('T')[0];
              daily[d] = (daily[d] || 0) + 1;
            });
          new Chart(document.getElementById('daily-chart'), {
            type: 'line',
            data: {
              labels: Object.keys(daily),
              datasets: [{ label: 'ì¶œê·¼', data: Object.values(daily), borderColor: '#3b82f6' }],
            },
            options: { maintainAspectRatio: false },
          });

          const locs = {};
          cleans.forEach((c) => (locs[c.location] = (locs[c.location] || 0) + 1));
          new Chart(document.getElementById('location-chart'), {
            type: 'doughnut',
            data: {
              labels: Object.keys(locs),
              datasets: [{ data: Object.values(locs), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'] }],
            },
            options: { maintainAspectRatio: false },
          });

          const emps = {};
          cleans.forEach((c) => (emps[c.employee_name] = (emps[c.employee_name] || 0) + 1));
          new Chart(document.getElementById('employee-chart'), {
            type: 'bar',
            data: {
              labels: Object.keys(emps),
              datasets: [{ label: 'ì²­ì†Œ', data: Object.values(emps), backgroundColor: '#8b5cf6' }],
            },
            options: { maintainAspectRatio: false },
          });

          const types = {};
          atts.forEach((a) => (types[a.attendance_type] = (types[a.attendance_type] || 0) + 1));
          new Chart(document.getElementById('type-chart'), {
            type: 'pie',
            data: {
              labels: Object.keys(types),
              datasets: [{ data: Object.values(types), backgroundColor: ['#3b82f6', '#6b7280', '#f59e0b', '#8b5cf6'] }],
            },
            options: { maintainAspectRatio: false },
          });
        },

        downloadWorkHours: function () {
          const ws = XLSX.utils.json_to_sheet(this.workHoursData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'WorkHours');
          XLSX.writeFile(wb, 'WorkHours.xlsx');
        },

        // --- DATA MANAGEMENT ---
        toggleEmployeeForm: function () {
          document.getElementById('employee-form').classList.toggle('hidden');
        },
        toggleLocationForm: function () {
          document.getElementById('location-form').classList.toggle('hidden');
        },

        loadEmployees: async function () {
          const { data } = await this.sb.from('employees').select('*').eq('apartment_id', this.currentAptId);
          const tbody = document.getElementById('employee-list');
          tbody.innerHTML = '';
          if (data)
            data.forEach((e) => {
              tbody.innerHTML += `<tr><td class="p-2">${e.name}</td><td class="p-2">${e.phone || '-'}</td><td class="p-2">${e.position || '-'}</td><td class="p-2 text-center"><button onclick="app.deleteItem('employees','${e.id}')" class="text-red-500"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        },
        saveEmployee: async function () {
          const name = document.getElementById('emp-name').value;
          if (!name) return alert('ì´ë¦„ í•„ìˆ˜');
          await this.sb.from('employees').insert([
            {
              name: name,
              phone: document.getElementById('emp-phone').value,
              position: document.getElementById('emp-position').value,
              status: 'active',
              apartment_id: this.currentAptId,
            },
          ]);
          this.loadEmployees();
          document.getElementById('employee-form').classList.add('hidden');
        },

        loadLocations: async function () {
          const { data } = await this.sb.from('locations').select('*').eq('apartment_id', this.currentAptId);
          const tbody = document.getElementById('location-list');
          tbody.innerHTML = '';
          if (data)
            data.forEach((l) => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td class="p-2">${l.name}</td>
                <td class="p-2">${l.floor || '-'}</td>
                <td class="p-2">${l.description || '-'}</td>
                <td class="p-2 text-center">
                  <button class="text-blue-600 hover:text-blue-800 mr-2" title="QR ìƒì„±">
                    <i class="fas fa-qrcode"></i>
                  </button>
                  <button class="text-red-500 hover:text-red-700" title="ì‚­ì œ">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              `;

              // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì§ì ‘ ì—°ê²°
              const qrBtn = tr.querySelectorAll('button')[0];
              qrBtn.addEventListener('click', () => this.generateLocationQR(l.id, l.name));

              const delBtn = tr.querySelectorAll('button')[1];
              delBtn.addEventListener('click', () => this.deleteItem('locations', l.id));

              tbody.appendChild(tr);
            });
        },
        saveLocation: async function () {
          const name = document.getElementById('loc-name').value;
          if (!name) return alert('êµ¬ì—­ëª… í•„ìˆ˜');
          await this.sb.from('locations').insert([
            {
              name: name,
              floor: document.getElementById('loc-floor').value,
              description: document.getElementById('loc-desc').value,
              status: 'active',
              code: 'LOC-' + Date.now(),
              apartment_id: this.currentAptId,
            },
          ]);
          this.loadLocations();
          document.getElementById('location-form').classList.add('hidden');
        },
        deleteItem: async function (table, id) {
          if (confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            await this.sb.from(table).delete().eq('id', id);
            if (table === 'employees') this.loadEmployees();
            else this.loadLocations();
          }
        },

        // QR ì½”ë“œ ìƒì„±
        generateLocationQR: function (locationId, locationName) {
          try {
            // ê°„ë‹¨í•œ URL ë°©ì‹ìœ¼ë¡œ ë³€ê²½ (ë” ì§§ì€ ë°ì´í„°)
            const qrData = `https://bdxi-qr-attendance.vercel.app/scan?loc=${locationId}&apt=${this.currentAptId}`;

            // QR ì½”ë“œ ìƒì„± (qrcode-generator ë¼ì´ë¸ŒëŸ¬ë¦¬)
            const qr = qrcode(0, 'M'); // Type 0 (ìë™ í¬ê¸°), Error correction M
            qr.addData(qrData);
            qr.make();

            // Canvas ìƒì„±
            const canvas = document.createElement('canvas');
            const size = 500;
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');

            // ë°°ê²½ (í°ìƒ‰)
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, size, size);

            // QR ëª¨ë“ˆ ê·¸ë¦¬ê¸°
            const moduleCount = qr.getModuleCount();
            const cellSize = size / moduleCount;

            for (let row = 0; row < moduleCount; row++) {
              for (let col = 0; col < moduleCount; col++) {
                if (qr.isDark(row, col)) {
                  ctx.fillStyle = '#000000';
                  ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                }
              }
            }

            // í•˜ë‹¨ì— í…ìŠ¤íŠ¸ ì¶”ê°€
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 20px "Noto Sans KR"';
            ctx.textAlign = 'center';
            ctx.fillText(locationName, size / 2, size - 20);

            // ë‹¤ìš´ë¡œë“œ
            const dataURL = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = dataURL;
            a.download = `QR_${locationName}_${APARTMENTS[this.currentAptId]}.png`;
            a.click();

            alert(
              `âœ… "${locationName}" QR ì½”ë“œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nğŸ’¡ ì´ QR ì½”ë“œë¥¼ í”„ë¦°íŠ¸í•´ì„œ í•´ë‹¹ êµ¬ì—­ì— ë¶€ì°©í•˜ì„¸ìš”.\n\nğŸ“± QR ì½”ë“œ ìŠ¤ìº” ì‹œ í•´ë‹¹ êµ¬ì—­ìœ¼ë¡œ ìë™ ì—°ê²°ë©ë‹ˆë‹¤.`,
            );
          } catch (error) {
            console.error('QR ìƒì„± ì‹¤íŒ¨:', error);
            alert('âŒ QR ì½”ë“œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\nìƒì„¸: ' + error.message);
          }
        },

        // --- CSV & EXPORT ---
        downloadTemplate: function (type) {
          let headers = [];
          if (type === 'employees') headers = ['name', 'phone', 'position', 'status'];
          if (type === 'locations') headers = ['name', 'floor', 'description', 'status'];
          if (type === 'cleaning_tasks') headers = ['employee_name', 'location', 'notes', 'created_at'];
          if (type === 'attendance_records') headers = ['employee_name', 'attendance_type', 'location', 'scan_time'];

          const csv = headers.join(',') + '\n' + (type === 'employees' ? 'í™ê¸¸ë™,010-0000-0000,ë¯¸í™”ì›,active' : '');
          const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = type + '_template.csv';
          a.click();
        },

        handleCSVUpload: function (e, table) {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = async (evt) => {
            const text = evt.target.result;
            const rows = text
              .split('\n')
              .slice(1)
              .filter((r) => r.trim());
            const keys = text
              .split('\n')[0]
              .split(',')
              .map((k) => k.trim());

            const data = rows.map((r, i) => {
              const vals = r.split(',');
              const obj = { apartment_id: this.currentAptId };
              keys.forEach((k, idx) => (obj[k] = vals[idx]?.trim()));
              if (table === 'locations') obj.code = 'LOC-' + Date.now() + '-' + i;
              return obj;
            });

            const { error } = await this.sb.from(table).insert(data);
            if (error) alert('Error: ' + error.message);
            else {
              alert('ì—…ë¡œë“œ ì™„ë£Œ');
              if (table === 'employees') this.loadEmployees();
              if (table === 'locations') this.loadLocations();
            }
          };
          reader.readAsText(file);
        },

        downloadData: async function () {
          const tables = ['employees', 'locations', 'cleaning_tasks', 'attendance_records'];
          const wb = XLSX.utils.book_new();

          for (const t of tables) {
            const { data } = await this.sb.from(t).select('*').eq('apartment_id', this.currentAptId);
            if (data) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), t);
          }
          XLSX.writeFile(wb, `Backup_${this.currentAptId}.xlsx`);
        },
      };

      document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
  <script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"9c367590ebc33270","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.9.1","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>
