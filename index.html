
<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KINDWON Admin Dashboard</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&amp;display=swap" rel="stylesheet">

    <!-- CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <style>
      body {
        font-family: 'Noto Sans KR', sans-serif;
      }
      .bg-gradient-brand {
        background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
      }
      .text-brand {
        color: #1b5e3e;
      }
      .bg-brand {
        background-color: #1b5e3e;
      }
      .tab-active {
        border-bottom: 3px solid #1b5e3e;
        color: #1b5e3e;
        font-weight: 700;
      }
      .tab-inactive {
        border-bottom: 3px solid transparent;
        color: #6b7280;
      }
      .loader {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #1b5e3e;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      
      /* Skeleton Loading */
      .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 0.5rem;
      }
      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }
      .skeleton-text {
        height: 1rem;
        margin: 0.5rem 0;
      }
      .skeleton-img {
        height: 12rem;
        width: 100%;
      }
      
      /* Lazy Loading */
      .lazy-image {
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
      }
      .lazy-image.fade-in {
        opacity: 1;
      }
      
      /* Smooth transitions */
      * {
        transition:
          color 0.2s ease,
          background-color 0.2s ease;
      }
      
      /* Tab Content - CRITICAL FIX */
      .tab-content {
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
        height: auto !important;
        min-height: 200px !important;
      }
      .tab-content.hidden {
        display: none !important;
      }

      /* Modal */
      .modal-backdrop {
        backdrop-filter: blur(8px);
        animation: fadeIn 0.2s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* Dropdown */
      .dropdown-item:hover {
        background-color: #f3f4f6;
      }
    </style>
</head>
  <body class="bg-gray-50 min-h-screen">
    <!-- LOGIN VIEW -->
    <div id="view-login" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-brand hidden">
      <div class="bg-white p-10 rounded-2xl shadow-2xl w-full max-w-md text-center transform transition-all hover:scale-[1.01]">
        <div class="mb-10">
          <img src="./logo.png" alt="KINDWON Logo" class="h-16 mx-auto" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'h-16 w-16 bg-brand text-white rounded-full flex items-center justify-center mx-auto text-2xl font-bold\'>K</div>'">
        </div>

        <h1 class="text-3xl font-extrabold text-gray-800 mb-2">ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
        <p class="text-gray-500 mb-2 text-sm">KINDWON ê´€ë¦¬ì ì‹œìŠ¤í…œ</p>
        <p class="text-gray-400 mb-8 text-xs">ì ‘ì†ì„ ìœ„í•´ PINì„ ì…ë ¥í•˜ì„¸ìš”</p>

        <div class="space-y-4">
          <input type="password" id="inp-pin" placeholder="PIN ì…ë ¥" class="w-full text-center text-2xl font-bold tracking-[0.3em] py-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-green-600 transition-colors" maxlength="10" onkeypress="if (event.key === 'Enter') app.login();">

          <button onclick="app.login()" class="w-full bg-brand hover:bg-green-800 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95">
            <i class="fas fa-sign-in-alt mr-2"></i>ì ‘ì†í•˜ê¸°
          </button>
        </div>

        <p id="msg-error" class="hidden mt-4 text-red-600 text-sm font-bold">
          <i class="fas fa-exclamation-triangle mr-1"></i>PIN ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </p>
      </div>
    </div>

    <!-- DASHBOARD VIEW -->
    <div id="view-dashboard" class="min-h-screen flex flex-col hidden">
      <!-- Header -->
      <header class="bg-white border-b sticky top-0 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
          <div class="flex items-center gap-2 md:gap-4" style="min-width: 0;">
            <img src="./logo.png" alt="KINDWON Logo" class="h-8 md:h-10" style="display: block !important; flex-shrink: 0; min-width: 32px; width: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='none'; this.parentElement.innerHTML='<div class=\'h-8 w-8 bg-brand text-white rounded flex items-center justify-center font-bold\'>K</div><div class=\'ml-2 font-bold text-gray-800\'>KINDWON</div>'">
            <span class="text-gray-300 hidden md:inline-block">|</span>
            <div class="flex-shrink-0">
              <div class="font-bold text-gray-800 text-base md:text-lg whitespace-nowrap">KINDWON</div>
              <div class="text-xs text-gray-400 -mt-1 whitespace-nowrap">ê´€ë¦¬ì ì‹œìŠ¤í…œ</div>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="hidden md:flex items-center gap-2 text-sm text-gray-500 bg-gray-50 px-3 py-1.5 rounded-lg border">
              <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
              <span id="live-time" class="font-mono">--:--:--</span>
            </div>
            <button onclick="app.logout()" class="px-4 py-2 text-sm bg-gray-800 text-white rounded-lg hover:bg-gray-900 transition-colors">
              <i class="fas fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ
            </button>
          </div>
        </div>
      </header>

      <!-- Nav -->
      <nav class="bg-white border-b sticky top-16 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4">
          <div class="flex space-x-8">
            <button onclick="app.switchTab('gallery')" class="nav-tab py-4 px-2 text-sm font-medium transition-all tab-active">
              <i class="fas fa-images mr-2"></i>ì²­ì†Œ ê°¤ëŸ¬ë¦¬
            </button>
            <button onclick="app.switchTab('history')" class="nav-tab py-4 px-2 text-sm font-medium transition-all tab-inactive">
              <i class="fas fa-history mr-2"></i>ìƒì„¸ ì¡°íšŒ
            </button>
            <button onclick="app.switchTab('stats')" class="nav-tab py-4 px-2 text-sm font-medium transition-all tab-inactive">
              <i class="fas fa-chart-bar mr-2"></i>í†µê³„ ìš”ì•½
            </button>
            <button onclick="app.switchTab('data')" class="nav-tab py-4 px-2 text-sm font-medium transition-all tab-inactive">
              <i class="fas fa-database mr-2"></i>ë°ì´í„° ê´€ë¦¬
            </button>
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="flex-1 max-w-7xl w-full mx-auto px-4 py-6">
        <!-- TAB 1: Gallery -->
        <div id="tab-gallery" class="tab-content space-y-6">
          <!-- Search Bar -->
          <div class="bg-white p-4 rounded-xl shadow-sm border">
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-search text-gray-400"></i>
              </div>
              <input type="text" id="quick-search" placeholder="ì§ì›ëª…, ì•„íŒŒíŠ¸ëª…ìœ¼ë¡œ ë¹ ë¥¸ ê²€ìƒ‰..." class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" oninput="app.quickSearch(this.value)">
              <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                <span id="search-count" class="text-sm text-gray-500"></span>
              </div>
            </div>
          </div>

          <!-- Filters -->
          <div class="bg-white p-6 rounded-xl shadow-sm border space-y-4">
            <div class="flex justify-between items-center">
              <h3 class="font-bold text-gray-800"><i class="fas fa-filter mr-2 text-brand"></i>ìƒì„¸ í•„í„°</h3>
              <button onclick="app.toggleFilters()" class="text-sm text-gray-600 hover:text-gray-800">
                <i class="fas fa-chevron-down" id="filter-toggle-icon"></i>
              </button>
            </div>
            <div id="filter-panel" class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ ë²”ìœ„</label>
                  <div class="flex gap-2">
                    <input type="date" id="filter-date-start" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 text-sm">
                    <span class="flex items-center text-gray-500">~</span>
                    <input type="date" id="filter-date-end" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 text-sm">
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ì§ì›</label>
                  <div class="relative">
                    <input type="text" id="filter-employee-input" placeholder="ì´ë¦„ ê²€ìƒ‰..." class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" oninput="app.searchEmployee(this.value)">
                    <div id="filter-employee-dropdown" class="absolute top-full left-0 right-0 mt-1 bg-white border rounded-lg shadow-lg max-h-48 overflow-y-auto z-10 hidden">
                      <!-- Items injected via JS -->
                    </div>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ìœ„ì¹˜</label>
                  <select id="filter-location" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    <option value="">ì „ì²´ ìœ„ì¹˜</option>
                  </select>
                </div>
              </div>
              <div class="flex gap-2">
                <button onclick="app.applyGalleryFilters()" class="px-4 py-2 bg-brand text-white rounded-lg hover:bg-green-700 transition-colors shadow-sm">
                  <i class="fas fa-search mr-2"></i>ì ìš©
                </button>
                <button onclick="app.resetGalleryFilters()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                  <i class="fas fa-redo mr-2"></i>ì´ˆê¸°í™”
                </button>
              </div>
            </div>
          </div>

          <!-- Gallery Grid -->
          <div class="flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-800">
              ğŸ“· ì²­ì†Œ ì‘ì—… ê°¤ëŸ¬ë¦¬ 
              <span id="gallery-count" class="text-sm text-gray-500 font-normal"></span>
            </h2>
            <button onclick="app.loadGallery()" class="text-sm bg-white border px-3 py-1 rounded shadow-sm hover:bg-gray-50">
              <i class="fas fa-sync-alt mr-1"></i>ìƒˆë¡œê³ ì¹¨
            </button>
          </div>

          <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
            <!-- Items injected by JS -->
          </div>
        </div>

        <!-- TAB 2: History -->
        <div id="tab-history" class="tab-content space-y-6 hidden">
          <!-- Search Bar -->
          <div class="bg-white p-4 rounded-xl shadow-sm border">
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-search text-gray-400"></i>
              </div>
              <input type="text" id="history-quick-search" placeholder="ì§ì›, ìœ„ì¹˜ ê²€ìƒ‰..." class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" oninput="app.quickSearchHistory(this.value)">
              <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                <span id="history-search-count" class="text-sm text-gray-500"></span>
              </div>
            </div>
          </div>

          <!-- Filters -->
          <div class="bg-white p-6 rounded-xl shadow-sm border space-y-4">
            <div class="flex justify-between items-center">
              <h3 class="font-bold text-gray-800"><i class="fas fa-filter mr-2 text-brand"></i>ìƒì„¸ í•„í„°</h3>
              <button onclick="app.toggleHistoryFilters()" class="text-sm text-gray-600 hover:text-gray-800">
                <i class="fas fa-chevron-down" id="history-filter-toggle-icon"></i>
              </button>
            </div>
            <div id="history-filter-panel" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì‹œì‘ì¼</label>
                <input type="date" id="hist-start" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì¢…ë£Œì¼</label>
                <input type="date" id="hist-end" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì§ì›</label>
                <div class="relative">
                  <input type="text" id="hist-employee-input" placeholder="ì´ë¦„ ê²€ìƒ‰..." class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
                  <div id="hist-employee-dropdown" class="absolute top-full left-0 right-0 mt-1 bg-white border rounded-lg shadow-lg max-h-48 overflow-y-auto z-10 hidden"></div>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ìœ í˜•</label>
                <select id="hist-type" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
                  <option value="">ì „ì²´</option>
                  <option value="ì¶œê·¼">ì¶œê·¼</option>
                  <option value="í‡´ê·¼">í‡´ê·¼</option>
                  <option value="íœ´ê²Œ ì‹œì‘">íœ´ê²Œ ì‹œì‘</option>
                  <option value="íœ´ê²Œ ì¢…ë£Œ">íœ´ê²Œ ì¢…ë£Œ</option>
                </select>
              </div>
            </div>
            <button onclick="app.applyHistoryFilters()" class="px-4 py-2 bg-brand text-white rounded-lg hover:bg-green-700">
              <i class="fas fa-search mr-2"></i>ê²€ìƒ‰
            </button>
          </div>
          </div>

          <!-- Table -->
          <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë‚ ì§œ/ì‹œê°„</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì§ì›</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìœ í˜•</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìœ„ì¹˜</th>
                  </tr>
                </thead>
                <tbody id="history-list" class="divide-y divide-gray-100">
                  <!-- JS Injected -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- TAB 3: Stats -->
        <div id="tab-stats" class="tab-content space-y-6 hidden">
          <!-- Realtime Status -->
          <div class="bg-gradient-to-r from-green-600 to-green-700 p-6 rounded-xl shadow-lg text-white">
            <div class="flex items-center justify-between">
              <div>
                <h2 class="text-2xl font-bold mb-2">ğŸ“Š ì‹¤ì‹œê°„ í˜„í™©</h2>
                <p class="text-green-100 text-sm">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="last-update-time">-</span></p>
              </div>
              <button onclick="app.loadStats()" class="px-4 py-2 bg-white text-green-600 rounded-lg hover:bg-green-50 transition-colors font-medium">
                <i class="fas fa-sync-alt mr-2"></i>ìƒˆë¡œê³ ì¹¨
              </button>
            </div>
          </div>

          <!-- Range Selector -->
          <div class="bg-white p-6 rounded-xl shadow-sm border">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-bold text-gray-800"><i class="fas fa-calendar-alt mr-2 text-brand"></i>ì¡°íšŒ ê¸°ê°„</h3>
            </div>
            <div class="flex flex-wrap gap-2 mb-4">
              <select id="stats-period" onchange="app.changePeriod()" class="px-4 py-2 border rounded-lg">
                <option value="today">ì˜¤ëŠ˜</option>
                <option value="week">ì´ë²ˆ ì£¼ (7ì¼)</option>
                <option value="month">ì´ë²ˆ ë‹¬</option>
                <option value="custom">ì‚¬ìš©ì ì§€ì •</option>
              </select>
            </div>
            <div id="custom-range" class="hidden grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm mb-1">ì‹œì‘ì¼</label>
                <input type="date" id="custom-start" class="w-full px-3 py-2 border rounded-lg">
              </div>
              <div>
                <label class="block text-sm mb-1">ì¢…ë£Œì¼</label>
                <input type="date" id="custom-end" class="w-full px-3 py-2 border rounded-lg">
              </div>
              <button onclick="app.loadStats()" class="col-span-2 px-4 py-2 bg-brand text-white rounded-lg hover:bg-green-700">
                <i class="fas fa-search mr-2"></i>ì¡°íšŒ
              </button>
            </div>
          </div>

          <!-- Cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-l-4 border-l-blue-500">
              <div class="flex justify-between items-start">
                <div>
                  <p class="text-sm text-gray-500 mb-1">ì´ì›</p>
                  <p class="text-3xl font-bold text-gray-800"><span id="stat-total">0</span></p>
                </div>
                <div class="p-3 bg-blue-50 rounded-lg">
                  <i class="fas fa-users text-2xl text-blue-500"></i>
                </div>
              </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-l-4 border-l-red-500">
              <div class="flex justify-between items-start">
                <div>
                  <p class="text-sm text-gray-500 mb-1">íœ´ê°€/ê²°ê·¼</p>
                  <p class="text-3xl font-bold text-gray-800"><span id="stat-absent">0</span></p>
                </div>
                <div class="p-3 bg-red-50 rounded-lg">
                  <i class="fas fa-user-times text-2xl text-red-500"></i>
                </div>
              </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-l-4 border-l-green-500">
              <div class="flex justify-between items-start">
                <div>
                  <p class="text-sm text-gray-500 mb-1">í˜„ì§€ì›</p>
                  <p class="text-3xl font-bold text-gray-800"><span id="stat-present">0</span></p>
                </div>
                <div class="p-3 bg-green-50 rounded-lg">
                  <i class="fas fa-user-check text-2xl text-green-500"></i>
                </div>
              </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-l-4 border-l-purple-500">
              <div class="flex justify-between items-start">
                <div>
                  <p class="text-sm text-gray-500 mb-1">ì²­ì†Œ ì‘ì—…</p>
                  <p class="text-3xl font-bold text-gray-800"><span id="stat-cleaning">0</span></p>
                </div>
                <div class="p-3 bg-purple-50 rounded-lg">
                  <i class="fas fa-broom text-2xl text-purple-500"></i>
                </div>
              </div>
            </div>
          </div>

          <!-- Hours Table -->
          <div class="bg-white p-6 rounded-xl shadow-sm border">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-gray-800">
                <i class="fas fa-clock mr-2 text-blue-600"></i>ì§ì›ë³„ ê·¼ë¡œì‹œê°„ ì§‘ê³„
              </h3>
              <button onclick="app.exportHoursToExcel()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                <i class="fas fa-file-excel mr-2"></i>Excel ë‹¤ìš´ë¡œë“œ
              </button>
            </div>
            <p class="text-sm text-gray-600 mb-4">ê° ì§ì›ì˜ ì¼ë³„, ì£¼ë³„, ì›”ë³„ ì´ ê·¼ë¡œì‹œê°„ì„ í™•ì¸í•˜ì„¸ìš”.</p>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì§ì›ëª…</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì§ì±…</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">ì¼ë³„ (ì˜¤ëŠ˜)</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">ì£¼ë³„ (7ì¼)</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">ì›”ë³„ (ì´ë²ˆë‹¬)</th>
                  </tr>
                </thead>
                <tbody id="hours-table-body" class="divide-y divide-gray-100">
                  <!-- JS injected -->
                </tbody>
                <tfoot class="bg-gray-50 font-bold">
                  <tr>
                    <td class="px-4 py-3 text-sm text-gray-800" colspan="2">í•©ê³„</td>
                    <td class="px-4 py-3 text-right text-sm text-gray-800"><span id="total-daily">0.0</span>h</td>
                    <td class="px-4 py-3 text-right text-sm text-gray-800"><span id="total-weekly">0.0</span>h</td>
                    <td class="px-4 py-3 text-right text-sm text-gray-800"><span id="total-monthly">0.0</span>h</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <!-- Charts -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border">
              <h3 class="font-bold text-gray-800 mb-4">ì¼ë³„ ì¶œê·¼ í˜„í™©</h3>
              <div class="h-64">
                <canvas id="daily-chart"></canvas>
              </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border">
              <h3 class="font-bold text-gray-800 mb-4">êµ¬ì—­ë³„ ì²­ì†Œ ì‘ì—…</h3>
              <div class="h-64">
                <canvas id="location-chart"></canvas>
              </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border">
              <h3 class="font-bold text-gray-800 mb-4">ì§ì›ë³„ ì‘ì—…ëŸ‰</h3>
              <div class="h-64">
                <canvas id="employee-chart"></canvas>
              </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border">
              <h3 class="font-bold text-gray-800 mb-4">ê·¼íƒœ ìœ í˜• ë¶„í¬</h3>
              <div class="h-64">
                <canvas id="type-chart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- TAB 4: Data -->
        <div id="tab-data" class="tab-content space-y-6 hidden">
          <!-- Employee Management -->
          <div class="bg-white p-6 rounded-xl shadow-sm border">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-gray-800">
                <i class="fas fa-users mr-2 text-purple-600"></i>ì§ì› ê´€ë¦¬
              </h3>
              <button onclick="app.showAddEmployeeModal()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                <i class="fas fa-plus mr-2"></i>ì§ì› ì¶”ê°€
              </button>
            </div>
            <p class="text-sm text-gray-600 mb-4">ì§ì› ì •ë³´ë¥¼ ê´€ë¦¬í•˜ê³  ìƒíƒœë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì´ë¦„</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì—°ë½ì²˜</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìƒíƒœ</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë“±ë¡ì¼</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ê´€ë¦¬</th>
                  </tr>
                </thead>
                <tbody id="employee-list" class="divide-y divide-gray-100">
                  <!-- JS Injected -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Location Management -->
          <div class="bg-white p-6 rounded-xl shadow-sm border">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-gray-800">
                <i class="fas fa-map-marker-alt mr-2 text-red-600"></i>êµ¬ì—­ ê´€ë¦¬
              </h3>
              <button onclick="app.showAddLocationModal()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                <i class="fas fa-plus mr-2"></i>êµ¬ì—­ ì¶”ê°€
              </button>
            </div>
            <p class="text-sm text-gray-600 mb-4">ì²­ì†Œ êµ¬ì—­ ì •ë³´ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">êµ¬ì—­ëª…</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìƒíƒœ</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë“±ë¡ì¼</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ê´€ë¦¬</th>
                  </tr>
                </thead>
                <tbody id="location-list" class="divide-y divide-gray-100">
                  <!-- JS Injected -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- QR Codes -->
          <div class="bg-white p-6 rounded-xl shadow-sm border">
            <h3 class="font-bold text-gray-800 mb-4">
              <i class="fas fa-qrcode mr-2 text-blue-600"></i>êµ¬ì—­ë³„ QR ì½”ë“œ ìƒì„±
            </h3>
            <p class="text-sm text-gray-600 mb-4">ê° ì²­ì†Œ êµ¬ì—­ë³„ QR ì½”ë“œë¥¼ ìƒì„±í•˜ê³  ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <div id="qr-location-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <!-- JS Injected -->
            </div>
          </div>

          <!-- Export -->
          <div class="bg-white p-6 rounded-xl shadow-sm border">
            <h3 class="font-bold text-gray-800 mb-4">
              <i class="fas fa-file-excel mr-2 text-green-600"></i>ë°ì´í„° ë‚´ë³´ë‚´ê¸°
            </h3>
            <p class="text-sm text-gray-600 mb-4">í˜„ì¬ í‘œì‹œëœ ëª¨ë“  ë°ì´í„°ë¥¼ Excel íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.</p>
            <button onclick="app.downloadData()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors shadow-md">
              <i class="fas fa-download mr-2"></i>Excel ë‹¤ìš´ë¡œë“œ
            </button>
          </div>
        </div>
      </main>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" class="fixed inset-0 z-50 hidden modal-backdrop bg-black/80 flex items-center justify-center p-4" onclick="if (event.target === this) app.closeModal();">
      <div class="bg-white rounded-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden shadow-2xl flex flex-col" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center p-4 border-b bg-gray-50">
          <div>
            <p class="font-bold text-gray-800 text-lg" id="modal-employee-name"></p>
            <p class="text-sm text-gray-500" id="modal-time"></p>
          </div>
          <button onclick="app.closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 bg-gray-100" id="modal-content">
          <!-- Content injected here -->
        </div>
        <div class="p-4 border-t bg-white hidden" id="modal-footer">
           <!-- Notes or extras -->
        </div>
      </div>
    </div>

    <!-- Employee Modal -->
    <div id="employee-modal" class="fixed inset-0 z-50 hidden modal-backdrop bg-black/80 flex items-center justify-center p-4" onclick="if (event.target === this) app.closeEmployeeModal();">
      <div class="bg-white rounded-2xl max-w-md w-full shadow-2xl" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center p-6 border-b">
          <h3 class="text-xl font-bold text-gray-800">ì§ì› ì¶”ê°€</h3>
          <button onclick="app.closeEmployeeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë¦„</label>
            <input type="text" id="new-employee-name" placeholder="ì§ì› ì´ë¦„" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ì—°ë½ì²˜</label>
            <input type="text" id="new-employee-phone" placeholder="010-1234-5678" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ìƒíƒœ</label>
            <select id="new-employee-status" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
              <option value="active">í™œì„±</option>
              <option value="inactive">ë¹„í™œì„±</option>
            </select>
          </div>
          <button onclick="app.addEmployee()" class="w-full px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium">
            <i class="fas fa-plus mr-2"></i>ì§ì› ë“±ë¡
          </button>
        </div>
      </div>
    </div>

    <!-- Location Modal -->
    <div id="location-modal" class="fixed inset-0 z-50 hidden modal-backdrop bg-black/80 flex items-center justify-center p-4" onclick="if (event.target === this) app.closeLocationModal();">
      <div class="bg-white rounded-2xl max-w-md w-full shadow-2xl" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center p-6 border-b">
          <h3 class="text-xl font-bold text-gray-800">êµ¬ì—­ ì¶”ê°€</h3>
          <button onclick="app.closeLocationModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">êµ¬ì—­ëª…</label>
            <input type="text" id="new-location-name" placeholder="ì˜ˆ: 101ë™ 1ì¸µ ë¡œë¹„" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ìƒíƒœ</label>
            <select id="new-location-status" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
              <option value="active">í™œì„±</option>
              <option value="inactive">ë¹„í™œì„±</option>
            </select>
          </div>
          <button onclick="app.addLocation()" class="w-full px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium">
            <i class="fas fa-plus mr-2"></i>êµ¬ì—­ ë“±ë¡
          </button>
        </div>
      </div>
    </div>


    <!-- JavaScript -->
    <script>
      const SUPABASE_URL = 'https://qgpqhtuynxhmgawakjxe.supabase.co';
      const SUPABASE_ANON_KEY =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFncHFodHV5bnhobWdhd2FranhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyOTQyNTEsImV4cCI6MjA4Mjg3MDI1MX0.WNljQIKDbeZCDlXe8fpBdZs58XRFfujGt7lBGfq_pVg';
      const LOGIN_PIN = 'bdxi2026';

      const app = {
        sb: null,
        charts: {},
        employeeList: [],
        state: {
          galleryData: []
        },

        init: async function () {
          this.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          this.checkLogin();

          setInterval(() => this.updateClock(), 1000);
          this.updateClock();

          setTimeout(() => {
            this.setupEmployeeSearch('filter-employee-input', 'filter-employee-dropdown');
            this.setupEmployeeSearch('hist-employee-input', 'hist-employee-dropdown');
          }, 1000);
        },

        setupEmployeeSearch: function (inputId, dropdownId) {
          const input = document.getElementById(inputId);
          const list = document.getElementById(dropdownId);
          if (!input || !list) return;

          const handler = () => {
            const val = input.value.trim().toLowerCase();
            list.innerHTML = '';
            if (!val) {
              list.classList.add('hidden');
              return;
            }
            const filtered = this.employeeList.filter((e) => e.name.toLowerCase().includes(val));
            filtered.forEach((emp) => {
              const div = document.createElement('div');
              div.className = 'dropdown-item px-3 py-2 cursor-pointer text-sm';
              div.textContent = emp.name;
              div.onclick = () => {
                input.value = emp.name;
                list.classList.add('hidden');
              };
              list.appendChild(div);
            });
            if (filtered.length > 0) list.classList.remove('hidden');
            else list.classList.add('hidden');
          };

          input.addEventListener('input', handler);
          input.addEventListener('focus', handler);

          // Hide dropdown when clicking outside
          document.addEventListener('click', (e) => {
            if (!input.contains(e.target) && !list.contains(e.target)) {
              list.classList.add('hidden');
            }
          });
        },

        updateClock: function () {
          const now = new Date();
          const time = now.toLocaleTimeString('ko-KR', { hour12: false });
          const el = document.getElementById('live-time');
          if (el) el.textContent = time;
        },

        login: function () {
          const pin = document.getElementById('inp-pin').value;
          if (pin === LOGIN_PIN) {
            sessionStorage.setItem('kindwon_login', 'true');
            this.showDashboard();
          } else {
            document.getElementById('msg-error').classList.remove('hidden');
          }
        },

        logout: function () {
          if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            sessionStorage.removeItem('kindwon_login');
            location.reload();
          }
        },

        checkLogin: function () {
          if (sessionStorage.getItem('kindwon_login') === 'true') {
            this.showDashboard();
          } else {
            document.getElementById('view-login').classList.remove('hidden');
            document.getElementById('view-dashboard').classList.add('hidden');
          }
        },

        showDashboard: function () {
          document.getElementById('view-login').classList.add('hidden');
          document.getElementById('view-dashboard').classList.remove('hidden');
          this.switchTab('gallery');
        },

        switchTab: function (tab) {
          document.querySelectorAll('.tab-content').forEach((el) => {
            el.classList.add('hidden');
          });
          const targetTab = document.getElementById(`tab-${tab}`);
          if (targetTab) {
            targetTab.classList.remove('hidden');
          }

          document.querySelectorAll('.nav-tab').forEach((el) => {
            el.classList.remove('tab-active');
            el.classList.add('tab-inactive');
          });

          const btn = document.querySelector(`button[onclick="app.switchTab('${tab}')"]`);
          if (btn) {
            btn.classList.remove('tab-inactive');
            btn.classList.add('tab-active');
          }

          if (tab === 'gallery') {
            this.loadGallery();
            this.loadMeta();
          } else if (tab === 'history') {
            this.loadHistory();
            this.loadMeta();
          } else if (tab === 'stats') {
            this.loadStats();
            // Update last-update-time
            const now = new Date();
            document.getElementById('last-update-time').textContent = now.toLocaleString('ko-KR');
          } else if (tab === 'data') {
            this.loadEmployees();
            this.loadLocations();
            this.loadQRCodes();
          }
        },

        loadMeta: async function () {
          if (this.employeeList.length > 0) return;
          try {
            const { data } = await this.sb.from('employees').select('name').eq('status', 'active');
            if (data) this.employeeList = data;

            const locRes = await this.sb.from('locations').select('name').eq('status', 'active');
            if (locRes.data) {
              const select = document.getElementById('filter-location');
              select.innerHTML = '<option value="">ì „ì²´ ìœ„ì¹˜</option>';
              locRes.data.forEach((l) => {
                const opt = document.createElement('option');
                opt.value = l.name;
                opt.textContent = l.name;
                select.appendChild(opt);
              });
            }
          } catch (e) {}
        },

        // Skeleton UI
        showSkeletonLoading: function(containerId, count = 8) {
          const container = document.getElementById(containerId);
          container.innerHTML = '';
          
          for (let i = 0; i < count; i++) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow overflow-hidden';
            div.innerHTML = `
              <div class="skeleton skeleton-img"></div>
              <div class="p-3">
                <div class="skeleton skeleton-text w-3/4"></div>
                <div class="skeleton skeleton-text w-1/2"></div>
              </div>
            `;
            container.appendChild(div);
          }
        },

        // --- NEW GALLERY LOGIC START ---

        loadGallery: async function () {
          const grid = document.getElementById('gallery-grid');
          
          this.showSkeletonLoading('gallery-grid', 8);

          try {
            let q = this.sb.from('cleaning_tasks').select('*').order('created_at', { ascending: false });

            const dateStart = document.getElementById('filter-date-start').value;
            const dateEnd = document.getElementById('filter-date-end').value;
            const emp = document.getElementById('filter-employee-input').value;
            const loc = document.getElementById('filter-location').value;

            // Date filtering
            if (dateStart) {
              const startUTC = new Date(dateStart + 'T00:00:00+09:00').toISOString();
              q = q.gte('created_at', startUTC);
            }
            if (dateEnd) {
              const endUTC = new Date(dateEnd + 'T23:59:59+09:00').toISOString();
              q = q.lte('created_at', endUTC);
            }
            if (emp) q = q.ilike('employee_name', `%${emp}%`);
            if (loc !== '') q = q.eq('location', loc);

            const { data, error } = await q.limit(200);

            if (error) {
              console.error('Gallery load error:', error);
              grid.innerHTML = '<div class="col-span-full text-center py-20 text-red-500">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message + '</div>';
              return;
            }

            console.log('ğŸ” [LOAD] Query result:', { dataCount: data?.length || 0 });

            if (data && data.length > 0) {
              // Grouping Logic
              console.log('ğŸ” [LOAD] Starting grouping...');
              const groupedData = this.groupPhotosByGroupId(data);
              console.log('âœ… [LOAD] Grouping complete. Groups:', groupedData.length);
              
              document.getElementById('gallery-count').textContent = `(${groupedData.length})`;
              grid.innerHTML = ''; // Clear skeleton

              groupedData.forEach((group) => {
                const card = this.createGalleryCard(group);
                grid.appendChild(card);
              });
              
              // Lazy Loading 
              this.initLazyLoading();
            } else {
              grid.innerHTML = '<div class="col-span-full text-center py-20 text-gray-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
              document.getElementById('gallery-count').textContent = '(0)';
            }
          } catch (e) {
            console.error(e);
            grid.innerHTML = '<div class="col-span-full text-center text-red-500">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
          }
        },

        groupPhotosByGroupId: function (photos) {
          const groups = {};
          photos.forEach((photo) => {
            // êµ¬ë²„ì „: photo_urls (jsonb ë°°ì—´)
            if (photo.photo_urls && Array.isArray(photo.photo_urls) && photo.photo_urls.length > 0) {
              photo.photo_urls.forEach((url, index) => {
                const syntheticPhoto = {
                  ...photo,
                  photo_url: url,
                  photo_order: index,
                  upload_type: photo.photo_urls.length > 1 ? 'multiple' : 'single',
                };
                const groupKey = photo.photo_urls.length > 1 ? `legacy_${photo.id}` : `single_legacy_${photo.id}_${index}`;
                if (!groups[groupKey]) groups[groupKey] = [];
                groups[groupKey].push(syntheticPhoto);
              });
            }
            // ì‹ ë²„ì „: photo_url + group_id
            else if (photo.photo_url) {
              if (photo.group_id) {
                if (!groups[photo.group_id]) groups[photo.group_id] = [];
                groups[photo.group_id].push(photo);
              } else {
                const uniqueKey = `single_${photo.id}`;
                groups[uniqueKey] = [photo];
              }
            }
          });
          
          Object.values(groups).forEach((group) => {
            group.sort((a, b) => (a.photo_order || 0) - (b.photo_order || 0));
          });
          
          return Object.values(groups).sort((a, b) => {
            const dateA = new Date(a[0].created_at);
            const dateB = new Date(b[0].created_at);
            return dateB - dateA;
          });
        },

        createGalleryCard: function (group) {
          const div = document.createElement('div');
          div.className = 'gallery-item bg-white rounded-lg shadow hover:shadow-lg transition-shadow overflow-hidden cursor-pointer';
          
          const firstPhoto = group[0];
          const count = group.length;
          const isBeforeAfter = firstPhoto.upload_type === 'before_after' && count === 2;
          
          let imageHTML = '';
          
          if (isBeforeAfter) {
             // Split View
             imageHTML = `
                <div class="grid grid-cols-2 h-48">
                    <div class="relative border-r border-white/20">
                        <img src="${group[0].photo_url}" class="w-full h-full object-cover" loading="lazy" />
                        <div class="absolute top-2 left-2 bg-blue-600/90 text-white text-[10px] px-2 py-0.5 rounded shadow">Before</div>
                    </div>
                    <div class="relative">
                        <img src="${group[1].photo_url}" class="w-full h-full object-cover" loading="lazy" />
                        <div class="absolute top-2 right-2 bg-green-600/90 text-white text-[10px] px-2 py-0.5 rounded shadow">After</div>
                    </div>
                </div>
            `;
          } else if (count > 1) {
             // Multi View
             imageHTML = `
                <div class="relative h-48">
                    <img src="${firstPhoto.photo_url}" class="w-full h-full object-cover" loading="lazy" />
                    <div class="absolute inset-0 bg-black/30 flex items-center justify-center">
                        <span class="text-white font-bold text-2xl drop-shadow-md">+${count}</span>
                    </div>
                    <div class="absolute top-2 right-2 bg-gray-800/80 text-white text-xs px-2 py-1 rounded-full">
                        <i class="fas fa-layer-group mr-1"></i>${count}ì¥
                    </div>
                </div>
            `;
          } else {
             // Single View
             imageHTML = `
                <div class="relative h-48">
                    <img src="${firstPhoto.photo_url}" class="w-full h-full object-cover" loading="lazy" />
                </div>
            `;
          }

          div.innerHTML = `
              ${imageHTML}
              <div class="p-3">
                  <div class="font-medium text-gray-800">${firstPhoto.employee_name || 'ì´ë¦„ ì—†ìŒ'}</div>
                  <div class="text-sm text-gray-500"><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"9ca89e9f58f6a7d7","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.9.1","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
