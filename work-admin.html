<!DOCTYPE html>
<html lang="ko" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>관리자 대시보드 | KINDWON</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />
    <!-- Supabase JS v2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SheetJS (Excel Export) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
      :root {
        --kindwon-green: #1b5e3e;
        --kindwon-green-light: #2d6e4f;
        --kindwon-green-lighter: #4a9370;
        --kindwon-green-pale: #e8f5e9;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', Roboto, Helvetica, Arial, sans-serif;
        background-color: #f3f4f6;
        min-height: 100vh;
        margin: 0;
      }

      .kindwon-gradient {
        background: linear-gradient(135deg, var(--kindwon-green) 0%, var(--kindwon-green-light) 100%);
      }

      .card-premium {
        background: white;
        border-radius: 12px;
        box-shadow:
          0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .nav-tab {
        padding: 0.75rem 1rem;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        font-weight: 600;
        color: #6b7280;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .nav-tab.active {
        border-bottom-color: var(--kindwon-green);
        color: var(--kindwon-green);
        background-color: var(--kindwon-green-pale);
      }

      .nav-tab:hover:not(.active) {
        color: var(--kindwon-green-light);
        background-color: #f9fafb;
      }

      .photo-grid-item {
        aspect-ratio: 1;
        position: relative;
        overflow: hidden;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.2s;
        border: 1px solid #e5e7eb;
      }

      .photo-grid-item:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .photo-grid-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .photo-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
        padding: 8px;
        color: white;
        font-size: 0.75rem;
      }

      .loading-spinner {
        border: 3px solid #f3f4f6;
        border-top: 3px solid var(--kindwon-green);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.85);
      }

      /* Custom scrollbar for horizontal tables */
      .table-container::-webkit-scrollbar {
        height: 6px;
      }
      .table-container::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      .table-container::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 3px;
      }

      .btn-primary {
        background-color: var(--kindwon-green);
        color: white;
      }
      .btn-primary:hover {
        background-color: var(--kindwon-green-light);
      }

      /* Login Screen */
      #loginScreen {
        background-image: linear-gradient(135deg, var(--kindwon-green) 0%, #111827 100%);
      }
    </style>
  </head>
  <body>
    <!-- ================= Login Screen ================= -->
    <div id="loginScreen" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center">
        <div class="mb-6">
          <img src="https://www.genspark.ai/api/files/s/UmgxPvd3" alt="KINDWON" class="h-10 mx-auto mb-2" />
          <h2 class="text-2xl font-bold text-gray-800">관리자 로그인</h2>
          <p class="text-sm text-gray-500">직원 업무 시스템 관리자 페이지</p>
        </div>

        <div class="mb-6">
          <input
            type="password"
            id="pinInput"
            placeholder="비밀번호 입력"
            class="w-full text-center text-2xl tracking-widest p-3 border-2 border-gray-200 rounded-xl focus:border-green-600 focus:outline-none transition mb-4"
            maxlength="10"
          />
          <button
            onclick="checkLogin()"
            class="w-full btn-primary font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95"
          >
            로그인
          </button>
        </div>
        <p id="loginError" class="text-red-500 text-sm hidden font-bold">
          <i class="fas fa-exclamation-circle mr-1"></i>비밀번호가 일치하지 않습니다.
        </p>
      </div>
    </div>

    <!-- ================= Main Application ================= -->
    <div id="appContainer" class="hidden flex flex-col min-h-screen">
      <!-- Header -->
      <header class="kindwon-gradient text-white shadow-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <img src="https://www.genspark.ai/api/files/s/UmgxPvd3" alt="Logo" class="h-8 bg-white rounded p-0.5" />
            <div>
              <h1 class="font-bold text-lg leading-tight hidden md:block">관리자 대시보드</h1>
              <h1 class="font-bold text-lg leading-tight md:hidden">관리자</h1>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-xs opacity-80 hidden md:inline">접속중: 관리자님</span>
            <button
              onclick="logout()"
              class="text-white hover:text-red-200 transition text-sm font-bold border border-white/30 px-3 py-1 rounded-lg"
            >
              <i class="fas fa-sign-out-alt mr-1"></i> 로그아웃
            </button>
          </div>
        </div>
      </header>

      <!-- Navigation Tabs -->
      <nav class="bg-white shadow-sm border-b sticky top-[56px] z-30 overflow-x-auto">
        <div class="max-w-7xl mx-auto px-2 flex">
          <button onclick="switchTab('gallery')" class="nav-tab active" id="tab-gallery">
            <i class="fas fa-images mr-2"></i>청소 갤러리
          </button>
          <button onclick="switchTab('history')" class="nav-tab" id="tab-history">
            <i class="fas fa-list-alt mr-2"></i>상세 조회
          </button>
          <button onclick="switchTab('stats')" class="nav-tab" id="tab-stats">
            <i class="fas fa-chart-pie mr-2"></i>통계 요약
          </button>
          <button onclick="switchTab('data')" class="nav-tab" id="tab-data">
            <i class="fas fa-file-export mr-2"></i>데이터 관리
          </button>
        </div>
      </nav>

      <!-- Content Area -->
      <main class="flex-1 max-w-7xl mx-auto w-full p-4 md:p-6 space-y-6">
        <!-- ================= TAB 1: Cleaning Gallery ================= -->
        <section id="section-gallery" class="space-y-4">
          <!-- Filter Bar -->
          <div class="card-premium p-4 flex flex-col md:flex-row gap-4 items-center justify-between">
            <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
              <div class="relative">
                <i class="fas fa-calendar absolute left-3 top-3 text-gray-400"></i>
                <input
                  type="date"
                  id="galleryDate"
                  class="pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-green-600 w-full"
                  onchange="loadGallery()"
                />
              </div>
              <select
                id="galleryLocation"
                class="py-2 px-3 border border-gray-300 rounded-lg focus:outline-none focus:border-green-600 bg-white w-full"
                onchange="loadGallery()"
              >
                <option value="">전체 위치</option>
              </select>
              <select
                id="galleryEmployee"
                class="py-2 px-3 border border-gray-300 rounded-lg focus:outline-none focus:border-green-600 bg-white w-full"
                onchange="loadGallery()"
              >
                <option value="">전체 직원</option>
              </select>
            </div>
            <button
              onclick="loadGallery()"
              class="w-full md:w-auto px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition font-medium"
            >
              <i class="fas fa-sync-alt mr-2"></i>새로고침
            </button>
          </div>

          <!-- Gallery Grid -->
          <div id="galleryGrid" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 md:gap-4">
            <!-- Photos will be injected here -->
          </div>

          <div id="galleryEmpty" class="hidden text-center py-12 text-gray-500">
            <i class="fas fa-camera text-4xl mb-3 text-gray-300"></i>
            <p>해당 조건의 사진이 없습니다.</p>
          </div>

          <div id="galleryLoading" class="text-center py-12 hidden">
            <div class="loading-spinner mx-auto mb-3"></div>
            <p class="text-gray-500">사진을 불러오는 중...</p>
          </div>
        </section>

        <!-- ================= TAB 2: Work History ================= -->
        <section id="section-history" class="hidden space-y-4">
          <!-- Filter Bar -->
          <div class="card-premium p-4 flex flex-col md:flex-row gap-4 items-center justify-between">
            <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
              <div class="flex items-center gap-2">
                <input
                  type="date"
                  id="historyStartDate"
                  class="py-2 px-3 border border-gray-300 rounded-lg focus:outline-none focus:border-green-600 w-full"
                />
                <span class="text-gray-400">~</span>
                <input
                  type="date"
                  id="historyEndDate"
                  class="py-2 px-3 border border-gray-300 rounded-lg focus:outline-none focus:border-green-600 w-full"
                />
              </div>
              <select
                id="historyEmployee"
                class="py-2 px-3 border border-gray-300 rounded-lg focus:outline-none focus:border-green-600 bg-white w-full"
              >
                <option value="">전체 직원</option>
              </select>
            </div>
            <button
              onclick="loadHistory()"
              class="btn-primary px-6 py-2 rounded-lg font-medium shadow-sm w-full md:w-auto"
            >
              조회하기
            </button>
          </div>

          <!-- Data Table -->
          <div class="card-premium overflow-hidden">
            <div class="table-container overflow-x-auto">
              <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-gray-700 font-bold border-b">
                  <tr>
                    <th class="p-4 whitespace-nowrap">날짜</th>
                    <th class="p-4 whitespace-nowrap">직원명</th>
                    <th class="p-4 whitespace-nowrap">출근 시간</th>
                    <th class="p-4 whitespace-nowrap">퇴근 시간</th>
                    <th class="p-4 whitespace-nowrap">근무 시간</th>
                    <th class="p-4 whitespace-nowrap">청소 작업</th>
                    <th class="p-4 whitespace-nowrap">상태</th>
                  </tr>
                </thead>
                <tbody id="historyTableBody" class="divide-y divide-gray-100">
                  <!-- Rows injected here -->
                </tbody>
              </table>
            </div>
            <div id="historyLoading" class="text-center py-8 hidden">
              <div class="loading-spinner mx-auto"></div>
            </div>
            <div id="historyEmpty" class="text-center py-8 text-gray-500 hidden">데이터가 없습니다.</div>
          </div>
        </section>

        <!-- ================= TAB 3: Statistics ================= -->
        <section id="section-stats" class="hidden space-y-6">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-xl font-bold text-gray-800">
              오늘의 현황 <span class="text-sm font-normal text-gray-500 ml-2" id="statsDate"></span>
            </h2>
            <button onclick="loadStats()" class="text-green-600 hover:text-green-800">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>

          <!-- Summary Cards -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="card-premium p-4 border-l-4 border-blue-500">
              <p class="text-xs text-gray-500 font-bold uppercase mb-1">총 직원</p>
              <h3 class="text-2xl font-bold text-gray-800" id="statTotalEmps">-</h3>
            </div>
            <div class="card-premium p-4 border-l-4 border-green-500">
              <p class="text-xs text-gray-500 font-bold uppercase mb-1">출근 완료</p>
              <h3 class="text-2xl font-bold text-gray-800" id="statPresent">-</h3>
            </div>
            <div class="card-premium p-4 border-l-4 border-orange-500">
              <p class="text-xs text-gray-500 font-bold uppercase mb-1">출근율</p>
              <h3 class="text-2xl font-bold text-gray-800" id="statRate">0%</h3>
            </div>
            <div class="card-premium p-4 border-l-4 border-purple-500">
              <p class="text-xs text-gray-500 font-bold uppercase mb-1">청소 작업</p>
              <h3 class="text-2xl font-bold text-gray-800" id="statCleaning">-건</h3>
            </div>
          </div>

          <!-- Visual Bars -->
          <div class="card-premium p-6">
            <h3 class="font-bold text-gray-700 mb-4">근태 요약 그래프</h3>
            <div class="space-y-4">
              <div>
                <div class="flex justify-between text-sm mb-1">
                  <span class="font-medium text-gray-600">출근율</span>
                  <span class="font-bold text-gray-800" id="barRateText">0%</span>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-4 overflow-hidden">
                  <div
                    id="barRate"
                    class="bg-green-500 h-4 rounded-full transition-all duration-500"
                    style="width: 0%"
                  ></div>
                </div>
              </div>

              <div>
                <div class="flex justify-between text-sm mb-1">
                  <span class="font-medium text-gray-600">퇴근율 (출근자 대비)</span>
                  <span class="font-bold text-gray-800" id="barOutText">0%</span>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-4 overflow-hidden">
                  <div
                    id="barOut"
                    class="bg-blue-500 h-4 rounded-full transition-all duration-500"
                    style="width: 0%"
                  ></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ================= TAB 4: Data Export ================= -->
        <section id="section-data" class="hidden space-y-6">
          <div class="card-premium p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
              <i class="fas fa-file-excel text-green-600 mr-2"></i>데이터 내보내기
            </h2>
            <p class="text-gray-500 mb-6 text-sm">기간을 설정하고 엑셀 파일로 데이터를 다운로드할 수 있습니다.</p>

            <div class="grid md:grid-cols-2 gap-8">
              <!-- Attendance Export -->
              <div class="border border-gray-200 rounded-xl p-5 hover:border-green-500 transition cursor-default">
                <h3 class="font-bold text-gray-700 mb-3">
                  <i class="fas fa-clock text-blue-500 mr-2"></i>근태 기록 다운로드
                </h3>
                <div class="flex flex-col gap-3 mb-4">
                  <label class="text-xs font-bold text-gray-500">조회 기간</label>
                  <div class="flex gap-2">
                    <input type="date" id="exportStartDate" class="w-full p-2 border rounded text-sm" />
                    <input type="date" id="exportEndDate" class="w-full p-2 border rounded text-sm" />
                  </div>
                </div>
                <button
                  onclick="exportData('attendance')"
                  class="w-full btn-primary py-2 rounded-lg text-sm font-bold shadow-sm"
                >
                  <i class="fas fa-download mr-1"></i> 엑셀 다운로드 (.xlsx)
                </button>
              </div>

              <!-- Cleaning Export -->
              <div class="border border-gray-200 rounded-xl p-5 hover:border-green-500 transition cursor-default">
                <h3 class="font-bold text-gray-700 mb-3">
                  <i class="fas fa-broom text-purple-500 mr-2"></i>청소 내역 다운로드
                </h3>
                <div class="flex flex-col gap-3 mb-4">
                  <label class="text-xs font-bold text-gray-500">조회 기간</label>
                  <div class="flex gap-2">
                    <input type="date" id="exportCleanStartDate" class="w-full p-2 border rounded text-sm" />
                    <input type="date" id="exportCleanEndDate" class="w-full p-2 border rounded text-sm" />
                  </div>
                </div>
                <button
                  onclick="exportData('cleaning')"
                  class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg text-sm font-bold shadow-sm transition"
                >
                  <i class="fas fa-download mr-1"></i> 엑셀 다운로드 (.xlsx)
                </button>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- ================= Image Modal ================= -->
    <div
      id="imageModal"
      class="fixed inset-0 z-50 modal-backdrop hidden flex items-center justify-center p-4"
      onclick="closeModal()"
    >
      <div class="relative max-w-4xl w-full max-h-screen flex flex-col items-center" onclick="event.stopPropagation()">
        <button onclick="closeModal()" class="absolute -top-10 right-0 text-white text-3xl hover:text-gray-300 z-50">
          <i class="fas fa-times"></i>
        </button>
        <img
          id="modalImage"
          src=""
          alt="Full size"
          class="max-w-full max-h-[80vh] rounded-lg shadow-2xl object-contain bg-black"
        />
        <div class="bg-white w-full p-4 mt-2 rounded-lg shadow-lg">
          <div class="flex justify-between items-center">
            <div>
              <h3 id="modalEmployee" class="font-bold text-gray-800 text-lg">직원 이름</h3>
              <p id="modalLocation" class="text-sm text-gray-600">위치 정보</p>
            </div>
            <div class="text-right">
              <p id="modalTime" class="text-sm font-mono text-gray-500">2023-01-01 12:00</p>
              <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full font-bold">청소 작업</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ================= CONFIGURATION =================
      const SUPABASE_URL = 'https://qgpqhtuynxhmgawakjxe.supabase.co';
      const SUPABASE_ANON_KEY =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFncHFodHV5bnhobWdhd2FranhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyOTQyNTEsImV4cCI6MjA4Mjg3MDI1MX0.WNljQIKDbeZCDlXe8fpBdZs58XRFfujGt7lBGfq_pVg';
      const LOGIN_PIN = 'bdxi2026';

      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // ================= AUTHENTICATION =================
      function checkLogin() {
        const input = document.getElementById('pinInput').value;
        const errorMsg = document.getElementById('loginError');

        if (input === LOGIN_PIN) {
          sessionStorage.setItem('isAdminLoggedIn', 'true');
          initDashboard();
        } else {
          errorMsg.classList.remove('hidden');
          document.getElementById('pinInput').value = '';
        }
      }

      function logout() {
        if (confirm('로그아웃 하시겠습니까?')) {
          sessionStorage.removeItem('isAdminLoggedIn');
          location.reload();
        }
      }

      function initDashboard() {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('appContainer').classList.remove('hidden');

        // Init Filters
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('galleryDate').value = today;

        // Set Default Date Range for History (This Month)
        const date = new Date();
        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).toISOString().split('T')[0];
        document.getElementById('historyStartDate').value = firstDay;
        document.getElementById('historyEndDate').value = today;
        document.getElementById('exportStartDate').value = firstDay;
        document.getElementById('exportEndDate').value = today;
        document.getElementById('exportCleanStartDate').value = firstDay;
        document.getElementById('exportCleanEndDate').value = today;

        // Load Initial Data
        loadMetadata();
        loadGallery();
      }

      // Check session on load
      window.onload = () => {
        if (sessionStorage.getItem('isAdminLoggedIn') === 'true') {
          initDashboard();
        }
      };

      // Enter key support for login
      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('pinInput')?.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') checkLogin();
        });
      });

      // ================= DATA LOADING =================
      let employeesCache = [];
      let locationsCache = [];

      async function loadMetadata() {
        // Load Employees
        const { data: emps } = await supabase.from('employees').select('id, name').eq('status', 'active').order('name');
        employeesCache = emps || [];

        // Load Locations
        const { data: locs } = await supabase.from('locations').select('id, name').order('name');
        locationsCache = locs || [];

        // Populate Dropdowns
        const empSelects = ['galleryEmployee', 'historyEmployee'];
        const locSelects = ['galleryLocation'];

        empSelects.forEach((id) => {
          const sel = document.getElementById(id);
          employeesCache.forEach((e) => {
            const opt = document.createElement('option');
            opt.value = e.id;
            opt.textContent = e.name;
            sel.appendChild(opt);
          });
        });

        locSelects.forEach((id) => {
          const sel = document.getElementById(id);
          locationsCache.forEach((l) => {
            const opt = document.createElement('option');
            opt.value = l.id;
            opt.textContent = l.name;
            sel.appendChild(opt);
          });
        });
      }

      // ================= TAB 1: GALLERY =================
      async function loadGallery() {
        const grid = document.getElementById('galleryGrid');
        const loading = document.getElementById('galleryLoading');
        const empty = document.getElementById('galleryEmpty');

        grid.innerHTML = '';
        loading.classList.remove('hidden');
        empty.classList.add('hidden');

        const date = document.getElementById('galleryDate').value;
        const locId = document.getElementById('galleryLocation').value;
        const empId = document.getElementById('galleryEmployee').value;

        // Query setup
        let query = supabase.from('cleaning_tasks').select('*').order('created_at', { ascending: false });

        if (date) {
          const start = new Date(date);
          start.setHours(0, 0, 0, 0);
          const end = new Date(date);
          end.setHours(23, 59, 59, 999);
          query = query.gte('created_at', start.toISOString()).lte('created_at', end.toISOString());
        }
        if (locId) query = query.eq('location_id', locId);
        if (empId) query = query.eq('employee_id', empId);

        const { data, error } = await query;
        loading.classList.add('hidden');

        if (error || !data || data.length === 0) {
          empty.classList.remove('hidden');
          return;
        }

        // Render Photos
        data.forEach((task) => {
          if (task.photo_urls && Array.isArray(task.photo_urls)) {
            task.photo_urls.forEach((url) => {
              const div = document.createElement('div');
              div.className = 'photo-grid-item group';
              div.onclick = () => openModal(url, task);

              const time = new Date(task.created_at).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit',
              });

              div.innerHTML = `
                <img src="${url}" loading="lazy" alt="Cleaning photo">
                <div class="photo-overlay opacity-0 group-hover:opacity-100 transition-opacity">
                  <div class="font-bold">${task.employee_name}</div>
                  <div class="text-xs truncate">${task.location_name}</div>
                  <div class="text-xs text-gray-300 mt-1">${time}</div>
                </div>
              `;
              grid.appendChild(div);
            });
          }
        });
      }

      // ================= TAB 2: HISTORY =================
      async function loadHistory() {
        const tbody = document.getElementById('historyTableBody');
        const loading = document.getElementById('historyLoading');
        const empty = document.getElementById('historyEmpty');

        tbody.innerHTML = '';
        loading.classList.remove('hidden');
        empty.classList.add('hidden');

        const start = document.getElementById('historyStartDate').value;
        const end = document.getElementById('historyEndDate').value;
        const empId = document.getElementById('historyEmployee').value;

        if (!start || !end) {
          alert('조회 기간을 선택해주세요.');
          loading.classList.add('hidden');
          return;
        }

        // 1. Fetch Attendance
        let attQuery = supabase
          .from('attendance_records')
          .select('*')
          .gte('scan_time', new Date(start).toISOString())
          .lte('scan_time', new Date(end + 'T23:59:59').toISOString())
          .order('scan_time', { ascending: true });

        if (empId) attQuery = attQuery.eq('employee_id', empId);

        // 2. Fetch Cleaning Counts
        let cleanQuery = supabase
          .from('cleaning_tasks')
          .select('employee_id, employee_name, created_at')
          .gte('created_at', new Date(start).toISOString())
          .lte('created_at', new Date(end + 'T23:59:59').toISOString());

        if (empId) cleanQuery = cleanQuery.eq('employee_id', empId);

        const [attRes, cleanRes] = await Promise.all([attQuery, cleanQuery]);

        if (attRes.error) {
          console.error(attRes.error);
          loading.classList.add('hidden');
          return;
        }

        const records = attRes.data;
        const cleaningTasks = cleanRes.data || [];

        // Process Data: Group by Date & Employee
        const grouped = {}; // Key: "YYYY-MM-DD_EMP_ID"

        records.forEach((r) => {
          const date = r.scan_time.split('T')[0];
          const key = `${date}_${r.employee_id}`;

          if (!grouped[key]) {
            grouped[key] = {
              date: date,
              empName: r.employee_name,
              inTime: null,
              outTime: null,
              cleanCount: 0,
            };
          }

          if (r.attendance_type === '출근' && !grouped[key].inTime) grouped[key].inTime = r.scan_time;
          if (r.attendance_type === '퇴근') grouped[key].outTime = r.scan_time; // Keep latest out time
        });

        // Add cleaning counts
        cleaningTasks.forEach((t) => {
          const date = t.created_at.split('T')[0];
          const key = `${date}_${t.employee_id}`;
          // If no attendance record but has cleaning, create entry
          if (!grouped[key]) {
            grouped[key] = {
              date: date,
              empName: t.employee_name,
              inTime: null,
              outTime: null,
              cleanCount: 0,
            };
          }
          grouped[key].cleanCount++;
        });

        // Render Table
        const sortedKeys = Object.keys(grouped).sort().reverse(); // Newest first
        loading.classList.add('hidden');

        if (sortedKeys.length === 0) {
          empty.classList.remove('hidden');
          return;
        }

        sortedKeys.forEach((key) => {
          const item = grouped[key];
          const inTimeStr = item.inTime
            ? new Date(item.inTime).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
            : '-';
          const outTimeStr = item.outTime
            ? new Date(item.outTime).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
            : '-';

          // Calc Duration
          let durationStr = '-';
          if (item.inTime && item.outTime) {
            const diffMs = new Date(item.outTime) - new Date(item.inTime);
            if (diffMs > 0) {
              const hours = Math.floor(diffMs / 3600000);
              const mins = Math.floor((diffMs % 3600000) / 60000);
              durationStr = `${hours}시간 ${mins}분`;
            }
          }

          // Status Badge
          let statusHtml = '';
          if (item.outTime)
            statusHtml = '<span class="px-2 py-1 rounded bg-gray-100 text-gray-600 text-xs font-bold">퇴근완료</span>';
          else if (item.inTime)
            statusHtml = '<span class="px-2 py-1 rounded bg-green-100 text-green-700 text-xs font-bold">근무중</span>';
          else statusHtml = '<span class="px-2 py-1 rounded bg-yellow-50 text-yellow-600 text-xs">기록없음</span>';

          const row = `
            <tr class="hover:bg-gray-50 border-b last:border-0 transition">
              <td class="p-4 font-mono text-gray-600">${item.date}</td>
              <td class="p-4 font-bold text-gray-800">${item.empName}</td>
              <td class="p-4 text-blue-600">${inTimeStr}</td>
              <td class="p-4 text-red-500">${outTimeStr}</td>
              <td class="p-4 font-medium">${durationStr}</td>
              <td class="p-4"><span class="font-bold text-purple-600">${item.cleanCount}</span> 건</td>
              <td class="p-4">${statusHtml}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      // ================= TAB 3: STATS =================
      async function loadStats() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('statsDate').textContent = today;

        // 1. Total Active Employees
        const { count: totalEmps } = await supabase
          .from('employees')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'active');
        document.getElementById('statTotalEmps').textContent = totalEmps || 0;

        // 2. Attendance Records Today
        const start = new Date(today);
        start.setHours(0, 0, 0, 0);
        const end = new Date(today);
        end.setHours(23, 59, 59, 999);

        const { data: attData } = await supabase
          .from('attendance_records')
          .select('employee_id, attendance_type')
          .gte('scan_time', start.toISOString())
          .lte('scan_time', end.toISOString());

        // Count unique employees who checked in ('출근')
        const presentEmps = new Set();
        const outEmps = new Set();

        if (attData) {
          attData.forEach((r) => {
            if (r.attendance_type === '출근') presentEmps.add(r.employee_id);
            if (r.attendance_type === '퇴근') outEmps.add(r.employee_id);
          });
        }

        const presentCount = presentEmps.size;
        document.getElementById('statPresent').textContent = presentCount;

        // Rate
        const rate = totalEmps > 0 ? Math.round((presentCount / totalEmps) * 100) : 0;
        document.getElementById('statRate').textContent = rate + '%';
        document.getElementById('barRate').style.width = rate + '%';
        document.getElementById('barRateText').textContent = rate + '%';

        // Out Rate (vs Present)
        const outRate = presentCount > 0 ? Math.round((outEmps.size / presentCount) * 100) : 0;
        document.getElementById('barOut').style.width = outRate + '%';
        document.getElementById('barOutText').textContent = outRate + '%';

        // 3. Cleaning Tasks Today
        const { count: cleanCount } = await supabase
          .from('cleaning_tasks')
          .select('*', { count: 'exact', head: true })
          .gte('created_at', start.toISOString())
          .lte('created_at', end.toISOString());

        document.getElementById('statCleaning').textContent = (cleanCount || 0) + '건';
      }

      // ================= TAB 4: EXPORT =================
      async function exportData(type) {
        if (!confirm('데이터를 다운로드 하시겠습니까?')) return;

        let start, end, data, filename;

        if (type === 'attendance') {
          start = document.getElementById('exportStartDate').value;
          end = document.getElementById('exportEndDate').value;
          filename = `근태기록_${start}_${end}.xlsx`;

          const { data: res } = await supabase
            .from('attendance_records')
            .select('*')
            .gte('scan_time', new Date(start).toISOString())
            .lte('scan_time', new Date(end + 'T23:59:59').toISOString())
            .order('scan_time');

          data = res.map((r) => ({
            날짜: r.scan_time.split('T')[0],
            시간: new Date(r.scan_time).toLocaleTimeString('ko-KR'),
            직원명: r.employee_name,
            유형: r.attendance_type,
            위치: r.location_name,
          }));
        } else {
          start = document.getElementById('exportCleanStartDate').value;
          end = document.getElementById('exportCleanEndDate').value;
          filename = `청소내역_${start}_${end}.xlsx`;

          const { data: res } = await supabase
            .from('cleaning_tasks')
            .select('*')
            .gte('created_at', new Date(start).toISOString())
            .lte('created_at', new Date(end + 'T23:59:59').toISOString())
            .order('created_at');

          data = res.map((r) => ({
            날짜: r.created_at.split('T')[0],
            시간: new Date(r.created_at).toLocaleTimeString('ko-KR'),
            직원명: r.employee_name,
            위치: r.location_name,
            사진수: r.photo_urls ? r.photo_urls.length : 0,
          }));
        }

        if (!data || data.length === 0) {
          alert('다운로드할 데이터가 없습니다.');
          return;
        }

        // Generate Excel
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
        XLSX.writeFile(wb, filename);
      }

      // ================= UI HELPERS =================
      function switchTab(tabId) {
        // Update Nav
        document.querySelectorAll('.nav-tab').forEach((el) => el.classList.remove('active'));
        document.getElementById(`tab-${tabId}`).classList.add('active');

        // Hide All Sections
        document.querySelectorAll('section').forEach((el) => el.classList.add('hidden'));

        // Show Target
        document.getElementById(`section-${tabId}`).classList.remove('hidden');

        // Initial Load for tab
        if (tabId === 'stats') loadStats();
      }

      function openModal(imgUrl, taskData) {
        const modal = document.getElementById('imageModal');
        const img = document.getElementById('modalImage');

        img.src = imgUrl;
        document.getElementById('modalEmployee').textContent = taskData.employee_name;
        document.getElementById('modalLocation').textContent = taskData.location_name;
        document.getElementById('modalTime').textContent = new Date(taskData.created_at).toLocaleString('ko-KR');

        modal.classList.remove('hidden');
      }

      function closeModal() {
        document.getElementById('imageModal').classList.add('hidden');
      }
    </script>
  </body>
</html>
