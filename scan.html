<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR ìŠ¤ìº” - ì¶œì„/ì²­ì†Œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <style>
        #reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        #reader video {
            width: 100% !important;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-xl md:text-2xl font-bold">
                    <i class="fas fa-qrcode mr-2"></i>QR ìŠ¤ìº”
                </h1>
                <div class="space-x-2 md:space-x-4 text-sm md:text-base">
                    <a href="index.html" class="hover:text-blue-200">
                        <i class="fas fa-home mr-1"></i>ê´€ë¦¬ì
                    </a>
                    <a href="records.html" class="hover:text-blue-200">
                        <i class="fas fa-chart-bar mr-1"></i>ê¸°ë¡
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="container mx-auto px-4 py-6">
        
        <!-- Step 1: QR ìŠ¤ìº” -->
        <div id="step-qr-scan" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6">
            <h2 class="text-lg md:text-xl font-bold mb-4">
                <i class="fas fa-qrcode mr-2"></i>Step 1: QR ì½”ë“œ ìŠ¤ìº”
            </h2>
            <p class="text-sm md:text-base text-gray-600 mb-4">êµ¬ì—­ì˜ QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”</p>
            
            <!-- QR ìŠ¤ìºë„ˆ -->
            <div id="reader" class="mb-4"></div>
            
            <!-- ìŠ¤ìº” ìƒíƒœ -->
            <div id="scan-status" class="text-center py-4 text-gray-500">
                <i class="fas fa-camera text-3xl mb-2"></i>
                <p>ì¹´ë©”ë¼ë¥¼ í™œì„±í™”í•˜ëŠ” ì¤‘...</p>
            </div>
        </div>

        <!-- Step 2: ë©”ë‰´ ì„ íƒ (ì¶œì„ or ì²­ì†Œ) -->
        <div id="step-menu-selection" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6 hidden">
            <h2 class="text-lg md:text-xl font-bold mb-4">
                <i class="fas fa-list mr-2"></i>Step 2: ì‘ì—… ì„ íƒ
            </h2>
            <div id="location-info" class="bg-blue-50 rounded-lg p-4 mb-6 text-center">
                <i class="fas fa-map-marker-alt text-blue-600 text-3xl mb-2"></i>
                <h3 class="text-xl font-bold" id="location-name-display">-</h3>
                <p class="text-gray-600" id="location-code-display">-</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="selectMode('attendance')" 
                    class="w-full bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-lg hover:shadow-xl transition transform hover:-translate-y-1">
                    <i class="fas fa-user-check text-4xl mb-3"></i>
                    <p class="font-bold text-xl">ğŸ“± ì¶œì„ ì²´í¬</p>
                    <p class="text-sm text-blue-100 mt-2">ì¶œê·¼/í‡´ê·¼ ê¸°ë¡í•˜ê¸°</p>
                </button>
                
                <button onclick="selectMode('cleaning')" 
                    class="w-full bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-lg hover:shadow-xl transition transform hover:-translate-y-1">
                    <i class="fas fa-broom text-4xl mb-3"></i>
                    <p class="font-bold text-xl">ğŸ§¹ ì²­ì†Œ ê¸°ë¡</p>
                    <p class="text-sm text-green-100 mt-2">ì²­ì†Œ ì‘ì—… ì‚¬ì§„ ì—…ë¡œë“œ</p>
                </button>
            </div>
            
            <button onclick="resetToScan()" class="mt-4 w-full bg-gray-200 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-300">
                <i class="fas fa-redo mr-2"></i>QR ë‹¤ì‹œ ìŠ¤ìº”
            </button>
        </div>

        <!-- Step 3: ì§ì› ì„ íƒ -->
        <div id="step-employee-selection" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6 hidden">
            <h2 class="text-lg md:text-xl font-bold mb-4">
                <i class="fas fa-user mr-2"></i>Step 3: ì§ì› ì„ íƒ
            </h2>
            <p class="text-sm md:text-base text-gray-600 mb-4" id="employee-instruction">ë³¸ì¸ì˜ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”</p>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">ì§ì› ê²€ìƒ‰</label>
                <input type="text" id="employee-search" placeholder="ì´ë¦„ ë˜ëŠ” ì‚¬ë²ˆìœ¼ë¡œ ê²€ìƒ‰..." 
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div id="employees-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                <div class="col-span-full text-center text-gray-500 py-8">
                    <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                    <p>ì§ì› ëª©ë¡ ë¡œë”© ì¤‘...</p>
                </div>
            </div>
            
            <button onclick="backToMenu()" class="mt-4 w-full bg-gray-200 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-300">
                <i class="fas fa-arrow-left mr-2"></i>ì´ì „ ë‹¨ê³„ë¡œ
            </button>
        </div>

        <!-- Step 4-A: ì¶œì„ ì™„ë£Œ (ì¶œì„ ëª¨ë“œ) -->
        <div id="step-attendance-complete" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6 hidden">
            <div class="text-center">
                <i class="fas fa-check-circle text-green-600 text-6xl mb-4"></i>
                <h2 class="text-2xl font-bold mb-2">ì¶œì„ ì™„ë£Œ!</h2>
                <div id="attendance-result" class="bg-gray-50 rounded-lg p-4 mb-4"></div>
                <button onclick="resetAll()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                    <i class="fas fa-redo mr-2"></i>ì²˜ìŒìœ¼ë¡œ
                </button>
            </div>
        </div>

        <!-- Step 4-B: êµ¬ì—­ ì„ íƒ (ì²­ì†Œ ëª¨ë“œ) -->
        <div id="step-location-selection" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6 hidden">
            <h2 class="text-lg md:text-xl font-bold mb-4">
                <i class="fas fa-map-marker-alt mr-2"></i>Step 4: ì²­ì†Œ êµ¬ì—­ ì„ íƒ
            </h2>
            <p class="text-sm md:text-base text-gray-600 mb-4">ì²­ì†Œí•  êµ¬ì—­ì„ ì„ íƒí•˜ì„¸ìš”</p>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">êµ¬ì—­ ê²€ìƒ‰</label>
                <input type="text" id="location-search" placeholder="êµ¬ì—­ ì´ë¦„ ë˜ëŠ” ì½”ë“œë¡œ ê²€ìƒ‰..." 
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            
            <div id="locations-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                <div class="col-span-full text-center text-gray-500 py-8">
                    <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                    <p>êµ¬ì—­ ëª©ë¡ ë¡œë”© ì¤‘...</p>
                </div>
            </div>
            
            <button onclick="backToEmployeeSelection()" class="mt-4 w-full bg-gray-200 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-300">
                <i class="fas fa-arrow-left mr-2"></i>ì´ì „ ë‹¨ê³„ë¡œ
            </button>
        </div>

        <!-- Step 5: ì‚¬ì§„ ì´¬ì˜ (ì²­ì†Œ ëª¨ë“œ) -->
        <div id="step-photo-capture" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6 hidden">
            <h2 class="text-lg md:text-xl font-bold mb-4">
                <i class="fas fa-camera mr-2"></i>Step 5: ì²­ì†Œ ì‚¬ì§„ ì´¬ì˜
            </h2>
            
            <div class="bg-green-50 rounded-lg p-4 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <p class="font-semibold">ì§ì›: <span id="selected-employee-name">-</span></p>
                        <p class="text-sm text-gray-600">êµ¬ì—­: <span id="selected-location-name">-</span></p>
                    </div>
                    <div class="text-green-600 text-right">
                        <p class="text-2xl font-bold" id="photo-count">0</p>
                        <p class="text-xs">ì¥ ì—…ë¡œë“œë¨</p>
                    </div>
                </div>
            </div>
            
            <input type="file" id="photo-input" accept="image/*" capture="environment" multiple class="hidden">
            
            <button onclick="capturePhotos()" class="w-full bg-green-600 text-white px-6 py-4 rounded-lg hover:bg-green-700 mb-4">
                <i class="fas fa-camera text-2xl mb-2"></i>
                <p class="font-bold">ì‚¬ì§„ ì´¬ì˜í•˜ê¸°</p>
                <p class="text-sm text-green-100">ìµœëŒ€ 30ì¥ê¹Œì§€ ê°€ëŠ¥</p>
            </button>
            
            <!-- ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° -->
            <div id="photo-preview" class="grid grid-cols-3 gap-2 mb-4"></div>
            
            <!-- ì—…ë¡œë“œ ì§„í–‰ë¥  -->
            <div id="upload-progress" class="hidden mb-4">
                <div class="bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div id="upload-progress-bar" class="bg-green-600 h-full transition-all" style="width: 0%"></div>
                </div>
                <p class="text-sm text-center mt-2" id="upload-status">ì—…ë¡œë“œ ì¤‘...</p>
            </div>
            
            <button onclick="submitCleaning()" id="submit-btn" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-400" disabled>
                <i class="fas fa-check mr-2"></i>ì œì¶œí•˜ê¸°
            </button>
            
            <button onclick="backToLocationSelection()" class="mt-2 w-full bg-gray-200 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-300">
                <i class="fas fa-arrow-left mr-2"></i>ì´ì „ ë‹¨ê³„ë¡œ
            </button>
        </div>

        <!-- Step 6: ì²­ì†Œ ì™„ë£Œ -->
        <div id="step-cleaning-complete" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6 hidden">
            <div class="text-center">
                <i class="fas fa-check-circle text-green-600 text-6xl mb-4"></i>
                <h2 class="text-2xl font-bold mb-2">ì²­ì†Œ ê¸°ë¡ ì™„ë£Œ!</h2>
                <div id="cleaning-result" class="bg-gray-50 rounded-lg p-4 mb-4"></div>
                <button onclick="resetAll()" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700">
                    <i class="fas fa-redo mr-2"></i>ì²˜ìŒìœ¼ë¡œ
                </button>
            </div>
        </div>

    </div>

    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://qgpqhtuynxhmgawakjxe.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_ujXj0mLf1casiQdVkc0fCA_G6exymqG';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ì „ì—­ ë³€ìˆ˜
        let html5QrCode = null;
        let currentMode = null; // 'attendance' or 'cleaning'
        let scannedLocation = null;
        let selectedEmployee = null;
        let selectedLocation = null;
        let employees = [];
        let locations = [];
        let uploadedPhotos = [];
        let isProcessing = false; // ì¤‘ë³µ ìŠ¤ìº” ë°©ì§€

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('âœ… Page loaded');
            await startScanner();
            await loadEmployees();
            await loadLocations();
        });

        // QR ìŠ¤ìºë„ˆ ì‹œì‘
        async function startScanner() {
            console.log('ğŸ“· Starting scanner...');
            const statusDiv = document.getElementById('scan-status');
            
            try {
                html5QrCode = new Html5Qrcode("reader");
                
                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                };
                
                await html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    onScanSuccess,
                    onScanError
                );
                
                console.log('âœ… Camera started');
                statusDiv.innerHTML = '<i class="fas fa-camera text-3xl mb-2"></i><p>QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”</p>';
                
            } catch (err) {
                console.error('âŒ Camera error:', err);
                statusDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle text-red-600 text-3xl mb-2"></i>
                    <p class="text-red-600 mb-2">ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨</p>
                    <p class="text-sm text-gray-600">${err.message}</p>
                    <button onclick="startScanner()" class="mt-3 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fas fa-redo mr-2"></i>ë‹¤ì‹œ ì‹œë„
                    </button>
                `;
            }
        }

        // QR ìŠ¤ìº” ì„±ê³µ
        async function onScanSuccess(decodedText, decodedResult) {
            // ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€
            if (isProcessing) {
                console.log('â³ Already processing... IGNORED');
                return;
            }
            
            isProcessing = true;
            console.log('ğŸ”µ QR SCANNED:', decodedText);
            
            // ì¦‰ì‹œ ìŠ¤ìºë„ˆ ì¤‘ì§€ (ìµœìš°ì„ !)
            if (html5QrCode) {
                try {
                    console.log('ğŸ›‘ Stopping scanner IMMEDIATELY...');
                    await html5QrCode.stop();
                    html5QrCode = null;
                    console.log('âœ… Scanner stopped');
                } catch (err) {
                    console.error('âŒ Scanner stop error:', err);
                }
            }
            
            try {
                const qrData = JSON.parse(decodedText);
                console.log('âœ… JSON parsed:', qrData);
                
                if (qrData.type !== 'location') {
                    alert('ì˜¬ë°”ë¥¸ êµ¬ì—­ QR ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤.');
                    isProcessing = false;
                    startScanner(); // ìŠ¤ìºë„ˆ ì¬ì‹œì‘
                    return;
                }
                
                // ìŠ¤ìº”ëœ êµ¬ì—­ ì •ë³´ ì €ì¥
                scannedLocation = {
                    id: qrData.locationId,
                    name: qrData.locationName,
                    code: qrData.locationCode
                };
                console.log('âœ… scannedLocation saved:', scannedLocation);
                
                // ì•½ê°„ì˜ ì§€ì—° í›„ í™”ë©´ ì „í™˜ (UI ì•ˆì •í™”)
                setTimeout(() => {
                    console.log('â¡ï¸ Calling showMenuSelection()...');
                    showMenuSelection();
                }, 300);
                
            } catch (error) {
                console.error('âŒ QR parse error:', error);
                alert('QR ì½”ë“œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                isProcessing = false;
                startScanner(); // ìŠ¤ìºë„ˆ ì¬ì‹œì‘
            }
        }

        // QR ìŠ¤ìº” ì—ëŸ¬ (ë¬´ì‹œ)
        function onScanError(errorMessage) {
            // ë¬´ì‹œ
        }

        // ë©”ë‰´ ì„ íƒ í™”ë©´ í‘œì‹œ
        function showMenuSelection() {
            console.log('ğŸŸ¢ showMenuSelection() CALLED');
            console.log('ğŸŸ¢ scannedLocation:', scannedLocation);
            
            const qrScanStep = document.getElementById('step-qr-scan');
            const menuStep = document.getElementById('step-menu-selection');
            
            console.log('ğŸŸ¢ step-qr-scan element:', qrScanStep);
            console.log('ğŸŸ¢ step-menu-selection element:', menuStep);
            
            qrScanStep.classList.add('hidden');
            menuStep.classList.remove('hidden');
            
            console.log('ğŸŸ¢ step-qr-scan hidden:', qrScanStep.classList.contains('hidden'));
            console.log('ğŸŸ¢ step-menu-selection hidden:', menuStep.classList.contains('hidden'));
            
            document.getElementById('location-name-display').textContent = scannedLocation.name;
            document.getElementById('location-code-display').textContent = scannedLocation.code;
            
            console.log('âœ… showMenuSelection() COMPLETED');
        }

        // ëª¨ë“œ ì„ íƒ (ì¶œì„ or ì²­ì†Œ)
        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('step-menu-selection').classList.add('hidden');
            document.getElementById('step-employee-selection').classList.remove('hidden');
            
            if (mode === 'attendance') {
                document.getElementById('employee-instruction').textContent = 'ì¶œì„í•  ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”';
            } else {
                document.getElementById('employee-instruction').textContent = 'ì²­ì†Œí•  ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”';
            }
        }

        // ì§ì› ëª©ë¡ ë¡œë“œ
        async function loadEmployees() {
            try {
                const { data, error } = await supabaseClient
                    .from('employees')
                    .select('*')
                    .eq('is_active', true)
                    .order('name', { ascending: true });
                
                if (error) throw error;
                
                employees = data || [];
                console.log(`âœ… Loaded ${employees.length} employees`);
                displayEmployees(employees);
                
            } catch (error) {
                console.error('âŒ Error loading employees:', error);
                document.getElementById('employees-grid').innerHTML = 
                    `<div class="col-span-full text-center text-red-500 py-4">
                        <p>ì§ì› ëª©ë¡ ë¡œë”© ì‹¤íŒ¨</p>
                        <button onclick="loadEmployees()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded-md">ë‹¤ì‹œ ì‹œë„</button>
                    </div>`;
            }
        }

        // ì§ì› ëª©ë¡ í‘œì‹œ
        function displayEmployees(employeeList) {
            const grid = document.getElementById('employees-grid');
            
            if (employeeList.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            grid.innerHTML = employeeList.map(emp => {
                const initial = emp.name.charAt(0);
                return `
                    <button onclick="selectEmployee('${emp.id}')" 
                        class="p-3 md:p-4 border-2 border-gray-200 rounded-lg hover:border-blue-600 hover:bg-blue-50 transition text-center">
                        <div class="w-10 h-10 md:w-12 md:h-12 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold mx-auto mb-2">
                            ${initial}
                        </div>
                        <div class="font-semibold text-sm md:text-base">${emp.name}</div>
                        <div class="text-xs text-gray-500">${emp.employee_number || ''}</div>
                    </button>
                `;
            }).join('');
        }

        // ì§ì› ê²€ìƒ‰
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('employee-search').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = searchTerm === '' ? employees : employees.filter(emp => 
                    emp.name.toLowerCase().includes(searchTerm) ||
                    (emp.employee_number && emp.employee_number.toLowerCase().includes(searchTerm))
                );
                displayEmployees(filtered);
            });
        });

        // ì§ì› ì„ íƒ
        function selectEmployee(employeeId) {
            selectedEmployee = employees.find(emp => emp.id === employeeId);
            
            if (!selectedEmployee) {
                alert('ì§ì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            console.log('ğŸ‘¤ Selected employee:', selectedEmployee.name);
            
            if (currentMode === 'attendance') {
                // ì¶œì„ ëª¨ë“œ: ë°”ë¡œ ì¶œì„ ì €ì¥
                saveAttendance();
            } else {
                // ì²­ì†Œ ëª¨ë“œ: êµ¬ì—­ ì„ íƒìœ¼ë¡œ ì´ë™
                showLocationSelection();
            }
        }

        // ì¶œì„ ì €ì¥
        async function saveAttendance() {
            const attendanceData = {
                employee_id: selectedEmployee.id,
                employee_name: selectedEmployee.name,
                employee_number: selectedEmployee.employee_number || '',
                location_id: scannedLocation.id,
                location_name: scannedLocation.name,
                location_code: scannedLocation.code,
                scan_time: new Date().toISOString(),
                device_info: navigator.userAgent
            };
            
            try {
                const { data, error } = await supabaseClient
                    .from('attendance_records')
                    .insert([attendanceData])
                    .select()
                    .single();
                
                if (error) throw error;
                
                console.log('âœ… Attendance saved');
                showAttendanceComplete(data);
                
            } catch (error) {
                console.error('âŒ Error saving attendance:', error);
                alert('ì¶œì„ ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì¶œì„ ì™„ë£Œ í‘œì‹œ
        function showAttendanceComplete(record) {
            document.getElementById('step-employee-selection').classList.add('hidden');
            document.getElementById('step-attendance-complete').classList.remove('hidden');
            
            const resultDiv = document.getElementById('attendance-result');
            const scanTime = new Date(record.scan_time);
            
            resultDiv.innerHTML = `
                <div class="text-left space-y-2">
                    <p><span class="font-semibold">ì§ì›:</span> ${record.employee_name}</p>
                    <p><span class="font-semibold">êµ¬ì—­:</span> ${record.location_name}</p>
                    <p><span class="font-semibold">ì‹œê°„:</span> ${formatDateTime(scanTime)}</p>
                </div>
            `;
        }

        // êµ¬ì—­ ì„ íƒ í™”ë©´ í‘œì‹œ
        function showLocationSelection() {
            document.getElementById('step-employee-selection').classList.add('hidden');
            document.getElementById('step-location-selection').classList.remove('hidden');
            displayLocations(locations);
        }

        // êµ¬ì—­ ëª©ë¡ ë¡œë“œ
        async function loadLocations() {
            try {
                const { data, error } = await supabaseClient
                    .from('locations')
                    .select('*')
                    .eq('is_active', true)
                    .order('name', { ascending: true });
                
                if (error) throw error;
                
                locations = data || [];
                console.log(`âœ… Loaded ${locations.length} locations`);
                
            } catch (error) {
                console.error('âŒ Error loading locations:', error);
            }
        }

        // êµ¬ì—­ ëª©ë¡ í‘œì‹œ
        function displayLocations(locationList) {
            const grid = document.getElementById('locations-grid');
            
            if (locationList.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">ë“±ë¡ëœ êµ¬ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            grid.innerHTML = locationList.map(loc => {
                return `
                    <button onclick="selectLocation('${loc.id}')" 
                        class="p-4 border-2 border-gray-200 rounded-lg hover:border-green-600 hover:bg-green-50 transition text-left">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-map-marker-alt text-green-600 text-xl mr-3"></i>
                            <div>
                                <div class="font-semibold">${loc.name}</div>
                                <div class="text-xs text-gray-500">${loc.code}</div>
                            </div>
                        </div>
                        ${loc.building ? `<div class="text-xs text-gray-400">${loc.building} ${loc.floor || ''}</div>` : ''}
                    </button>
                `;
            }).join('');
        }

        // êµ¬ì—­ ê²€ìƒ‰
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('location-search').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = searchTerm === '' ? locations : locations.filter(loc => 
                    loc.name.toLowerCase().includes(searchTerm) ||
                    (loc.code && loc.code.toLowerCase().includes(searchTerm))
                );
                displayLocations(filtered);
            });
        });

        // êµ¬ì—­ ì„ íƒ
        function selectLocation(locationId) {
            selectedLocation = locations.find(loc => loc.id === locationId);
            
            if (!selectedLocation) {
                alert('êµ¬ì—­ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            console.log('ğŸ“ Selected location:', selectedLocation.name);
            showPhotoCapture();
        }

        // ì‚¬ì§„ ì´¬ì˜ í™”ë©´ í‘œì‹œ
        function showPhotoCapture() {
            document.getElementById('step-location-selection').classList.add('hidden');
            document.getElementById('step-photo-capture').classList.remove('hidden');
            
            document.getElementById('selected-employee-name').textContent = selectedEmployee.name;
            document.getElementById('selected-location-name').textContent = selectedLocation.name;
        }

        // ì‚¬ì§„ ì´¬ì˜
        function capturePhotos() {
            document.getElementById('photo-input').click();
        }

        // ì‚¬ì§„ ì„ íƒ ì‹œ
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('photo-input').addEventListener('change', async function(e) {
                const files = Array.from(e.target.files);
                
                if (files.length === 0) return;
                
                if (uploadedPhotos.length + files.length > 30) {
                    alert('ìµœëŒ€ 30ì¥ê¹Œì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // ì‚¬ì§„ ì—…ë¡œë“œ
                await uploadPhotos(files);
            });
        });

        // ì‚¬ì§„ ì—…ë¡œë“œ
        async function uploadPhotos(files) {
            const progressDiv = document.getElementById('upload-progress');
            const progressBar = document.getElementById('upload-progress-bar');
            const statusText = document.getElementById('upload-status');
            const submitBtn = document.getElementById('submit-btn');
            
            progressDiv.classList.remove('hidden');
            submitBtn.disabled = true;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const progress = ((i + 1) / files.length) * 100;
                
                progressBar.style.width = progress + '%';
                statusText.textContent = `ì—…ë¡œë“œ ì¤‘... ${i + 1}/${files.length}`;
                
                try {
                    // EXIF ê²€ì¦ (10ë¶„ ì´ë‚´ ì´¬ì˜)
                    const isValid = await validatePhotoTime(file);
                    if (!isValid) {
                        alert(`${file.name}: 10ë¶„ ì´ë‚´ì— ì´¬ì˜í•œ ì‚¬ì§„ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                        continue;
                    }
                    
                    // íŒŒì¼ëª… ìƒì„±
                    const timestamp = Date.now();
                    const fileName = `${timestamp}_${selectedLocation.code}_${selectedEmployee.name}_${file.name}`;
                    
                    // Supabase Storage ì—…ë¡œë“œ
                    const { data, error } = await supabaseClient.storage
                        .from('cleaning-photos')
                        .upload(fileName, file);
                    
                    if (error) throw error;
                    
                    // URL ê°€ì ¸ì˜¤ê¸°
                    const { data: urlData } = supabaseClient.storage
                        .from('cleaning-photos')
                        .getPublicUrl(fileName);
                    
                    uploadedPhotos.push({
                        url: urlData.publicUrl,
                        fileName: fileName
                    });
                    
                    console.log('âœ… Photo uploaded:', fileName);
                    
                } catch (error) {
                    console.error('âŒ Upload error:', error);
                    alert(`ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨: ${file.name}`);
                }
            }
            
            progressDiv.classList.add('hidden');
            updatePhotoPreview();
            updatePhotoCount();
            
            if (uploadedPhotos.length > 0) {
                submitBtn.disabled = false;
            }
        }

        // EXIF ì‹œê°„ ê²€ì¦ (10ë¶„ ì´ë‚´)
        async function validatePhotoTime(file) {
            return new Promise((resolve) => {
                EXIF.getData(file, function() {
                    const dateTime = EXIF.getTag(this, 'DateTimeOriginal');
                    
                    if (!dateTime) {
                        // EXIF ì—†ìœ¼ë©´ íŒŒì¼ ìˆ˜ì •ì‹œê°„ìœ¼ë¡œ í™•ì¸
                        const fileTime = new Date(file.lastModified);
                        const now = new Date();
                        const diff = now - fileTime;
                        resolve(diff < 10 * 60 * 1000); // 10ë¶„
                    } else {
                        // EXIF ì‹œê°„ íŒŒì‹±
                        const parts = dateTime.split(' ');
                        const datePart = parts[0].replace(/:/g, '-');
                        const timePart = parts[1];
                        const photoTime = new Date(`${datePart}T${timePart}`);
                        
                        const now = new Date();
                        const diff = now - photoTime;
                        resolve(diff < 10 * 60 * 1000); // 10ë¶„
                    }
                });
            });
        }

        // ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updatePhotoPreview() {
            const previewDiv = document.getElementById('photo-preview');
            previewDiv.innerHTML = uploadedPhotos.map((photo, index) => `
                <div class="relative">
                    <img src="${photo.url}" class="w-full h-24 object-cover rounded-lg">
                    <button onclick="removePhoto(${index})" class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        // ì‚¬ì§„ ì‚­ì œ
        function removePhoto(index) {
            uploadedPhotos.splice(index, 1);
            updatePhotoPreview();
            updatePhotoCount();
            
            if (uploadedPhotos.length === 0) {
                document.getElementById('submit-btn').disabled = true;
            }
        }

        // ì‚¬ì§„ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        function updatePhotoCount() {
            document.getElementById('photo-count').textContent = uploadedPhotos.length;
        }

        // ì²­ì†Œ ê¸°ë¡ ì œì¶œ
        async function submitCleaning() {
            const cleaningData = {
                employee_id: selectedEmployee.id,
                employee_name: selectedEmployee.name,
                employee_number: selectedEmployee.employee_number || '',
                location_id: selectedLocation.id,
                location_name: selectedLocation.name,
                location_code: selectedLocation.code,
                photo_urls: uploadedPhotos.map(p => p.url),
                photo_count: uploadedPhotos.length,
                photo_taken_at: new Date().toISOString(),
                submitted_at: new Date().toISOString(),
                status: 'completed',
                device_info: navigator.userAgent
            };
            
            try {
                const { data, error } = await supabaseClient
                    .from('cleaning_tasks')
                    .insert([cleaningData])
                    .select()
                    .single();
                
                if (error) throw error;
                
                console.log('âœ… Cleaning record saved');
                showCleaningComplete(data);
                
            } catch (error) {
                console.error('âŒ Error saving cleaning:', error);
                alert('ì²­ì†Œ ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì²­ì†Œ ì™„ë£Œ í‘œì‹œ
        function showCleaningComplete(record) {
            document.getElementById('step-photo-capture').classList.add('hidden');
            document.getElementById('step-cleaning-complete').classList.remove('hidden');
            
            const resultDiv = document.getElementById('cleaning-result');
            
            resultDiv.innerHTML = `
                <div class="text-left space-y-2">
                    <p><span class="font-semibold">ì§ì›:</span> ${record.employee_name}</p>
                    <p><span class="font-semibold">êµ¬ì—­:</span> ${record.location_name}</p>
                    <p><span class="font-semibold">ì‚¬ì§„:</span> ${record.photo_count}ì¥</p>
                    <p><span class="font-semibold">ì‹œê°„:</span> ${formatDateTime(new Date(record.submitted_at))}</p>
                </div>
            `;
        }

        // ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ë“¤
        function resetToScan() {
            isProcessing = false; // í”Œë˜ê·¸ ë¦¬ì…‹
            document.getElementById('step-menu-selection').classList.add('hidden');
            document.getElementById('step-qr-scan').classList.remove('hidden');
            // ìŠ¤ìºë„ˆ ë‹¤ì‹œ ì‹œì‘
            startScanner();
        }

        function backToMenu() {
            document.getElementById('step-employee-selection').classList.add('hidden');
            document.getElementById('step-menu-selection').classList.remove('hidden');
        }

        function backToEmployeeSelection() {
            document.getElementById('step-location-selection').classList.add('hidden');
            document.getElementById('step-employee-selection').classList.remove('hidden');
        }

        function backToLocationSelection() {
            uploadedPhotos = [];
            updatePhotoPreview();
            updatePhotoCount();
            document.getElementById('step-photo-capture').classList.add('hidden');
            document.getElementById('step-location-selection').classList.remove('hidden');
        }

        function resetAll() {
            // ëª¨ë“  ë³€ìˆ˜ ì´ˆê¸°í™”
            currentMode = null;
            scannedLocation = null;
            selectedEmployee = null;
            selectedLocation = null;
            uploadedPhotos = [];
            isProcessing = false; // í”Œë˜ê·¸ ë¦¬ì…‹
            
            // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('step-menu-selection').classList.add('hidden');
            document.getElementById('step-employee-selection').classList.add('hidden');
            document.getElementById('step-location-selection').classList.add('hidden');
            document.getElementById('step-photo-capture').classList.add('hidden');
            document.getElementById('step-attendance-complete').classList.add('hidden');
            document.getElementById('step-cleaning-complete').classList.add('hidden');
            
            // QR ìŠ¤ìº” í™”ë©´ìœ¼ë¡œ
            document.getElementById('step-qr-scan').classList.remove('hidden');
            // ìŠ¤ìºë„ˆ ë‹¤ì‹œ ì‹œì‘
            startScanner();
        }

        // ë‚ ì§œ/ì‹œê°„ í¬ë§·íŒ…
        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
    </script>
</body>
</html>
