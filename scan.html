<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR ìŠ¤ìº” - ì¶œì„/ì²­ì†Œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <style>
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -20px); }
            20% { opacity: 1; transform: translate(-50%, 0); }
            80% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -20px); }
        }
        .animate-fade-in-out {
            animation: fadeInOut 2s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-xl md:text-2xl font-bold">
                    <i class="fas fa-qrcode mr-2"></i>QR ìŠ¤ìº”
                </h1>
                <div class="space-x-2 md:space-x-4 text-sm md:text-base">
                    <a href="index.html" class="hover:text-blue-200">
                        <i class="fas fa-home mr-1"></i>ê´€ë¦¬ì
                    </a>
                    <a href="records.html" class="hover:text-blue-200">
                        <i class="fas fa-chart-bar mr-1"></i>ê¸°ë¡
                    </a>
                    <a href="?mode=cleaning_all" class="hover:text-purple-200 bg-purple-500 px-3 py-1 rounded-lg">
                        <i class="fas fa-broom mr-1"></i>ë¯¸í™” ì „ìš©
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- íƒ€ì´ë¨¸ í‘œì‹œ -->
    <div id="timer-display" class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-4 hidden">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas fa-clock text-yellow-600 text-2xl mr-3"></i>
                <div>
                    <p class="font-bold text-yellow-800">ë‚¨ì€ ì‹œê°„</p>
                    <p class="text-sm text-yellow-700">ì‹œê°„ì´ ì´ˆê³¼ë˜ë©´ ìë™ìœ¼ë¡œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤</p>
                </div>
            </div>
            <div class="text-right">
                <p class="text-3xl font-bold text-yellow-800" id="timer-countdown">5:00</p>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="container mx-auto px-4 py-6">
        
        <!-- Step 1: ì‘ì—… ì„ íƒ (ì²« í™”ë©´) -->
        <div id="step-menu-selection" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6">
            <h2 class="text-lg md:text-xl font-bold mb-4 text-center">
                <i class="fas fa-list mr-2"></i>ì‘ì—… ì„ íƒ
            </h2>
            <div id="location-info" class="bg-blue-50 rounded-lg p-4 mb-6 text-center">
                <i class="fas fa-map-marker-alt text-blue-600 text-3xl mb-2"></i>
                <h3 class="text-xl font-bold" id="location-name-display">-</h3>
                <p class="text-gray-600" id="location-code-display">-</p>
            </div>
            <p class="text-sm md:text-base text-gray-600 mb-6 text-center">ìˆ˜í–‰í•  ì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš”</p>
            
            <div class="space-y-4">
                <button onclick="selectMode('attendance')" 
                    class="w-full bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-lg hover:shadow-xl transition transform hover:-translate-y-1">
                    <i class="fas fa-user-check text-4xl mb-3"></i>
                    <p class="font-bold text-xl">ğŸ“± ê·¼íƒœ ê¸°ë¡</p>
                    <p class="text-sm text-blue-100 mt-2">ì¶œê·¼/í‡´ê·¼/íœ´ê²Œ</p>
                </button>
                
                <button onclick="selectMode('cleaning')" 
                    class="w-full bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-lg hover:shadow-xl transition transform hover:-translate-y-1">
                    <i class="fas fa-broom text-4xl mb-3"></i>
                    <p class="font-bold text-xl">ğŸ§¹ ì²­ì†Œ ì—…ë¬´</p>
                    <p class="text-sm text-green-100 mt-2">ì²­ì†Œ ì‚¬ì§„ ì—…ë¡œë“œ</p>
                </button>
            </div>
        </div>

        <!-- Step 2: êµ¬ì—­ ì„ íƒ (ë¯¸í™” ì „ìš© ëª¨ë“œ) -->
        <div id="step-location-selection" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6 hidden">
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-4 mb-6 text-center text-white">
                <i class="fas fa-broom text-4xl mb-2"></i>
                <h2 class="text-xl font-bold">ğŸ§¹ ë¯¸í™” ì „ìš© ëª¨ë“œ</h2>
                <p class="text-sm text-purple-100 mt-2">ì²­ì†Œí•  êµ¬ì—­ì„ ì„ íƒí•˜ì„¸ìš”</p>
            </div>
            
            <div class="bg-purple-50 rounded-lg p-4 mb-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="font-semibold">ë¯¸í™”ì›: <span id="cleaner-employee-name">-</span></p>
                        <p class="text-sm text-gray-600">ì˜¤ëŠ˜ ì§„í–‰ ìƒí™©</p>
                    </div>
                    <div class="text-purple-600 text-right">
                        <p class="text-2xl font-bold" id="completed-locations-count">0</p>
                        <p class="text-xs">êµ¬ì—­ ì™„ë£Œ</p>
                    </div>
                </div>
            </div>
            
            <div id="locations-grid" class="space-y-3 mb-4">
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                    <p>êµ¬ì—­ ëª©ë¡ ë¡œë”© ì¤‘...</p>
                </div>
            </div>
            
            <button onclick="finishAllCleaning()" class="w-full bg-gradient-to-br from-green-500 to-green-600 text-white px-6 py-4 rounded-lg hover:shadow-xl transition transform hover:-translate-y-1">
                <i class="fas fa-check-circle text-2xl mb-2"></i>
                <p class="font-bold text-xl">âœ… ëª¨ë“  ì²­ì†Œ ì™„ë£Œ</p>
                <p class="text-sm text-green-100 mt-1">ì˜¤ëŠ˜ ì²­ì†Œë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤</p>
            </button>
        </div>

        <!-- Step 2: ì§ì› ì„ íƒ -->
        <div id="step-employee-selection" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6 hidden">
            <h2 class="text-lg md:text-xl font-bold mb-4">
                <i class="fas fa-user mr-2"></i>ì§ì› ì„ íƒ
            </h2>
            <p class="text-sm md:text-base text-gray-600 mb-4" id="employee-instruction">ë³¸ì¸ì˜ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”</p>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">ì§ì› ê²€ìƒ‰</label>
                <input type="text" id="employee-search" placeholder="ì´ë¦„ ë˜ëŠ” ì‚¬ë²ˆìœ¼ë¡œ ê²€ìƒ‰..." 
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div id="employees-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                <div class="col-span-full text-center text-gray-500 py-8">
                    <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                    <p>ì§ì› ëª©ë¡ ë¡œë”© ì¤‘...</p>
                </div>
            </div>
            
            <button onclick="backToMenu()" class="mt-4 w-full bg-gray-200 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-300">
                <i class="fas fa-arrow-left mr-2"></i>ì´ì „ ë‹¨ê³„ë¡œ
            </button>
        </div>

        <!-- Step 3-A: ê·¼íƒœ íƒ€ì… ì„ íƒ (ì¶œì„ ëª¨ë“œ) -->
        <div id="step-attendance-type" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6 hidden">
            <h2 class="text-lg md:text-xl font-bold mb-4 text-center">
                <i class="fas fa-clock mr-2"></i>ê·¼íƒœ íƒ€ì… ì„ íƒ
            </h2>
            
            <div class="bg-blue-50 rounded-lg p-4 mb-6 text-center">
                <p class="font-semibold text-lg" id="attendance-employee-name">-</p>
                <p class="text-sm text-gray-600" id="attendance-location-name">-</p>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <button onclick="selectAttendanceType('ì¶œê·¼')" 
                    class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-lg hover:shadow-xl transition">
                    <i class="fas fa-sign-in-alt text-3xl mb-2"></i>
                    <p class="font-bold">ì¶œê·¼</p>
                </button>
                
                <button onclick="selectAttendanceType('í‡´ê·¼')" 
                    class="bg-gradient-to-br from-red-500 to-red-600 text-white p-6 rounded-lg hover:shadow-xl transition">
                    <i class="fas fa-sign-out-alt text-3xl mb-2"></i>
                    <p class="font-bold">í‡´ê·¼</p>
                </button>
                
                <button onclick="selectAttendanceType('íœ´ê²Œ ì‹œì‘')" 
                    class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-6 rounded-lg hover:shadow-xl transition">
                    <i class="fas fa-coffee text-3xl mb-2"></i>
                    <p class="font-bold">íœ´ê²Œ ì‹œì‘</p>
                </button>
                
                <button onclick="selectAttendanceType('íœ´ê²Œ ì¢…ë£Œ')" 
                    class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-lg hover:shadow-xl transition">
                    <i class="fas fa-play-circle text-3xl mb-2"></i>
                    <p class="font-bold">íœ´ê²Œ ì¢…ë£Œ</p>
                </button>
            </div>
            
            <button onclick="backToEmployeeSelection()" class="mt-4 w-full bg-gray-200 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-300">
                <i class="fas fa-arrow-left mr-2"></i>ì´ì „ ë‹¨ê³„ë¡œ
            </button>
        </div>

        <!-- Step 3-B: ì‚¬ì§„ ì´¬ì˜ (ì²­ì†Œ ëª¨ë“œ) -->
        <div id="step-photo-capture" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6 hidden">
            <h2 class="text-lg md:text-xl font-bold mb-4">
                <i class="fas fa-camera mr-2"></i>ì²­ì†Œ ì‚¬ì§„ ì´¬ì˜
            </h2>
            
            <!-- í˜„ì¬ ì‘ì—… ì¤‘ì¸ êµ¬ì—­ ì •ë³´ -->
            <div class="bg-green-50 rounded-lg p-4 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <p class="font-semibold">ì§ì›: <span id="current-employee-name">-</span></p>
                        <p class="text-sm text-gray-600">êµ¬ì—­: <span id="current-location-name">-</span></p>
                    </div>
                    <div class="text-green-600 text-right">
                        <p class="text-2xl font-bold" id="current-photo-count">0</p>
                        <p class="text-xs">ì¥</p>
                    </div>
                </div>
            </div>
            
            <!-- íŒŒì¼ ì„ íƒ input (ì¹´ë©”ë¼ ì§ì ‘ ì´¬ì˜) -->
            <input type="file" id="photo-input-camera" accept="image/*" capture="environment" multiple class="hidden">
            
            <!-- íŒŒì¼ ì„ íƒ input (ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒ) -->
            <input type="file" id="photo-input-gallery" accept="image/*" multiple class="hidden">
            
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button onclick="capturePhotos()" class="bg-gradient-to-br from-green-500 to-green-600 text-white px-6 py-4 rounded-lg hover:shadow-xl transition transform hover:-translate-y-1">
                    <i class="fas fa-camera text-3xl mb-2"></i>
                    <p class="font-bold">ğŸ“· ì‚¬ì§„ ì´¬ì˜</p>
                    <p class="text-xs text-green-100 mt-1">ì¹´ë©”ë¼ ì—´ê¸°</p>
                </button>
                
                <button onclick="selectFromGallery()" class="bg-gradient-to-br from-blue-500 to-blue-600 text-white px-6 py-4 rounded-lg hover:shadow-xl transition transform hover:-translate-y-1">
                    <i class="fas fa-images text-3xl mb-2"></i>
                    <p class="font-bold">ğŸ–¼ï¸ ê°¤ëŸ¬ë¦¬</p>
                    <p class="text-xs text-blue-100 mt-1">ì‚¬ì§„ ì„ íƒ</p>
                </button>
            </div>
            
            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 mb-4 text-sm">
                <p class="text-yellow-800"><i class="fas fa-info-circle mr-2"></i><strong>íŒ:</strong> ì²­ì†Œ í›„ ì‚¬ì§„ì„ ì—¬ëŸ¬ ì¥ ì´¬ì˜í•´ë‘ê³ , 'ê°¤ëŸ¬ë¦¬' ë²„íŠ¼ìœ¼ë¡œ í•œ ë²ˆì— ì„ íƒí•˜ì„¸ìš”! (ìµœëŒ€ 30ì¥)</p>
            </div>
            
            <!-- ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° -->
            <div id="photo-preview" class="grid grid-cols-3 gap-2 mb-4"></div>
            
            <!-- ì—…ë¡œë“œ ì§„í–‰ë¥  -->
            <div id="upload-progress" class="hidden mb-4">
                <div class="bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div id="upload-progress-bar" class="bg-green-600 h-full transition-all" style="width: 0%"></div>
                </div>
                <p class="text-sm text-center mt-2" id="upload-status">ì—…ë¡œë“œ ì¤‘...</p>
            </div>
            
            <button onclick="submitCleaning()" id="submit-cleaning-btn" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 mb-3" disabled>
                <i class="fas fa-check mr-2"></i>ì—…ë¡œë“œ & ì™„ë£Œ
            </button>
            
            <button onclick="cancelCleaning()" class="w-full bg-gray-200 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-300">
                <i class="fas fa-times mr-2"></i>ì·¨ì†Œ
            </button>
        </div>

        <!-- Step 4-A: ì¶œì„ ì™„ë£Œ (ì¶œì„ ëª¨ë“œ) -->
        <div id="step-attendance-complete" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6 hidden">
            <div class="text-center">
                <i class="fas fa-check-circle text-green-600 text-6xl mb-4"></i>
                <h2 class="text-2xl font-bold mb-2">ê·¼íƒœ ê¸°ë¡ ì™„ë£Œ!</h2>
                <div id="attendance-result" class="bg-gray-50 rounded-lg p-4 mb-4"></div>
                <button onclick="resetAll()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                    <i class="fas fa-redo mr-2"></i>ì²˜ìŒìœ¼ë¡œ
                </button>
            </div>
        </div>

        <!-- Step 4-B: ì²­ì†Œ ì™„ë£Œ -->
        <div id="step-cleaning-complete" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6 hidden">
            <div class="text-center">
                <i class="fas fa-check-circle text-green-600 text-6xl mb-4"></i>
                <h2 class="text-2xl font-bold mb-2">ì²­ì†Œ ê¸°ë¡ ì™„ë£Œ!</h2>
                <div id="cleaning-result" class="bg-gray-50 rounded-lg p-4 mb-4"></div>
                <button onclick="resetAll()" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700">
                    <i class="fas fa-redo mr-2"></i>ì²˜ìŒìœ¼ë¡œ
                </button>
            </div>
        </div>

    </div>

    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://qgpqhtuynxhmgawakjxe.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_ujXj0mLf1casiQdVkc0fCA_G6exymqG';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ì „ì—­ ë³€ìˆ˜
        let currentMode = null;
        let scannedLocation = null;
        let selectedEmployee = null;
        let employees = [];
        let currentPhotos = [];
        let sessionTimer = null;
        let sessionStartTime = null;
        const SESSION_DURATION = 5 * 60 * 1000;
        let allLocations = [];
        let completedLocations = [];
        let isCleaningAllMode = false;

        // âœ¨ ì‚¬ì§„ ì••ì¶• í•¨ìˆ˜ ì¶”ê°€ (70~80% ìš©ëŸ‰ ì ˆê°!)
        async function compressImage(file, maxWidth = 1920, quality = 0.7) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // ìµœëŒ€ ë„ˆë¹„ ì œí•œ
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            const compressedFile = new File([blob], file.name, {
                                type: 'image/jpeg',
                                lastModified: Date.now(),
                            });
                            console.log(`ğŸ—œï¸ ì••ì¶•: ${(file.size / 1024 / 1024).toFixed(2)}MB â†’ ${(compressedFile.size / 1024 / 1024).toFixed(2)}MB`);
                            resolve(compressedFile);
                        }, 'image/jpeg', quality);
                    };
                };
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('âœ… Page loaded');
            
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const locationId = urlParams.get('id');
            const locationName = urlParams.get('name');
            const locationCode = urlParams.get('location');
            
            console.log('ğŸ“ URL Parameters:', { mode, locationId, locationName, locationCode });
            
            if (mode === 'cleaning_all') {
                console.log('ğŸ§¹ ë¯¸í™” ì „ìš© ëª¨ë“œ í™œì„±í™”!');
                isCleaningAllMode = true;
                currentMode = 'cleaning_all';
                
                document.getElementById('timer-display').classList.add('hidden');
                document.getElementById('step-menu-selection').classList.add('hidden');
                document.getElementById('step-employee-selection').classList.remove('hidden');
                document.getElementById('employee-instruction').textContent = 'ë¯¸í™”ì›ì„ ì„ íƒí•˜ì„¸ìš”';
                
                await loadLocations();
            }
            else if (locationId && locationName && locationCode) {
                scannedLocation = {
                    id: locationId,
                    name: decodeURIComponent(locationName),
                    code: locationCode
                };
                
                console.log('âœ… Location loaded:', scannedLocation);
                startSessionTimer();
                showMenuSelection();
            } else {
                console.error('âŒ Missing parameters:', { locationId, locationName, locationCode });
                alert('ì˜¬ë°”ë¥¸ QR ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤.\nêµ¬ì—­ ì •ë³´ê°€ í¬í•¨ëœ QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”.');
            }
            
            await loadEmployees();
        });

        function showMenuSelection() {
            console.log('ğŸŸ¢ showMenuSelection()');
            document.getElementById('location-name-display').textContent = scannedLocation.name;
            document.getElementById('location-code-display').textContent = scannedLocation.code;
            document.getElementById('timer-display').classList.remove('hidden');
            console.log('âœ… Menu selection screen shown');
        }

        function startSessionTimer() {
            sessionStartTime = Date.now();
            document.getElementById('timer-display').classList.remove('hidden');
            
            sessionTimer = setInterval(() => {
                const elapsed = Date.now() - sessionStartTime;
                const remaining = SESSION_DURATION - elapsed;
                
                if (remaining <= 0) {
                    clearInterval(sessionTimer);
                    alert('â° ì‹œê°„ì´ ì´ˆê³¼ë˜ì–´ ìë™ìœ¼ë¡œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.');
                    window.location.reload();
                } else {
                    const minutes = Math.floor(remaining / 60000);
                    const seconds = Math.floor((remaining % 60000) / 1000);
                    document.getElementById('timer-countdown').textContent = 
                        `${minutes}:${String(seconds).padStart(2, '0')}`;
                    
                    const timerDisplay = document.getElementById('timer-display');
                    if (remaining < 60000) {
                        timerDisplay.classList.remove('bg-yellow-50', 'border-yellow-500');
                        timerDisplay.classList.add('bg-red-50', 'border-red-500');
                        document.getElementById('timer-countdown').classList.remove('text-yellow-800');
                        document.getElementById('timer-countdown').classList.add('text-red-800');
                    }
                }
            }, 1000);
            
            console.log('â° Session timer started (5 minutes)');
        }

        function stopSessionTimer() {
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
                console.log('â° Session timer stopped');
            }
        }

        function selectMode(mode) {
            currentMode = mode;
            console.log('ğŸ”µ Selected mode:', mode);
            document.getElementById('step-menu-selection').classList.add('hidden');
            document.getElementById('step-employee-selection').classList.remove('hidden');
            
            if (mode === 'attendance') {
                document.getElementById('employee-instruction').textContent = 'ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”';
            } else {
                document.getElementById('employee-instruction').textContent = 'ì²­ì†Œ ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”';
            }
        }

        async function loadLocations() {
            try {
                const { data, error } = await supabaseClient
                    .from('locations')
                    .select('*')
                    .eq('is_active', true)
                    .order('name', { ascending: true });
                
                if (error) throw error;
                
                allLocations = data || [];
                console.log(`âœ… Loaded ${allLocations.length} locations`);
                
            } catch (error) {
                console.error('âŒ Error loading locations:', error);
                allLocations = [];
            }
        }

        function showLocationSelection() {
            document.getElementById('step-employee-selection').classList.add('hidden');
            document.getElementById('step-photo-capture').classList.add('hidden');
            document.getElementById('step-cleaning-complete').classList.add('hidden');
            document.getElementById('step-location-selection').classList.remove('hidden');
            
            document.getElementById('cleaner-employee-name').textContent = selectedEmployee.name;
            document.getElementById('completed-locations-count').textContent = completedLocations.length;
            
            displayLocations();
        }

        function displayLocations() {
            const grid = document.getElementById('locations-grid');
            
            if (allLocations.length === 0) {
                grid.innerHTML = '<div class="text-center text-gray-500 py-4">ë“±ë¡ëœ êµ¬ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            grid.innerHTML = allLocations.map(loc => {
                const isCompleted = completedLocations.includes(loc.id);
                
                if (isCompleted) {
                    return `
                        <div class="bg-green-50 border-2 border-green-500 rounded-lg p-4 flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-600 text-2xl mr-3"></i>
                                <div>
                                    <p class="font-bold text-green-800">${loc.name}</p>
                                    <p class="text-sm text-green-600">${loc.code}</p>
                                </div>
                            </div>
                            <span class="bg-green-600 text-white px-3 py-1 rounded-full text-sm font-bold">ì™„ë£Œ</span>
                        </div>
                    `;
                } else {
                    return `
                        <button onclick='selectLocation("${loc.id}")' 
                            class="w-full bg-white border-2 border-gray-300 rounded-lg p-4 flex items-center justify-between hover:border-purple-500 hover:bg-purple-50 transition">
                            <div class="flex items-center">
                                <i class="fas fa-map-marker-alt text-gray-400 text-2xl mr-3"></i>
                                <div class="text-left">
                                    <p class="font-bold text-gray-800">${loc.name}</p>
                                    <p class="text-sm text-gray-600">${loc.code}</p>
                                </div>
                            </div>
                            <span class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-purple-700">
                                <i class="fas fa-broom mr-1"></i>ì²­ì†Œí•˜ê¸°
                            </span>
                        </button>
                    `;
                }
            }).join('');
        }

        function selectLocation(locationId) {
            const location = allLocations.find(loc => loc.id === locationId);
            
            if (!location) {
                alert('êµ¬ì—­ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            scannedLocation = {
                id: location.id,
                name: location.name,
                code: location.code
            };
            
            console.log('ğŸ“ Selected location:', scannedLocation);
            showPhotoCapture();
        }

        function finishAllCleaning() {
            if (completedLocations.length === 0) {
                alert('ì•„ì§ ì™„ë£Œëœ êµ¬ì—­ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (confirm(`ì´ ${completedLocations.length}ê°œ êµ¬ì—­ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.\nì˜¤ëŠ˜ ì²­ì†Œë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                showToast(`ğŸ‰ ì´ ${completedLocations.length}ê°œ êµ¬ì—­ ì²­ì†Œ ì™„ë£Œ!`);
                
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        }

        async function loadEmployees() {
            try {
                const { data, error } = await supabaseClient
                    .from('employees')
                    .select('*')
                    .eq('is_active', true)
                    .order('name', { ascending: true });
                
                if (error) throw error;
                
                employees = data || [];
                console.log(`âœ… Loaded ${employees.length} employees`);
                displayEmployees(employees);
                
            } catch (error) {
                console.error('âŒ Error loading employees:', error);
                document.getElementById('employees-grid').innerHTML = 
                    `<div class="col-span-full text-center text-red-500 py-4">
                        <p>ì§ì› ëª©ë¡ ë¡œë”© ì‹¤íŒ¨</p>
                        <button onclick="loadEmployees()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded-md">ë‹¤ì‹œ ì‹œë„</button>
                    </div>`;
            }
        }

        function displayEmployees(employeeList) {
            const grid = document.getElementById('employees-grid');
            
            let filteredList = employeeList;
            if (isCleaningAllMode) {
                filteredList = employeeList.filter(emp => {
                    const position = emp.position || '';
                    return position.includes('ë¯¸í™”');
                });
                console.log(`ğŸ§¹ ë¯¸í™” ì „ìš©: ${filteredList.length}ëª… / ${employeeList.length}ëª…`);
            }
            
            if (filteredList.length === 0) {
                if (isCleaningAllMode) {
                    grid.innerHTML = '<div class="col-span-full text-center text-purple-500 py-4">ë¯¸í™” ì§ì±…ì˜ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                } else {
                    grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
                return;
            }
            
            grid.innerHTML = filteredList.map(emp => {
                const initial = emp.name.charAt(0);
                const borderColor = isCleaningAllMode ? 'border-purple-200 hover:border-purple-600 hover:bg-purple-50' : 'border-gray-200 hover:border-blue-600 hover:bg-blue-50';
                const bgColor = isCleaningAllMode ? 'bg-purple-600' : 'bg-blue-600';
                return `
                    <button onclick="selectEmployee('${emp.id}')" 
                        class="p-3 md:p-4 border-2 ${borderColor} rounded-lg transition text-center">
                        <div class="w-10 h-10 md:w-12 md:h-12 ${bgColor} rounded-full flex items-center justify-center text-white font-bold mx-auto mb-2">
                            ${initial}
                        </div>
                        <div class="font-semibold text-sm md:text-base">${emp.name}</div>
                        <div class="text-xs text-gray-500">${emp.employee_number || ''}</div>
                        ${emp.position ? `<div class="text-xs text-purple-600 mt-1">${emp.position}</div>` : ''}
                    </button>
                `;
            }).join('');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('employee-search');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    let filtered = searchTerm === '' ? employees : employees.filter(emp => 
                        emp.name.toLowerCase().includes(searchTerm) ||
                        (emp.employee_number && emp.employee_number.toLowerCase().includes(searchTerm)) ||
                        (emp.position && emp.position.toLowerCase().includes(searchTerm))
                    );
                    displayEmployees(filtered);
                });
            }
        });

        function selectEmployee(employeeId) {
            selectedEmployee = employees.find(emp => emp.id === employeeId);
            
            if (!selectedEmployee) {
                alert('ì§ì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            console.log('ğŸ‘¤ Selected employee:', selectedEmployee.name);
            
            if (isCleaningAllMode) {
                showLocationSelection();
            } else if (currentMode === 'attendance') {
                showAttendanceTypeSelection();
            } else {
                showPhotoCapture();
            }
        }

        function showAttendanceTypeSelection() {
            document.getElementById('step-employee-selection').classList.add('hidden');
            document.getElementById('step-attendance-type').classList.remove('hidden');
            
            document.getElementById('attendance-employee-name').textContent = selectedEmployee.name;
            document.getElementById('attendance-location-name').textContent = scannedLocation.name;
        }

        async function selectAttendanceType(type) {
            const attendanceData = {
                employee_id: selectedEmployee.id,
                employee_name: selectedEmployee.name,
                employee_number: selectedEmployee.employee_number || '',
                location_id: scannedLocation.id,
                location_name: scannedLocation.name,
                location_code: scannedLocation.code,
                attendance_type: type,
                scan_time: new Date().toISOString(),
                device_info: navigator.userAgent
            };
            
            try {
                const { data, error } = await supabaseClient
                    .from('attendance_records')
                    .insert([attendanceData])
                    .select()
                    .single();
                
                if (error) throw error;
                
                console.log('âœ… Attendance saved');
                stopSessionTimer();
                showAttendanceComplete(data);
                
            } catch (error) {
                console.error('âŒ Error saving attendance:', error);
                alert('ê·¼íƒœ ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function showAttendanceComplete(record) {
            document.getElementById('step-attendance-type').classList.add('hidden');
            document.getElementById('step-attendance-complete').classList.remove('hidden');
            
            const resultDiv = document.getElementById('attendance-result');
            const scanTime = new Date(record.scan_time);
            
            resultDiv.innerHTML = `
                <div class="text-left space-y-2">
                    <p><span class="font-semibold">ì§ì›:</span> ${record.employee_name}</p>
                    <p><span class="font-semibold">êµ¬ì—­:</span> ${record.location_name}</p>
                    <p><span class="font-semibold">íƒ€ì…:</span> ${record.attendance_type}</p>
                    <p><span class="font-semibold">ì‹œê°„:</span> ${formatDateTime(scanTime)}</p>
                </div>
            `;
        }

        function showPhotoCapture() {
            document.getElementById('step-employee-selection').classList.add('hidden');
            document.getElementById('step-photo-capture').classList.remove('hidden');
            
            document.getElementById('current-employee-name').textContent = selectedEmployee.name;
            document.getElementById('current-location-name').textContent = scannedLocation.name;
            updateCurrentPhotoCount();
        }

        function capturePhotos() {
            document.getElementById('photo-input-camera').click();
        }
        
        function selectFromGallery() {
            document.getElementById('photo-input-gallery').click();
        }

        // âœ¨ ì‚¬ì§„ ì„ íƒ í•¸ë“¤ëŸ¬ (ì••ì¶• ì ìš©!)
        async function handlePhotoSelection(files) {
            if (files.length === 0) return;
            
            if (currentPhotos.length + files.length > 30) {
                alert(`ìµœëŒ€ 30ì¥ê¹Œì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\ní˜„ì¬: ${currentPhotos.length}ì¥, ì„ íƒ: ${files.length}ì¥`);
                return;
            }
            
            let validCount = 0;
            let invalidCount = 0;
            
            for (const file of files) {
                const isValid = await validatePhotoTime(file);
                if (!isValid) {
                    invalidCount++;
                    console.warn(`âŒ Invalid photo: ${file.name}`);
                    continue;
                }
                
                // âœ¨ ì‚¬ì§„ ì••ì¶• ì ìš©!
                const compressedFile = await compressImage(file);
                currentPhotos.push(compressedFile);
                validCount++;
            }
            
            if (invalidCount > 0) {
                alert(`âœ… ${validCount}ì¥ ì¶”ê°€ë¨\nâŒ ${invalidCount}ì¥ ì œì™¸ë¨ (10ë¶„ ì´ë‚´ ì´¬ì˜ ì‚¬ì§„ë§Œ ê°€ëŠ¥)`);
            } else if (validCount > 0) {
                showToast(`âœ… ${validCount}ì¥ ì¶”ê°€ë¨! (ìš©ëŸ‰ ì ˆê° ì ìš©)`);
            }
            
            updatePhotoPreview();
            updateCurrentPhotoCount();
            updateSubmitButton();
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in-out';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 2000);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const photoCameraInput = document.getElementById('photo-input-camera');
            if (photoCameraInput) {
                photoCameraInput.addEventListener('change', async function(e) {
                    const files = Array.from(e.target.files);
                    await handlePhotoSelection(files);
                    e.target.value = '';
                });
            }
            
            const photoGalleryInput = document.getElementById('photo-input-gallery');
            if (photoGalleryInput) {
                photoGalleryInput.addEventListener('change', async function(e) {
                    const files = Array.from(e.target.files);
                    await handlePhotoSelection(files);
                    e.target.value = '';
                });
            }
        });

        function updatePhotoPreview() {
            const previewDiv = document.getElementById('photo-preview');
            previewDiv.innerHTML = currentPhotos.map((file, index) => {
                const url = URL.createObjectURL(file);
                return `
                    <div class="relative">
                        <img src="${url}" class="w-full h-24 object-cover rounded-lg">
                        <button onclick="removePhoto(${index})" class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function removePhoto(index) {
            currentPhotos.splice(index, 1);
            updatePhotoPreview();
            updateCurrentPhotoCount();
            updateSubmitButton();
        }

        function updateCurrentPhotoCount() {
            document.getElementById('current-photo-count').textContent = currentPhotos.length;
        }

        function updateSubmitButton() {
            const submitBtn = document.getElementById('submit-cleaning-btn');
            submitBtn.disabled = currentPhotos.length === 0;
        }

        async function validatePhotoTime(file) {
            return new Promise((resolve) => {
                EXIF.getData(file, function() {
                    const dateTime = EXIF.getTag(this, 'DateTimeOriginal');
                    
                    if (!dateTime) {
                        const fileTime = new Date(file.lastModified);
                        const now = new Date();
                        const diff = now - fileTime;
                        resolve(diff < 10 * 60 * 1000);
                    } else {
                        const parts = dateTime.split(' ');
                        const datePart = parts[0].replace(/:/g, '-');
                        const timePart = parts[1];
                        const photoTime = new Date(`${datePart}T${timePart}`);
                        
                        const now = new Date();
                        const diff = now - photoTime;
                        resolve(diff < 10 * 60 * 1000);
                    }
                });
            });
        }

        async function submitCleaning() {
            if (currentPhotos.length === 0) {
                alert('ì‚¬ì§„ì„ ì¶”ê°€í•˜ì„¸ìš”.');
                return;
            }
            
            const progressDiv = document.getElementById('upload-progress');
            const progressBar = document.getElementById('upload-progress-bar');
            const statusText = document.getElementById('upload-status');
            const submitBtn = document.getElementById('submit-cleaning-btn');
            
            progressDiv.classList.remove('hidden');
            submitBtn.disabled = true;
            
            try {
                const photoUrls = [];
                let uploadedCount = 0;
                const totalPhotos = currentPhotos.length;
                
                for (const file of currentPhotos) {
                    const timestamp = Date.now();
                    const sanitizedFileName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                    const fileName = `${timestamp}_${scannedLocation.code}_${selectedEmployee.id}_${sanitizedFileName}`;
                    
                    const { data, error } = await supabaseClient.storage
                        .from('cleaning-photos')
                        .upload(fileName, file);
                    
                    if (error) throw error;
                    
                    const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/cleaning-photos/${fileName}`;
                    photoUrls.push(publicUrl);
                    
                    console.log('âœ… Photo uploaded:', fileName, publicUrl);
                    
                    uploadedCount++;
                    const progress = (uploadedCount / totalPhotos) * 100;
                    progressBar.style.width = progress + '%';
                    statusText.textContent = `ì—…ë¡œë“œ ì¤‘... ${uploadedCount}/${totalPhotos}`;
                }
                
                const cleaningData = {
                    employee_id: selectedEmployee.id,
                    employee_name: selectedEmployee.name,
                    employee_number: selectedEmployee.employee_number || '',
                    location_id: scannedLocation.id,
                    location_name: scannedLocation.name,
                    location_code: scannedLocation.code,
                    photo_urls: photoUrls,
                    photo_count: photoUrls.length,
                    photo_taken_at: new Date().toISOString(),
                    submitted_at: new Date().toISOString(),
                    status: 'completed',
                    device_info: navigator.userAgent
                };
                
                const { error: dbError } = await supabaseClient
                    .from('cleaning_tasks')
                    .insert([cleaningData]);
                
                if (dbError) throw dbError;
                
                progressDiv.classList.add('hidden');
                console.log('âœ… Cleaning saved');
                stopSessionTimer();
                showCleaningComplete();
                
            } catch (error) {
                console.error('âŒ Error submitting cleaning:', error);
                alert('ì²­ì†Œ ê¸°ë¡ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                progressDiv.classList.add('hidden');
                submitBtn.disabled = false;
            }
        }

        function showCleaningComplete() {
            document.getElementById('step-photo-capture').classList.add('hidden');
            document.getElementById('step-cleaning-complete').classList.remove('hidden');
            
            const resultDiv = document.getElementById('cleaning-result');
            
            resultDiv.innerHTML = `
                <div class="text-left space-y-2">
                    <p><span class="font-semibold">ì§ì›:</span> ${selectedEmployee.name}</p>
                    <p><span class="font-semibold">êµ¬ì—­:</span> ${scannedLocation.name}</p>
                    <p><span class="font-semibold">ì‚¬ì§„:</span> ${currentPhotos.length}ì¥</p>
                    <p><span class="font-semibold">ì‹œê°„:</span> ${formatDateTime(new Date())}</p>
                </div>
            `;
            
            if (isCleaningAllMode) {
                if (!completedLocations.includes(scannedLocation.id)) {
                    completedLocations.push(scannedLocation.id);
                }
                
                currentPhotos = [];
                
                setTimeout(() => {
                    showLocationSelection();
                }, 2000);
            }
        }

        function cancelCleaning() {
            if (confirm('ì‘ì—…ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ë°ì´í„°ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.')) {
                resetAll();
            }
        }

        function backToMenu() {
            document.getElementById('step-employee-selection').classList.add('hidden');
            document.getElementById('step-menu-selection').classList.remove('hidden');
        }

        function backToEmployeeSelection() {
            document.getElementById('step-attendance-type').classList.add('hidden');
            document.getElementById('step-employee-selection').classList.remove('hidden');
        }

        function resetAll() {
            stopSessionTimer();
            
            currentMode = null;
            selectedEmployee = null;
            currentPhotos = [];
            
            document.getElementById('step-employee-selection').classList.add('hidden');
            document.getElementById('step-attendance-type').classList.add('hidden');
            document.getElementById('step-photo-capture').classList.add('hidden');
            document.getElementById('step-attendance-complete').classList.add('hidden');
            document.getElementById('step-cleaning-complete').classList.add('hidden');
            
            startSessionTimer();
            
            document.getElementById('step-menu-selection').classList.remove('hidden');
        }

        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
    </script>
</body>
</html>
