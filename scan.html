
<!DOCTYPE html>
<html lang="ko" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>KINDWON ì§ì› ì—…ë¬´ ì‹œìŠ¤í…œ</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
      body {
        font-family: 'Noto Sans KR', sans-serif;
        background-color: #f8f9fa;
        -webkit-tap-highlight-color: transparent;
      }
      .bg-gradient-brand {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      }
      .text-brand {
        color: #1b5e3e;
      }
      .bg-brand {
        background-color: #1b5e3e;
      }
      .btn-professional {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      .btn-professional:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }
      .btn-professional:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      }
      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 3px solid white;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
      }
      .spinner-dark {
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-top: 3px solid #1b5e3e;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      /* Toast Animation */
      .toast-enter {
        transform: translateY(100%);
        opacity: 0;
      }
      .toast-enter-active {
        transform: translateY(0);
        opacity: 1;
        transition: all 0.3s ease-out;
      }
      /* Session Timer */
      .timer-warning {
        animation: pulse-warning 2s ease-in-out infinite;
      }
      @keyframes pulse-warning {
        0%, 100% {
          background-color: #fbbf24;
        }
        50% {
          background-color: #f59e0b;
        }
      }
      /* Multi Upload Progress */
      .upload-progress {
        height: 6px;
        background: linear-gradient(90deg, #10b981 0%, #10b981 var(--progress), #e5e7eb var(--progress), #e5e7eb 100%);
        transition: all 0.3s;
      }
      /* Before/After Mode */
      .mode-toggle {
        position: relative;
        width: 60px;
        height: 28px;
        background-color: #d1d5db;
        border-radius: 14px;
        transition: background-color 0.3s;
        cursor: pointer;
      }
      .mode-toggle.active {
        background-color: #3b82f6;
      }
      .mode-toggle-circle {
        position: absolute;
        top: 2px;
        left: 2px;
        width: 24px;
        height: 24px;
        background-color: white;
        border-radius: 50%;
        transition: transform 0.3s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      .mode-toggle.active .mode-toggle-circle {
        transform: translateX(32px);
      }
    </style>
  </head>
  <body class="min-h-screen relative pb-20">
    <!-- Loading Overlay -->
    <div id="screen-loading" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
      <div class="spinner spinner-dark w-12 h-12 mb-4"></div>
      <p class="text-gray-500 font-medium animate-pulse">ì‹œìŠ¤í…œ ì—°ê²° ì¤‘...</p>
    </div>

    <!-- Header -->
    <header class="bg-gradient-brand shadow-lg sticky top-0 z-30">
      <div class="px-6 py-5 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="/logo.png" alt="KINDWON" class="h-8 bg-white rounded px-1" style="display: block !important; flex-shrink: 0; min-width: 32px;" onerror="this.style.display='none';" />
          <div class="h-4 w-px bg-white/20"></div>
          <span class="font-bold text-white text-lg tracking-wide">ì—…ë¬´ ê¸°ë¡</span>
        </div>
        <div class="flex items-center gap-3">
          <div id="session-timer" class="hidden text-white text-xs font-medium bg-white/20 px-3 py-1 rounded-full">
            <i class="fas fa-clock mr-1"></i>
            <span id="timer-text">30:00</span>
          </div>
          <div id="connection-status" class="w-2.5 h-2.5 rounded-full bg-green-400 shadow-sm animate-pulse"></div>
        </div>
      </div>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-4">
      <!-- 1. Location Info Card -->
      <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
        <div class="flex items-start justify-between">
          <div>
            <p class="text-xs text-gray-400 font-medium mb-1">í˜„ì¬ ìœ„ì¹˜</p>
            <h1 id="display-location" class="text-2xl font-bold text-gray-800 leading-tight">ë¡œë”© ì¤‘...</h1>
            <p
              id="display-apt"
              class="text-sm text-brand font-medium mt-2 bg-green-50 inline-block px-2 py-0.5 rounded-md"
            >
              <i class="fas fa-building mr-1"></i>...
            </p>
          </div>
          <div class="bg-gray-50 p-3 rounded-full text-gray-400">
            <i class="fas fa-map-marker-alt text-xl"></i>
          </div>
        </div>
      </div>

      <!-- 2. Employee Selection -->
      <div id="section-employee" class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 transition-all">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-bold text-gray-800 flex items-center gap-2">
            <span class="bg-gray-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
            ì§ì› ì„ íƒ
          </h2>
          <button
            id="btn-reset-emp"
            onclick="app.resetSelection()"
            class="hidden text-xs text-gray-500 underline px-2 py-1"
          >
            ë³€ê²½
          </button>
        </div>

        <!-- Search Input -->
        <div id="employee-search-container">
          <div class="relative mb-3">
            <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
            <input
              type="text"
              id="inp-search"
              class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 focus:bg-white focus:border-green-500 focus:ring-0 rounded-xl transition-all text-sm outline-none"
              placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”..."
              onkeyup="app.filterEmployees()"
            />
          </div>

          <!-- Employee List -->
          <div id="list-employees" class="max-h-60 overflow-y-auto space-y-2 pr-1 custom-scrollbar">
            <!-- Dynamic Content -->
          </div>
        </div>

        <!-- Selected State (Hidden initially) -->
        <div id="employee-selected" class="hidden">
          <div class="bg-green-50 border border-green-100 rounded-xl p-4 flex items-center gap-3">
            <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center text-green-700 text-xl">
              <i class="fas fa-user"></i>
            </div>
            <div class="flex-1">
              <p id="selected-name" class="font-bold text-gray-800 text-lg"></p>
              <p id="selected-pos" class="text-xs text-gray-600"></p>
            </div>
            <i class="fas fa-check-circle text-green-600 text-2xl"></i>
          </div>
        </div>
      </div>

      <!-- 3. Work Options (Hidden initially) -->
      <div id="section-work" class="hidden space-y-4">
        <div class="flex items-center gap-2 px-1 mt-6">
          <span class="bg-gray-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
          <h2 class="font-bold text-gray-800">ì—…ë¬´ ê¸°ë¡</h2>
        </div>

        <!-- Attendance Grid -->
        <div class="grid grid-cols-2 gap-3">
          <button
            onclick="app.recordAttendance('ì¶œê·¼')"
            class="btn-professional bg-white border-2 border-gray-200 text-gray-800 p-5 rounded-xl flex flex-col items-center gap-2 group"
          >
            <div class="w-12 h-12 rounded-full bg-green-50 flex items-center justify-center mb-1 group-hover:bg-green-100 transition-colors">
              <i class="fas fa-sign-in-alt text-xl text-green-600"></i>
            </div>
            <span class="font-bold text-sm">ì¶œê·¼</span>
          </button>
          <button
            onclick="app.recordAttendance('í‡´ê·¼')"
            class="btn-professional bg-white border-2 border-gray-200 text-gray-800 p-5 rounded-xl flex flex-col items-center gap-2 group"
          >
            <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center mb-1 group-hover:bg-blue-100 transition-colors">
              <i class="fas fa-sign-out-alt text-xl text-blue-600"></i>
            </div>
            <span class="font-bold text-sm">í‡´ê·¼</span>
          </button>
          <button
            onclick="app.recordAttendance('íœ´ê²Œ ì‹œì‘')"
            class="btn-professional bg-white border-2 border-gray-200 text-gray-800 p-5 rounded-xl flex flex-col items-center gap-2 group"
          >
            <div class="w-12 h-12 rounded-full bg-orange-50 flex items-center justify-center mb-1 group-hover:bg-orange-100 transition-colors">
              <i class="fas fa-mug-hot text-xl text-orange-600"></i>
            </div>
            <span class="font-bold text-sm">íœ´ê²Œ ì‹œì‘</span>
          </button>
          <button
            onclick="app.recordAttendance('íœ´ê²Œ ì¢…ë£Œ')"
            class="btn-professional bg-white border-2 border-gray-200 text-gray-800 p-5 rounded-xl flex flex-col items-center gap-2 group"
          >
            <div class="w-12 h-12 rounded-full bg-purple-50 flex items-center justify-center mb-1 group-hover:bg-purple-100 transition-colors">
              <i class="fas fa-history text-xl text-purple-600"></i>
            </div>
            <span class="font-bold text-sm">íœ´ê²Œ ì¢…ë£Œ</span>
          </button>
        </div>

        <!-- Divider -->
        <div class="relative py-2">
          <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
          <div class="relative flex justify-center">
            <span class="bg-gray-50 px-3 py-1 rounded-full text-xs text-gray-400 font-medium">íŠ¹ìˆ˜ ì—…ë¬´</span>
          </div>
        </div>

        <!-- Before/After Mode Toggle -->
        <div class="bg-white border-2 border-gray-200 rounded-xl p-4 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center">
              <i class="fas fa-exchange-alt text-gray-600"></i>
            </div>
            <div>
              <div class="font-bold text-gray-800 text-sm">Before/After ëª¨ë“œ</div>
              <div class="text-xs text-gray-500 mt-0.5">ì²­ì†Œ ì „/í›„ ë¹„êµ ì‚¬ì§„</div>
            </div>
          </div>
          <div class="mode-toggle" id="before-after-toggle" onclick="app.toggleBeforeAfterMode()">
            <div class="mode-toggle-circle"></div>
          </div>
        </div>

        <!-- Before/After Split Upload UI (Hidden by default) -->
        <div id="before-after-split-ui" class="hidden bg-white rounded-2xl p-4 border border-blue-200 shadow-sm">
          <div class="grid grid-cols-2 gap-3">
            <!-- Before Section -->
            <div class="border-2 border-blue-300 rounded-xl p-3 bg-blue-50">
              <div class="text-center mb-2">
                <div class="text-sm font-bold text-blue-700">ğŸ”µ Before</div>
                <div class="text-xs text-blue-600">ì²­ì†Œ ì „</div>
              </div>
              
              <!-- Before Photo Preview -->
              <div id="before-photo-preview" class="hidden bg-black rounded-lg overflow-hidden mb-2" style="height: 180px;">
                <img id="before-photo-img" class="w-full h-full object-contain" />
              </div>
              
              <!-- Before Photo Placeholder -->
              <div id="before-photo-placeholder" class="bg-blue-100 border-2 border-dashed border-blue-300 rounded-lg flex items-center justify-center mb-2" style="height: 180px;">
                <div class="text-center text-blue-400">
                  <i class="fas fa-image text-3xl mb-2"></i>
                  <div class="text-xs">ì‚¬ì§„ì„ ì¶”ê°€í•˜ì„¸ìš”</div>
                </div>
              </div>
              
              <!-- Before Action Buttons -->
              <div class="space-y-2">
                <button
                  onclick="app.openBeforeAfterCamera('before', 'capture')"
                  class="w-full btn-touch bg-blue-500 text-white py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2"
                >
                  <i class="fas fa-camera"></i>
                  <span>ì´¬ì˜</span>
                </button>
                <button
                  onclick="app.openBeforeAfterCamera('before', 'gallery')"
                  class="w-full btn-touch bg-blue-400 text-white py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2"
                >
                  <i class="fas fa-images"></i>
                  <span>ê°¤ëŸ¬ë¦¬</span>
                </button>
              </div>
            </div>

            <!-- After Section -->
            <div class="border-2 border-green-300 rounded-xl p-3 bg-green-50">
              <div class="text-center mb-2">
                <div class="text-sm font-bold text-green-700">ğŸŸ¢ After</div>
                <div class="text-xs text-green-600">ì²­ì†Œ í›„</div>
              </div>
              
              <!-- After Photo Preview -->
              <div id="after-photo-preview" class="hidden bg-black rounded-lg overflow-hidden mb-2" style="height: 180px;">
                <img id="after-photo-img" class="w-full h-full object-contain" />
              </div>
              
              <!-- After Photo Placeholder -->
              <div id="after-photo-placeholder" class="bg-green-100 border-2 border-dashed border-green-300 rounded-lg flex items-center justify-center mb-2" style="height: 180px;">
                <div class="text-center text-green-400">
                  <i class="fas fa-image text-3xl mb-2"></i>
                  <div class="text-xs">ì‚¬ì§„ì„ ì¶”ê°€í•˜ì„¸ìš”</div>
                </div>
              </div>
              
              <!-- After Action Buttons -->
              <div class="space-y-2">
                <button
                  onclick="app.openBeforeAfterCamera('after', 'capture')"
                  class="w-full btn-touch bg-green-500 text-white py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2"
                >
                  <i class="fas fa-camera"></i>
                  <span>ì´¬ì˜</span>
                </button>
                <button
                  onclick="app.openBeforeAfterCamera('after', 'gallery')"
                  class="w-full btn-touch bg-green-400 text-white py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2"
                >
                  <i class="fas fa-images"></i>
                  <span>ê°¤ëŸ¬ë¦¬</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Notes Input -->
          <input
            type="text"
            id="inp-notes-before-after"
            placeholder="íŠ¹ì´ì‚¬í•­ ì…ë ¥ (ì„ íƒ)"
            class="w-full mt-3 bg-gray-50 border border-gray-200 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-blue-500"
          />

          <!-- Upload Button -->
          <button
            id="btn-upload-before-after"
            onclick="app.uploadBeforeAfter()"
            disabled
            class="w-full mt-3 py-4 bg-gray-300 text-white rounded-xl font-bold text-base flex items-center justify-center gap-2 disabled:opacity-50 transition-all"
          >
            <i class="fas fa-cloud-upload-alt"></i>
            <span>2ì¥ ëª¨ë‘ ì—…ë¡œë“œ</span>
            <div id="spinner-before-after" class="spinner hidden w-4 h-4 ml-2"></div>
          </button>
        </div>

        <!-- Regular Cleaning Buttons (Hidden when Before/After mode active) -->
        <div id="regular-cleaning-buttons" class="grid grid-cols-1 gap-3">
          <!-- ì¼ë°˜ ì´¬ì˜ -->
          <button
            onclick="app.openCameraMode('capture')"
            class="btn-professional bg-white border-2 border-gray-200 text-gray-800 p-5 rounded-xl flex items-center justify-between group"
          >
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 rounded-lg bg-gray-100 flex items-center justify-center group-hover:bg-green-50 transition-colors">
                <i class="fas fa-camera text-xl text-gray-600 group-hover:text-green-600 transition-colors"></i>
              </div>
              <div class="text-left">
                <div class="font-bold text-base">ì‚¬ì§„ ì´¬ì˜</div>
                <div class="text-gray-500 text-xs mt-0.5">ì¹´ë©”ë¼ë¡œ ì¦‰ì‹œ ì´¬ì˜</div>
              </div>
            </div>
            <i class="fas fa-chevron-right text-gray-400"></i>
          </button>

          <!-- ê°¤ëŸ¬ë¦¬ ì„ íƒ -->
          <button
            onclick="app.openCameraMode('gallery')"
            class="btn-professional bg-white border-2 border-gray-200 text-gray-800 p-5 rounded-xl flex items-center justify-between group"
          >
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 rounded-lg bg-gray-100 flex items-center justify-center group-hover:bg-green-50 transition-colors">
                <i class="fas fa-images text-xl text-gray-600 group-hover:text-green-600 transition-colors"></i>
              </div>
              <div class="text-left">
                <div class="font-bold text-base">ê°¤ëŸ¬ë¦¬ ì„ íƒ</div>
                <div class="text-gray-500 text-xs mt-0.5">ì—¬ëŸ¬ ì¥ í•œë²ˆì— ì—…ë¡œë“œ</div>
              </div>
            </div>
            <i class="fas fa-chevron-right text-gray-400"></i>
          </button>
        </div>

        <!-- Hidden File Inputs -->
        <input
          type="file"
          id="inp-camera-capture"
          accept="image/*"
          capture="environment"
          class="hidden"
          onchange="app.handlePhoto(this)"
        />
        <input
          type="file"
          id="inp-camera-gallery"
          accept="image/*"
          multiple
          class="hidden"
          onchange="app.handleMultiplePhotos(this)"
        />
        <!-- Before/After File Inputs -->
        <input
          type="file"
          id="inp-before-capture"
          accept="image/*"
          capture="environment"
          class="hidden"
          onchange="app.handleBeforeAfterPhoto('before', this)"
        />
        <input
          type="file"
          id="inp-before-gallery"
          accept="image/*"
          class="hidden"
          onchange="app.handleBeforeAfterPhoto('before', this)"
        />
        <input
          type="file"
          id="inp-after-capture"
          accept="image/*"
          capture="environment"
          class="hidden"
          onchange="app.handleBeforeAfterPhoto('after', this)"
        />
        <input
          type="file"
          id="inp-after-gallery"
          accept="image/*"
          class="hidden"
          onchange="app.handleBeforeAfterPhoto('after', this)"
        />
      </div>
    </main>

    <!-- Photo Preview Overlay -->
    <div id="preview-overlay" class="hidden fixed inset-0 bg-black/95 z-50 flex flex-col p-4 animate-fade-in">
      <div class="flex justify-between items-center text-white mb-4">
        <h3 class="font-bold text-lg">
          <span id="preview-title">ğŸ“¸ ì‚¬ì§„ í™•ì¸</span>
          <span id="preview-count" class="text-sm font-normal opacity-70"></span>
        </h3>
        <button onclick="app.cancelPhoto()" class="w-8 h-8 flex items-center justify-center rounded-full bg-white/20">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Single Photo Preview -->
      <div id="single-preview" class="flex-1 bg-black flex items-center justify-center rounded-lg overflow-hidden mb-4 relative">
        <img id="img-preview" class="max-w-full max-h-full object-contain" />
      </div>

      <!-- Multiple Photos Preview (Hidden by default) -->
      <div id="multi-preview" class="hidden flex-1 overflow-y-auto mb-4">
        <div id="multi-preview-grid" class="grid grid-cols-2 gap-2">
          <!-- Dynamic content -->
        </div>
      </div>

      <!-- Before/After Preview (Hidden by default) -->
      <div id="before-after-preview" class="hidden flex-1 mb-4 space-y-2">
        <div class="bg-gray-800 rounded-lg p-2">
          <div class="text-xs text-gray-400 mb-1">ğŸ”µ Before (ì²­ì†Œ ì „)</div>
          <div id="before-img-container" class="bg-black rounded-lg overflow-hidden flex items-center justify-center" style="height: 200px;">
            <img id="img-preview-before" class="max-w-full max-h-full object-contain" />
          </div>
        </div>
        <div class="bg-gray-800 rounded-lg p-2">
          <div class="text-xs text-gray-400 mb-1">ğŸŸ¢ After (ì²­ì†Œ í›„)</div>
          <div id="after-img-container" class="bg-black rounded-lg overflow-hidden flex items-center justify-center" style="height: 200px;">
            <img id="img-preview-after" class="max-w-full max-h-full object-contain" />
          </div>
        </div>
      </div>

      <div class="space-y-3">
        <!-- Upload Progress (Hidden by default) -->
        <div id="upload-progress-container" class="hidden bg-gray-800 rounded-xl p-3">
          <div class="flex justify-between text-xs text-gray-400 mb-2">
            <span>ì—…ë¡œë“œ ì¤‘...</span>
            <span id="upload-progress-text">0 / 0</span>
          </div>
          <div class="upload-progress rounded-full" id="upload-progress-bar" style="--progress: 0%"></div>
        </div>

        <input
          type="text"
          id="inp-notes"
          placeholder="íŠ¹ì´ì‚¬í•­ ì…ë ¥ (ì„ íƒ)"
          class="w-full bg-gray-800 border border-gray-700 text-white rounded-xl px-4 py-3 focus:outline-none focus:border-orange-500"
        />

        <div class="grid grid-cols-2 gap-3">
          <button
            onclick="app.retakePhoto()"
            id="btn-retake"
            class="py-3 bg-gray-700 text-white rounded-xl font-bold flex items-center justify-center gap-2"
          >
            <i class="fas fa-redo"></i>
            <span>ì¬ì´¬ì˜</span>
          </button>
          <button
            onclick="app.uploadPhoto()"
            id="btn-upload"
            class="py-3 bg-orange-500 text-white rounded-xl font-bold flex items-center justify-center gap-2"
          >
            <span>ì—…ë¡œë“œ</span>
            <div id="upload-spinner" class="spinner hidden w-4 h-4"></div>
          </button>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div
      id="toast"
      class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-gray-800/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-xl z-50 flex items-center gap-3 transition-all duration-300 translate-y-24 opacity-0 w-max max-w-[90%]"
    >
      <i id="toast-icon" class="fas fa-check-circle text-green-400"></i>
      <span id="toast-msg" class="font-medium text-sm">ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</span>
    </div>

    <!-- Error Screen -->
    <div
      id="screen-error"
      class="hidden fixed inset-0 bg-white z-50 flex flex-col items-center justify-center p-8 text-center"
    >
      <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mb-4 text-red-500">
        <i class="fas fa-exclamation-triangle text-2xl"></i>
      </div>
      <h2 class="text-xl font-bold text-gray-800 mb-2">ì˜¤ë¥˜ ë°œìƒ</h2>
      <p id="error-msg" class="text-gray-500 mb-6 text-sm break-keep">ì‹œìŠ¤í…œì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
      <button onclick="location.reload()" class="px-6 py-2 bg-gray-800 text-white rounded-lg text-sm font-bold">
        ë‹¤ì‹œ ì‹œë„
      </button>
    </div>

    <script>
      // --- CONFIGURATION ---
      const SUPABASE_URL = 'https://qgpqhtuynxhmgawakjxe.supabase.co';
      const SUPABASE_KEY =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFncHFodHV5bnhobWdhd2FranhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyOTQyNTEsImV4cCI6MjA4Mjg3MDI1MX0.WNljQIKDbeZCDlXe8fpBdZs58XRFfujGt7lBGfq_pVg';

      const APARTMENTS = {
        BJD001: 'ë´‰ë‹´ìì´í”„ë¼ì´ë“œì‹œí‹°',
        YDB002: 'ìš©ì¸ë™ë°±ì„¼íŠ¸ëŸ´',
        SYT003: 'ìˆ˜ì›ì˜í†µìì´',
        PGD004: 'í‰íƒê³ ë•êµ­ì œì‹ ë„ì‹œ',
        ETC999: 'ê¸°íƒ€ ë‹¨ì§€',
      };

      const app = {
        sb: null,
        state: {
          locId: null,
          aptId: null,
          locationName: '',
          employees: [],
          selectedEmp: null,
          photoFile: null,
          photoFiles: [], // Multiple photos
          isGalleryMode: false, // Track if in gallery mode
          beforeAfterMode: false,
          beforePhoto: null,
          afterPhoto: null,
          sessionTimer: null,
          sessionStartTime: null,
          sessionDuration: 30 * 60 * 1000, // 30 minutes in milliseconds
        },

        init: async function () {
          try {
            // 1. Init Supabase
            this.sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // 2. Parse URL
            const params = new URLSearchParams(window.location.search);
            this.state.locId = params.get('loc');
            this.state.aptId = params.get('apt');

            if (!this.state.locId || !this.state.aptId) {
              throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ QR ì½”ë“œì…ë‹ˆë‹¤.');
            }

            // 3. Load Data
            await Promise.all([this.loadLocation(), this.loadEmployees()]);

            // 4. Render
            this.renderLocationInfo();
            this.renderEmployeeList(this.state.employees);

            // 5. Start Session Timer
            this.startSessionTimer();

            // 6. Hide Loader
            document.getElementById('screen-loading').classList.add('hidden');
          } catch (e) {
            console.error(e);
            this.showError(e.message);
          }
        },

        // --- SESSION TIMER ---
        getSessionKey: function () {
          return `kindwon_session_${this.state.locId}_${this.state.aptId}`;
        },

        startSessionTimer: function () {
          const sessionKey = this.getSessionKey();
          
          // Check if session already exists in localStorage
          let sessionStartTime = localStorage.getItem(sessionKey);
          
          if (sessionStartTime) {
            // Use existing session time
            this.state.sessionStartTime = parseInt(sessionStartTime, 10);
            
            // Check if session has already expired
            const elapsed = Date.now() - this.state.sessionStartTime;
            if (elapsed >= this.state.sessionDuration) {
              this.expireSession();
              return;
            }
          } else {
            // Create new session
            this.state.sessionStartTime = Date.now();
            localStorage.setItem(sessionKey, this.state.sessionStartTime.toString());
          }
          
          document.getElementById('session-timer').classList.remove('hidden');

          // Update timer immediately on load
          this.updateTimerDisplay();

          // Then update every second
          this.state.sessionTimer = setInterval(() => {
            this.updateTimerDisplay();
          }, 1000);
        },

        updateTimerDisplay: function () {
          const elapsed = Date.now() - this.state.sessionStartTime;
          const remaining = this.state.sessionDuration - elapsed;

          if (remaining <= 0) {
            this.expireSession();
            return;
          }

          // Update timer display
          const minutes = Math.floor(remaining / 60000);
          const seconds = Math.floor((remaining % 60000) / 1000);
          const timerText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          document.getElementById('timer-text').textContent = timerText;

          // Warning at 5 minutes
          const timerEl = document.getElementById('session-timer');
          if (remaining <= 5 * 60 * 1000) {
            timerEl.classList.add('timer-warning');
          } else {
            timerEl.classList.remove('timer-warning');
          }
        },

        expireSession: function () {
          clearInterval(this.state.sessionTimer);
          
          // Remove session from localStorage
          const sessionKey = this.getSessionKey();
          localStorage.removeItem(sessionKey);
          
          alert('â° ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\në³´ì•ˆì„ ìœ„í•´ QR ìŠ¤ìº” í›„ 30ë¶„ì´ ê²½ê³¼í•˜ì—¬ ìë™ìœ¼ë¡œ ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤.\në‹¤ì‹œ QR ì½”ë“œë¥¼ ìŠ¤ìº”í•´ì£¼ì„¸ìš”.');
          
          // Redirect to a blank page or reload
          window.location.href = 'about:blank';
        },

        // --- DATA LOADING ---
        loadLocation: async function () {
          const { data, error } = await this.sb.from('locations').select('name').eq('id', this.state.locId).single();

          if (error) throw new Error('êµ¬ì—­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          this.state.locationName = data.name;
        },

        loadEmployees: async function () {
          const { data, error } = await this.sb.from('employees').select('*').eq('status', 'active').order('name');

          if (error) throw error;
          this.state.employees = data || [];
        },

        // --- RENDERING ---
        renderLocationInfo: function () {
          document.getElementById('display-location').textContent = this.state.locationName;
          const aptName = APARTMENTS[this.state.aptId] || this.state.aptId;
          document.getElementById('display-apt').innerHTML = `<i class="fas fa-building mr-1"></i>${aptName}`;
        },

        renderEmployeeList: function (list) {
          const container = document.getElementById('list-employees');
          container.innerHTML = '';

          if (list.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-400 text-sm py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
          }

          list.forEach((emp) => {
            const div = document.createElement('div');
            div.className =
              'flex items-center p-3 bg-white border border-gray-100 rounded-xl active:bg-gray-50 cursor-pointer mb-2 transition-colors';
            div.onclick = () => this.selectEmployee(emp);

            div.innerHTML = `
              <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 mr-3 text-sm">
                <i class="fas fa-user"></i>
              </div>
              <div>
                <p class="font-bold text-gray-800 text-sm">${emp.name}</p>
                <p class="text-xs text-gray-400">${emp.position || 'ì§ì›'} ${emp.phone ? ' Â· ' + emp.phone.slice(-4) : ''}</p>
              </div>
              <i class="fas fa-chevron-right ml-auto text-gray-300 text-xs"></i>
            `;
            container.appendChild(div);
          });
        },

        filterEmployees: function () {
          const term = document.getElementById('inp-search').value.toLowerCase();
          const filtered = this.state.employees.filter(
            (e) => e.name.toLowerCase().includes(term) || (e.phone && e.phone.includes(term)),
          );
          this.renderEmployeeList(filtered);
        },

        // --- INTERACTION ---
        selectEmployee: function (emp) {
          this.state.selectedEmp = emp;

          // UI Updates
          document.getElementById('employee-search-container').classList.add('hidden');
          document.getElementById('employee-selected').classList.remove('hidden');

          document.getElementById('selected-name').textContent = emp.name;
          document.getElementById('selected-pos').textContent = emp.position || 'ì§ì›';

          document.getElementById('btn-reset-emp').classList.remove('hidden');
          document.getElementById('section-work').classList.remove('hidden');

          // Scroll to work section
          setTimeout(() => {
            document.getElementById('section-work').scrollIntoView({ behavior: 'smooth' });
          }, 100);
        },

        resetSelection: function () {
          this.state.selectedEmp = null;
          document.getElementById('employee-selected').classList.add('hidden');
          document.getElementById('employee-search-container').classList.remove('hidden');
          document.getElementById('btn-reset-emp').classList.add('hidden');
          document.getElementById('section-work').classList.add('hidden');

          document.getElementById('inp-search').value = '';
          this.renderEmployeeList(this.state.employees);
        },

        // --- ACTIONS: ATTENDANCE ---
        recordAttendance: async function (type) {
          if (!this.state.selectedEmp) return;

          const btnIcon = event.currentTarget.querySelector('i');
          const originalClass = btnIcon.className;
          btnIcon.className = 'fas fa-spinner fa-spin text-2xl mb-1';

          try {
            const payload = {
              employee_name: this.state.selectedEmp.name,
              attendance_type: type,
              location: this.state.locationName,
              scan_time: new Date().toISOString(),
            };

            const { error } = await this.sb.from('attendance_records').insert([payload]);
            if (error) throw error;

            this.showToast(`${this.state.selectedEmp.name}ë‹˜, ${type} ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            this.resetSelection();
          } catch (e) {
            console.error(e);
            this.showToast('ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
          } finally {
            btnIcon.className = originalClass;
          }
        },

        // --- ACTIONS: CLEANING ---
        toggleBeforeAfterMode: function () {
          this.state.beforeAfterMode = !this.state.beforeAfterMode;
          const toggle = document.getElementById('before-after-toggle');
          const splitUI = document.getElementById('before-after-split-ui');
          const regularButtons = document.getElementById('regular-cleaning-buttons');

          if (this.state.beforeAfterMode) {
            toggle.classList.add('active');
            splitUI.classList.remove('hidden');
            regularButtons.classList.add('hidden');
            // Reset before/after photos
            this.state.beforePhoto = null;
            this.state.afterPhoto = null;
            this.updateBeforeAfterUI();
          } else {
            toggle.classList.remove('active');
            splitUI.classList.add('hidden');
            regularButtons.classList.remove('hidden');
          }
        },

        openBeforeAfterCamera: function (type, mode) {
          if (type === 'before') {
            if (mode === 'capture') {
              document.getElementById('inp-before-capture').click();
            } else {
              document.getElementById('inp-before-gallery').click();
            }
          } else if (type === 'after') {
            if (mode === 'capture') {
              document.getElementById('inp-after-capture').click();
            } else {
              document.getElementById('inp-after-gallery').click();
            }
          }
        },

        handleBeforeAfterPhoto: async function (type, input) {
          if (!input.files || !input.files[0]) return;

          const file = input.files[0];

          // Check photo time (12 hours limit)
          const isValid = await this.validatePhotoTime(file);
          if (!isValid) {
            alert('âš ï¸ ì´¬ì˜ ì‹œê°„ ì œí•œ\n\n12ì‹œê°„ ì´ë‚´ì— ì´¬ì˜ëœ ì‚¬ì§„ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\nì˜¤ë˜ëœ ì‚¬ì§„ì˜ ì¬í™œìš©ì„ ë°©ì§€í•˜ê¸° ìœ„í•œ ì •ì±…ì…ë‹ˆë‹¤.');
            input.value = '';
            return;
          }

          // Store photo
          if (type === 'before') {
            this.state.beforePhoto = file;
          } else {
            this.state.afterPhoto = file;
          }

          // Update UI
          this.updateBeforeAfterUI();
          input.value = '';
        },

        updateBeforeAfterUI: function () {
          const beforePreview = document.getElementById('before-photo-preview');
          const beforePlaceholder = document.getElementById('before-photo-placeholder');
          const beforeImg = document.getElementById('before-photo-img');

          const afterPreview = document.getElementById('after-photo-preview');
          const afterPlaceholder = document.getElementById('after-photo-placeholder');
          const afterImg = document.getElementById('after-photo-img');

          const uploadBtn = document.getElementById('btn-upload-before-after');

          // Update Before
          if (this.state.beforePhoto) {
            const reader = new FileReader();
            reader.onload = (e) => {
              beforeImg.src = e.target.result;
              beforePreview.classList.remove('hidden');
              beforePlaceholder.classList.add('hidden');
            };
            reader.readAsDataURL(this.state.beforePhoto);
          } else {
            beforePreview.classList.add('hidden');
            beforePlaceholder.classList.remove('hidden');
          }

          // Update After
          if (this.state.afterPhoto) {
            const reader = new FileReader();
            reader.onload = (e) => {
              afterImg.src = e.target.result;
              afterPreview.classList.remove('hidden');
              afterPlaceholder.classList.add('hidden');
            };
            reader.readAsDataURL(this.state.afterPhoto);
          } else {
            afterPreview.classList.add('hidden');
            afterPlaceholder.classList.remove('hidden');
          }

          // Enable upload button only when both photos are ready
          if (this.state.beforePhoto && this.state.afterPhoto) {
            uploadBtn.disabled = false;
            uploadBtn.classList.remove('bg-gray-300');
            uploadBtn.classList.add('bg-brand', 'hover:bg-green-700');
          } else {
            uploadBtn.disabled = true;
            uploadBtn.classList.remove('bg-brand', 'hover:bg-green-700');
            uploadBtn.classList.add('bg-gray-300');
          }
        },

        uploadBeforeAfter: async function () {
          if (!this.state.beforePhoto || !this.state.afterPhoto) {
            alert('âš ï¸ Beforeì™€ After ì‚¬ì§„ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
          }

          const btn = document.getElementById('btn-upload-before-after');
          const spinner = document.getElementById('spinner-before-after');
          const btnText = btn.querySelector('span');

          btn.disabled = true;
          btnText.textContent = 'ì—…ë¡œë“œ ì¤‘...';
          spinner.classList.remove('hidden');

          try {
            const notes = document.getElementById('inp-notes-before-after').value;

            // Upload Before photo
            const beforeExt = this.state.beforePhoto.name.split('.').pop() || 'jpg';
            const beforeFileName = `${this.state.aptId}/${Date.now()}_before_${Math.random().toString(36).substr(2, 9)}.${beforeExt}`;

            const { data: beforeUpload, error: beforeError } = await this.sb.storage
              .from('cleaning-photos')
              .upload(beforeFileName, this.state.beforePhoto);

            if (beforeError) throw beforeError;

            const { data: { publicUrl: beforeUrl } } = this.sb.storage
              .from('cleaning-photos')
              .getPublicUrl(beforeFileName);

            // Upload After photo
            const afterExt = this.state.afterPhoto.name.split('.').pop() || 'jpg';
            const afterFileName = `${this.state.aptId}/${Date.now()}_after_${Math.random().toString(36).substr(2, 9)}.${afterExt}`;

            const { data: afterUpload, error: afterError } = await this.sb.storage
              .from('cleaning-photos')
              .upload(afterFileName, this.state.afterPhoto);

            if (afterError) throw afterError;

            const { data: { publicUrl: afterUrl } } = this.sb.storage
              .from('cleaning-photos')
              .getPublicUrl(afterFileName);

            // Save to database
            const groupId = String(Date.now()); // Generate Group ID

            const payloads = [
              {
                employee_name: this.state.selectedEmp.name,
                location: this.state.locationName,
                photo_url: beforeUrl,
                notes: notes || 'Before/After ì²­ì†Œ ì‘ì—…',
                group_id: groupId,
                before_after: 'before',
                upload_type: 'before_after',
                photo_order: 0,
                created_at: new Date().toISOString(),
              },
              {
                employee_name: this.state.selectedEmp.name,
                location: this.state.locationName,
                photo_url: afterUrl,
                notes: notes || 'Before/After ì²­ì†Œ ì‘ì—…',
                group_id: groupId,
                before_after: 'after',
                upload_type: 'before_after',
                photo_order: 1,
                created_at: new Date().toISOString(),
              }
            ];

            const { error: dbError } = await this.sb.from('cleaning_tasks').insert(payloads);
            if (dbError) throw dbError;

            this.showToast('âœ… Before/After ì²­ì†Œ ì‘ì—…ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');

            // Reset UI
            this.state.beforePhoto = null;
            this.state.afterPhoto = null;
            document.getElementById('inp-notes-before-after').value = '';
            this.updateBeforeAfterUI();
            this.resetSelection();
          } catch (e) {
            console.error(e);
            alert('âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
          } finally {
            btn.disabled = false;
            btnText.textContent = '2ì¥ ëª¨ë‘ ì—…ë¡œë“œ';
            spinner.classList.add('hidden');
          }
        },

        openCameraMode: function (mode) {
          if (mode === 'capture') {
            this.state.isGalleryMode = false;
            document.getElementById('inp-camera-capture').click();
          } else if (mode === 'gallery') {
            this.state.isGalleryMode = true;
            document.getElementById('inp-camera-gallery').click();
          }
        },

        // Single photo (capture mode)
        handlePhoto: async function (input) {
          if (input.files && input.files[0]) {
            const file = input.files[0];

            // Check photo time (12 hours limit)
            const isValid = await this.validatePhotoTime(file);
            if (!isValid) {
              alert('âš ï¸ ì´¬ì˜ ì‹œê°„ ì œí•œ\n\n12ì‹œê°„ ì´ë‚´ì— ì´¬ì˜ëœ ì‚¬ì§„ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\nì˜¤ë˜ëœ ì‚¬ì§„ì˜ ì¬í™œìš©ì„ ë°©ì§€í•˜ê¸° ìœ„í•œ ì •ì±…ì…ë‹ˆë‹¤.');
              input.value = '';
              return;
            }

            this.state.photoFile = file;
            this.state.photoFiles = [file];
            this.state.isGalleryMode = false;

            const reader = new FileReader();
            reader.onload = (e) => {
              document.getElementById('img-preview').src = e.target.result;
              document.getElementById('single-preview').classList.remove('hidden');
              document.getElementById('multi-preview').classList.add('hidden');
              document.getElementById('before-after-preview').classList.add('hidden');
              document.getElementById('preview-overlay').classList.remove('hidden');
              document.getElementById('preview-count').textContent = '';
              
              // Update button text for single photo mode
              document.getElementById('btn-retake').innerHTML = '<i class="fas fa-redo mr-1"></i>ì¬ì´¬ì˜';
            };
            reader.readAsDataURL(file);
          }
        },

        // Multiple photos (gallery mode)
        handleMultiplePhotos: async function (input, isAdding = false) {
          if (!input.files || input.files.length === 0) return;

          const files = Array.from(input.files);

          // Before/After mode: require exactly 2 photos
          if (this.state.beforeAfterMode && files.length !== 2) {
            alert('âš ï¸ Before/After ëª¨ë“œ\n\nBeforeì™€ After ì‚¬ì§„ 2ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            input.value = '';
            return;
          }

          // Validate all photos (12 hours limit)
          const validations = await Promise.all(files.map(f => this.validatePhotoTime(f)));
          const invalidPhotos = validations.filter(v => !v).length;

          if (invalidPhotos > 0) {
            alert(`âš ï¸ ì´¬ì˜ ì‹œê°„ ì œí•œ\n\n${invalidPhotos}ì¥ì˜ ì‚¬ì§„ì´ 12ì‹œê°„ ì œí•œì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.\nìµœê·¼ 12ì‹œê°„ ì´ë‚´ì— ì´¬ì˜ëœ ì‚¬ì§„ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
            input.value = '';
            return;
          }

          // If adding to existing photos, merge arrays
          if (isAdding && this.state.photoFiles.length > 0) {
            this.state.photoFiles = [...this.state.photoFiles, ...files];
          } else {
            this.state.photoFiles = files;
          }

          // Show preview based on mode
          if (this.state.beforeAfterMode) {
            this.showBeforeAfterPreview(this.state.photoFiles);
          } else {
            this.showMultiPreview(this.state.photoFiles);
          }
        },

        showBeforeAfterPreview: function (files) {
          const beforeImg = document.getElementById('img-preview-before');
          const afterImg = document.getElementById('img-preview-after');

          const reader1 = new FileReader();
          reader1.onload = (e) => {
            beforeImg.src = e.target.result;
          };
          reader1.readAsDataURL(files[0]);

          const reader2 = new FileReader();
          reader2.onload = (e) => {
            afterImg.src = e.target.result;
          };
          reader2.readAsDataURL(files[1]);

          document.getElementById('single-preview').classList.add('hidden');
          document.getElementById('multi-preview').classList.add('hidden');
          document.getElementById('before-after-preview').classList.remove('hidden');
          document.getElementById('preview-overlay').classList.remove('hidden');
          document.getElementById('preview-title').textContent = 'ğŸ”„ Before/After í™•ì¸';
          document.getElementById('preview-count').textContent = '';
        },

        showMultiPreview: function (files) {
          const grid = document.getElementById('multi-preview-grid');
          grid.innerHTML = '';

          files.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              const div = document.createElement('div');
              div.className = 'relative bg-black rounded-lg overflow-hidden';
              div.style.height = '150px';
              div.innerHTML = `
                <img src="${e.target.result}" class="w-full h-full object-contain" />
                <div class="absolute top-2 left-2 bg-black/70 text-white text-xs px-2 py-1 rounded-full">${index + 1}</div>
              `;
              grid.appendChild(div);
            };
            reader.readAsDataURL(file);
          });

          document.getElementById('single-preview').classList.add('hidden');
          document.getElementById('multi-preview').classList.remove('hidden');
          document.getElementById('before-after-preview').classList.add('hidden');
          document.getElementById('preview-overlay').classList.remove('hidden');
          document.getElementById('preview-title').textContent = 'ğŸ“¸ ì‚¬ì§„ í™•ì¸';
          document.getElementById('preview-count').textContent = `(${files.length}ì¥)`;
          
          // Update button text for gallery mode
          document.getElementById('btn-retake').innerHTML = '<i class="fas fa-plus mr-1"></i>ì¶”ê°€ ì´¬ì˜';
        },

        // Validate photo taken within 12 hours
        validatePhotoTime: async function (file) {
          return new Promise((resolve) => {
            // Try to extract EXIF data
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                // Simple EXIF check using DataView
                const view = new DataView(e.target.result);
                
                // Check if JPEG (starts with FFD8)
                if (view.getUint16(0, false) !== 0xFFD8) {
                  // Not a JPEG, use file modification time
                  const fileTime = file.lastModified;
                  const now = Date.now();
                  const hoursDiff = (now - fileTime) / (1000 * 60 * 60);
                  resolve(hoursDiff <= 12);
                  return;
                }

                // Try to find EXIF DateTime
                // This is a simplified check - in production, use a library like exif-js
                let offset = 2;
                let exifFound = false;
                
                while (offset < view.byteLength) {
                  const marker = view.getUint16(offset, false);
                  if (marker === 0xFFE1) { // APP1 marker (EXIF)
                    exifFound = true;
                    break;
                  }
                  offset += 2 + view.getUint16(offset + 2, false);
                }

                // For now, use file modification time as fallback
                // In production, you'd parse EXIF DateTime here
                const fileTime = file.lastModified;
                const now = Date.now();
                const hoursDiff = (now - fileTime) / (1000 * 60 * 60);
                resolve(hoursDiff <= 12);
              } catch (err) {
                console.error('EXIF parsing error:', err);
                // On error, allow the upload (fallback to trust)
                resolve(true);
              }
            };
            reader.readAsArrayBuffer(file);
          });
        },

        retakePhoto: function () {
          if (this.state.isGalleryMode || this.state.photoFiles.length > 1) {
            // Gallery mode: Add more photos
            this.addMorePhotos();
          } else {
            // Single capture mode: Replace photo
            this.cancelPhoto();
            setTimeout(() => {
              this.openCameraMode('capture');
            }, 100);
          }
        },

        addMorePhotos: function () {
          // Don't close preview overlay, just open gallery to add more
          const input = document.getElementById('inp-camera-gallery');
          const oldHandler = input.onchange;
          
          // Temporarily override handler to add photos
          input.onchange = (e) => {
            this.handleMultiplePhotos(input, true); // isAdding = true
            input.onchange = oldHandler; // Restore original handler
          };
          
          input.click();
        },

        cancelPhoto: function () {
          document.getElementById('preview-overlay').classList.add('hidden');
          document.getElementById('inp-camera-capture').value = '';
          document.getElementById('inp-camera-gallery').value = '';
          document.getElementById('inp-notes').value = '';
          this.state.photoFile = null;
          this.state.photoFiles = [];
        },

        uploadPhoto: async function () {
          if (!this.state.photoFiles || this.state.photoFiles.length === 0) return;

          const btn = document.getElementById('btn-upload');
          const spinner = document.getElementById('upload-spinner');
          const btnText = btn.querySelector('span');
          const progressContainer = document.getElementById('upload-progress-container');
          const progressBar = document.getElementById('upload-progress-bar');
          const progressText = document.getElementById('upload-progress-text');

          btn.disabled = true;
          btn.classList.add('opacity-75');
          btnText.textContent = 'ì—…ë¡œë“œ ì¤‘...';
          spinner.classList.remove('hidden');

          // Show progress for multiple files
          if (this.state.photoFiles.length > 1) {
            progressContainer.classList.remove('hidden');
          }

          try {
            const notes = document.getElementById('inp-notes').value;
            const uploadedUrls = [];
            let uploadCount = 0;

            // Upload all photos
            for (const file of this.state.photoFiles) {
              const ext = file.name.split('.').pop() || 'jpg';
              const fileName = `${this.state.aptId}/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${ext}`;

              const { data: uploadData, error: uploadError } = await this.sb.storage
                .from('cleaning-photos')
                .upload(fileName, file);

              if (uploadError) throw uploadError;

              const {
                data: { publicUrl },
              } = this.sb.storage.from('cleaning-photos').getPublicUrl(fileName);

              uploadedUrls.push(publicUrl);
              uploadCount++;

              // Update progress
              if (this.state.photoFiles.length > 1) {
                const progress = (uploadCount / this.state.photoFiles.length) * 100;
                progressBar.style.setProperty('--progress', `${progress}%`);
                progressText.textContent = `${uploadCount} / ${this.state.photoFiles.length}`;
              }
            }

            // Save records to database
            if (this.state.beforeAfterMode && uploadedUrls.length === 2) {
              // Before/After mode: save as paired record
              const groupId = String(Date.now()); // Generate Group ID

              const payloads = [
                {
                  employee_name: this.state.selectedEmp.name,
                  location: this.state.locationName,
                  photo_url: uploadedUrls[0], // Before
                  notes: notes || 'Before/After ì²­ì†Œ ì‘ì—…',
                  group_id: groupId,
                  before_after: 'before',
                  upload_type: 'before_after',
                  photo_order: 0,
                  created_at: new Date().toISOString(),
                },
                {
                  employee_name: this.state.selectedEmp.name,
                  location: this.state.locationName,
                  photo_url: uploadedUrls[1], // After
                  notes: notes || 'Before/After ì²­ì†Œ ì‘ì—…',
                  group_id: groupId,
                  before_after: 'after',
                  upload_type: 'before_after',
                  photo_order: 1,
                  created_at: new Date().toISOString(),
                }
              ];

              const { error: dbError } = await this.sb.from('cleaning_tasks').insert(payloads);
              if (dbError) throw dbError;

              this.showToast('Before/After ì²­ì†Œ ì‘ì—…ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
              // âœ… Regular mode: save as single record with photo_urls array
              const groupId = uploadedUrls.length > 1 ? String(Date.now()) : null;

              const payload = {
                employee_name: this.state.selectedEmp.name,
                location: this.state.locationName,
                photo_url: uploadedUrls[0], // First photo as main
                photo_urls: uploadedUrls, // All photos as array
                notes: notes,
                group_id: groupId,
                upload_type: uploadedUrls.length > 1 ? 'multiple' : 'single',
                photo_count: uploadedUrls.length,
                created_at: new Date().toISOString(),
              };

              const { error: dbError } = await this.sb.from('cleaning_tasks').insert([payload]);
              if (dbError) throw dbError;

              this.showToast(`ì²­ì†Œ ì‘ì—… ${uploadedUrls.length}ê±´ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }

            this.cancelPhoto();
            this.resetSelection();
          } catch (e) {
            console.error(e);
            alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
          } finally {
            btn.disabled = false;
            btn.classList.remove('opacity-75');
            btnText.textContent = 'ì—…ë¡œë“œ';
            spinner.classList.add('hidden');
            progressContainer.classList.add('hidden');
          }
        },

        // --- UTILS ---
        showToast: function (msg, type = 'success') {
          const el = document.getElementById('toast');
          const icon = document.getElementById('toast-icon');
          const text = document.getElementById('toast-msg');

          text.textContent = msg;

          if (type === 'error') {
            icon.className = 'fas fa-exclamation-circle text-red-400';
          } else {
            icon.className = 'fas fa-check-circle text-green-400';
          }

          el.classList.remove('translate-y-24', 'opacity-0');

          setTimeout(() => {
            el.classList.add('translate-y-24', 'opacity-0');
          }, 3000);
        },

        showError: function (msg) {
          document.getElementById('screen-loading').classList.add('hidden');
          document.getElementById('screen-error').classList.remove('hidden');
          document.getElementById('error-msg').textContent = msg;
        },
      };

      document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
  <script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"9c4f78d68e083182","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.9.1","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"9ca7915b5afb16dd","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.9.1","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>

</partial_content>

<instructions>

Document is too large (12989 tokens). Only showing first 10000 tokens. For complete analysis, use the <tool>summarize_large_document</tool> tool with a specific question. This tool can analyze PDFs, academic papers, reports, and web content to provide targeted answers.

</instructions>
