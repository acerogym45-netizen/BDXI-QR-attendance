<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR 스캔 출석 | KINDWON</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
      :root {
        --kindwon-green: #1b5e3e;
        --kindwon-green-light: #2d6e4f;
        --kindwon-green-lighter: #4a9370;
        --kindwon-green-pale: #e8f5e9;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
        overflow-x: hidden;
      }

      .kindwon-gradient {
        background: linear-gradient(135deg, var(--kindwon-green) 0%, var(--kindwon-green-light) 100%);
      }

      .logo-image {
        height: 32px;
        width: auto;
      }

      @media (max-width: 640px) {
        .logo-image {
          height: 28px;
        }
      }

      .btn-kindwon {
        background: var(--kindwon-green);
        color: white;
        transition: all 0.3s ease;
      }

      .btn-kindwon:hover {
        background: var(--kindwon-green-light);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(27, 94, 62, 0.3);
      }

      .btn-outline-kindwon {
        background: white;
        color: var(--kindwon-green);
        border: 2px solid var(--kindwon-green);
        transition: all 0.3s ease;
      }

      .btn-outline-kindwon:hover {
        background: var(--kindwon-green-pale);
        transform: translateY(-1px);
      }

      .card-premium {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        transition: all 0.3s ease;
      }

      .attendance-btn {
        padding: 1.5rem;
        border-radius: 16px;
        font-weight: 700;
        font-size: 1.125rem;
        transition: all 0.3s ease;
        border: 3px solid transparent;
        text-align: center;
        cursor: pointer;
      }

      .attendance-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
      }

      .attendance-btn.selected {
        border-color: var(--kindwon-green);
        box-shadow: 0 0 0 4px var(--kindwon-green-pale);
      }

      #reader {
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      #reader video {
        border-radius: 16px;
      }

      .success-animation {
        animation: successPulse 0.6s ease;
      }

      @keyframes successPulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .error-shake {
        animation: errorShake 0.5s ease;
      }

      @keyframes errorShake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-10px);
        }
        75% {
          transform: translateX(10px);
        }
      }

      select:focus,
      input:focus {
        outline: none;
        border-color: var(--kindwon-green);
        box-shadow: 0 0 0 3px rgba(27, 94, 62, 0.1);
      }

      .photo-preview {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .photo-preview img {
        width: 100%;
        height: auto;
        display: block;
      }

      .photo-count {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
      }

      .loading-spinner {
        border: 3px solid rgba(27, 94, 62, 0.2);
        border-top-color: var(--kindwon-green);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="kindwon-gradient text-white shadow-lg sticky top-0 z-50">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <img src="https://www.genspark.ai/api/files/s/UmgxPvd3" alt="KINDWON" class="logo-image" />
            <div class="hidden sm:block w-px h-8 bg-white opacity-30"></div>
            <h1 class="text-xl sm:text-2xl font-extrabold tracking-tight">
              <i class="fas fa-qrcode mr-2"></i>청소 사진 촬영
            </h1>
          </div>
          <button onclick="goBack()" class="text-white hover:text-gray-200 transition font-medium">
            <i class="fas fa-arrow-left mr-2"></i>
            <span class="hidden sm:inline">돌아가기</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-6 max-w-2xl">
      <!-- Step 1: Employee Selection -->
      <div id="step1" class="card-premium p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
          <i class="fas fa-user mr-3" style="color: var(--kindwon-green)"></i>
          직원 선택
        </h2>
        <p class="text-gray-600 mb-4 text-sm">본인의 이름을 선택해주세요.</p>
        <select id="employeeSelect" class="w-full p-4 border-2 border-gray-200 rounded-lg text-lg transition">
          <option value="">직원을 선택하세요...</option>
        </select>
        <button
          onclick="selectEmployee()"
          class="w-full mt-4 btn-kindwon py-4 rounded-lg font-bold text-lg shadow-md"
        >
          다음 <i class="fas fa-arrow-right ml-2"></i>
        </button>
      </div>

      <!-- Step 2: QR Scan -->
      <div id="step2" class="hidden">
        <!-- Selected Employee Info -->
        <div class="card-premium p-4 mb-6" style="background: var(--kindwon-green-pale)">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-semibold" style="color: var(--kindwon-green)">직원:</p>
              <p class="text-xl font-bold text-gray-800" id="selectedEmployee">-</p>
            </div>
            <button
              onclick="changeEmployee()"
              class="text-sm font-semibold hover:underline"
              style="color: var(--kindwon-green)"
            >
              <i class="fas fa-edit mr-1"></i>변경
            </button>
          </div>
        </div>

        <!-- QR Scanner -->
        <div class="card-premium p-6 mb-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-camera mr-3" style="color: var(--kindwon-green)"></i>
            QR 코드 스캔
          </h2>
          <p class="text-gray-600 mb-4 text-sm">구역 QR 코드를 카메라로 스캔해주세요.</p>
          <div id="reader" class="mb-4"></div>
          <div id="scanResult" class="hidden mt-4 p-4 rounded-lg" style="background: var(--kindwon-green-pale)">
            <p class="font-bold text-gray-800 mb-2" style="color: var(--kindwon-green)">
              <i class="fas fa-check-circle mr-2"></i>스캔 완료!
            </p>
            <p class="text-gray-700">
              구역: <span id="scannedLocation" class="font-bold">-</span>
            </p>
          </div>
        </div>

        <!-- Attendance Type Selection -->
        <div id="attendanceTypeSection" class="card-premium p-6 mb-6 hidden">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-clock mr-3" style="color: var(--kindwon-green)"></i>
            출퇴근 선택
          </h2>
          <div class="grid grid-cols-2 gap-3">
            <button onclick="selectAttendanceType('출근')" class="attendance-btn" style="background: #dbeafe; color: #1e40af">
              <i class="fas fa-sign-in-alt text-2xl mb-2 block"></i>
              출근
            </button>
            <button onclick="selectAttendanceType('퇴근')" class="attendance-btn" style="background: #fce7f3; color: #be185d">
              <i class="fas fa-sign-out-alt text-2xl mb-2 block"></i>
              퇴근
            </button>
            <button onclick="selectAttendanceType('휴게 시작')" class="attendance-btn" style="background: #fef3c7; color: #b45309">
              <i class="fas fa-coffee text-2xl mb-2 block"></i>
              휴게 시작
            </button>
            <button onclick="selectAttendanceType('휴게 종료')" class="attendance-btn" style="background: #d1fae5; color: #047857">
              <i class="fas fa-play-circle text-2xl mb-2 block"></i>
              휴게 종료
            </button>
          </div>
        </div>

        <!-- Photo Upload Section -->
        <div id="photoSection" class="card-premium p-6 mb-6 hidden">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-camera mr-3" style="color: var(--kindwon-green)"></i>
            청소 사진 촬영
          </h2>
          <p class="text-gray-600 mb-4 text-sm">
            청소 완료 후 사진을 촬영해주세요. (최대 30장)
          </p>

          <!-- Photo Preview Grid -->
          <div id="photoPreviewGrid" class="grid grid-cols-2 gap-3 mb-4"></div>

          <!-- Photo Count -->
          <div class="flex items-center justify-between mb-4 p-3 rounded-lg" style="background: var(--kindwon-green-pale)">
            <span class="font-semibold" style="color: var(--kindwon-green)">
              <i class="fas fa-image mr-2"></i>
              <span id="photoCount">0</span> 장
            </span>
            <span class="text-sm text-gray-600">최대 30장</span>
          </div>

          <!-- Upload Buttons -->
          <div class="grid grid-cols-2 gap-3">
            <button
              onclick="triggerCamera()"
              class="btn-kindwon py-4 rounded-lg font-bold shadow-md"
            >
              <i class="fas fa-camera mr-2"></i>사진 촬영
            </button>
            <button
              onclick="triggerGallery()"
              class="btn-outline-kindwon py-4 rounded-lg font-bold shadow-md"
            >
              <i class="fas fa-images mr-2"></i>갤러리
            </button>
          </div>

          <input
            type="file"
            id="cameraInput"
            accept="image/*"
            capture="environment"
            multiple
            class="hidden"
            onchange="handlePhotoSelect(event)"
          />
          <input
            type="file"
            id="galleryInput"
            accept="image/*"
            multiple
            class="hidden"
            onchange="handlePhotoSelect(event)"
          />

          <p class="text-xs text-gray-500 mt-3 text-center">
            <i class="fas fa-info-circle mr-1"></i>
            <strong>팁:</strong> 청소 후 사진을 여러 장 촬영해두고, '갤러리' 버튼으로 한 번에 선택하세요! (최대 30장)
          </p>

          <!-- Submit Button -->
          <button
            id="submitBtn"
            onclick="submitAttendance()"
            class="w-full mt-6 btn-kindwon py-4 rounded-lg font-bold text-lg shadow-md hidden"
          >
            제출하기 <i class="fas fa-check ml-2"></i>
          </button>
        </div>
      </div>

      <!-- Loading Overlay -->
      <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 text-center shadow-2xl">
          <div class="loading-spinner mx-auto mb-4"></div>
          <p class="text-lg font-bold text-gray-800" id="loadingText">업로드 중...</p>
          <p class="text-sm text-gray-600 mt-2" id="uploadProgress">0 / 0</p>
        </div>
      </div>
    </div>

    <script>
      const SUPABASE_URL = 'https://qgpqhtuynxhmgawakjxe.supabase.co';
      const SUPABASE_ANON_KEY = 'sb_publishable_ujXj0mLf1casiQdVkc0fCA_G6exymqG';
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      let html5QrCode;
      let selectedEmployeeId = null;
      let selectedEmployeeName = null;
      let scannedLocationId = null;
      let scannedLocationName = null;
      let selectedAttendanceType = null;
      let photoFiles = [];

      // Load Employees
      async function loadEmployees() {
        const { data, error } = await supabase.from('employees').select('*').eq('status', 'active').order('name');

        const select = document.getElementById('employeeSelect');
        if (error || !data || data.length === 0) {
          select.innerHTML = '<option value="">직원 정보를 불러올 수 없습니다.</option>';
          return;
        }

        select.innerHTML =
          '<option value="">직원을 선택하세요...</option>' +
          data.map((emp) => `<option value="${emp.id}">${emp.name}</option>`).join('');
      }

      function selectEmployee() {
        const select = document.getElementById('employeeSelect');
        if (!select.value) {
          alert('직원을 선택해주세요.');
          return;
        }

        selectedEmployeeId = select.value;
        selectedEmployeeName = select.options[select.selectedIndex].text;
        document.getElementById('selectedEmployee').innerText = selectedEmployeeName;

        document.getElementById('step1').classList.add('hidden');
        document.getElementById('step2').classList.remove('hidden');

        startQRScanner();
      }

      function changeEmployee() {
        document.getElementById('step1').classList.remove('hidden');
        document.getElementById('step2').classList.add('hidden');
        stopQRScanner();
      }

      function startQRScanner() {
        html5QrCode = new Html5Qrcode('reader');
        html5QrCode
          .start(
            { facingMode: 'environment' },
            {
              fps: 10,
              qrbox: { width: 250, height: 250 },
            },
            onScanSuccess,
          )
          .catch((err) => {
            console.error('QR 스캐너 시작 실패:', err);
            alert('카메라 접근에 실패했습니다.\n\n권한을 확인해주세요.');
          });
      }

      function stopQRScanner() {
        if (html5QrCode) {
          html5QrCode
            .stop()
            .then(() => {
              html5QrCode.clear();
            })
            .catch(() => {});
        }
      }

      function onScanSuccess(decodedText) {
        try {
          const data = JSON.parse(decodedText);
          scannedLocationId = data.location_id;
          scannedLocationName = data.location_name;

          document.getElementById('scanResult').classList.remove('hidden');
          document.getElementById('scannedLocation').innerText = scannedLocationName;
          document.getElementById('scanResult').classList.add('success-animation');

          stopQRScanner();

          // Show attendance type selection
          document.getElementById('attendanceTypeSection').classList.remove('hidden');
        } catch (error) {
          console.error('QR 데이터 파싱 오류:', error);
          alert('올바르지 않은 QR 코드입니다.');
        }
      }

      function selectAttendanceType(type) {
        selectedAttendanceType = type;

        // Update button styles
        document.querySelectorAll('.attendance-btn').forEach((btn) => btn.classList.remove('selected'));
        event.target.closest('.attendance-btn').classList.add('selected');

        // Show photo section
        document.getElementById('photoSection').classList.remove('hidden');
        document.getElementById('submitBtn').classList.remove('hidden');

        // Scroll to photo section
        document.getElementById('photoSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      function triggerCamera() {
        document.getElementById('cameraInput').click();
      }

      function triggerGallery() {
        document.getElementById('galleryInput').click();
      }

      function handlePhotoSelect(event) {
        const files = Array.from(event.target.files);
        
        if (photoFiles.length + files.length > 30) {
          alert('최대 30장까지만 선택할 수 있습니다.');
          return;
        }

        photoFiles.push(...files);
        updatePhotoPreview();
        event.target.value = ''; // Reset input
      }

      function updatePhotoPreview() {
        const grid = document.getElementById('photoPreviewGrid');
        document.getElementById('photoCount').innerText = photoFiles.length;

        grid.innerHTML = photoFiles
          .map(
            (file, index) => `
          <div class="photo-preview">
            <img src="${URL.createObjectURL(file)}" alt="Photo ${index + 1}">
            <div class="photo-count">${index + 1}</div>
            <button 
              onclick="removePhoto(${index})" 
              class="absolute top-2 left-2 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-red-600 transition shadow-lg"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
        `,
          )
          .join('');
      }

      function removePhoto(index) {
        photoFiles.splice(index, 1);
        updatePhotoPreview();
      }

      async function submitAttendance() {
        if (!selectedAttendanceType) {
          alert('출퇴근 유형을 선택해주세요.');
          return;
        }

        if (photoFiles.length === 0) {
          if (!confirm('사진이 없습니다. 그대로 제출하시겠습니까?')) return;
        }

        showLoading(true);

        try {
          // 1. Upload Photos
          const uploadedUrls = [];
          for (let i = 0; i < photoFiles.length; i++) {
            updateUploadProgress(i + 1, photoFiles.length);
            const url = await uploadPhoto(photoFiles[i], i);
            uploadedUrls.push(url);
          }

          // 2. Save Attendance Record
          const { error: attendanceError } = await supabase.from('attendance_records').insert({
            employee_id: selectedEmployeeId,
            location_id: scannedLocationId,
            location_name: scannedLocationName,
            attendance_type: selectedAttendanceType,
            scan_time: new Date().toISOString(),
          });

          if (attendanceError) throw attendanceError;

          // 3. Save Cleaning Task
          const { error: cleaningError } = await supabase.from('cleaning_tasks').insert({
            worker_name: selectedEmployeeName,
            area: scannedLocationName,
            photo_urls: uploadedUrls,
            created_at: new Date().toISOString(),
          });

          if (cleaningError) throw cleaningError;

          showLoading(false);
          alert(
            `✅ 제출 완료!\n\n직원: ${selectedEmployeeName}\n구역: ${scannedLocationName}\n유형: ${selectedAttendanceType}\n사진: ${photoFiles.length}장`,
          );

          // Reset
          resetForm();
        } catch (error) {
          showLoading(false);
          console.error('제출 오류:', error);
          alert('제출 중 오류가 발생했습니다.\n\n' + error.message);
        }
      }

      async function uploadPhoto(file, index) {
        const fileName = `${Date.now()}_${index}_${Math.random().toString(36).substr(2, 9)}.jpg`;
        const filePath = `cleaning/${fileName}`;

        const { error } = await supabase.storage.from('work-log-photos').upload(filePath, file);

        if (error) throw error;

        const { data } = supabase.storage.from('work-log-photos').getPublicUrl(filePath);
        return data.publicUrl;
      }

      function showLoading(show) {
        document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
      }

      function updateUploadProgress(current, total) {
        document.getElementById('uploadProgress').innerText = `${current} / ${total}`;
      }

      function resetForm() {
        scannedLocationId = null;
        scannedLocationName = null;
        selectedAttendanceType = null;
        photoFiles = [];

        document.getElementById('scanResult').classList.add('hidden');
        document.getElementById('attendanceTypeSection').classList.add('hidden');
        document.getElementById('photoSection').classList.add('hidden');
        document.getElementById('photoPreviewGrid').innerHTML = '';
        document.getElementById('photoCount').innerText = '0';

        startQRScanner();
      }

      function goBack() {
        if (confirm('작업을 취소하고 돌아가시겠습니까?')) {
          window.location.href = 'index.html';
        }
      }

      // Initialize
      loadEmployees();
    </script>
  </body>
</html>
