<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR ìŠ¤ìº” - ì¶œì„ ì²´í¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        #reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        #reader video {
            width: 100% !important;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-xl md:text-2xl font-bold">
                    <i class="fas fa-qrcode mr-2"></i>QR ìŠ¤ìº”
                </h1>
                <div class="space-x-2 md:space-x-4 text-sm md:text-base">
                    <a href="index.html" class="hover:text-blue-200">
                        <i class="fas fa-home mr-1"></i>ê´€ë¦¬ì
                    </a>
                    <a href="records.html" class="hover:text-blue-200">
                        <i class="fas fa-chart-bar mr-1"></i>ê¸°ë¡
                    </a>
                </div>
            </div>
        </div>
    </nav>
    <div class="container mx-auto px-4 py-6">
        <div id="employee-selection" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6">
            <h2 class="text-lg md:text-xl font-bold mb-4">
                <i class="fas fa-user mr-2"></i>ì§ì› ì„ íƒ
            </h2>
            <p class="text-sm md:text-base text-gray-600 mb-4">ë³¸ì¸ì˜ ì´ë¦„ì„ ì„ íƒí•œ í›„ QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”.</p>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">ì§ì› ê²€ìƒ‰</label>
                <input type="text" id="employee-search" placeholder="ì´ë¦„ ë˜ëŠ” ì‚¬ë²ˆìœ¼ë¡œ ê²€ìƒ‰..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div id="employees-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                <div class="col-span-full text-center text-gray-500 py-8">
                    <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                    <p>ì§ì› ëª©ë¡ ë¡œë”© ì¤‘...</p>
                </div>
            </div>
        </div>
        <div id="timer-warning" class="bg-yellow-50 border-2 border-yellow-500 rounded-lg p-4 mb-6 hidden">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl mr-3"></i>
                    <div>
                        <h3 class="font-bold text-yellow-800">â± ë‚¨ì€ ì‹œê°„</h3>
                        <p class="text-sm text-yellow-700">QR ìŠ¤ìº” í›„ <span id="timer-display" class="font-bold">5:00</span> ì´ë‚´ì— ì¶œì„ ì²´í¬í•˜ì„¸ìš”</p>
                    </div>
                </div>
            </div>
        </div>
        <div id="session-expired" class="bg-red-50 border-2 border-red-500 rounded-lg p-6 text-center mb-6 hidden">
            <i class="fas fa-clock text-red-600 text-5xl mb-3"></i>
            <h3 class="text-xl font-bold text-red-800 mb-2">â° ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h3>
            <p class="text-gray-700 mb-4">QR ì½”ë“œë¥¼ ë‹¤ì‹œ ìŠ¤ìº”í•´ì£¼ì„¸ìš”</p>
            <button onclick="resetSession()" class="bg-red-600 text-white px-6 py-3 rounded-md hover:bg-red-700 transition">
                <i class="fas fa-redo mr-2"></i>QR ì½”ë“œ ë‹¤ì‹œ ìŠ¤ìº”í•˜ê¸°
            </button>
        </div>
        <div id="selected-employee-info" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6 hidden">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-12 h-12 md:w-16 md:h-16 bg-blue-600 rounded-full flex items-center justify-center text-white text-xl md:text-2xl font-bold mr-3 md:mr-4">
                        <span id="employee-initial"></span>
                    </div>
                    <div>
                        <h3 class="text-lg md:text-xl font-bold" id="employee-name-display"></h3>
                        <p class="text-sm md:text-base text-gray-600" id="employee-info-display"></p>
                    </div>
                </div>
                <button onclick="clearEmployeeSelection()" class="text-red-600 hover:text-red-800">
                    <i class="fas fa-times-circle text-2xl"></i>
                </button>
            </div>
        </div>
        <div id="scanner-section" class="bg-white rounded-lg shadow-md p-4 md:p-6 hidden">
            <h2 class="text-lg md:text-xl font-bold mb-4">
                <i class="fas fa-camera mr-2"></i>QR ì½”ë“œ ìŠ¤ìº”
            </h2>
            <p class="text-sm md:text-base text-gray-600 mb-4">êµ¬ì—­ì˜ QR ì½”ë“œë¥¼ ì¹´ë©”ë¼ì— ë¹„ì¶”ì„¸ìš”.</p>
            <div id="reader" class="mb-4"></div>
            <div id="scan-result"></div>
        </div>
        <div id="recent-scans" class="bg-white rounded-lg shadow-md p-4 md:p-6 mt-6 hidden">
            <h2 class="text-lg md:text-xl font-bold mb-4">
                <i class="fas fa-history mr-2"></i>ìµœê·¼ ìŠ¤ìº” ê¸°ë¡
            </h2>
            <div id="recent-scans-list"></div>
        </div>
    </div>
    <script>
        const SUPABASE_URL = 'https://qgpqhtuynxhmgawakjxe.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_ujXj0mLf1casiQdVkc0fCA_G6exymqG';
        let employees = [];
        let selectedEmployee = null;
        let html5QrCode = null;
        let recentScans = [];
        let sessionTimer = null;
        let sessionExpireTime = null;
        let timerInterval = null;
        const SESSION_DURATION = 5 * 60 * 1000;
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('âœ… Page loaded');
            await loadEmployees();
            setupEmployeeSearch();
            loadRecentScans();
        });
        async function loadEmployees() {
            try {
                console.log('ğŸ“‹ Loading employees from Supabase...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/employees?select=*&is_active=eq.true&order=name.asc&limit=100`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                employees = await response.json();
                console.log(`âœ… Loaded ${employees.length} employees`);
                displayEmployees(employees);
            } catch (error) {
                console.error('âŒ Error loading employees:', error);
                document.getElementById('employees-grid').innerHTML = `<div class="col-span-full text-center text-red-500 py-4"><i class="fas fa-exclamation-triangle text-3xl mb-2"></i><p class="mb-2">ì§ì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p><p class="text-sm text-gray-600">${error.message}</p><button onclick="loadEmployees()" class="mt-3 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"><i class="fas fa-redo mr-2"></i>ë‹¤ì‹œ ì‹œë„</button></div>`;
            }
        }
        function displayEmployees(employeeList) {
            const grid = document.getElementById('employees-grid');
            if (employeeList.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            grid.innerHTML = employeeList.map(emp => {
                const initial = emp.name.charAt(0);
                return `<button onclick="selectEmployee('${emp.id}')" class="p-3 md:p-4 border-2 border-gray-200 rounded-lg hover:border-blue-600 hover:bg-blue-50 transition text-center"><div class="w-10 h-10 md:w-12 md:h-12 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold mx-auto mb-2">${initial}</div><div class="font-semibold text-sm md:text-base">${emp.name}</div><div class="text-xs text-gray-500">${emp.employee_number || ''}</div>${emp.department ? `<div class="text-xs text-gray-400">${emp.department}</div>` : ''}</button>`;
            }).join('');
        }
        function setupEmployeeSearch() {
            const searchInput = document.getElementById('employee-search');
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                if (searchTerm === '') {
                    displayEmployees(employees);
                    return;
                }
                const filtered = employees.filter(emp => emp.name.toLowerCase().includes(searchTerm) || (emp.employee_number && emp.employee_number.toLowerCase().includes(searchTerm)) || (emp.department && emp.department.toLowerCase().includes(searchTerm)));
                displayEmployees(filtered);
            });
        }
        function selectEmployee(employeeId) {
            console.log('ğŸ‘¤ Selecting employee:', employeeId);
            selectedEmployee = employees.find(emp => emp.id === employeeId);
            if (!selectedEmployee) {
                alert('ì§ì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            document.getElementById('employee-initial').textContent = selectedEmployee.name.charAt(0);
            document.getElementById('employee-name-display').textContent = selectedEmployee.name;
            let infoText = selectedEmployee.employee_number || '';
            if (selectedEmployee.department) infoText += (infoText ? ' | ' : '') + selectedEmployee.department;
            if (selectedEmployee.position) infoText += (infoText ? ' | ' : '') + selectedEmployee.position;
            document.getElementById('employee-info-display').textContent = infoText;
            document.getElementById('employee-selection').classList.add('hidden');
            document.getElementById('selected-employee-info').classList.remove('hidden');
            document.getElementById('scanner-section').classList.remove('hidden');
            setTimeout(() => { startScanner(); }, 500);
        }
        function clearEmployeeSelection() {
            selectedEmployee = null;
            clearSessionTimer();
            document.getElementById('employee-selection').classList.remove('hidden');
            document.getElementById('selected-employee-info').classList.add('hidden');
            document.getElementById('scanner-section').classList.add('hidden');
            document.getElementById('timer-warning').classList.add('hidden');
            document.getElementById('session-expired').classList.add('hidden');
            stopScanner();
            document.getElementById('employee-search').value = '';
            displayEmployees(employees);
        }
        async function startScanner() {
            console.log('ğŸ“· Starting scanner...');
            const resultDiv = document.getElementById('scan-result');
            try {
                html5QrCode = new Html5Qrcode("reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                console.log('ğŸ¥ Requesting camera...');
                await html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanError);
                console.log('âœ… Camera started successfully');
                resultDiv.innerHTML = `<div class="text-center py-4 text-gray-600"><i class="fas fa-camera text-3xl mb-2"></i><p>QR ì½”ë“œë¥¼ ì¹´ë©”ë¼ì— ë¹„ì¶”ì„¸ìš”</p></div>`;
            } catch (err) {
                console.error('âŒ Camera error:', err);
                resultDiv.innerHTML = `<div class="border-2 border-red-500 bg-red-50 rounded-lg p-4 text-center"><i class="fas fa-exclamation-triangle text-red-600 text-3xl mb-2"></i><h3 class="font-bold text-red-600 mb-2">ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨</h3><p class="text-sm text-gray-700 mb-3">${err.message}</p><p class="text-xs text-gray-600 mb-3">ë¸Œë¼ìš°ì €ì—ì„œ ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.</p><button onclick="startScanner()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm"><i class="fas fa-redo mr-2"></i>ë‹¤ì‹œ ì‹œë„</button></div>`;
            }
        }
        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().catch(err => { console.error('Scanner stop error:', err); }).finally(() => { html5QrCode = null; });
            }
        }
        function startSessionTimer() {
            clearSessionTimer();
            sessionExpireTime = Date.now() + SESSION_DURATION;
            document.getElementById('timer-warning').classList.remove('hidden');
            document.getElementById('session-expired').classList.add('hidden');
            timerInterval = setInterval(() => {
                const remaining = sessionExpireTime - Date.now();
                if (remaining <= 0) { expireSession(); } else { updateTimerDisplay(remaining); }
            }, 1000);
            console.log('â± 5ë¶„ íƒ€ì´ë¨¸ ì‹œì‘');
        }
        function updateTimerDisplay(remaining) {
            const minutes = Math.floor(remaining / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            const display = `${minutes}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('timer-display').textContent = display;
            const timerWarning = document.getElementById('timer-warning');
            if (remaining < 60000) {
                timerWarning.classList.remove('bg-yellow-50', 'border-yellow-500');
                timerWarning.classList.add('bg-red-50', 'border-red-500');
                timerWarning.querySelector('h3').classList.remove('text-yellow-800');
                timerWarning.querySelector('h3').classList.add('text-red-800');
                timerWarning.querySelector('p').classList.remove('text-yellow-700');
                timerWarning.querySelector('p').classList.add('text-red-700');
                timerWarning.querySelector('i').classList.remove('text-yellow-600');
                timerWarning.querySelector('i').classList.add('text-red-600');
            }
        }
        function expireSession() {
            clearSessionTimer();
            document.getElementById('timer-warning').classList.add('hidden');
            document.getElementById('session-expired').classList.remove('hidden');
            document.getElementById('scanner-section').classList.add('hidden');
            stopScanner();
            console.log('â° ì„¸ì…˜ ë§Œë£Œ - QR ì½”ë“œë¥¼ ë‹¤ì‹œ ìŠ¤ìº”í•´ì£¼ì„¸ìš”');
        }
        function clearSessionTimer() {
            if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
            sessionExpireTime = null;
        }
        function resetSession() {
            clearSessionTimer();
            document.getElementById('session-expired').classList.add('hidden');
            document.getElementById('timer-warning').classList.add('hidden');
            document.getElementById('selected-employee-info').classList.add('hidden');
            document.getElementById('employee-selection').classList.remove('hidden');
            selectedEmployee = null;
            document.getElementById('employee-search').value = '';
            displayEmployees(employees);
        }
        async function onScanSuccess(decodedText, decodedResult) {
            console.log('ğŸ“± QR code scanned:', decodedText);
            try {
                let qrData;
                if (decodedText.includes('scan.html?')) {
                    const url = new URL(decodedText);
                    qrData = {
                        locationId: url.searchParams.get('id'),
                        locationName: decodeURIComponent(url.searchParams.get('name')),
                        locationCode: url.searchParams.get('location')
                    };
                } else {
                    qrData = JSON.parse(decodedText);
                    if (qrData.type !== 'location') { showScanResult(false, 'ì˜¬ë°”ë¥¸ êµ¬ì—­ QR ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤.'); return; }
                }
                if (!qrData.locationId || !qrData.locationName || !qrData.locationCode) {
                    showScanResult(false, 'ì˜¬ë°”ë¥¸ êµ¬ì—­ QR ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤.');
                    return;
                }
                if (html5QrCode) { html5QrCode.pause(true); }
                startSessionTimer();
                await saveAttendanceRecord(qrData);
            } catch (error) {
                console.error('âŒ Scan processing error:', error);
                showScanResult(false, 'QR ì½”ë“œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                setTimeout(() => { if (html5QrCode) { html5QrCode.resume(); } }, 3000);
            }
        }
        function onScanError(errorMessage) { }
        async function saveAttendanceRecord(qrData) {
            if (sessionExpireTime && Date.now() > sessionExpireTime) { expireSession(); showScanResult(false, 'ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. QR ì½”ë“œë¥¼ ë‹¤ì‹œ ìŠ¤ìº”í•´ì£¼ì„¸ìš”.'); return; }
            const attendanceData = { employee_id: selectedEmployee.id, employee_name: selectedEmployee.name, employee_number: selectedEmployee.employee_number || '', location_id: qrData.locationId, location_name: qrData.locationName, location_code: qrData.locationCode, scan_time: new Date().toISOString(), device_info: navigator.userAgent };
            try {
                console.log('ğŸ’¾ Saving attendance record...', attendanceData);
                const response = await fetch(`${SUPABASE_URL}/rest/v1/attendance_records`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(attendanceData)
                });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                console.log('âœ… Attendance saved:', data);
                showScanResult(true, `${qrData.locationName}ì— ì¶œì„ ì²´í¬ë˜ì—ˆìŠµë‹ˆë‹¤.`, data[0]);
                addToRecentScans(data[0]);
            } catch (error) {
                console.error('âŒ Error saving attendance:', error);
                showScanResult(false, 'ì¶œì„ ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        function showScanResult(success, message, record = null) {
            const resultDiv = document.getElementById('scan-result');
            const icon = success ? 'fa-check-circle text-green-600' : 'fa-exclamation-circle text-red-600';
            const bgColor = success ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500';
            let html = `<div class="border-2 ${bgColor} rounded-lg p-4 md:p-6 text-center"><i class="fas ${icon} text-4xl md:text-5xl mb-3"></i><h3 class="text-lg md:text-xl font-bold mb-2">${success ? 'ì¶œì„ ì™„ë£Œ!' : 'ìŠ¤ìº” ì‹¤íŒ¨'}</h3><p class="text-sm md:text-base text-gray-700 mb-4">${message}</p>`;
            if (success && record) {
                const scanTime = new Date(record.scan_time);
                html += `<div class="bg-white rounded-lg p-3 md:p-4 mb-4 text-left"><div class="grid grid-cols-2 gap-2 text-sm"><div class="text-gray-600">ì§ì›:</div><div class="font-semibold">${record.employee_name}</div><div class="text-gray-600">êµ¬ì—­:</div><div class="font-semibold">${record.location_name}</div><div class="text-gray-600">ì‹œê°„:</div><div class="font-semibold">${formatDateTime(scanTime)}</div></div></div>`;
            }
            html += `<button onclick="continueScanning()" class="bg-blue-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-md hover:bg-blue-700 transition w-full mb-2"><i class="fas fa-qrcode mr-2"></i>ê³„ì† ìŠ¤ìº”í•˜ê¸°</button><button onclick="clearEmployeeSelection()" class="bg-gray-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-md hover:bg-gray-700 transition w-full"><i class="fas fa-user-times mr-2"></i>ì§ì› ë³€ê²½</button></div>`;
            resultDiv.innerHTML = html;
        }
        function continueScanning() {
            const resultDiv = document.getElementById('scan-result');
            resultDiv.innerHTML = `<div class="text-center py-4 text-gray-600"><i class="fas fa-camera text-3xl mb-2"></i><p>QR ì½”ë“œë¥¼ ì¹´ë©”ë¼ì— ë¹„ì¶”ì„¸ìš”</p></div>`;
            if (html5QrCode) { html5QrCode.resume(); }
        }
        function loadRecentScans() {
            const stored = localStorage.getItem('recentScans');
            if (stored) {
                try { recentScans = JSON.parse(stored); displayRecentScans(); } catch (e) { console.error('Error loading recent scans:', e); recentScans = []; }
            }
        }
        function addToRecentScans(record) {
            recentScans.unshift(record);
            if (recentScans.length > 10) { recentScans = recentScans.slice(0, 10); }
            localStorage.setItem('recentScans', JSON.stringify(recentScans));
            displayRecentScans();
        }
        function displayRecentScans() {
            if (recentScans.length === 0) return;
            document.getElementById('recent-scans').classList.remove('hidden');
            const listDiv = document.getElementById('recent-scans-list');
            listDiv.innerHTML = recentScans.map(record => {
                const scanTime = new Date(record.scan_time);
                return `<div class="border-l-4 border-blue-600 bg-gray-50 p-3 md:p-4 mb-3 rounded"><div class="flex justify-between items-start"><div><div class="font-semibold text-base md:text-lg">${record.employee_name || 'ì•Œ ìˆ˜ ì—†ìŒ'}</div><div class="text-sm md:text-base text-gray-600">${record.location_name || 'ì•Œ ìˆ˜ ì—†ìŒ'}</div><div class="text-xs md:text-sm text-gray-500">${formatDateTime(scanTime)}</div></div><div class="text-green-600"><i class="fas fa-check-circle text-xl md:text-2xl"></i></div></div></div>`;
            }).join('');
        }
        function formatDateTime(date) {
            if (!date || isNaN(date.getTime())) { return 'ì•Œ ìˆ˜ ì—†ìŒ'; }
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
    </script>
</body>
</html>
