<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR ìŠ¤ìº” - ì¶œì„ ì²´í¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        #reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        #reader video {
            width: 100% !important;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-xl md:text-2xl font-bold">
                    <i class="fas fa-qrcode mr-2"></i>ì¶œì„ ì²´í¬
                </h1>
                <div class="space-x-2 md:space-x-4 text-sm md:text-base">
                    <a href="index.html" class="hover:text-blue-200">
                        <i class="fas fa-home mr-1"></i>ê´€ë¦¬ì
                    </a>
                    <a href="records.html" class="hover:text-blue-200">
                        <i class="fas fa-chart-bar mr-1"></i>ê¸°ë¡
                    </a>
                </div>
            </div>
        </div>
    </nav>
    <div class="container mx-auto px-4 py-6">
        <div id="location-info" class="bg-blue-50 border-2 border-blue-500 rounded-lg p-4 mb-6 hidden">
            <div class="flex items-center">
                <i class="fas fa-map-marker-alt text-blue-600 text-2xl mr-3"></i>
                <div>
                    <h3 class="font-bold text-blue-800">êµ¬ì—­ ì •ë³´</h3>
                    <p class="text-sm text-blue-700" id="location-display"></p>
                </div>
            </div>
        </div>
        <div id="employee-selection" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6">
            <h2 class="text-lg md:text-xl font-bold mb-4">
                <i class="fas fa-user mr-2"></i>ì§ì› ì„ íƒ
            </h2>
            <p class="text-sm md:text-base text-gray-600 mb-4">ë³¸ì¸ì˜ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”.</p>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">ì§ì› ê²€ìƒ‰</label>
                <input type="text" id="employee-search" placeholder="ì´ë¦„ ë˜ëŠ” ì‚¬ë²ˆìœ¼ë¡œ ê²€ìƒ‰..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div id="employees-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                <div class="col-span-full text-center text-gray-500 py-8">
                    <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                    <p>ì§ì› ëª©ë¡ ë¡œë”© ì¤‘...</p>
                </div>
            </div>
        </div>
        <div id="attendance-type-selection" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6 hidden">
            <h2 class="text-lg md:text-xl font-bold mb-4">
                <i class="fas fa-clipboard-check mr-2"></i>ì¶œì„ ìœ í˜• ì„ íƒ
            </h2>
            <p class="text-sm md:text-base text-gray-600 mb-4">ì¶œì„ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”.</p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="selectAttendanceType('ì¶œê·¼')" class="p-4 border-2 border-gray-200 rounded-lg hover:border-green-600 hover:bg-green-50 transition text-center">
                    <i class="fas fa-sign-in-alt text-green-600 text-3xl mb-2"></i>
                    <div class="font-semibold text-base">ì¶œê·¼</div>
                </button>
                <button onclick="selectAttendanceType('í‡´ê·¼')" class="p-4 border-2 border-gray-200 rounded-lg hover:border-red-600 hover:bg-red-50 transition text-center">
                    <i class="fas fa-sign-out-alt text-red-600 text-3xl mb-2"></i>
                    <div class="font-semibold text-base">í‡´ê·¼</div>
                </button>
                <button onclick="selectAttendanceType('íœ´ê²Œ ì‹œì‘')" class="p-4 border-2 border-gray-200 rounded-lg hover:border-orange-600 hover:bg-orange-50 transition text-center">
                    <i class="fas fa-coffee text-orange-600 text-3xl mb-2"></i>
                    <div class="font-semibold text-base">íœ´ê²Œ ì‹œì‘</div>
                </button>
                <button onclick="selectAttendanceType('íœ´ê²Œ ì¢…ë£Œ')" class="p-4 border-2 border-gray-200 rounded-lg hover:border-blue-600 hover:bg-blue-50 transition text-center">
                    <i class="fas fa-briefcase text-blue-600 text-3xl mb-2"></i>
                    <div class="font-semibold text-base">íœ´ê²Œ ì¢…ë£Œ</div>
                </button>
            </div>
            <button onclick="goBackToEmployeeSelection()" class="mt-4 w-full bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition">
                <i class="fas fa-arrow-left mr-2"></i>ì§ì› ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
        </div>
        <div id="timer-warning" class="bg-yellow-50 border-2 border-yellow-500 rounded-lg p-4 mb-6 hidden">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl mr-3"></i>
                    <div>
                        <h3 class="font-bold text-yellow-800">â± ë‚¨ì€ ì‹œê°„</h3>
                        <p class="text-sm text-yellow-700">QR ìŠ¤ìº” í›„ <span id="timer-display" class="font-bold">5:00</span> ì´ë‚´ì— ì¶œì„ ì²´í¬í•˜ì„¸ìš”</p>
                    </div>
                </div>
            </div>
        </div>
        <div id="session-expired" class="bg-red-50 border-2 border-red-500 rounded-lg p-6 text-center mb-6 hidden">
            <i class="fas fa-clock text-red-600 text-5xl mb-3"></i>
            <h3 class="text-xl font-bold text-red-800 mb-2">â° ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h3>
            <p class="text-gray-700 mb-4">QR ì½”ë“œë¥¼ ë‹¤ì‹œ ìŠ¤ìº”í•´ì£¼ì„¸ìš”</p>
            <a href="scan.html" class="inline-block bg-red-600 text-white px-6 py-3 rounded-md hover:bg-red-700 transition">
                <i class="fas fa-redo mr-2"></i>ë‹¤ì‹œ ì‹œì‘
            </a>
        </div>
        <div id="success-result" class="bg-white rounded-lg shadow-md p-4 md:p-6 hidden">
            <div class="text-center">
                <i class="fas fa-check-circle text-green-600 text-5xl mb-3"></i>
                <h3 class="text-xl font-bold text-green-800 mb-2">ì¶œì„ ì™„ë£Œ!</h3>
                <div id="success-details" class="bg-gray-50 rounded-lg p-4 mb-4"></div>
                <a href="scan.html" class="inline-block bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition w-full">
                    <i class="fas fa-redo mr-2"></i>ì²˜ìŒìœ¼ë¡œ
                </a>
            </div>
        </div>
        <div id="recent-scans" class="bg-white rounded-lg shadow-md p-4 md:p-6 mt-6 hidden">
            <h2 class="text-lg md:text-xl font-bold mb-4">
                <i class="fas fa-history mr-2"></i>ìµœê·¼ ì¶œì„ ê¸°ë¡
            </h2>
            <div id="recent-scans-list"></div>
        </div>
    </div>
    <script>
        const SUPABASE_URL = 'https://qgpqhtuynxhmgawakjxe.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_ujXj0mLf1casiQdVkc0fCA_G6exymqG';
        let employees = [];
        let locationData = null;
        let selectedEmployee = null;
        let recentScans = [];
        let sessionExpireTime = null;
        let timerInterval = null;
        const SESSION_DURATION = 5 * 60 * 1000;
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('âœ… Page loaded');
            parseLocationFromURL();
            await loadEmployees();
            setupEmployeeSearch();
            loadRecentScans();
            if (locationData) {
                startSessionTimer();
            }
        });
        function parseLocationFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const locationId = urlParams.get('id');
            const locationName = urlParams.get('name');
            const locationCode = urlParams.get('location');
            if (locationId && locationName && locationCode) {
                locationData = {
                    locationId: locationId,
                    locationName: decodeURIComponent(locationName),
                    locationCode: locationCode
                };
                document.getElementById('location-info').classList.remove('hidden');
                document.getElementById('location-display').textContent = `${locationData.locationName} (${locationData.locationCode})`;
                console.log('âœ… Location data loaded:', locationData);
            }
        }
        async function loadEmployees() {
            try {
                console.log('ğŸ“‹ Loading employees...');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/employees?select=*&is_active=eq.true&order=name.asc&limit=100`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                employees = await response.json();
                console.log(`âœ… Loaded ${employees.length} employees`);
                displayEmployees(employees);
            } catch (error) {
                console.error('âŒ Error loading employees:', error);
                document.getElementById('employees-grid').innerHTML = `<div class="col-span-full text-center text-red-500 py-4"><i class="fas fa-exclamation-triangle text-3xl mb-2"></i><p class="mb-2">ì§ì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p><p class="text-sm text-gray-600">${error.message}</p><button onclick="loadEmployees()" class="mt-3 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"><i class="fas fa-redo mr-2"></i>ë‹¤ì‹œ ì‹œë„</button></div>`;
            }
        }
        function displayEmployees(employeeList) {
            const grid = document.getElementById('employees-grid');
            if (employeeList.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            grid.innerHTML = employeeList.map(emp => {
                const initial = emp.name.charAt(0);
                return `<button onclick="selectEmployee('${emp.id}')" class="p-3 md:p-4 border-2 border-gray-200 rounded-lg hover:border-blue-600 hover:bg-blue-50 transition text-center"><div class="w-10 h-10 md:w-12 md:h-12 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold mx-auto mb-2">${initial}</div><div class="font-semibold text-sm md:text-base">${emp.name}</div><div class="text-xs text-gray-500">${emp.employee_number || ''}</div>${emp.department ? `<div class="text-xs text-gray-400">${emp.department}</div>` : ''}</button>`;
            }).join('');
        }
        function setupEmployeeSearch() {
            const searchInput = document.getElementById('employee-search');
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                if (searchTerm === '') {
                    displayEmployees(employees);
                    return;
                }
                const filtered = employees.filter(emp => emp.name.toLowerCase().includes(searchTerm) || (emp.employee_number && emp.employee_number.toLowerCase().includes(searchTerm)) || (emp.department && emp.department.toLowerCase().includes(searchTerm)));
                displayEmployees(filtered);
            });
        }
        function selectEmployee(employeeId) {
            if (sessionExpireTime && Date.now() > sessionExpireTime) {
                expireSession();
                return;
            }
            console.log('ğŸ‘¤ Selecting employee:', employeeId);
            selectedEmployee = employees.find(emp => emp.id === employeeId);
            if (!selectedEmployee) {
                alert('ì§ì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            if (!locationData) {
                alert('êµ¬ì—­ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. QR ì½”ë“œë¥¼ ë‹¤ì‹œ ìŠ¤ìº”í•´ì£¼ì„¸ìš”.');
                return;
            }
            document.getElementById('employee-selection').classList.add('hidden');
            document.getElementById('attendance-type-selection').classList.remove('hidden');
        }
        function goBackToEmployeeSelection() {
            selectedEmployee = null;
            document.getElementById('attendance-type-selection').classList.add('hidden');
            document.getElementById('employee-selection').classList.remove('hidden');
        }
        async function selectAttendanceType(type) {
            if (sessionExpireTime && Date.now() > sessionExpireTime) {
                expireSession();
                return;
            }
            console.log('ğŸ“‹ Attendance type:', type);
            document.getElementById('attendance-type-selection').classList.add('hidden');
            await saveAttendanceRecord(type);
        }
        function startSessionTimer() {
            sessionExpireTime = Date.now() + SESSION_DURATION;
            document.getElementById('timer-warning').classList.remove('hidden');
            document.getElementById('session-expired').classList.add('hidden');
            timerInterval = setInterval(() => {
                const remaining = sessionExpireTime - Date.now();
                if (remaining <= 0) {
                    expireSession();
                } else {
                    updateTimerDisplay(remaining);
                }
            }, 1000);
            console.log('â± 5ë¶„ íƒ€ì´ë¨¸ ì‹œì‘');
        }
        function updateTimerDisplay(remaining) {
            const minutes = Math.floor(remaining / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            const display = `${minutes}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('timer-display').textContent = display;
            const timerWarning = document.getElementById('timer-warning');
            if (remaining < 60000) {
                timerWarning.classList.remove('bg-yellow-50', 'border-yellow-500');
                timerWarning.classList.add('bg-red-50', 'border-red-500');
                timerWarning.querySelector('h3').classList.remove('text-yellow-800');
                timerWarning.querySelector('h3').classList.add('text-red-800');
                timerWarning.querySelector('p').classList.remove('text-yellow-700');
                timerWarning.querySelector('p').classList.add('text-red-700');
                timerWarning.querySelector('i').classList.remove('text-yellow-600');
                timerWarning.querySelector('i').classList.add('text-red-600');
            }
        }
        function expireSession() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('timer-warning').classList.add('hidden');
            document.getElementById('session-expired').classList.remove('hidden');
            document.getElementById('employee-selection').classList.add('hidden');
            document.getElementById('attendance-type-selection').classList.add('hidden');
            console.log('â° ì„¸ì…˜ ë§Œë£Œ');
        }
        async function saveAttendanceRecord(attendanceType) {
            const attendanceData = {
                employee_id: selectedEmployee.id,
                employee_name: selectedEmployee.name,
                employee_number: selectedEmployee.employee_number || '',
                location_id: locationData.locationId,
                location_name: locationData.locationName,
                location_code: locationData.locationCode,
                attendance_type: attendanceType,
                scan_time: new Date().toISOString(),
                device_info: navigator.userAgent
            };
            try {
                console.log('ğŸ’¾ Saving attendance...', attendanceData);
                const response = await fetch(`${SUPABASE_URL}/rest/v1/attendance_records`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(attendanceData)
                });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                console.log('âœ… Attendance saved:', data);
                showSuccess(data[0]);
                addToRecentScans(data[0]);
            } catch (error) {
                console.error('âŒ Error:', error);
                alert('ì¶œì„ ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                location.reload();
            }
        }
        function showSuccess(record) {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('timer-warning').classList.add('hidden');
            document.getElementById('location-info').classList.add('hidden');
            const scanTime = new Date(record.scan_time);
            const typeColor = {
                'ì¶œê·¼': 'text-green-600',
                'í‡´ê·¼': 'text-red-600',
                'íœ´ê²Œ ì‹œì‘': 'text-orange-600',
                'íœ´ê²Œ ì¢…ë£Œ': 'text-blue-600'
            };
            document.getElementById('success-details').innerHTML = `
                <div class="grid grid-cols-2 gap-2 text-sm text-left">
                    <div class="text-gray-600">ì§ì›:</div>
                    <div class="font-semibold">${record.employee_name}</div>
                    <div class="text-gray-600">êµ¬ì—­:</div>
                    <div class="font-semibold">${record.location_name}</div>
                    <div class="text-gray-600">ì¶œì„ ìœ í˜•:</div>
                    <div class="font-semibold ${typeColor[record.attendance_type] || ''}">${record.attendance_type}</div>
                    <div class="text-gray-600">ì‹œê°„:</div>
                    <div class="font-semibold">${formatDateTime(scanTime)}</div>
                </div>
            `;
            document.getElementById('success-result').classList.remove('hidden');
        }
        function loadRecentScans() {
            const stored = localStorage.getItem('recentScans');
            if (stored) {
                try {
                    recentScans = JSON.parse(stored);
                    displayRecentScans();
                } catch (e) {
                    console.error('Error loading recent scans:', e);
                    recentScans = [];
                }
            }
        }
        function addToRecentScans(record) {
            recentScans.unshift(record);
            if (recentScans.length > 10) {
                recentScans = recentScans.slice(0, 10);
            }
            localStorage.setItem('recentScans', JSON.stringify(recentScans));
            displayRecentScans();
        }
        function displayRecentScans() {
            if (recentScans.length === 0) return;
            document.getElementById('recent-scans').classList.remove('hidden');
            const listDiv = document.getElementById('recent-scans-list');
            const typeColor = {
                'ì¶œê·¼': 'border-green-600',
                'í‡´ê·¼': 'border-red-600',
                'íœ´ê²Œ ì‹œì‘': 'border-orange-600',
                'íœ´ê²Œ ì¢…ë£Œ': 'border-blue-600'
            };
            listDiv.innerHTML = recentScans.map(record => {
                const scanTime = new Date(record.scan_time);
                const borderColor = typeColor[record.attendance_type] || 'border-blue-600';
                return `<div class="border-l-4 ${borderColor} bg-gray-50 p-3 md:p-4 mb-3 rounded"><div class="flex justify-between items-start"><div><div class="font-semibold text-base md:text-lg">${record.employee_name || 'ì•Œ ìˆ˜ ì—†ìŒ'} <span class="text-sm text-gray-500">[${record.attendance_type || 'ì¶œê·¼'}]</span></div><div class="text-sm md:text-base text-gray-600">${record.location_name || 'ì•Œ ìˆ˜ ì—†ìŒ'}</div><div class="text-xs md:text-sm text-gray-500">${formatDateTime(scanTime)}</div></div><div class="text-green-600"><i class="fas fa-check-circle text-xl md:text-2xl"></i></div></div></div>`;
            }).join('');
        }
        function formatDateTime(date) {
            if (!date || isNaN(date.getTime())) {
                return 'ì•Œ ìˆ˜ ì—†ìŒ';
            }
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
    </script>
</body>
</html>
