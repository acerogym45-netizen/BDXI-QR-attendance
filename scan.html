<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR ìŠ¤ìº” - ì¶œì„/ì²­ì†Œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <style>
        #reader {
            max-width: 500px;
            margin: 0 auto;
        }
        #reader video {
            width: 100%;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-8">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold text-gray-900">QR ìŠ¤ìº” ì‹œìŠ¤í…œ</h1>
                    </div>
                    <div class="hidden md:flex space-x-4">
                        <a href="index.html" class="text-gray-600 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium flex items-center">
                            <i class="fas fa-home mr-2"></i>
                            ê´€ë¦¬ì
                        </a>
                        <a href="records.html" class="text-gray-600 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium flex items-center">
                            <i class="fas fa-list mr-2"></i>
                            ê¸°ë¡
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-2xl mx-auto px-4 py-8">
        <!-- Step 1: QR ìŠ¤ìº” -->
        <div id="step-qr-scan" class="bg-white rounded-lg shadow-md p-6">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
                    <i class="fas fa-qrcode text-3xl text-blue-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900">QR ì½”ë“œ ìŠ¤ìº”</h2>
                <p class="text-gray-600 mt-2">êµ¬ì—­ QR ì½”ë“œë¥¼ ìŠ¤ìº”í•´ì£¼ì„¸ìš”</p>
            </div>

            <div id="reader" class="mb-4"></div>
            <div id="scan-status" class="text-center text-sm text-gray-500"></div>
        </div>

        <!-- Step 2: ë©”ë‰´ ì„ íƒ (ì¶œì„ or ì²­ì†Œ) -->
        <div id="step-menu-selection" class="bg-white rounded-lg shadow-md p-6 hidden">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                    <i class="fas fa-check-circle text-3xl text-green-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900">ì‘ì—… ì„ íƒ</h2>
                <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                    <p class="text-sm text-gray-600">ìŠ¤ìº”ëœ êµ¬ì—­</p>
                    <p class="text-lg font-bold text-gray-900" id="location-name-display"></p>
                    <p class="text-sm text-gray-500" id="location-code-display"></p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <button onclick="selectMode('attendance')" class="flex flex-col items-center justify-center p-6 bg-blue-50 hover:bg-blue-100 rounded-lg border-2 border-blue-200 transition">
                    <i class="fas fa-user-check text-4xl text-blue-600 mb-3"></i>
                    <span class="text-lg font-semibold text-gray-900">ì¶œì„ ì²´í¬</span>
                    <span class="text-sm text-gray-600 mt-1">ì§ì› ì„ íƒ í›„ ì¦‰ì‹œ ì™„ë£Œ</span>
                </button>

                <button onclick="selectMode('cleaning')" class="flex flex-col items-center justify-center p-6 bg-green-50 hover:bg-green-100 rounded-lg border-2 border-green-200 transition">
                    <i class="fas fa-broom text-4xl text-green-600 mb-3"></i>
                    <span class="text-lg font-semibold text-gray-900">ì²­ì†Œ ê¸°ë¡</span>
                    <span class="text-sm text-gray-600 mt-1">ì‚¬ì§„ ì´¬ì˜ ë° ì—…ë¡œë“œ</span>
                </button>
            </div>

            <button onclick="resetToScan()" class="w-full mt-4 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">
                <i class="fas fa-qrcode mr-2"></i>
                QR ë‹¤ì‹œ ìŠ¤ìº”
            </button>
        </div>

        <!-- Step 3: ì§ì› ì„ íƒ -->
        <div id="step-employee-selection" class="bg-white rounded-lg shadow-md p-6 hidden">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-purple-100 rounded-full mb-4">
                    <i class="fas fa-users text-3xl text-purple-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900">ì§ì› ì„ íƒ</h2>
                <p class="text-gray-600 mt-2">ì‘ì—…í•  ì§ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
            </div>

            <div class="mb-4">
                <input type="text" id="employee-search" placeholder="ì´ë¦„, ì‚¬ë²ˆ, ë¶€ì„œë¡œ ê²€ìƒ‰..." 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>

            <div id="employees-grid" class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
                <div class="text-center text-gray-500 py-8">ì§ì› ëª©ë¡ ë¡œë”© ì¤‘...</div>
            </div>

            <button onclick="backToMenu()" class="w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">
                <i class="fas fa-arrow-left mr-2"></i>
                ì´ì „
            </button>
        </div>

        <!-- Step 4: êµ¬ì—­ ì„ íƒ (ì²­ì†Œ ëª¨ë“œ) -->
        <div id="step-location-selection" class="bg-white rounded-lg shadow-md p-6 hidden">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-orange-100 rounded-full mb-4">
                    <i class="fas fa-map-marker-alt text-3xl text-orange-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900">êµ¬ì—­ ì„ íƒ</h2>
                <p class="text-gray-600 mt-2">ì²­ì†Œí•  êµ¬ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
                <div class="mt-4 p-3 bg-purple-50 rounded-lg">
                    <p class="text-sm font-semibold text-gray-900" id="selected-employee-name"></p>
                </div>
            </div>

            <div class="mb-4">
                <input type="text" id="location-search" placeholder="êµ¬ì—­ëª…, ì½”ë“œë¡œ ê²€ìƒ‰..." 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>

            <div id="locations-grid" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                <div class="text-center text-gray-500 py-8">êµ¬ì—­ ëª©ë¡ ë¡œë”© ì¤‘...</div>
            </div>

            <button onclick="backToEmployeeSelection()" class="w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">
                <i class="fas fa-arrow-left mr-2"></i>
                ì´ì „
            </button>
        </div>

        <!-- Step 5: ì‚¬ì§„ ì´¬ì˜ (ì²­ì†Œ ëª¨ë“œ) -->
        <div id="step-photo-capture" class="bg-white rounded-lg shadow-md p-6 hidden">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-pink-100 rounded-full mb-4">
                    <i class="fas fa-camera text-3xl text-pink-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900">ì²­ì†Œ ì‚¬ì§„ ì´¬ì˜</h2>
                <p class="text-gray-600 mt-2">ì²­ì†Œ ì™„ë£Œ ì‚¬ì§„ì„ ì´¬ì˜í•´ì£¼ì„¸ìš”</p>
                <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                    <p class="text-sm font-semibold text-gray-900">
                        <span id="photo-employee-name"></span> - <span id="photo-location-name"></span>
                    </p>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-images mr-2"></i>
                    ì‚¬ì§„ ì„ íƒ (ìµœëŒ€ 30ì¥)
                </label>
                <input type="file" id="photo-input" accept="image/*" multiple capture="environment"
                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <p class="mt-2 text-xs text-gray-500">
                    <i class="fas fa-info-circle mr-1"></i>
                    10ë¶„ ì´ë‚´ ì´¬ì˜í•œ ì‚¬ì§„ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                </p>
            </div>

            <div id="photo-preview" class="mb-4 hidden">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">
                        <i class="fas fa-check-circle text-green-600 mr-1"></i>
                        ì„ íƒëœ ì‚¬ì§„: <span id="photo-count">0</span>ì¥
                    </span>
                </div>
                <div id="photo-grid" class="grid grid-cols-3 gap-2"></div>
            </div>

            <div id="upload-progress" class="mb-4 hidden">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">ì—…ë¡œë“œ ì¤‘...</span>
                    <span class="text-sm text-gray-600" id="upload-status">0/0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="upload-bar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                </div>
            </div>

            <div class="space-y-3">
                <button id="submit-cleaning-btn" onclick="submitCleaning()" disabled
                    class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-lg font-semibold transition">
                    <i class="fas fa-check mr-2"></i>
                    ì œì¶œí•˜ê¸°
                </button>
                <button onclick="backToLocationSelection()" class="w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">
                    <i class="fas fa-arrow-left mr-2"></i>
                    ì´ì „
                </button>
            </div>
        </div>

        <!-- Step 6: ì¶œì„ ì™„ë£Œ -->
        <div id="step-attendance-complete" class="bg-white rounded-lg shadow-md p-6 hidden">
            <div class="text-center">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-green-100 rounded-full mb-4">
                    <i class="fas fa-check-circle text-5xl text-green-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">ì¶œì„ ì²´í¬ ì™„ë£Œ!</h2>
                <p class="text-gray-600 mb-6" id="attendance-complete-message"></p>
                <button onclick="resetAll()" class="w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition">
                    <i class="fas fa-home mr-2"></i>
                    ì²˜ìŒìœ¼ë¡œ
                </button>
            </div>
        </div>

        <!-- Step 6: ì²­ì†Œ ì™„ë£Œ -->
        <div id="step-cleaning-complete" class="bg-white rounded-lg shadow-md p-6 hidden">
            <div class="text-center">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-green-100 rounded-full mb-4">
                    <i class="fas fa-check-circle text-5xl text-green-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">ì²­ì†Œ ê¸°ë¡ ì™„ë£Œ!</h2>
                <p class="text-gray-600 mb-2" id="cleaning-complete-message"></p>
                <p class="text-sm text-gray-500 mb-6" id="cleaning-photo-count"></p>
                <button onclick="resetAll()" class="w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition">
                    <i class="fas fa-home mr-2"></i>
                    ì²˜ìŒìœ¼ë¡œ
                </button>
            </div>
        </div>
    </div>

    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://qgpqhtuynxhmgawakjxe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFncHFodHV5bnhobWdhd2FranhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYxMzgxMzUsImV4cCI6MjA1MTcxNDEzNX0.sb_publishable_ujXj0mLf1casiQdVkc0fCA_G6exymqG';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ì „ì—­ ë³€ìˆ˜
        let html5QrCode = null;
        let isProcessingQr = false; // ì¤‘ë³µ ìŠ¤ìº” ë°©ì§€ í”Œë˜ê·¸
        let currentMode = null; // 'attendance' or 'cleaning'
        let scannedLocation = null; // QRì—ì„œ ìŠ¤ìº”ëœ êµ¬ì—­
        let selectedEmployee = null;
        let selectedLocation = null;
        let employees = [];
        let locations = [];
        let uploadedPhotos = [];

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“± Page loaded');
            startScanner();
            loadEmployees();
            loadLocations();
            setupPhotoInput();
        });

        // QR ìŠ¤ìºë„ˆ ì‹œì‘
        async function startScanner() {
            try {
                isProcessingQr = false; // í”Œë˜ê·¸ ì´ˆê¸°í™”
                html5QrCode = new Html5Qrcode("reader");
                
                await html5QrCode.start(
                    { facingMode: "environment" },
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 }
                    },
                    onScanSuccess,
                    onScanError
                );
                
                document.getElementById('scan-status').textContent = 'ì¹´ë©”ë¼ ì¤€ë¹„ ì™„ë£Œ';
                console.log('âœ… Scanner started');
            } catch (error) {
                console.error('âŒ Camera error:', error);
                document.getElementById('scan-status').innerHTML = 
                    `<span class="text-red-600">ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨</span>
                    <button onclick="startScanner()" class="ml-2 text-blue-600 underline">ì¬ì‹œë„</button>`;
            }
        }

        // QR ìŠ¤ìº” ì„±ê³µ
        async function onScanSuccess(decodedText, decodedResult) {
            if (isProcessingQr) return; // ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ë©´ ë¬´ì‹œ
            
            console.log('ğŸ“± QR scanned:', decodedText);
            isProcessingQr = true; // ì²˜ë¦¬ ì‹œì‘
            
            try {
                const qrData = JSON.parse(decodedText);
                
                if (qrData.type !== 'location') {
                    alert('ì˜¬ë°”ë¥¸ êµ¬ì—­ QR ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤.');
                    isProcessingQr = false; // í”Œë˜ê·¸ í•´ì œ
                    return;
                }
                
                // ìŠ¤ìºë„ˆ ì™„ì „íˆ ì¤‘ì§€
                if (html5QrCode) {
                    await html5QrCode.stop();
                    html5QrCode = null;
                }
                
                // ìŠ¤ìº”ëœ êµ¬ì—­ ì •ë³´ ì €ì¥
                scannedLocation = {
                    id: qrData.locationId,
                    name: qrData.locationName,
                    code: qrData.locationCode
                };
                
                // ë©”ë‰´ ì„ íƒ í™”ë©´ìœ¼ë¡œ ì´ë™
                showMenuSelection();
                
            } catch (error) {
                console.error('âŒ Scan error:', error);
                alert('QR ì½”ë“œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                isProcessingQr = false; // í”Œë˜ê·¸ í•´ì œ
            }
        }

        // QR ìŠ¤ìº” ì—ëŸ¬ (ë¬´ì‹œ)
        function onScanError(errorMessage) {
            // ë¬´ì‹œ
        }

        // ë©”ë‰´ ì„ íƒ í™”ë©´ í‘œì‹œ
        function showMenuSelection() {
            document.getElementById('step-qr-scan').classList.add('hidden');
            document.getElementById('step-menu-selection').classList.remove('hidden');
            
            document.getElementById('location-name-display').textContent = scannedLocation.name;
            document.getElementById('location-code-display').textContent = scannedLocation.code;
        }

        // ëª¨ë“œ ì„ íƒ (ì¶œì„ or ì²­ì†Œ)
        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('step-menu-selection').classList.add('hidden');
            document.getElementById('step-employee-selection').classList.remove('hidden');
            
            console.log('âœ… Mode selected:', mode);
        }

        // ì§ì› ëª©ë¡ ë¡œë“œ
        async function loadEmployees() {
            try {
                const { data, error } = await supabaseClient
                    .from('employees')
                    .select('*')
                    .eq('is_active', true)
                    .order('name');

                if (error) throw error;

                employees = data;
                console.log(`âœ… Loaded ${employees.length} employees`);
                displayEmployees();
                setupEmployeeSearch();
            } catch (error) {
                console.error('âŒ Load employees error:', error);
                document.getElementById('employees-grid').innerHTML = 
                    '<div class="col-span-full text-center text-red-600">ì§ì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ì§ì› ëª©ë¡ í‘œì‹œ
        function displayEmployees(filterText = '') {
            const grid = document.getElementById('employees-grid');
            const filtered = employees.filter(emp => 
                emp.name.toLowerCase().includes(filterText.toLowerCase()) ||
                (emp.employee_number && emp.employee_number.includes(filterText)) ||
                (emp.department && emp.department.toLowerCase().includes(filterText.toLowerCase()))
            );

            if (filtered.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            grid.innerHTML = filtered.map(emp => {
                const initial = emp.name.charAt(0);
                return `
                    <button onclick="selectEmployee('${emp.id}')" 
                        class="p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition text-left">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">
                                ${initial}
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-gray-900 truncate">${emp.name}</p>
                                <p class="text-xs text-gray-500 truncate">${emp.employee_number || ''}</p>
                                ${emp.department ? `<p class="text-xs text-gray-400 truncate">${emp.department}</p>` : ''}
                            </div>
                        </div>
                    </button>
                `;
            }).join('');
        }

        // ì§ì› ê²€ìƒ‰ ì„¤ì •
        function setupEmployeeSearch() {
            const searchInput = document.getElementById('employee-search');
            searchInput.addEventListener('input', (e) => {
                displayEmployees(e.target.value);
            });
        }

        // ì§ì› ì„ íƒ
        function selectEmployee(employeeId) {
            selectedEmployee = employees.find(emp => emp.id === employeeId);
            console.log('âœ… Employee selected:', selectedEmployee.name);

            if (currentMode === 'attendance') {
                // ì¶œì„ ëª¨ë“œ: ë°”ë¡œ ì¶œì„ ì €ì¥
                saveAttendance();
            } else if (currentMode === 'cleaning') {
                // ì²­ì†Œ ëª¨ë“œ: êµ¬ì—­ ì„ íƒìœ¼ë¡œ ì´ë™
                showLocationSelection();
            }
        }

        // ì¶œì„ ì €ì¥
        async function saveAttendance() {
            try {
                const attendanceData = {
                    employee_id: selectedEmployee.id,
                    employee_name: selectedEmployee.name,
                    employee_number: selectedEmployee.employee_number,
                    location_id: scannedLocation.id,
                    location_name: scannedLocation.name,
                    location_code: scannedLocation.code,
                    attendance_type: 'ì¶œê·¼', // ê¸°ë³¸ê°’
                    scan_time: new Date().toISOString(),
                    device_info: navigator.userAgent
                };

                const { data, error } = await supabaseClient
                    .from('attendance_records')
                    .insert([attendanceData])
                    .select()
                    .single();

                if (error) throw error;

                console.log('âœ… Attendance saved:', data);
                showAttendanceComplete();
            } catch (error) {
                console.error('âŒ Save attendance error:', error);
                alert('ì¶œì„ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì¶œì„ ì™„ë£Œ í™”ë©´
        function showAttendanceComplete() {
            document.getElementById('step-employee-selection').classList.add('hidden');
            document.getElementById('step-attendance-complete').classList.remove('hidden');
            
            document.getElementById('attendance-complete-message').textContent = 
                `${selectedEmployee.name}ë‹˜ì˜ ì¶œì„ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`;
        }

        // êµ¬ì—­ ëª©ë¡ ë¡œë“œ
        async function loadLocations() {
            try {
                const { data, error } = await supabaseClient
                    .from('locations')
                    .select('*')
                    .eq('is_active', true)
                    .order('name');

                if (error) throw error;

                locations = data;
                console.log(`âœ… Loaded ${locations.length} locations`);
            } catch (error) {
                console.error('âŒ Load locations error:', error);
            }
        }

        // êµ¬ì—­ ì„ íƒ í™”ë©´ í‘œì‹œ
        function showLocationSelection() {
            document.getElementById('step-employee-selection').classList.add('hidden');
            document.getElementById('step-location-selection').classList.remove('hidden');
            
            document.getElementById('selected-employee-name').textContent = 
                `${selectedEmployee.name} (${selectedEmployee.employee_number || ''})`;
            
            displayLocations();
            setupLocationSearch();
        }

        // êµ¬ì—­ ëª©ë¡ í‘œì‹œ
        function displayLocations(filterText = '') {
            const grid = document.getElementById('locations-grid');
            const filtered = locations.filter(loc => 
                loc.name.toLowerCase().includes(filterText.toLowerCase()) ||
                (loc.code && loc.code.toLowerCase().includes(filterText.toLowerCase()))
            );

            if (filtered.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            grid.innerHTML = filtered.map(loc => `
                <button onclick="selectLocation('${loc.id}')" 
                    class="p-4 border-2 border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50 transition text-left">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-green-600 text-white rounded-full flex items-center justify-center">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-gray-900 truncate">${loc.name}</p>
                            <p class="text-xs text-gray-500 truncate">${loc.code || ''}</p>
                        </div>
                    </div>
                </button>
            `).join('');
        }

        // êµ¬ì—­ ê²€ìƒ‰ ì„¤ì •
        function setupLocationSearch() {
            const searchInput = document.getElementById('location-search');
            searchInput.addEventListener('input', (e) => {
                displayLocations(e.target.value);
            });
        }

        // êµ¬ì—­ ì„ íƒ
        function selectLocation(locationId) {
            selectedLocation = locations.find(loc => loc.id === locationId);
            console.log('âœ… Location selected:', selectedLocation.name);
            showPhotoCapture();
        }

        // ì‚¬ì§„ ì´¬ì˜ í™”ë©´ í‘œì‹œ
        function showPhotoCapture() {
            document.getElementById('step-location-selection').classList.add('hidden');
            document.getElementById('step-photo-capture').classList.remove('hidden');
            
            document.getElementById('photo-employee-name').textContent = selectedEmployee.name;
            document.getElementById('photo-location-name').textContent = selectedLocation.name;
        }

        // ì‚¬ì§„ ì…ë ¥ ì„¤ì •
        function setupPhotoInput() {
            const photoInput = document.getElementById('photo-input');
            photoInput.addEventListener('change', handlePhotoSelection);
        }

        // ì‚¬ì§„ ì„ íƒ ì²˜ë¦¬
        async function handlePhotoSelection(event) {
            const files = Array.from(event.target.files);
            
            if (files.length === 0) return;
            if (files.length > 30) {
                alert('ìµœëŒ€ 30ì¥ê¹Œì§€ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            // ì‹œê°„ ê²€ì¦
            let validFiles = [];
            for (let file of files) {
                const isValid = await validatePhotoTime(file);
                if (isValid) {
                    validFiles.push(file);
                } else {
                    alert(`${file.name}ì€(ëŠ”) 10ë¶„ ì´ë‚´ ì´¬ì˜í•œ ì‚¬ì§„ì´ ì•„ë‹™ë‹ˆë‹¤.`);
                }
            }

            if (validFiles.length === 0) return;

            // ì—…ë¡œë“œ ì‹œì‘
            await uploadPhotos(validFiles);
        }

        // ì‚¬ì§„ ì‹œê°„ ê²€ì¦ (EXIF)
        function validatePhotoTime(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        EXIF.getData(img, function() {
                            const dateTime = EXIF.getTag(this, 'DateTimeOriginal');
                            
                            if (dateTime) {
                                // EXIF ë‚ ì§œ íŒŒì‹± (YYYY:MM:DD HH:mm:ss)
                                const [datePart, timePart] = dateTime.split(' ');
                                const [year, month, day] = datePart.split(':');
                                const [hour, minute, second] = timePart.split(':');
                                const photoDate = new Date(year, month - 1, day, hour, minute, second);
                                
                                const now = new Date();
                                const diffMinutes = (now - photoDate) / 1000 / 60;
                                
                                console.log(`ğŸ“¸ Photo time: ${dateTime}, diff: ${diffMinutes.toFixed(1)} minutes`);
                                resolve(diffMinutes <= 10);
                            } else {
                                // EXIF ì—†ìœ¼ë©´ íŒŒì¼ ìˆ˜ì • ì‹œê°„ ê¸°ì¤€
                                const fileDate = new Date(file.lastModified);
                                const now = new Date();
                                const diffMinutes = (now - fileDate) / 1000 / 60;
                                console.log(`ğŸ“¸ File time (no EXIF): ${fileDate}, diff: ${diffMinutes.toFixed(1)} minutes`);
                                resolve(diffMinutes <= 10);
                            }
                        });
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // ì‚¬ì§„ ì—…ë¡œë“œ
        async function uploadPhotos(files) {
            const progressDiv = document.getElementById('upload-progress');
            const statusSpan = document.getElementById('upload-status');
            const progressBar = document.getElementById('upload-bar');
            
            progressDiv.classList.remove('hidden');

            let uploaded = 0;
            const total = files.length;

            for (let file of files) {
                try {
                    const timestamp = Date.now();
                    const fileName = `${timestamp}_${selectedLocation.code}_${selectedEmployee.name}_${file.name}`;
                    const filePath = `${fileName}`;

                    // Supabase Storage ì—…ë¡œë“œ
                    const { data, error } = await supabaseClient.storage
                        .from('cleaning-photos')
                        .upload(filePath, file, {
                            cacheControl: '3600',
                            upsert: false
                        });

                    if (error) throw error;

                    // ê³µê°œ URL ê°€ì ¸ì˜¤ê¸°
                    const { data: urlData } = supabaseClient.storage
                        .from('cleaning-photos')
                        .getPublicUrl(filePath);

                    uploadedPhotos.push({
                        url: urlData.publicUrl,
                        name: file.name,
                        path: filePath
                    });

                    uploaded++;
                    statusSpan.textContent = `${uploaded}/${total}`;
                    progressBar.style.width = `${(uploaded / total) * 100}%`;

                    console.log(`âœ… Uploaded: ${file.name}`);
                } catch (error) {
                    console.error('âŒ Upload error:', error);
                    alert(`${file.name} ì—…ë¡œë“œ ì‹¤íŒ¨`);
                }
            }

            // ì—…ë¡œë“œ ì™„ë£Œ
            updatePhotoPreview();
            document.getElementById('submit-cleaning-btn').disabled = false;
        }

        // ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updatePhotoPreview() {
            const previewDiv = document.getElementById('photo-preview');
            const grid = document.getElementById('photo-grid');
            const count = document.getElementById('photo-count');

            if (uploadedPhotos.length === 0) {
                previewDiv.classList.add('hidden');
                return;
            }

            previewDiv.classList.remove('hidden');
            count.textContent = uploadedPhotos.length;

            grid.innerHTML = uploadedPhotos.map((photo, index) => `
                <div class="relative group">
                    <img src="${photo.url}" alt="${photo.name}" class="w-full h-24 object-cover rounded-lg">
                    <button onclick="removePhoto(${index})" 
                        class="absolute top-1 right-1 w-6 h-6 bg-red-600 text-white rounded-full opacity-0 group-hover:opacity-100 transition">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            `).join('');
        }

        // ì‚¬ì§„ ì‚­ì œ
        async function removePhoto(index) {
            const photo = uploadedPhotos[index];
            
            try {
                // Storageì—ì„œ ì‚­ì œ
                const { error } = await supabaseClient.storage
                    .from('cleaning-photos')
                    .remove([photo.path]);

                if (error) throw error;

                uploadedPhotos.splice(index, 1);
                updatePhotoPreview();

                if (uploadedPhotos.length === 0) {
                    document.getElementById('submit-cleaning-btn').disabled = true;
                }

                console.log('âœ… Photo removed');
            } catch (error) {
                console.error('âŒ Remove photo error:', error);
                alert('ì‚¬ì§„ ì‚­ì œ ì‹¤íŒ¨');
            }
        }

        // ì²­ì†Œ ê¸°ë¡ ì œì¶œ
        async function submitCleaning() {
            if (uploadedPhotos.length === 0) {
                alert('ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const cleaningData = {
                    employee_id: selectedEmployee.id,
                    employee_name: selectedEmployee.name,
                    employee_number: selectedEmployee.employee_number,
                    location_id: selectedLocation.id,
                    location_name: selectedLocation.name,
                    location_code: selectedLocation.code,
                    photo_urls: uploadedPhotos.map(p => p.url),
                    photo_count: uploadedPhotos.length,
                    photo_taken_at: new Date().toISOString(),
                    submitted_at: new Date().toISOString(),
                    status: 'ì™„ë£Œ',
                    device_info: navigator.userAgent
                };

                const { data, error } = await supabaseClient
                    .from('cleaning_tasks')
                    .insert([cleaningData])
                    .select()
                    .single();

                if (error) throw error;

                console.log('âœ… Cleaning task saved:', data);
                showCleaningComplete();
            } catch (error) {
                console.error('âŒ Submit cleaning error:', error);
                alert('ì²­ì†Œ ê¸°ë¡ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì²­ì†Œ ì™„ë£Œ í™”ë©´
        function showCleaningComplete() {
            document.getElementById('step-photo-capture').classList.add('hidden');
            document.getElementById('step-cleaning-complete').classList.remove('hidden');
            
            document.getElementById('cleaning-complete-message').textContent = 
                `${selectedEmployee.name}ë‹˜ì˜ ì²­ì†Œ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            document.getElementById('cleaning-photo-count').textContent = 
                `${uploadedPhotos.length}ì¥ì˜ ì‚¬ì§„ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`;
        }

        // ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ë“¤
        function resetToScan() {
            document.getElementById('step-menu-selection').classList.add('hidden');
            document.getElementById('step-qr-scan').classList.remove('hidden');
            startScanner(); // ìƒˆë¡œ ì‹œì‘
        }

        function backToMenu() {
            document.getElementById('step-employee-selection').classList.add('hidden');
            document.getElementById('step-menu-selection').classList.remove('hidden');
        }

        function backToEmployeeSelection() {
            document.getElementById('step-location-selection').classList.add('hidden');
            document.getElementById('step-employee-selection').classList.remove('hidden');
        }

        function backToLocationSelection() {
            // ì—…ë¡œë“œëœ ì‚¬ì§„ ì´ˆê¸°í™”
            uploadedPhotos = [];
            updatePhotoPreview();
            document.getElementById('submit-cleaning-btn').disabled = true;
            
            document.getElementById('step-photo-capture').classList.add('hidden');
            document.getElementById('step-location-selection').classList.remove('hidden');
        }

        function resetAll() {
            // ëª¨ë“  ìƒíƒœ ì´ˆê¸°í™”
            currentMode = null;
            scannedLocation = null;
            selectedEmployee = null;
            selectedLocation = null;
            uploadedPhotos = [];
            
            // ëª¨ë“  í™”ë©´ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('[id^="step-"]').forEach(el => {
                el.classList.add('hidden');
            });
            
            // QR ìŠ¤ìº” í™”ë©´ìœ¼ë¡œ
            document.getElementById('step-qr-scan').classList.remove('hidden');
            startScanner();
        }

        // ë‚ ì§œ í¬ë§· í•¨ìˆ˜
        function formatDateTime(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');
            const seconds = String(d.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
    </script>
</body>
</html>
