
<!DOCTYPE html>
<html lang="ko" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>KINDWON ì§ì› ì—…ë¬´ ì‹œìŠ¤í…œ</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
      body {
        font-family: 'Noto Sans KR', sans-serif;
        background-color: #f3f4f6;
        -webkit-tap-highlight-color: transparent;
      }
      .bg-brand {
        background-color: #1b5e3e;
      }
      .text-brand {
        color: #1b5e3e;
      }
      .btn-touch {
        transition:
          transform 0.1s,
          opacity 0.1s;
      }
      .btn-touch:active {
        transform: scale(0.98);
        opacity: 0.9;
      }
      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 3px solid white;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Toast Animation */
      .toast-enter {
        transform: translateY(100%);
        opacity: 0;
      }
      .toast-enter-active {
        transform: translateY(0);
        opacity: 1;
        transition: all 0.3s ease-out;
      }
      .toast-exit {
        transform: translateY(0);
        opacity: 1;
      }
      .toast-exit-active {
        transform: translateY(100%);
        opacity: 0;
        transition: all 0.3s ease-in;
      }
    </style>
  </head>
  <body class="min-h-screen relative">
    <!-- Loading Screen -->
    <div id="screen-loading" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
      <div class="spinner !border-gray-200 !border-t-green-800 w-12 h-12 mb-4"></div>
      <p class="text-gray-500 font-medium animate-pulse">ì‹œìŠ¤í…œ ì—°ê²° ì¤‘...</p>
    </div>

    <!-- Main Content -->
    <div id="screen-main" class="hidden max-w-lg mx-auto min-h-screen flex flex-col pb-20">
      <!-- Header -->
      <header class="bg-white shadow-sm sticky top-0 z-30">
        <div class="px-6 py-4 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <img src="https://www.genspark.ai/api/files/s/UmgxPvd3" alt="KINDWON" class="h-8" />
            <div class="h-4 w-px bg-gray-300"></div>
            <span class="font-bold text-gray-700 text-lg">ì—…ë¬´ ê¸°ë¡</span>
          </div>
          <div id="connection-status" class="w-2.5 h-2.5 rounded-full bg-green-500 shadow-sm animate-pulse"></div>
        </div>
      </header>

      <main class="flex-1 p-4 space-y-4">
        <!-- Location Info Card -->
        <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
          <div class="flex items-start justify-between">
            <div>
              <p class="text-xs text-gray-400 font-medium mb-1">í˜„ì¬ ìœ„ì¹˜</p>
              <h1 id="display-location" class="text-2xl font-bold text-gray-800 leading-tight">ë¡œë”© ì¤‘...</h1>
              <p
                id="display-apt"
                class="text-sm text-brand font-medium mt-1 bg-green-50 inline-block px-2 py-0.5 rounded"
              ></p>
            </div>
            <div class="bg-gray-50 p-2.5 rounded-xl text-gray-400">
              <i class="fas fa-map-marker-alt text-xl"></i>
            </div>
          </div>
        </div>

        <!-- STEP 1: Employee Selection -->
        <div id="section-employee" class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 transition-all">
          <div class="flex items-center justify-between mb-3">
            <h2 class="font-bold text-gray-800 flex items-center gap-2">
              <span class="bg-gray-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs"
                >1</span
              >
              ì§ì› ì„ íƒ
            </h2>
            <button id="btn-reset-emp" onclick="app.resetSelection()" class="hidden text-xs text-gray-400 underline">
              ë³€ê²½
            </button>
          </div>

          <!-- Search Input -->
          <div id="employee-search-container">
            <div class="relative mb-3">
              <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
              <input
                type="text"
                id="inp-search"
                class="w-full pl-10 pr-4 py-3 bg-gray-50 border-transparent focus:bg-white focus:border-green-500 focus:ring-0 rounded-xl transition-all text-sm outline-none"
                placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”..."
                onkeyup="app.filterEmployees()"
              />
            </div>

            <!-- Employee List -->
            <div id="list-employees" class="max-h-48 overflow-y-auto space-y-2 pr-1">
              <!-- Dynamic Content -->
            </div>
          </div>

          <!-- Selected State -->
          <div id="employee-selected" class="hidden">
            <div class="bg-green-50 border border-green-100 rounded-xl p-4 flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-700">
                <i class="fas fa-user"></i>
              </div>
              <div>
                <p id="selected-name" class="font-bold text-gray-800 text-lg"></p>
                <p id="selected-pos" class="text-xs text-gray-500"></p>
              </div>
              <i class="fas fa-check-circle text-green-500 ml-auto text-xl"></i>
            </div>
          </div>
        </div>

        <!-- STEP 2: Work Options -->
        <div id="section-work" class="hidden space-y-4">
          <div class="flex items-center gap-2 px-1">
            <span class="bg-gray-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
            <h2 class="font-bold text-gray-800">ì—…ë¬´ ì„ íƒ</h2>
          </div>

          <!-- Attendance Grid -->
          <div class="grid grid-cols-2 gap-3">
            <button
              onclick="app.recordAttendance('ì¶œê·¼')"
              class="btn-touch bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-xl shadow-sm shadow-blue-200 flex flex-col items-center gap-2"
            >
              <i class="fas fa-sign-in-alt text-2xl mb-1"></i>
              <span class="font-bold">ì¶œê·¼</span>
            </button>
            <button
              onclick="app.recordAttendance('í‡´ê·¼')"
              class="btn-touch bg-green-500 hover:bg-green-600 text-white p-4 rounded-xl shadow-sm shadow-green-200 flex flex-col items-center gap-2"
            >
              <i class="fas fa-sign-out-alt text-2xl mb-1"></i>
              <span class="font-bold">í‡´ê·¼</span>
            </button>
            <button
              onclick="app.recordAttendance('íœ´ê²Œ ì‹œì‘')"
              class="btn-touch bg-yellow-500 hover:bg-yellow-600 text-white p-4 rounded-xl shadow-sm shadow-yellow-200 flex flex-col items-center gap-2"
            >
              <i class="fas fa-mug-hot text-2xl mb-1"></i>
              <span class="font-bold">íœ´ê²Œ ì‹œì‘</span>
            </button>
            <button
              onclick="app.recordAttendance('íœ´ê²Œ ì¢…ë£Œ')"
              class="btn-touch bg-purple-500 hover:bg-purple-600 text-white p-4 rounded-xl shadow-sm shadow-purple-200 flex flex-col items-center gap-2"
            >
              <i class="fas fa-hourglass-start text-2xl mb-1"></i>
              <span class="font-bold">íœ´ê²Œ ì¢…ë£Œ</span>
            </button>
          </div>

          <!-- Divider -->
          <div class="relative py-2">
            <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
            <div class="relative flex justify-center">
              <span class="bg-gray-50 px-2 text-xs text-gray-400">ë˜ëŠ”</span>
            </div>
          </div>

          <!-- Cleaning Button -->
          <button
            onclick="document.getElementById('inp-camera').click()"
            class="btn-touch w-full bg-orange-500 hover:bg-orange-600 text-white p-5 rounded-2xl shadow-md shadow-orange-200 flex items-center justify-between group"
          >
            <div class="flex items-center gap-4">
              <div class="bg-white/20 w-12 h-12 rounded-xl flex items-center justify-center">
                <i class="fas fa-camera text-2xl"></i>
              </div>
              <div class="text-left">
                <div class="font-bold text-lg">ì²­ì†Œ ê¸°ë¡</div>
                <div class="text-orange-100 text-xs">ì‚¬ì§„ ì´¬ì˜ í›„ ìë™ ì—…ë¡œë“œ</div>
              </div>
            </div>
            <i class="fas fa-chevron-right opacity-50 group-hover:opacity-100 transition-opacity"></i>
          </button>
          <input
            type="file"
            id="inp-camera"
            accept="image/*"
            capture="environment"
            class="hidden"
            onchange="app.handlePhoto(this)"
          />

          <!-- Photo Preview Overlay (Hidden) -->
          <div id="preview-overlay" class="hidden fixed inset-0 bg-black/90 z-50 flex flex-col justify-center p-6">
            <h3 class="text-white text-center mb-4 font-bold text-lg">ğŸ“¸ ì‚¬ì§„ í™•ì¸</h3>
            <img id="img-preview" class="w-full rounded-lg mb-6 max-h-[60vh] object-contain bg-black" />
            <div class="grid grid-cols-2 gap-3">
              <button onclick="app.cancelPhoto()" class="py-3 bg-gray-600 text-white rounded-xl font-bold">
                ì¬ì´¬ì˜
              </button>
              <button
                onclick="app.uploadPhoto()"
                class="py-3 bg-orange-500 text-white rounded-xl font-bold flex items-center justify-center gap-2"
              >
                <span id="btn-upload-text">ì—…ë¡œë“œ</span>
                <div id="upload-spinner" class="spinner hidden w-4 h-4"></div>
              </button>
            </div>
          </div>
        </div>
      </main>

      <footer class="text-center py-6 text-xs text-gray-400">KINDWON Employee System v1.0</footer>
    </div>

    <!-- Error State -->
    <div
      id="screen-error"
      class="hidden fixed inset-0 bg-white z-50 flex flex-col items-center justify-center p-8 text-center"
    >
      <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mb-4 text-red-500">
        <i class="fas fa-exclamation-triangle text-2xl"></i>
      </div>
      <h2 class="text-xl font-bold text-gray-800 mb-2">ì˜¤ë¥˜ ë°œìƒ</h2>
      <p id="error-msg" class="text-gray-500 mb-6 text-sm">ì‹œìŠ¤í…œì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
      <button onclick="location.reload()" class="px-6 py-2 bg-gray-800 text-white rounded-lg text-sm">ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <!-- Toast Notification -->
    <div
      id="toast"
      class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg z-50 flex items-center gap-3 min-w-[300px] justify-center transition-all duration-300 translate-y-20 opacity-0"
    >
      <i id="toast-icon" class="fas fa-check-circle text-green-400"></i>
      <span id="toast-msg" class="font-medium text-sm">ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</span>
    </div>

    <script>
      // Configuration
      const SUPABASE_URL = 'https://qgpqhtuynxhmgawakjxe.supabase.co';
      const SUPABASE_KEY =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFncHFodHV5bnhobWdhd2FranhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyOTQyNTEsImV4cCI6MjA4Mjg3MDI1MX0.WNljQIKDbeZCDlXe8fpBdZs58XRFfujGt7lBGfq_pVg';

      const APARTMENTS = {
        BJD001: 'ë´‰ë‹´ìì´í”„ë¼ì´ë“œì‹œí‹°',
        YDB002: 'ìš©ì¸ë™ë°±ì„¼íŠ¸ëŸ´',
        SYT003: 'ìˆ˜ì›ì˜í†µìì´',
        PGD004: 'í‰íƒê³ ë•êµ­ì œì‹ ë„ì‹œ',
        ETC999: 'ê¸°íƒ€ ë‹¨ì§€',
      };

      const app = {
        sb: null,
        state: {
          locId: null,
          aptId: null,
          locationName: '',
          employees: [],
          selectedEmp: null,
          photoFile: null,
        },

        init: async function () {
          try {
            // 1. Initialize Supabase
            this.sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // 2. Parse URL Params
            const params = new URLSearchParams(window.location.search);
            this.state.locId = params.get('loc');
            this.state.aptId = params.get('apt');

            if (!this.state.locId) throw new Error('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. (QR ì½”ë“œë¥¼ ë‹¤ì‹œ ìŠ¤ìº”í•´ì£¼ì„¸ìš”)');

            // 3. Load Data
            await Promise.all([this.loadLocationInfo(), this.loadEmployees()]);

            // 4. Render
            this.renderLocation();
            this.renderEmployeeList(this.state.employees);

            // Show Main Screen
            document.getElementById('screen-loading').classList.add('hidden');
            document.getElementById('screen-main').classList.remove('hidden');
          } catch (error) {
            this.showError(error.message);
          }
        },

        loadLocationInfo: async function () {
          // Fetch location details
          // Note: Assuming 'locations' table has 'id', 'name'. 'apartment_id' might be missing as per instructions.
          const { data, error } = await this.sb.from('locations').select('name').eq('id', this.state.locId).single();

          if (error) {
            console.error('Loc Load Error:', error);
            // Fallback if ID lookup fails or logic requires direct usage
            this.state.locationName = 'ì•Œ ìˆ˜ ì—†ëŠ” êµ¬ì—­';
          } else {
            this.state.locationName = data.name;
          }
        },

        loadEmployees: async function () {
          // Fetch employees.
          // Note: Cannot filter by apartment_id in DB if column doesn't exist.
          // Fetching all active employees and we will filter in memory if necessary or just show all.
          let query = this.sb.from('employees').select('name, position').eq('status', 'active');

          // If apartment_id existed, we would do: .eq('apartment_id', this.state.aptId)
          // For now, we fetch all.
          const { data, error } = await query;

          if (error) throw error;
          if (!data || data.length === 0) throw new Error('ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.');

          this.state.employees = data;
        },

        renderLocation: function () {
          document.getElementById('display-location').textContent = this.state.locationName;
          const aptName = APARTMENTS[this.state.aptId] || 'KINDWON';
          document.getElementById('display-apt').textContent = aptName;
        },

        renderEmployeeList: function (list) {
          const container = document.getElementById('list-employees');
          container.innerHTML = '';

          list.forEach((emp) => {
            const div = document.createElement('div');
            div.className =
              'flex items-center p-3 bg-white border border-gray-100 rounded-xl active:bg-gray-50 cursor-pointer';
            div.onclick = () => this.selectEmployee(emp);
            div.innerHTML = `
                        <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 mr-3 text-xs">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <p class="font-bold text-gray-800 text-sm">${emp.name}</p>
                            <p class="text-xs text-gray-400">${emp.position || 'ì§ì›'}</p>
                        </div>
                    `;
            container.appendChild(div);
          });
        },

        filterEmployees: function () {
          const term = document.getElementById('inp-search').value.toLowerCase();
          const filtered = this.state.employees.filter((e) => e.name.toLowerCase().includes(term));
          this.renderEmployeeList(filtered);
        },

        selectEmployee: function (emp) {
          this.state.selectedEmp = emp;

          // UI Update
          document.getElementById('employee-search-container').classList.add('hidden');
          document.getElementById('employee-selected').classList.remove('hidden');

          document.getElementById('selected-name').textContent = emp.name;
          document.getElementById('selected-pos').textContent = emp.position || 'ì§ì›';

          document.getElementById('btn-reset-emp').classList.remove('hidden');
          document.getElementById('section-work').classList.remove('hidden');

          // Haptic
          if (navigator.vibrate) navigator.vibrate(10);
        },

        resetSelection: function () {
          this.state.selectedEmp = null;
          document.getElementById('employee-selected').classList.add('hidden');
          document.getElementById('employee-search-container').classList.remove('hidden');
          document.getElementById('btn-reset-emp').classList.add('hidden');
          document.getElementById('section-work').classList.add('hidden');
          document.getElementById('inp-search').value = '';
          this.renderEmployeeList(this.state.employees);
        },

        // --- ACTIONS ---

        recordAttendance: async function (type) {
          if (!this.state.selectedEmp) return;

          const payload = {
            employee_name: this.state.selectedEmp.name,
            attendance_type: type,
            location: this.state.locationName,
            scan_time: new Date().toISOString(),
            // apartment_id omitted as per DB constraint, but available in state.aptId
          };

          try {
            const { error } = await this.sb.from('attendance_records').insert([payload]);
            if (error) throw error;

            this.showToast(`${type} ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            this.resetSelection(); // Reset for next person
          } catch (e) {
            this.showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            console.error(e);
          }
        },

        handlePhoto: function (input) {
          if (input.files && input.files[0]) {
            const file = input.files[0];
            this.state.photoFile = file;

            // Preview
            const reader = new FileReader();
            reader.onload = function (e) {
              document.getElementById('img-preview').src = e.target.result;
              document.getElementById('preview-overlay').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
          }
        },

        cancelPhoto: function () {
          document.getElementById('preview-overlay').classList.add('hidden');
          document.getElementById('inp-camera').value = '';
          this.state.photoFile = null;
        },

        uploadPhoto: async function () {
          if (!this.state.photoFile) return;

          const btn = document.querySelector('#preview-overlay button:last-child');
          const spinner = document.getElementById('upload-spinner');
          const btnText = document.getElementById('btn-upload-text');

          btn.disabled = true;
          btnText.textContent = 'ì—…ë¡œë“œ ì¤‘...';
          spinner.classList.remove('hidden');

          try {
            // 1. Upload to Storage
            const ext = this.state.photoFile.name.split('.').pop();
            const fileName = `${this.state.aptId || 'common'}/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${ext}`;

            const { data: uploadData, error: uploadError } = await this.sb.storage
              .from('cleaning-photos')
              .upload(fileName, this.state.photoFile);

            if (uploadError) throw uploadError;

            // 2. Get Public URL
            const {
              data: { publicUrl },
            } = this.sb.storage.from('cleaning-photos').getPublicUrl(fileName);

            // 3. Insert Record
            const payload = {
              employee_name: this.state.selectedEmp.name,
              location: this.state.locationName,
              photo_url: publicUrl,
              created_at: new Date().toISOString(),
              // apartment_id omitted
            };

            const { error: dbError } = await this.sb.from('cleaning_tasks').insert([payload]);
            if (dbError) throw dbError;

            this.showToast('ì²­ì†Œ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            this.cancelPhoto();
            this.resetSelection();
          } catch (e) {
            console.error(e);
            alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
          } finally {
            btn.disabled = false;
            btnText.textContent = 'ì—…ë¡œë“œ';
            spinner.classList.add('hidden');
          }
        },

        // --- UTILS ---

        showToast: function (msg, type = 'success') {
          const el = document.getElementById('toast');
          const icon = document.getElementById('toast-icon');
          const text = document.getElementById('toast-msg');

          text.textContent = msg;
          if (type === 'error') {
            icon.className = 'fas fa-exclamation-circle text-red-400';
          } else {
            icon.className = 'fas fa-check-circle text-green-400';
          }

          el.classList.remove('translate-y-20', 'opacity-0');

          setTimeout(() => {
            el.classList.add('translate-y-20', 'opacity-0');
          }, 3000);
        },

        showError: function (msg) {
          document.getElementById('screen-loading').classList.add('hidden');
          document.getElementById('screen-error').classList.remove('hidden');
          document.getElementById('error-msg').textContent = msg;
        },
      };

      // Start
      document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
  <script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"9c365f523f2eea9a","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.9.1","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>
