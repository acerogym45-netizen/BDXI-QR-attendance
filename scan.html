<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR ìŠ¤ìº” - ì¶œì„/ì²­ì†Œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-xl md:text-2xl font-bold">
                    <i class="fas fa-qrcode mr-2"></i>QR ìŠ¤ìº”
                </h1>
                <div class="space-x-2 md:space-x-4 text-sm md:text-base">
                    <a href="index.html" class="hover:text-blue-200">
                        <i class="fas fa-home mr-1"></i>ê´€ë¦¬ì
                    </a>
                    <a href="records.html" class="hover:text-blue-200">
                        <i class="fas fa-chart-bar mr-1"></i>ê¸°ë¡
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="container mx-auto px-4 py-6">
        
        <!-- Step 1: ì‘ì—… ì„ íƒ (ì²« í™”ë©´) -->
        <div id="step-menu-selection" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6">
            <h2 class="text-lg md:text-xl font-bold mb-4 text-center">
                <i class="fas fa-list mr-2"></i>ì‘ì—… ì„ íƒ
            </h2>
            <div id="location-info" class="bg-blue-50 rounded-lg p-4 mb-6 text-center">
                <i class="fas fa-map-marker-alt text-blue-600 text-3xl mb-2"></i>
                <h3 class="text-xl font-bold" id="location-name-display">-</h3>
                <p class="text-gray-600" id="location-code-display">-</p>
            </div>
            <p class="text-sm md:text-base text-gray-600 mb-6 text-center">ìˆ˜í–‰í•  ì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš”</p>
            
            <div class="space-y-4">
                <button onclick="selectMode('attendance')" 
                    class="w-full bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-lg hover:shadow-xl transition transform hover:-translate-y-1">
                    <i class="fas fa-user-check text-4xl mb-3"></i>
                    <p class="font-bold text-xl">ğŸ“± ê·¼íƒœ ê¸°ë¡</p>
                    <p class="text-sm text-blue-100 mt-2">ì¶œê·¼/í‡´ê·¼/íœ´ê²Œ</p>
                </button>
                
                <button onclick="selectMode('cleaning')" 
                    class="w-full bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-lg hover:shadow-xl transition transform hover:-translate-y-1">
                    <i class="fas fa-broom text-4xl mb-3"></i>
                    <p class="font-bold text-xl">ğŸ§¹ ì²­ì†Œ ì—…ë¬´</p>
                    <p class="text-sm text-green-100 mt-2">ì²­ì†Œ ì‚¬ì§„ ì—…ë¡œë“œ</p>
                </button>
            </div>
        </div>

        <!-- Step 2: ì§ì› ì„ íƒ -->
        <div id="step-employee-selection" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6 hidden">
            <h2 class="text-lg md:text-xl font-bold mb-4">
                <i class="fas fa-user mr-2"></i>ì§ì› ì„ íƒ
            </h2>
            <p class="text-sm md:text-base text-gray-600 mb-4" id="employee-instruction">ë³¸ì¸ì˜ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”</p>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">ì§ì› ê²€ìƒ‰</label>
                <input type="text" id="employee-search" placeholder="ì´ë¦„ ë˜ëŠ” ì‚¬ë²ˆìœ¼ë¡œ ê²€ìƒ‰..." 
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div id="employees-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                <div class="col-span-full text-center text-gray-500 py-8">
                    <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                    <p>ì§ì› ëª©ë¡ ë¡œë”© ì¤‘...</p>
                </div>
            </div>
            
            <button onclick="backToMenu()" class="mt-4 w-full bg-gray-200 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-300">
                <i class="fas fa-arrow-left mr-2"></i>ì´ì „ ë‹¨ê³„ë¡œ
            </button>
        </div>

        <!-- Step 3-A: ê·¼íƒœ íƒ€ì… ì„ íƒ (ì¶œì„ ëª¨ë“œ) -->
        <div id="step-attendance-type" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6 hidden">
            <h2 class="text-lg md:text-xl font-bold mb-4 text-center">
                <i class="fas fa-clock mr-2"></i>ê·¼íƒœ íƒ€ì… ì„ íƒ
            </h2>
            
            <div class="bg-blue-50 rounded-lg p-4 mb-6 text-center">
                <p class="font-semibold text-lg" id="attendance-employee-name">-</p>
                <p class="text-sm text-gray-600" id="attendance-location-name">-</p>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <button onclick="selectAttendanceType('ì¶œê·¼')" 
                    class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-lg hover:shadow-xl transition">
                    <i class="fas fa-sign-in-alt text-3xl mb-2"></i>
                    <p class="font-bold">ì¶œê·¼</p>
                </button>
                
                <button onclick="selectAttendanceType('í‡´ê·¼')" 
                    class="bg-gradient-to-br from-red-500 to-red-600 text-white p-6 rounded-lg hover:shadow-xl transition">
                    <i class="fas fa-sign-out-alt text-3xl mb-2"></i>
                    <p class="font-bold">í‡´ê·¼</p>
                </button>
                
                <button onclick="selectAttendanceType('íœ´ê²Œ ì‹œì‘')" 
                    class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-6 rounded-lg hover:shadow-xl transition">
                    <i class="fas fa-coffee text-3xl mb-2"></i>
                    <p class="font-bold">íœ´ê²Œ ì‹œì‘</p>
                </button>
                
                <button onclick="selectAttendanceType('íœ´ê²Œ ì¢…ë£Œ')" 
                    class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-lg hover:shadow-xl transition">
                    <i class="fas fa-play-circle text-3xl mb-2"></i>
                    <p class="font-bold">íœ´ê²Œ ì¢…ë£Œ</p>
                </button>
            </div>
            
            <button onclick="backToEmployeeSelection()" class="mt-4 w-full bg-gray-200 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-300">
                <i class="fas fa-arrow-left mr-2"></i>ì´ì „ ë‹¨ê³„ë¡œ
            </button>
        </div>

        <!-- Step 3-B: ì‚¬ì§„ ì´¬ì˜ (ì²­ì†Œ ëª¨ë“œ) -->
        <div id="step-photo-capture" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6 hidden">
            <h2 class="text-lg md:text-xl font-bold mb-4">
                <i class="fas fa-camera mr-2"></i>ì²­ì†Œ ì‚¬ì§„ ì´¬ì˜
            </h2>
            
            <!-- í˜„ì¬ ì‘ì—… ì¤‘ì¸ êµ¬ì—­ ì •ë³´ -->
            <div class="bg-green-50 rounded-lg p-4 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <p class="font-semibold">ì§ì›: <span id="current-employee-name">-</span></p>
                        <p class="text-sm text-gray-600">êµ¬ì—­: <span id="current-location-name">-</span></p>
                    </div>
                    <div class="text-green-600 text-right">
                        <p class="text-2xl font-bold" id="current-photo-count">0</p>
                        <p class="text-xs">ì¥</p>
                    </div>
                </div>
            </div>
            
            <input type="file" id="photo-input" accept="image/*" capture="environment" multiple class="hidden">
            
            <button onclick="capturePhotos()" class="w-full bg-green-600 text-white px-6 py-4 rounded-lg hover:bg-green-700 mb-4">
                <i class="fas fa-camera text-2xl mb-2"></i>
                <p class="font-bold">ì‚¬ì§„ ì´¬ì˜í•˜ê¸°</p>
                <p class="text-sm text-green-100">ìµœëŒ€ 30ì¥ê¹Œì§€ ê°€ëŠ¥</p>
            </button>
            
            <!-- ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° -->
            <div id="photo-preview" class="grid grid-cols-3 gap-2 mb-4"></div>
            
            <!-- ì—…ë¡œë“œ ì§„í–‰ë¥  -->
            <div id="upload-progress" class="hidden mb-4">
                <div class="bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div id="upload-progress-bar" class="bg-green-600 h-full transition-all" style="width: 0%"></div>
                </div>
                <p class="text-sm text-center mt-2" id="upload-status">ì—…ë¡œë“œ ì¤‘...</p>
            </div>
            
            <button onclick="submitCleaning()" id="submit-cleaning-btn" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 mb-3" disabled>
                <i class="fas fa-check mr-2"></i>ì—…ë¡œë“œ & ì™„ë£Œ
            </button>
            
            <button onclick="cancelCleaning()" class="w-full bg-gray-200 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-300">
                <i class="fas fa-times mr-2"></i>ì·¨ì†Œ
            </button>
        </div>

        <!-- Step 4-A: ì¶œì„ ì™„ë£Œ (ì¶œì„ ëª¨ë“œ) -->
        <div id="step-attendance-complete" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6 hidden">
            <div class="text-center">
                <i class="fas fa-check-circle text-green-600 text-6xl mb-4"></i>
                <h2 class="text-2xl font-bold mb-2">ê·¼íƒœ ê¸°ë¡ ì™„ë£Œ!</h2>
                <div id="attendance-result" class="bg-gray-50 rounded-lg p-4 mb-4"></div>
                <button onclick="resetAll()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                    <i class="fas fa-redo mr-2"></i>ì²˜ìŒìœ¼ë¡œ
                </button>
            </div>
        </div>

        <!-- Step 4-B: ì²­ì†Œ ì™„ë£Œ -->
        <div id="step-cleaning-complete" class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6 hidden">
            <div class="text-center">
                <i class="fas fa-check-circle text-green-600 text-6xl mb-4"></i>
                <h2 class="text-2xl font-bold mb-2">ì²­ì†Œ ê¸°ë¡ ì™„ë£Œ!</h2>
                <div id="cleaning-result" class="bg-gray-50 rounded-lg p-4 mb-4"></div>
                <button onclick="resetAll()" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700">
                    <i class="fas fa-redo mr-2"></i>ì²˜ìŒìœ¼ë¡œ
                </button>
            </div>
        </div>

    </div>

    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://qgpqhtuynxhmgawakjxe.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_ujXj0mLf1casiQdVkc0fCA_G6exymqG';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ì „ì—­ ë³€ìˆ˜
        let currentMode = null; // 'attendance' or 'cleaning'
        let scannedLocation = null;
        let selectedEmployee = null;
        let employees = [];
        let currentPhotos = []; // í˜„ì¬ ì‚¬ì§„ë“¤

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('âœ… Page loaded');
            
            // URL íŒŒë¼ë¯¸í„°ì—ì„œ êµ¬ì—­ ì •ë³´ ì½ê¸°
            const urlParams = new URLSearchParams(window.location.search);
            const locationId = urlParams.get('id');
            const locationName = urlParams.get('name');
            const locationCode = urlParams.get('code');
            
            // URL í•´ì‹œ(#)ì—ì„œ JSON ë°ì´í„° ì½ê¸° (ê¸°ì¡´ QR ì½”ë“œ í˜¸í™˜)
            const hash = window.location.hash.substring(1); // # ì œê±°
            
            if (locationId && locationName && locationCode) {
                // ë°©ë²• 1: URL íŒŒë¼ë¯¸í„° ë°©ì‹ (ìƒˆë¡œìš´ ë°©ì‹)
                scannedLocation = {
                    id: locationId,
                    name: decodeURIComponent(locationName),
                    code: decodeURIComponent(locationCode)
                };
                
                console.log('âœ… Location from URL params:', scannedLocation);
                showMenuSelection();
            } else if (hash) {
                // ë°©ë²• 2: JSON í•´ì‹œ ë°©ì‹ (ê¸°ì¡´ QR ì½”ë“œ)
                try {
                    // URL ì¸ì½”ë”© ì—¬ë¶€ í™•ì¸ í›„ íŒŒì‹±
                    let qrData;
                    try {
                        // ë¨¼ì € ë””ì½”ë”© ì‹œë„
                        qrData = JSON.parse(decodeURIComponent(hash));
                    } catch (e) {
                        // ë””ì½”ë”© ì‹¤íŒ¨í•˜ë©´ ê·¸ëŒ€ë¡œ íŒŒì‹±
                        qrData = JSON.parse(hash);
                    }
                    
                    if (qrData.type === 'location' && qrData.locationId && qrData.locationName && qrData.locationCode) {
                        scannedLocation = {
                            id: qrData.locationId,
                            name: qrData.locationName,
                            code: qrData.locationCode
                        };
                        
                        console.log('âœ… Location from JSON hash:', scannedLocation);
                        showMenuSelection();
                    } else {
                        alert('ì˜¬ë°”ë¥¸ êµ¬ì—­ QR ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤.');
                    }
                } catch (error) {
                    console.error('âŒ JSON parse error:', error);
                    alert('QR ì½”ë“œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            } else {
                // êµ¬ì—­ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì—ëŸ¬
                alert('ì˜¬ë°”ë¥¸ QR ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤.\nêµ¬ì—­ ì •ë³´ê°€ í¬í•¨ëœ QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”.');
            }
            
            // ì§ì› ëª©ë¡ ë¡œë“œ
            await loadEmployees();
        });

        // ë©”ë‰´ ì„ íƒ í™”ë©´ í‘œì‹œ
        function showMenuSelection() {
            console.log('ğŸŸ¢ showMenuSelection()');
            document.getElementById('location-name-display').textContent = scannedLocation.name;
            document.getElementById('location-code-display').textContent = scannedLocation.code;
            console.log('âœ… Menu selection screen shown');
        }

        // ëª¨ë“œ ì„ íƒ (ì¶œì„ or ì²­ì†Œ)
        function selectMode(mode) {
            currentMode = mode;
            console.log('ğŸ”µ Selected mode:', mode);
            document.getElementById('step-menu-selection').classList.add('hidden');
            document.getElementById('step-employee-selection').classList.remove('hidden');
            
            if (mode === 'attendance') {
                document.getElementById('employee-instruction').textContent = 'ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”';
            } else {
                document.getElementById('employee-instruction').textContent = 'ì²­ì†Œ ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”';
            }
        }

        // ì§ì› ëª©ë¡ ë¡œë“œ
        async function loadEmployees() {
            try {
                const { data, error } = await supabaseClient
                    .from('employees')
                    .select('*')
                    .eq('is_active', true)
                    .order('name', { ascending: true });
                
                if (error) throw error;
                
                employees = data || [];
                console.log(`âœ… Loaded ${employees.length} employees`);
                displayEmployees(employees);
                
            } catch (error) {
                console.error('âŒ Error loading employees:', error);
                document.getElementById('employees-grid').innerHTML = 
                    `<div class="col-span-full text-center text-red-500 py-4">
                        <p>ì§ì› ëª©ë¡ ë¡œë”© ì‹¤íŒ¨</p>
                        <button onclick="loadEmployees()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded-md">ë‹¤ì‹œ ì‹œë„</button>
                    </div>`;
            }
        }

        // ì§ì› ëª©ë¡ í‘œì‹œ
        function displayEmployees(employeeList) {
            const grid = document.getElementById('employees-grid');
            
            if (employeeList.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            grid.innerHTML = employeeList.map(emp => {
                const initial = emp.name.charAt(0);
                return `
                    <button onclick="selectEmployee('${emp.id}')" 
                        class="p-3 md:p-4 border-2 border-gray-200 rounded-lg hover:border-blue-600 hover:bg-blue-50 transition text-center">
                        <div class="w-10 h-10 md:w-12 md:h-12 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold mx-auto mb-2">
                            ${initial}
                        </div>
                        <div class="font-semibold text-sm md:text-base">${emp.name}</div>
                        <div class="text-xs text-gray-500">${emp.employee_number || ''}</div>
                    </button>
                `;
            }).join('');
        }

        // ì§ì› ê²€ìƒ‰
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('employee-search');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const filtered = searchTerm === '' ? employees : employees.filter(emp => 
                        emp.name.toLowerCase().includes(searchTerm) ||
                        (emp.employee_number && emp.employee_number.toLowerCase().includes(searchTerm))
                    );
                    displayEmployees(filtered);
                });
            }
        });

        // ì§ì› ì„ íƒ
        function selectEmployee(employeeId) {
            selectedEmployee = employees.find(emp => emp.id === employeeId);
            
            if (!selectedEmployee) {
                alert('ì§ì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            console.log('ğŸ‘¤ Selected employee:', selectedEmployee.name);
            
            if (currentMode === 'attendance') {
                // ì¶œì„ ëª¨ë“œ: ê·¼íƒœ íƒ€ì… ì„ íƒìœ¼ë¡œ
                showAttendanceTypeSelection();
            } else {
                // ì²­ì†Œ ëª¨ë“œ: ì‚¬ì§„ ì´¬ì˜ìœ¼ë¡œ
                showPhotoCapture();
            }
        }

        // ê·¼íƒœ íƒ€ì… ì„ íƒ í™”ë©´ í‘œì‹œ
        function showAttendanceTypeSelection() {
            document.getElementById('step-employee-selection').classList.add('hidden');
            document.getElementById('step-attendance-type').classList.remove('hidden');
            
            document.getElementById('attendance-employee-name').textContent = selectedEmployee.name;
            document.getElementById('attendance-location-name').textContent = scannedLocation.name;
        }

        // ê·¼íƒœ íƒ€ì… ì„ íƒ
        async function selectAttendanceType(type) {
            const attendanceData = {
                employee_id: selectedEmployee.id,
                employee_name: selectedEmployee.name,
                employee_number: selectedEmployee.employee_number || '',
                location_id: scannedLocation.id,
                location_name: scannedLocation.name,
                location_code: scannedLocation.code,
                attendance_type: type,
                scan_time: new Date().toISOString(),
                device_info: navigator.userAgent
            };
            
            try {
                const { data, error } = await supabaseClient
                    .from('attendance_records')
                    .insert([attendanceData])
                    .select()
                    .single();
                
                if (error) throw error;
                
                console.log('âœ… Attendance saved');
                showAttendanceComplete(data);
                
            } catch (error) {
                console.error('âŒ Error saving attendance:', error);
                alert('ê·¼íƒœ ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì¶œì„ ì™„ë£Œ í‘œì‹œ
        function showAttendanceComplete(record) {
            document.getElementById('step-attendance-type').classList.add('hidden');
            document.getElementById('step-attendance-complete').classList.remove('hidden');
            
            const resultDiv = document.getElementById('attendance-result');
            const scanTime = new Date(record.scan_time);
            
            resultDiv.innerHTML = `
                <div class="text-left space-y-2">
                    <p><span class="font-semibold">ì§ì›:</span> ${record.employee_name}</p>
                    <p><span class="font-semibold">êµ¬ì—­:</span> ${record.location_name}</p>
                    <p><span class="font-semibold">íƒ€ì…:</span> ${record.attendance_type}</p>
                    <p><span class="font-semibold">ì‹œê°„:</span> ${formatDateTime(scanTime)}</p>
                </div>
            `;
        }

        // ì‚¬ì§„ ì´¬ì˜ í™”ë©´ í‘œì‹œ
        function showPhotoCapture() {
            document.getElementById('step-employee-selection').classList.add('hidden');
            document.getElementById('step-photo-capture').classList.remove('hidden');
            
            document.getElementById('current-employee-name').textContent = selectedEmployee.name;
            document.getElementById('current-location-name').textContent = scannedLocation.name;
            updateCurrentPhotoCount();
        }

        // ì‚¬ì§„ ì´¬ì˜
        function capturePhotos() {
            document.getElementById('photo-input').click();
        }

        // ì‚¬ì§„ ì„ íƒ ì‹œ
        document.addEventListener('DOMContentLoaded', function() {
            const photoInput = document.getElementById('photo-input');
            if (photoInput) {
                photoInput.addEventListener('change', async function(e) {
                    const files = Array.from(e.target.files);
                    
                    if (files.length === 0) return;
                    
                    if (currentPhotos.length + files.length > 30) {
                        alert('ìµœëŒ€ 30ì¥ê¹Œì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    // ì‚¬ì§„ ì¶”ê°€
                    for (const file of files) {
                        // EXIF ê²€ì¦
                        const isValid = await validatePhotoTime(file);
                        if (!isValid) {
                            alert(`${file.name}: 10ë¶„ ì´ë‚´ì— ì´¬ì˜í•œ ì‚¬ì§„ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                            continue;
                        }
                        
                        currentPhotos.push(file);
                    }
                    
                    updatePhotoPreview();
                    updateCurrentPhotoCount();
                    updateSubmitButton();
                    
                    // íŒŒì¼ input ì´ˆê¸°í™”
                    e.target.value = '';
                });
            }
        });

        // ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updatePhotoPreview() {
            const previewDiv = document.getElementById('photo-preview');
            previewDiv.innerHTML = currentPhotos.map((file, index) => {
                const url = URL.createObjectURL(file);
                return `
                    <div class="relative">
                        <img src="${url}" class="w-full h-24 object-cover rounded-lg">
                        <button onclick="removePhoto(${index})" class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        // ì‚¬ì§„ ì‚­ì œ
        function removePhoto(index) {
            currentPhotos.splice(index, 1);
            updatePhotoPreview();
            updateCurrentPhotoCount();
            updateSubmitButton();
        }

        // í˜„ì¬ ì‚¬ì§„ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        function updateCurrentPhotoCount() {
            document.getElementById('current-photo-count').textContent = currentPhotos.length;
        }

        // ì œì¶œ ë²„íŠ¼ í™œì„±í™”
        function updateSubmitButton() {
            const submitBtn = document.getElementById('submit-cleaning-btn');
            submitBtn.disabled = currentPhotos.length === 0;
        }

        // EXIF ì‹œê°„ ê²€ì¦ (10ë¶„ ì´ë‚´)
        async function validatePhotoTime(file) {
            return new Promise((resolve) => {
                EXIF.getData(file, function() {
                    const dateTime = EXIF.getTag(this, 'DateTimeOriginal');
                    
                    if (!dateTime) {
                        // EXIF ì—†ìœ¼ë©´ íŒŒì¼ ìˆ˜ì •ì‹œê°„ìœ¼ë¡œ í™•ì¸
                        const fileTime = new Date(file.lastModified);
                        const now = new Date();
                        const diff = now - fileTime;
                        resolve(diff < 10 * 60 * 1000); // 10ë¶„
                    } else {
                        // EXIF ì‹œê°„ íŒŒì‹±
                        const parts = dateTime.split(' ');
                        const datePart = parts[0].replace(/:/g, '-');
                        const timePart = parts[1];
                        const photoTime = new Date(`${datePart}T${timePart}`);
                        
                        const now = new Date();
                        const diff = now - photoTime;
                        resolve(diff < 10 * 60 * 1000); // 10ë¶„
                    }
                });
            });
        }

        // ì²­ì†Œ ì œì¶œ (ì¼ê´„ ì—…ë¡œë“œ)
        async function submitCleaning() {
            if (currentPhotos.length === 0) {
                alert('ì‚¬ì§„ì„ ì¶”ê°€í•˜ì„¸ìš”.');
                return;
            }
            
            const progressDiv = document.getElementById('upload-progress');
            const progressBar = document.getElementById('upload-progress-bar');
            const statusText = document.getElementById('upload-status');
            const submitBtn = document.getElementById('submit-cleaning-btn');
            
            progressDiv.classList.remove('hidden');
            submitBtn.disabled = true;
            
            try {
                const photoUrls = [];
                let uploadedCount = 0;
                const totalPhotos = currentPhotos.length;
                
                // ì‚¬ì§„ ì—…ë¡œë“œ
                for (const file of currentPhotos) {
                    const timestamp = Date.now();
                    const fileName = `${timestamp}_${scannedLocation.code}_${selectedEmployee.name}_${file.name}`;
                    
                    // Supabase Storage ì—…ë¡œë“œ
                    const { data, error } = await supabaseClient.storage
                        .from('cleaning-photos')
                        .upload(fileName, file);
                    
                    if (error) throw error;
                    
                    // URL ê°€ì ¸ì˜¤ê¸°
                    const { data: urlData } = supabaseClient.storage
                        .from('cleaning-photos')
                        .getPublicUrl(fileName);
                    
                    photoUrls.push(urlData.publicUrl);
                    
                    uploadedCount++;
                    const progress = (uploadedCount / totalPhotos) * 100;
                    progressBar.style.width = progress + '%';
                    statusText.textContent = `ì—…ë¡œë“œ ì¤‘... ${uploadedCount}/${totalPhotos}`;
                }
                
                // DBì— ê¸°ë¡ ì €ì¥
                const cleaningData = {
                    employee_id: selectedEmployee.id,
                    employee_name: selectedEmployee.name,
                    employee_number: selectedEmployee.employee_number || '',
                    location_id: scannedLocation.id,
                    location_name: scannedLocation.name,
                    location_code: scannedLocation.code,
                    photo_urls: photoUrls,
                    photo_count: photoUrls.length,
                    photo_taken_at: new Date().toISOString(),
                    submitted_at: new Date().toISOString(),
                    status: 'completed',
                    device_info: navigator.userAgent
                };
                
                const { error: dbError } = await supabaseClient
                    .from('cleaning_tasks')
                    .insert([cleaningData]);
                
                if (dbError) throw dbError;
                
                progressDiv.classList.add('hidden');
                console.log('âœ… Cleaning saved');
                showCleaningComplete();
                
            } catch (error) {
                console.error('âŒ Error submitting cleaning:', error);
                alert('ì²­ì†Œ ê¸°ë¡ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                progressDiv.classList.add('hidden');
                submitBtn.disabled = false;
            }
        }

        // ì²­ì†Œ ì™„ë£Œ í‘œì‹œ
        function showCleaningComplete() {
            document.getElementById('step-photo-capture').classList.add('hidden');
            document.getElementById('step-cleaning-complete').classList.remove('hidden');
            
            const resultDiv = document.getElementById('cleaning-result');
            
            resultDiv.innerHTML = `
                <div class="text-left space-y-2">
                    <p><span class="font-semibold">ì§ì›:</span> ${selectedEmployee.name}</p>
                    <p><span class="font-semibold">êµ¬ì—­:</span> ${scannedLocation.name}</p>
                    <p><span class="font-semibold">ì‚¬ì§„:</span> ${currentPhotos.length}ì¥</p>
                    <p><span class="font-semibold">ì‹œê°„:</span> ${formatDateTime(new Date())}</p>
                </div>
            `;
        }

        // ì²­ì†Œ ì·¨ì†Œ
        function cancelCleaning() {
            if (confirm('ì‘ì—…ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ë°ì´í„°ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.')) {
                resetAll();
            }
        }

        // ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ë“¤
        function backToMenu() {
            document.getElementById('step-employee-selection').classList.add('hidden');
            document.getElementById('step-menu-selection').classList.remove('hidden');
        }

        function backToEmployeeSelection() {
            document.getElementById('step-attendance-type').classList.add('hidden');
            document.getElementById('step-employee-selection').classList.remove('hidden');
        }

        function resetAll() {
            // ëª¨ë“  ë³€ìˆ˜ ì´ˆê¸°í™”
            currentMode = null;
            selectedEmployee = null;
            currentPhotos = [];
            
            // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('step-employee-selection').classList.add('hidden');
            document.getElementById('step-attendance-type').classList.add('hidden');
            document.getElementById('step-photo-capture').classList.add('hidden');
            document.getElementById('step-attendance-complete').classList.add('hidden');
            document.getElementById('step-cleaning-complete').classList.add('hidden');
            
            // ë©”ë‰´ ì„ íƒ í™”ë©´ìœ¼ë¡œ
            document.getElementById('step-menu-selection').classList.remove('hidden');
        }

        // ë‚ ì§œ/ì‹œê°„ í¬ë§·íŒ…
        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
    </script>
</body>
</html>
