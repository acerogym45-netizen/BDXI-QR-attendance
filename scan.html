<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR 스캔 - 출석 체크</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100">
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <h1 class="text-xl font-bold"><i class="fas fa-qrcode mr-2"></i>QR 스캔</h1>
                <a href="index.html" class="text-sm hover:text-blue-200"><i class="fas fa-home mr-1"></i>홈</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-6">
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded">
            <p class="text-sm"><i class="fas fa-info-circle mr-2"></i>카메라 권한을 허용해주세요.</p>
        </div>

        <div id="employee-selection" class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-lg font-bold mb-4"><i class="fas fa-user mr-2"></i>직원 선택</h2>
            <input type="text" id="employee-search" placeholder="이름 또는 사번으로 검색..." 
                class="w-full px-4 py-2 border rounded-md mb-4">
            <div id="employees-grid" class="grid grid-cols-2 md:grid-cols-3 gap-3">
                <div class="col-span-full text-center text-gray-500 py-8">
                    <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                    <p>로딩 중...</p>
                </div>
            </div>
        </div>

        <div id="scanner-section" class="bg-white rounded-lg shadow-md p-6 hidden">
            <div id="selected-info" class="mb-4 p-4 bg-blue-50 rounded-lg"></div>
            <h2 class="text-lg font-bold mb-4"><i class="fas fa-camera mr-2"></i>QR 코드 스캔</h2>
            <div id="reader" class="mb-4"></div>
            <div id="scan-result"></div>
            <button onclick="clearSelection()" class="w-full bg-gray-600 text-white py-2 rounded-md mt-4">
                <i class="fas fa-arrow-left mr-2"></i>직원 재선택
            </button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let employees = [];
        let selectedEmployee = null;
        let html5QrCode = null;

        document.addEventListener('DOMContentLoaded', loadEmployees);

        async function loadEmployees() {
            try {
                const { data, error } = await supabase
                    .from('employees')
                    .select('*')
                    .eq('is_active', true);
                
                if (error) throw error;
                employees = data || [];
                displayEmployees(employees);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('employees-grid').innerHTML = 
                    '<div class="col-span-full text-center text-red-500 py-4">데이터베이스 연결 오류</div>';
            }
        }

        function displayEmployees(list) {
            const grid = document.getElementById('employees-grid');
            if (list.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">등록된 직원이 없습니다.</div>';
                return;
            }
            grid.innerHTML = list.map(emp => `
                <button onclick="selectEmployee('${emp.id}')" 
                    class="p-4 border-2 border-gray-200 rounded-lg hover:border-blue-600 hover:bg-blue-50 transition">
                    <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold mx-auto mb-2">
                        ${emp.name.charAt(0)}
                    </div>
                    <div class="font-semibold">${emp.name}</div>
                    <div class="text-xs text-gray-500">${emp.employee_number}</div>
                </button>
            `).join('');
        }

        document.getElementById('employee-search').addEventListener('input', function(e) {
            const term = e.target.value.toLowerCase();
            const filtered = term ? employees.filter(emp => 
                emp.name.toLowerCase().includes(term) || 
                emp.employee_number.toLowerCase().includes(term)
            ) : employees;
            displayEmployees(filtered);
        });

        function selectEmployee(id) {
            selectedEmployee = employees.find(e => e.id === id);
            if (!selectedEmployee) return;
            
            document.getElementById('selected-info').innerHTML = `
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold mr-3">
                        ${selectedEmployee.name.charAt(0)}
                    </div>
                    <div>
                        <div class="font-bold">${selectedEmployee.name}</div>
                        <div class="text-sm text-gray-600">${selectedEmployee.employee_number}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('employee-selection').classList.add('hidden');
            document.getElementById('scanner-section').classList.remove('hidden');
            
            setTimeout(startScanner, 300);
        }

        function clearSelection() {
            selectedEmployee = null;
            stopScanner();
            document.getElementById('employee-selection').classList.remove('hidden');
            document.getElementById('scanner-section').classList.add('hidden');
        }

        async function startScanner() {
            try {
                html5QrCode = new Html5Qrcode("reader");
                await html5QrCode.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    onScanSuccess,
                    () => {}
                );
            } catch (err) {
                document.getElementById('scan-result').innerHTML = `
                    <div class="border-2 border-red-500 bg-red-50 rounded-lg p-4 text-center">
                        <i class="fas fa-exclamation-triangle text-red-600 text-3xl mb-2"></i>
                        <p class="text-sm text-gray-700">카메라 접근 실패: ${err.message}</p>
                    </div>
                `;
            }
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().catch(() => {});
            }
        }

        async function onScanSuccess(decodedText) {
            try {
                const qrData = JSON.parse(decodedText);
                if (qrData.type !== 'location') {
                    showResult(false, '올바른 구역 QR 코드가 아닙니다.');
                    return;
                }
                
                if (html5QrCode) html5QrCode.pause(true);
                
                const { data, error } = await supabase
                    .from('attendance_records')
                    .insert([{
                        employee_id: selectedEmployee.id,
                        employee_name: selectedEmployee.name,
                        location_id: qrData.locationId,
                        location_name: qrData.locationName,
                        location_code: qrData.locationCode,
                        scan_time: new Date().toISOString()
                    }])
                    .select();
                
                if (error) throw error;
                showResult(true, `${qrData.locationName}에 출석 체크되었습니다!`, data[0]);
            } catch (error) {
                console.error('Error:', error);
                showResult(false, 'QR 코드 처리 중 오류가 발생했습니다.');
            }
        }

        function showResult(success, message, record) {
            const resultDiv = document.getElementById('scan-result');
            const color = success ? 'green' : 'red';
            let html = `
                <div class="border-2 border-${color}-500 bg-${color}-50 rounded-lg p-4 text-center">
                    <i class="fas fa-${success ? 'check' : 'exclamation'}-circle text-${color}-600 text-4xl mb-2"></i>
                    <h3 class="font-bold mb-2">${success ? '출석 완료!' : '스캔 실패'}</h3>
                    <p class="text-sm mb-3">${message}</p>
            `;
            if (success && record) {
                html += `
                    <div class="bg-white rounded p-3 mb-3 text-left text-sm">
                        <div><strong>시간:</strong> ${new Date(record.scan_time).toLocaleString('ko-KR')}</div>
                    </div>
                `;
            }
            html += `
                    <button onclick="continueScanning()" class="w-full bg-blue-600 text-white py-2 rounded-md">
                        <i class="fas fa-qrcode mr-2"></i>계속 스캔하기
                    </button>
                </div>
            `;
            resultDiv.innerHTML = html;
        }

        function continueScanning() {
            document.getElementById('scan-result').innerHTML = '';
            if (html5QrCode) html5QrCode.resume();
        }
    </script>
</body>
</html>
