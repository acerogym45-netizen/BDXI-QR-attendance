
<!DOCTYPE html>
<html lang="ko" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>KINDWON ì§ì› ì—…ë¬´ ì‹œìŠ¤í…œ</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
      body {
        font-family: 'Noto Sans KR', sans-serif;
        background-color: #f3f4f6;
        -webkit-tap-highlight-color: transparent;
      }
      .bg-gradient-brand {
        background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
      }
      .text-brand {
        color: #1b5e3e;
      }
      .bg-brand {
        background-color: #1b5e3e;
      }
      .btn-touch {
        transition:
          transform 0.1s,
          opacity 0.1s;
      }
      .btn-touch:active {
        transform: scale(0.98);
        opacity: 0.9;
      }
      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 3px solid white;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
      }
      .spinner-dark {
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-top: 3px solid #1b5e3e;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      /* Toast Animation */
      .toast-enter {
        transform: translateY(100%);
        opacity: 0;
      }
      .toast-enter-active {
        transform: translateY(0);
        opacity: 1;
        transition: all 0.3s ease-out;
      }
    </style>
  </head>
  <body class="min-h-screen relative pb-20">
    <!-- Loading Overlay -->
    <div id="screen-loading" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
      <div class="spinner spinner-dark w-12 h-12 mb-4"></div>
      <p class="text-gray-500 font-medium animate-pulse">ì‹œìŠ¤í…œ ì—°ê²° ì¤‘...</p>
    </div>

    <!-- Header -->
    <header class="bg-gradient-brand shadow-lg sticky top-0 z-30">
      <div class="px-6 py-5 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="https://www.genspark.ai/api/files/s/UmgxPvd3" alt="KINDWON" class="h-8 bg-white rounded px-1" />
          <div class="h-4 w-px bg-white/20"></div>
          <span class="font-bold text-white text-lg tracking-wide">ì—…ë¬´ ê¸°ë¡</span>
        </div>
        <div id="connection-status" class="w-2.5 h-2.5 rounded-full bg-green-400 shadow-sm animate-pulse"></div>
      </div>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-4">
      <!-- 1. Location Info Card -->
      <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
        <div class="flex items-start justify-between">
          <div>
            <p class="text-xs text-gray-400 font-medium mb-1">í˜„ì¬ ìœ„ì¹˜</p>
            <h1 id="display-location" class="text-2xl font-bold text-gray-800 leading-tight">ë¡œë”© ì¤‘...</h1>
            <p
              id="display-apt"
              class="text-sm text-brand font-medium mt-2 bg-green-50 inline-block px-2 py-0.5 rounded-md"
            >
              <i class="fas fa-building mr-1"></i>...
            </p>
          </div>
          <div class="bg-gray-50 p-3 rounded-full text-gray-400">
            <i class="fas fa-map-marker-alt text-xl"></i>
          </div>
        </div>
      </div>

      <!-- 2. Employee Selection -->
      <div id="section-employee" class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 transition-all">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-bold text-gray-800 flex items-center gap-2">
            <span class="bg-gray-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
            ì§ì› ì„ íƒ
          </h2>
          <button
            id="btn-reset-emp"
            onclick="app.resetSelection()"
            class="hidden text-xs text-gray-500 underline px-2 py-1"
          >
            ë³€ê²½
          </button>
        </div>

        <!-- Search Input -->
        <div id="employee-search-container">
          <div class="relative mb-3">
            <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
            <input
              type="text"
              id="inp-search"
              class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 focus:bg-white focus:border-green-500 focus:ring-0 rounded-xl transition-all text-sm outline-none"
              placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”..."
              onkeyup="app.filterEmployees()"
            />
          </div>

          <!-- Employee List -->
          <div id="list-employees" class="max-h-60 overflow-y-auto space-y-2 pr-1 custom-scrollbar">
            <!-- Dynamic Content -->
          </div>
        </div>

        <!-- Selected State (Hidden initially) -->
        <div id="employee-selected" class="hidden">
          <div class="bg-green-50 border border-green-100 rounded-xl p-4 flex items-center gap-3">
            <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center text-green-700 text-xl">
              <i class="fas fa-user"></i>
            </div>
            <div class="flex-1">
              <p id="selected-name" class="font-bold text-gray-800 text-lg"></p>
              <p id="selected-pos" class="text-xs text-gray-600"></p>
            </div>
            <i class="fas fa-check-circle text-green-600 text-2xl"></i>
          </div>
        </div>
      </div>

      <!-- 3. Work Options (Hidden initially) -->
      <div id="section-work" class="hidden space-y-4">
        <div class="flex items-center gap-2 px-1 mt-6">
          <span class="bg-gray-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
          <h2 class="font-bold text-gray-800">ì—…ë¬´ ê¸°ë¡</h2>
        </div>

        <!-- Attendance Grid -->
        <div class="grid grid-cols-2 gap-3">
          <button
            onclick="app.recordAttendance('ì¶œê·¼')"
            class="btn-touch bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-xl shadow-sm shadow-blue-100 flex flex-col items-center gap-2"
          >
            <i class="fas fa-sign-in-alt text-2xl mb-1 opacity-90"></i>
            <span class="font-bold">ì¶œê·¼</span>
          </button>
          <button
            onclick="app.recordAttendance('í‡´ê·¼')"
            class="btn-touch bg-green-500 hover:bg-green-600 text-white p-4 rounded-xl shadow-sm shadow-green-100 flex flex-col items-center gap-2"
          >
            <i class="fas fa-sign-out-alt text-2xl mb-1 opacity-90"></i>
            <span class="font-bold">í‡´ê·¼</span>
          </button>
          <button
            onclick="app.recordAttendance('íœ´ê²Œ ì‹œì‘')"
            class="btn-touch bg-yellow-500 hover:bg-yellow-600 text-white p-4 rounded-xl shadow-sm shadow-yellow-100 flex flex-col items-center gap-2"
          >
            <i class="fas fa-mug-hot text-2xl mb-1 opacity-90"></i>
            <span class="font-bold">íœ´ê²Œ ì‹œì‘</span>
          </button>
          <button
            onclick="app.recordAttendance('íœ´ê²Œ ì¢…ë£Œ')"
            class="btn-touch bg-purple-500 hover:bg-purple-600 text-white p-4 rounded-xl shadow-sm shadow-purple-100 flex flex-col items-center gap-2"
          >
            <i class="fas fa-history text-2xl mb-1 opacity-90"></i>
            <span class="font-bold">íœ´ê²Œ ì¢…ë£Œ</span>
          </button>
        </div>

        <!-- Divider -->
        <div class="relative py-2">
          <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
          <div class="relative flex justify-center">
            <span class="bg-gray-50 px-3 py-1 rounded-full text-xs text-gray-400 font-medium">íŠ¹ìˆ˜ ì—…ë¬´</span>
          </div>
        </div>

        <!-- Cleaning Button -->
        <button
          onclick="document.getElementById('inp-camera').click()"
          class="btn-touch w-full bg-orange-500 hover:bg-orange-600 text-white p-5 rounded-2xl shadow-md shadow-orange-100 flex items-center justify-between group"
        >
          <div class="flex items-center gap-4">
            <div class="bg-white/20 w-12 h-12 rounded-xl flex items-center justify-center">
              <i class="fas fa-camera text-2xl"></i>
            </div>
            <div class="text-left">
              <div class="font-bold text-lg">ì²­ì†Œ ì‘ì—…</div>
              <div class="text-orange-100 text-xs">ì‚¬ì§„ ì´¬ì˜ ë° ê¸°ë¡</div>
            </div>
          </div>
          <i class="fas fa-chevron-right opacity-60"></i>
        </button>
        <input
          type="file"
          id="inp-camera"
          accept="image/*"
          capture="environment"
          class="hidden"
          onchange="app.handlePhoto(this)"
        />
      </div>
    </main>

    <!-- Photo Preview Overlay -->
    <div id="preview-overlay" class="hidden fixed inset-0 bg-black/95 z-50 flex flex-col p-4 animate-fade-in">
      <div class="flex justify-between items-center text-white mb-4">
        <h3 class="font-bold text-lg">ğŸ“¸ ì‚¬ì§„ í™•ì¸</h3>
        <button onclick="app.cancelPhoto()" class="w-8 h-8 flex items-center justify-center rounded-full bg-white/20">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="flex-1 bg-black flex items-center justify-center rounded-lg overflow-hidden mb-4 relative">
        <img id="img-preview" class="max-w-full max-h-full object-contain" />
      </div>

      <div class="space-y-3">
        <input
          type="text"
          id="inp-notes"
          placeholder="íŠ¹ì´ì‚¬í•­ ì…ë ¥ (ì„ íƒ)"
          class="w-full bg-gray-800 border border-gray-700 text-white rounded-xl px-4 py-3 focus:outline-none focus:border-orange-500"
        />

        <div class="grid grid-cols-2 gap-3">
          <button
            onclick="document.getElementById('inp-camera').click()"
            class="py-3 bg-gray-700 text-white rounded-xl font-bold"
          >
            ì¬ì´¬ì˜
          </button>
          <button
            onclick="app.uploadPhoto()"
            id="btn-upload"
            class="py-3 bg-orange-500 text-white rounded-xl font-bold flex items-center justify-center gap-2"
          >
            <span>ì—…ë¡œë“œ</span>
            <div id="upload-spinner" class="spinner hidden w-4 h-4"></div>
          </button>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div
      id="toast"
      class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-gray-800/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-xl z-50 flex items-center gap-3 transition-all duration-300 translate-y-24 opacity-0 w-max max-w-[90%]"
    >
      <i id="toast-icon" class="fas fa-check-circle text-green-400"></i>
      <span id="toast-msg" class="font-medium text-sm">ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</span>
    </div>

    <!-- Error Screen -->
    <div
      id="screen-error"
      class="hidden fixed inset-0 bg-white z-50 flex flex-col items-center justify-center p-8 text-center"
    >
      <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mb-4 text-red-500">
        <i class="fas fa-exclamation-triangle text-2xl"></i>
      </div>
      <h2 class="text-xl font-bold text-gray-800 mb-2">ì˜¤ë¥˜ ë°œìƒ</h2>
      <p id="error-msg" class="text-gray-500 mb-6 text-sm break-keep">ì‹œìŠ¤í…œì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
      <button onclick="location.reload()" class="px-6 py-2 bg-gray-800 text-white rounded-lg text-sm font-bold">
        ë‹¤ì‹œ ì‹œë„
      </button>
    </div>

    <script>
      // --- CONFIGURATION ---
      const SUPABASE_URL = 'https://qgpqhtuynxhmgawakjxe.supabase.co';
      const SUPABASE_KEY =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFncHFodHV5bnhobWdhd2FranhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyOTQyNTEsImV4cCI6MjA4Mjg3MDI1MX0.WNljQIKDbeZCDlXe8fpBdZs58XRFfujGt7lBGfq_pVg';

      const APARTMENTS = {
        BJD001: 'ë´‰ë‹´ìì´í”„ë¼ì´ë“œì‹œí‹°',
        YDB002: 'ìš©ì¸ë™ë°±ì„¼íŠ¸ëŸ´',
        SYT003: 'ìˆ˜ì›ì˜í†µìì´',
        PGD004: 'í‰íƒê³ ë•êµ­ì œì‹ ë„ì‹œ',
        ETC999: 'ê¸°íƒ€ ë‹¨ì§€',
      };

      const app = {
        sb: null,
        state: {
          locId: null,
          aptId: null,
          locationName: '',
          employees: [],
          selectedEmp: null,
          photoFile: null,
        },

        init: async function () {
          try {
            // 1. Init Supabase
            this.sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // 2. Parse URL
            const params = new URLSearchParams(window.location.search);
            this.state.locId = params.get('loc');
            this.state.aptId = params.get('apt');

            if (!this.state.locId || !this.state.aptId) {
              throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ QR ì½”ë“œì…ë‹ˆë‹¤.');
            }

            // 3. Load Data
            await Promise.all([this.loadLocation(), this.loadEmployees()]);

            // 4. Render
            this.renderLocationInfo();
            this.renderEmployeeList(this.state.employees);

            // 5. Hide Loader
            document.getElementById('screen-loading').classList.add('hidden');
          } catch (e) {
            console.error(e);
            this.showError(e.message);
          }
        },

        // --- DATA LOADING ---
        loadLocation: async function () {
          const { data, error } = await this.sb
            .from('locations')
            .select('name, apartment_id')
            .eq('id', this.state.locId)
            .single();

          if (error) throw new Error('êµ¬ì—­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          this.state.locationName = data.name;

          // Verify Apartment Match
          if (data.apartment_id !== this.state.aptId) {
            console.warn('Apartment mismatch', data.apartment_id, this.state.aptId);
          }
        },

        loadEmployees: async function () {
          const { data, error } = await this.sb
            .from('employees')
            .select('*')
            .eq('apartment_id', this.state.aptId)
            .eq('status', 'active')
            .order('name');

          if (error) throw error;
          this.state.employees = data || [];
        },

        // --- RENDERING ---
        renderLocationInfo: function () {
          document.getElementById('display-location').textContent = this.state.locationName;
          const aptName = APARTMENTS[this.state.aptId] || this.state.aptId;
          document.getElementById('display-apt').innerHTML = `<i class="fas fa-building mr-1"></i>${aptName}`;
        },

        renderEmployeeList: function (list) {
          const container = document.getElementById('list-employees');
          container.innerHTML = '';

          if (list.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-400 text-sm py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
          }

          list.forEach((emp) => {
            const div = document.createElement('div');
            div.className =
              'flex items-center p-3 bg-white border border-gray-100 rounded-xl active:bg-gray-50 cursor-pointer mb-2 transition-colors';
            div.onclick = () => this.selectEmployee(emp);

            div.innerHTML = `
              <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 mr-3 text-sm">
                <i class="fas fa-user"></i>
              </div>
              <div>
                <p class="font-bold text-gray-800 text-sm">${emp.name}</p>
                <p class="text-xs text-gray-400">${emp.position || 'ì§ì›'} ${emp.phone ? ' Â· ' + emp.phone.slice(-4) : ''}</p>
              </div>
              <i class="fas fa-chevron-right ml-auto text-gray-300 text-xs"></i>
            `;
            container.appendChild(div);
          });
        },

        filterEmployees: function () {
          const term = document.getElementById('inp-search').value.toLowerCase();
          const filtered = this.state.employees.filter(
            (e) => e.name.toLowerCase().includes(term) || (e.phone && e.phone.includes(term)),
          );
          this.renderEmployeeList(filtered);
        },

        // --- INTERACTION ---
        selectEmployee: function (emp) {
          this.state.selectedEmp = emp;

          // UI Updates
          document.getElementById('employee-search-container').classList.add('hidden');
          document.getElementById('employee-selected').classList.remove('hidden');

          document.getElementById('selected-name').textContent = emp.name;
          document.getElementById('selected-pos').textContent = emp.position || 'ì§ì›';

          document.getElementById('btn-reset-emp').classList.remove('hidden');
          document.getElementById('section-work').classList.remove('hidden');

          // Scroll to work section
          setTimeout(() => {
            document.getElementById('section-work').scrollIntoView({ behavior: 'smooth' });
          }, 100);
        },

        resetSelection: function () {
          this.state.selectedEmp = null;
          document.getElementById('employee-selected').classList.add('hidden');
          document.getElementById('employee-search-container').classList.remove('hidden');
          document.getElementById('btn-reset-emp').classList.add('hidden');
          document.getElementById('section-work').classList.add('hidden');

          document.getElementById('inp-search').value = '';
          this.renderEmployeeList(this.state.employees);
        },

        // --- ACTIONS: ATTENDANCE ---
        recordAttendance: async function (type) {
          if (!this.state.selectedEmp) return;

          const btnIcon = event.currentTarget.querySelector('i');
          const originalClass = btnIcon.className;
          btnIcon.className = 'fas fa-spinner fa-spin text-2xl mb-1';

          try {
            const payload = {
              employee_name: this.state.selectedEmp.name,
              attendance_type: type,
              location: this.state.locationName,
              scan_time: new Date().toISOString(),
              apartment_id: this.state.aptId,
            };

            const { error } = await this.sb.from('attendance_records').insert([payload]);
            if (error) throw error;

            this.showToast(`${this.state.selectedEmp.name}ë‹˜, ${type} ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            this.resetSelection();
          } catch (e) {
            console.error(e);
            this.showToast('ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
          } finally {
            btnIcon.className = originalClass;
          }
        },

        // --- ACTIONS: CLEANING ---
        handlePhoto: function (input) {
          if (input.files && input.files[0]) {
            const file = input.files[0];
            this.state.photoFile = file;

            const reader = new FileReader();
            reader.onload = (e) => {
              document.getElementById('img-preview').src = e.target.result;
              document.getElementById('preview-overlay').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
          }
        },

        cancelPhoto: function () {
          document.getElementById('preview-overlay').classList.add('hidden');
          document.getElementById('inp-camera').value = ''; // reset input
          document.getElementById('inp-notes').value = '';
          this.state.photoFile = null;
        },

        uploadPhoto: async function () {
          if (!this.state.photoFile) return;

          const btn = document.getElementById('btn-upload');
          const spinner = document.getElementById('upload-spinner');
          const btnText = btn.querySelector('span');

          btn.disabled = true;
          btn.classList.add('opacity-75');
          btnText.textContent = 'ì—…ë¡œë“œ ì¤‘...';
          spinner.classList.remove('hidden');

          try {
            // 1. Upload Image
            const ext = this.state.photoFile.name.split('.').pop() || 'jpg';
            const fileName = `${this.state.aptId}/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${ext}`;

            const { data: uploadData, error: uploadError } = await this.sb.storage
              .from('cleaning-photos')
              .upload(fileName, this.state.photoFile);

            if (uploadError) throw uploadError;

            // 2. Get URL
            const {
              data: { publicUrl },
            } = this.sb.storage.from('cleaning-photos').getPublicUrl(fileName);

            // 3. Save Record
            const notes = document.getElementById('inp-notes').value;
            const payload = {
              employee_name: this.state.selectedEmp.name,
              location: this.state.locationName,
              photo_url: publicUrl,
              notes: notes,
              created_at: new Date().toISOString(),
              apartment_id: this.state.aptId,
            };

            const { error: dbError } = await this.sb.from('cleaning_tasks').insert([payload]);
            if (dbError) throw dbError;

            this.showToast('ì²­ì†Œ ì‘ì—…ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            this.cancelPhoto();
            this.resetSelection();
          } catch (e) {
            console.error(e);
            alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
          } finally {
            btn.disabled = false;
            btn.classList.remove('opacity-75');
            btnText.textContent = 'ì—…ë¡œë“œ';
            spinner.classList.add('hidden');
          }
        },

        // --- UTILS ---
        showToast: function (msg, type = 'success') {
          const el = document.getElementById('toast');
          const icon = document.getElementById('toast-icon');
          const text = document.getElementById('toast-msg');

          text.textContent = msg;

          if (type === 'error') {
            icon.className = 'fas fa-exclamation-circle text-red-400';
          } else {
            icon.className = 'fas fa-check-circle text-green-400';
          }

          el.classList.remove('translate-y-24', 'opacity-0');

          setTimeout(() => {
            el.classList.add('translate-y-24', 'opacity-0');
          }, 3000);
        },

        showError: function (msg) {
          document.getElementById('screen-loading').classList.add('hidden');
          document.getElementById('screen-error').classList.remove('hidden');
          document.getElementById('error-msg').textContent = msg;
        },
      };

      document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
  <script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"9c367f4648a7bcf1","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.9.1","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>
